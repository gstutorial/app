<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0f172a" id="meta-theme-color">
  <meta charset="UTF-8" />
  <title>G.S. Tutorial â€“ Interactive Learning App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <!-- Include jsPDF library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <!-- Include html2canvas for capturing screenshots -->
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <!-- Include Noto Sans font for better Unicode support -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* ===== CSS VARIABLES FOR LIGHT/DARK THEMES ===== */
    :root {
      --bg-gradient-start: #0f172a;
      --bg-gradient-end: #1e293b;
      --surface: #020617;
      --surface-light: #1e293b;
      --text-primary: #f1f5f9;
      --text-secondary: #cbd5e1;
      --text-muted: #94a3b8;
      --border-color: rgba(148, 163, 184, 0.2);
      --accent-blue: #3b82f6;
      --accent-blue-hover: #2563eb;
      --accent-green: #22c55e;
      --accent-green-hover: #16a34a;
      --header-bg: rgba(2, 6, 23, 0.98);
      --card-bg: rgba(15, 23, 42, 0.8);
      --shadow: 0 18px 40px rgba(0,0,0,0.7);
      --sidebar-bg: #0f172a;
      --sidebar-border: #1e293b;
      --option-bg: rgba(15, 23, 42, 0.6);
      --input-bg: #0f172a;
      --input-border: #334155;
      --hover-bg: rgba(31, 41, 55, 0.9);
      --danger-bg: rgba(239, 68, 68, 0.15);
      --danger-border: rgba(239, 68, 68, 0.3);
      --success-bg: rgba(34, 197, 94, 0.15);
      --success-border: rgba(34, 197, 94, 0.3);
      --warning-bg: rgba(245, 158, 11, 0.15);
      --warning-border: rgba(245, 158, 11, 0.3);
      --button-secondary: #334155;
      --button-secondary-hover: #475569;
      --whatsapp-green: #25d366;
      --phone-blue: #3b82f6;
      --email-red: #ea4335;
    }

    body.light-mode {
      --bg-gradient-start: #f0f4fa;
      --bg-gradient-end: #d9e2ef;
      --surface: #ffffff;
      --surface-light: #f8fafc;
      --text-primary: #0f172a;
      --text-secondary: #334155;
      --text-muted: #64748b;
      --border-color: rgba(0,0,0,0.08);
      --accent-blue: #2563eb;
      --accent-blue-hover: #1d4ed8;
      --accent-green: #16a34a;
      --accent-green-hover: #15803d;
      --header-bg: rgba(255,255,255,0.98);
      --card-bg: #ffffff;
      --shadow: 0 10px 30px rgba(0,0,0,0.1);
      --sidebar-bg: #ffffff;
      --sidebar-border: #e2e8f0;
      --option-bg: #ffffff;
      --input-bg: #ffffff;
      --input-border: #cbd5e1;
      --hover-bg: #f1f5f9;
      --danger-bg: #fee2e2;
      --danger-border: #fecaca;
      --success-bg: #dcfce7;
      --success-border: #bbf7d0;
      --warning-bg: #fef3c7;
      --warning-border: #fde68a;
      --button-secondary: #e2e8f0;
      --button-secondary-hover: #cbd5e1;
    }

    /* ===== BASE STYLES ===== */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      background: var(--bg-gradient-start);
      color: var(--text-primary);
      min-height: 100vh;
      background-image: radial-gradient(circle at 50% 50%, var(--bg-gradient-end) 0%, var(--bg-gradient-start) 100%);
      transition: background-color 0.3s, color 0.2s;
      display: flex;
      flex-direction: column;
      align-items: center;
      -webkit-tap-highlight-color: transparent;
    }

    /* ===== LOADING ANIMATIONS ===== */
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes pulse {
      0%, 100% { opacity: 0.6; }
      50% { opacity: 1; }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes shimmer {
      0% { background-position: -1000px 0; }
      100% { background-position: 1000px 0; }
    }

    .loading-spinner {
      border: 4px solid rgba(59, 130, 246, 0.2);
      border-top: 4px solid #3b82f6;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }

    .loading-spinner-small {
      border: 3px solid rgba(59, 130, 246, 0.2);
      border-top: 3px solid #3b82f6;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      display: inline-block;
      margin-right: 10px;
    }

    .loading-pulse {
      animation: pulse 1.5s ease-in-out infinite;
    }

    .loading-shimmer {
      background: linear-gradient(90deg, 
        rgba(30, 41, 59, 0.3) 0%, 
        rgba(30, 41, 59, 0.5) 50%, 
        rgba(30, 41, 59, 0.3) 100%);
      background-size: 1000px 100%;
      animation: shimmer 2s infinite;
    }

    .loading-container {
      text-align: center;
      padding: 40px;
      color: var(--text-muted);
      grid-column: 1/-1;
    }

    .loading-text {
      font-size: 1.1rem;
      margin-top: 15px;
      color: var(--accent-blue);
    }

    .loading-subtext {
      font-size: 0.9rem;
      margin-top: 8px;
      color: var(--text-muted);
    }

    /* ===== FIXED HEADER - REDESIGNED ===== */
    .fixed-header {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background: var(--header-bg);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border-color);
      z-index: 1000;
      padding: 0 20px;
      height: 80px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .logo-header {
      width: 56px;
      height: 56px;
      border-radius: 12px;
      object-fit: contain;
      background: rgba(255, 255, 255, 0.05);
      padding: 4px;
    }

    .brand-container {
      display: flex;
      flex-direction: column;
    }

    .brand-main {
      font-weight: 700;
      font-size: 1.6rem;
      background: linear-gradient(135deg, var(--accent-blue) 0%, var(--accent-green) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      letter-spacing: -0.02em;
      line-height: 1.2;
    }

    .brand-sub {
      font-size: 0.8rem;
      color: var(--text-muted);
      letter-spacing: 0.5px;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .user-info {
      font-size: 0.9rem;
      color: var(--accent-blue);
      background: rgba(59, 130, 246, 0.15);
      padding: 8px 16px;
      border-radius: 999px;
      border: 1px solid rgba(59, 130, 246, 0.3);
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .menu-toggle {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      background: var(--surface-light);
      border: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 6px;
      cursor: pointer;
      transition: 0.2s;
    }

    .menu-toggle:hover {
      background: rgba(59, 130, 246, 0.2);
    }

    .menu-toggle span {
      width: 24px;
      height: 2px;
      background: var(--text-primary);
      border-radius: 4px;
      transition: 0.3s;
    }

    /* ===== SIDE MENU ===== */
    .side-menu {
      position: fixed;
      top: 80px;
      right: -320px;
      width: 300px;
      height: calc(100vh - 80px);
      background: var(--sidebar-bg);
      backdrop-filter: blur(12px);
      border-left: 1px solid var(--sidebar-border);
      box-shadow: -5px 0 25px rgba(0,0,0,0.2);
      transition: right 0.3s ease;
      z-index: 1001;
      display: flex;
      flex-direction: column;
      padding: 24px 16px;
      overflow-y: auto;
    }

    .side-menu.open {
      right: 0;
    }

    .menu-overlay {
      position: fixed;
      top: 80px;
      left: 0;
      width: 100%;
      height: calc(100vh - 80px);
      background: rgba(0,0,0,0.3);
      backdrop-filter: blur(2px);
      z-index: 1000;
      display: none;
    }

    .menu-overlay.open {
      display: block;
    }

    .side-profile {
      text-align: center;
      margin-bottom: 24px;
    }

    .side-profile img {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid var(--accent-blue);
      margin-bottom: 12px;
    }

    .side-username {
      font-weight: 600;
      font-size: 1.1rem;
      background: rgba(59,130,246,0.1);
      padding: 6px 12px;
      border-radius: 40px;
      display: inline-block;
      margin-top: 4px;
      color: var(--text-primary);
    }

    .side-dev {
      border-top: 1px solid var(--border-color);
      border-bottom: 1px solid var(--border-color);
      padding: 20px 0;
      margin: 10px 0;
    }

    .side-dev p {
      color: var(--text-secondary);
      margin-bottom: 16px;
      font-weight: 600;
    }

    .contact-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 0;
      color: var(--text-secondary);
      transition: 0.2s;
      cursor: pointer;
    }

    .contact-item:hover {
      color: var(--accent-blue);
      transform: translateX(4px);
    }

    .contact-item img {
      width: 24px;
      height: 24px;
      object-fit: contain;
    }

    .contact-item span {
      color: var(--text-secondary);
      text-decoration: none;
      font-size: 0.95rem;
    }

    .theme-toggle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--surface-light);
      padding: 12px 16px;
      border-radius: 40px;
      margin: 20px 0;
      border: 1px solid var(--border-color);
      cursor: pointer;
      color: var(--text-primary);
    }

    .logout-side {
      margin-top: auto;
      padding: 14px;
      background: rgba(239,68,68,0.1);
      border: 1px solid rgba(239,68,68,0.3);
      border-radius: 40px;
      color: #ef4444;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      cursor: pointer;
      transition: 0.2s;
    }

    .logout-side:hover {
      background: rgba(239,68,68,0.2);
    }

    /* ===== MAIN CONTENT ===== */
    .main-content {
      width: 100%;
      max-width: 800px;
      margin-top: 100px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    /* ===== GREETING MESSAGE ===== */
    .greeting-message {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 20px 24px;
      border: 1px solid var(--border-color);
      font-size: 1.2rem;
      backdrop-filter: blur(4px);
      color: var(--text-primary);
      box-shadow: var(--shadow);
      margin-bottom: 20px;
    }

    .greeting-message span {
      font-weight: 700;
      background: linear-gradient(135deg, var(--accent-blue), var(--accent-green));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .class-title {
      font-size: 1rem;
      color: var(--text-muted);
      margin-bottom: 16px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* ===== LOGIN CONTAINER ===== */
    #login-container {
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 20px;
    }

    .login-box {
      background: var(--surface);
      border-radius: 24px;
      padding: 30px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border-color);
      width: 100%;
      max-width: 420px;
    }

    .login-header {
      text-align: center;
      margin-bottom: 30px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
    }

    .logo-login {
      width: 80px;
      height: 80px;
      border-radius: 16px;
      object-fit: contain;
      background: rgba(255, 255, 255, 0.1);
      padding: 5px;
    }

    .login-title {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 8px;
      background: linear-gradient(90deg, var(--accent-blue) 0%, var(--accent-green) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: 0.5px;
    }

    .login-subtitle {
      font-size: 1rem;
      color: var(--text-secondary);
      text-align: center;
    }

    .login-form {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
      position: relative;
    }

    .form-group label {
      font-size: 0.9rem;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .form-input {
      background: var(--input-bg);
      color: var(--text-primary);
      border-radius: 40px;
      border: 1px solid var(--input-border);
      padding: 14px 18px;
      font-size: 1rem;
      transition: all 0.2s ease;
      width: 100%;
      padding-right: 45px;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--accent-blue);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }

    .form-input::placeholder {
      color: var(--text-muted);
    }

    .password-input-wrapper {
      position: relative;
      width: 100%;
    }

    .password-toggle {
      position: absolute;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      background: transparent;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      transition: color 0.2s ease;
      z-index: 10;
    }

    .password-toggle:hover {
      color: var(--accent-blue);
    }

    .attempt-counter {
      margin-top: 8px;
      font-size: 0.8rem;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .attempt-counter.warning {
      color: #fbbf24;
    }

    .attempt-counter.critical {
      color: #ef4444;
    }

    .cooldown-message {
      margin-top: 8px;
      padding: 10px;
      background: var(--danger-bg);
      border: 1px solid var(--danger-border);
      border-radius: 8px;
      font-size: 0.85rem;
      color: #fca5a5;
      text-align: center;
      animation: pulse 2s infinite;
    }

    .login-btn {
      background: linear-gradient(to right, var(--accent-blue), var(--accent-blue-hover));
      color: white;
      border: none;
      border-radius: 999px;
      padding: 16px 24px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-top: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: 0 8px 18px rgba(37, 99, 235, 0.4);
      width: 100%;
    }

    .login-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 22px rgba(37, 99, 235, 0.5);
    }

    .login-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .login-error {
      background: var(--danger-bg);
      color: #fca5a5;
      padding: 10px 12px;
      border-radius: 8px;
      font-size: 0.85rem;
      border: 1px solid var(--danger-border);
      display: none;
      text-align: center;
    }

    .account-config-error {
      background: var(--surface);
      border-radius: 24px;
      padding: 30px;
      box-shadow: var(--shadow);
      border: 1px solid var(--danger-border);
      display: none;
      width: 100%;
      max-width: 500px;
      margin: 0 auto;
    }

    .error-header {
      text-align: center;
      margin-bottom: 25px;
    }

    .error-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: #ef4444;
      margin-bottom: 10px;
      letter-spacing: 0.5px;
    }

    .error-subtitle {
      font-size: 1rem;
      color: var(--text-primary);
      text-align: center;
      margin-bottom: 5px;
    }

    .error-user-info {
      text-align: center;
      margin-bottom: 25px;
      padding: 15px;
      background: var(--danger-bg);
      border-radius: 12px;
      border: 1px solid var(--danger-border);
    }

    .error-user-info strong {
      color: #fca5a5;
      font-size: 1.1rem;
    }

    .error-details {
      background: rgba(30, 41, 59, 0.5);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 25px;
      border: 1px solid var(--border-color);
    }

    .error-details ul {
      margin: 0;
      padding-left: 20px;
      color: var(--text-secondary);
      line-height: 1.6;
    }

    .error-details li {
      margin-bottom: 10px;
    }

    .error-details strong {
      color: #fca5a5;
    }

    .whatsapp-btn {
      background: linear-gradient(to right, #25d366, #128c7e);
      color: white;
      border: none;
      border-radius: 999px;
      padding: 14px 24px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      box-shadow: 0 8px 18px rgba(37, 211, 102, 0.4);
      width: 100%;
      text-decoration: none;
      text-align: center;
    }

    .whatsapp-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 22px rgba(37, 211, 102, 0.5);
    }

    .whatsapp-btn img {
      width: 24px;
      height: 24px;
      object-fit: contain;
    }

    .subscription-expired {
      background: var(--surface);
      border-radius: 24px;
      padding: 30px;
      box-shadow: var(--shadow);
      border: 1px solid var(--danger-border);
      display: none;
      width: 100%;
      max-width: 500px;
      margin: 0 auto;
    }

    .expired-header {
      text-align: center;
      margin-bottom: 25px;
    }

    .expired-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: #ef4444;
      margin-bottom: 10px;
      letter-spacing: 0.5px;
    }

    .expired-subtitle {
      font-size: 1rem;
      color: var(--text-primary);
      text-align: center;
      margin-bottom: 5px;
    }

    .expired-user-info {
      text-align: center;
      margin-bottom: 25px;
      padding: 15px;
      background: var(--danger-bg);
      border-radius: 12px;
      border: 1px solid var(--danger-border);
    }

    .expired-user-info strong {
      color: #fca5a5;
      font-size: 1.1rem;
    }

    .expired-details {
      background: rgba(30, 41, 59, 0.5);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 25px;
      border: 1px solid var(--border-color);
      text-align: center;
    }

    .expired-details p {
      margin: 0;
      color: var(--text-secondary);
      line-height: 1.6;
      margin-bottom: 15px;
    }

    .back-to-login-btn {
      background: rgba(75, 85, 99, 0.15);
      color: var(--text-secondary);
      border: 1px solid var(--border-color);
      border-radius: 999px;
      padding: 12px 24px;
      font-size: 0.95rem;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-top: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 100%;
    }

    .back-to-login-btn:hover {
      background: rgba(75, 85, 99, 0.25);
      transform: translateY(-1px);
    }

    .config-info {
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.3);
      border-radius: 8px;
      padding: 10px;
      margin-top: 15px;
      font-size: 0.8rem;
      color: var(--accent-blue);
      text-align: center;
    }

    .request-credentials-btn {
      background: linear-gradient(to right, #25d366, #128c7e);
      color: white;
      border: none;
      border-radius: 999px;
      padding: 12px 24px;
      font-size: 0.95rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-top: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      box-shadow: 0 8px 18px rgba(37, 211, 102, 0.4);
      width: 100%;
      text-decoration: none;
      text-align: center;
    }

    .request-credentials-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 22px rgba(37, 211, 102, 0.5);
    }

    .request-credentials-btn img {
      width: 24px;
      height: 24px;
      object-fit: contain;
    }

    /* ===== CLASS SELECTION ===== */
    .class-selection {
      background: var(--surface);
      border-radius: 24px;
      padding: 30px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border-color);
      display: none;
      width: 100%;
    }

    .screen-header {
      text-align: center;
      margin-bottom: 30px;
    }

    .screen-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 8px;
      background: linear-gradient(90deg, var(--accent-blue) 0%, var(--accent-green) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: 0.5px;
    }

    .screen-subtitle {
      font-size: 0.95rem;
      color: var(--text-secondary);
      text-align: center;
      margin-bottom: 20px;
    }

    .class-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 16px;
      margin-top: 20px;
    }

    .class-card {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 120px;
    }

    .class-card:hover {
      transform: translateY(-4px);
      background: var(--hover-bg);
      border-color: var(--accent-blue);
      box-shadow: 0 8px 20px rgba(59, 130, 246, 0.3);
    }

    .class-icon {
      font-size: 2rem;
      margin-bottom: 10px;
    }

    .class-name {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .class-desc {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 5px;
    }

    /* ===== SUBJECT SELECTION ===== */
    .subject-selection {
      background: var(--surface);
      border-radius: 24px;
      padding: 30px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border-color);
      display: none;
      width: 100%;
    }

    .subject-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-top: 20px;
    }

    .subject-card {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 25px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 140px;
    }

    .subject-card:hover {
      transform: translateY(-4px);
      background: var(--hover-bg);
      box-shadow: 0 8px 20px rgba(59, 130, 246, 0.3);
    }

    .subject-icon {
      font-size: 2.5rem;
      margin-bottom: 15px;
    }

    .subject-name {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .subject-desc {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-top: 8px;
    }

    .back-btn {
      background: rgba(75, 85, 99, 0.15);
      color: var(--text-secondary);
      border: 1px solid var(--border-color);
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-top: 20px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .back-btn:hover {
      background: rgba(75, 85, 99, 0.25);
      transform: translateY(-1px);
    }

    /* ===== QUIZ CONTAINER ===== */
    .quiz-container {
      background: var(--surface);
      border-radius: 24px;
      padding: 20px 22px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border-color);
      display: none;
      width: 100%;
    }

    .topic-section {
      margin-bottom: 20px;
      padding: 15px;
      background: var(--card-bg);
      border-radius: 16px;
      border: 1px solid var(--border-color);
    }

    .topic-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      flex-wrap: wrap;
      gap: 10px;
    }

    .current-path {
      font-size: 0.85rem;
      color: var(--accent-blue);
      background: rgba(59, 130, 246, 0.1);
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid rgba(59, 130, 246, 0.2);
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .path-separator {
      color: var(--text-muted);
      margin: 0 4px;
    }

    .path-link {
      color: var(--accent-blue);
      cursor: pointer;
      text-decoration: underline;
      transition: color 0.2s ease;
    }

    .path-link:hover {
      color: #60a5fa;
    }

    .topic-name {
      font-size: 1rem;
      font-weight: 600;
      color: var(--accent-blue);
      background: rgba(59, 130, 246, 0.15);
      padding: 4px 12px;
      border-radius: 8px;
      border: 1px solid rgba(59, 130, 246, 0.3);
    }

    .question-count {
      font-size: 0.9rem;
      color: var(--accent-green);
      background: rgba(34, 197, 94, 0.15);
      padding: 4px 12px;
      border-radius: 8px;
      border: 1px solid rgba(34, 197, 94, 0.3);
    }

    .topic-row {
      display: flex;
      gap: 10px;
      align-items: center;
      width: 100%;
    }

    .topic-select {
      flex: 1;
      min-width: 0;
      background: var(--input-bg);
      color: var(--text-primary);
      border-radius: 40px;
      border: 1px solid var(--input-border);
      padding: 12px 16px;
      font-size: 0.95rem;
      appearance: none;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 16px center;
      background-size: 16px;
    }

    .start-btn {
      border-radius: 40px;
      border: none;
      padding: 12px 24px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(to right, var(--accent-blue), var(--accent-blue-hover));
      color: white;
      white-space: nowrap;
      min-width: 120px;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    }

    .start-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 14px rgba(37, 99, 235, 0.4);
    }

    .start-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* ===== QUESTION NAVIGATION ===== */
    .question-navigation {
      margin: 15px 0;
      padding: 15px;
      background: var(--card-bg);
      border-radius: 16px;
      border: 1px solid var(--border-color);
      overflow: hidden;
      transition: all 0.3s ease;
      display: block;
    }

    .question-navigation.collapsed {
      padding: 12px 15px;
    }

    .question-navigation.expanded {
      max-height: none;
    }

    .navigation-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      flex-wrap: wrap;
      gap: 10px;
    }

    .navigation-title {
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--accent-blue);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .question-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
      gap: 8px;
      max-height: 200px;
      overflow-y: auto;
      padding: 5px;
      transition: all 0.3s ease;
    }

    .question-navigation.collapsed .question-grid,
    .question-navigation.collapsed .navigation-stats {
      display: none;
    }

    .question-number-btn {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      border: 1px solid var(--border-color);
      background: var(--surface-light);
      color: var(--text-primary);
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .question-number-btn:hover {
      background: var(--hover-bg);
      transform: translateY(-2px);
      border-color: var(--accent-blue);
    }

    .question-number-btn.current {
      background: rgba(59, 130, 246, 0.3);
      border-color: var(--accent-blue);
      color: var(--accent-blue);
      font-weight: 600;
      box-shadow: 0 0 10px rgba(59, 130, 246, 0.3);
    }

    .question-number-btn.answered {
      background: rgba(34, 197, 94, 0.2);
      border-color: var(--accent-green);
      color: var(--accent-green);
    }

    .question-number-btn.not-answered {
      background: rgba(239, 68, 68, 0.2);
      border-color: #ef4444;
      color: #fca5a5;
    }

    .navigation-toggle-btn {
      background: rgba(139, 92, 246, 0.15);
      color: #a78bfa;
      border: 1px solid rgba(139, 92, 246, 0.3);
      border-radius: 8px;
      padding: 6px 12px;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .navigation-toggle-btn:hover {
      background: rgba(139, 92, 246, 0.25);
      transform: translateY(-1px);
    }

    .navigation-toggle-btn i {
      font-size: 0.9rem;
      transition: transform 0.3s ease;
    }

    .navigation-toggle-btn.collapsed i {
      transform: rotate(-90deg);
    }

    .navigation-stats {
      display: flex;
      gap: 12px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border-color);
      flex-wrap: wrap;
      transition: all 0.3s ease;
    }

    .stat-badge {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.8rem;
      padding: 4px 8px;
      border-radius: 6px;
    }

    .stat-badge.answered {
      background: rgba(34, 197, 94, 0.15);
      color: #86efac;
    }

    .stat-badge.not-answered {
      background: rgba(239, 68, 68, 0.15);
      color: #fca5a5;
    }

    .stat-badge.current {
      background: rgba(59, 130, 246, 0.15);
      color: var(--accent-blue);
    }

    .toggle-row {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .toggle-row.hidden {
      display: none;
    }

    .toggle-row input {
      transform: scale(1.1);
      cursor: pointer;
      accent-color: var(--accent-blue);
    }

    .toggle-row label {
      cursor: pointer;
    }

    /* ===== QUESTION IMAGE ===== */
    .question-image-container {
      margin: 15px 0;
      display: none;
      text-align: center;
      width: 100%;
      max-width: 100%;
      overflow: hidden;
      border-radius: 12px;
      background: rgba(15, 23, 42, 0.5);
      border: 2px solid rgba(59, 130, 246, 0.2);
      padding: 8px;
      transition: all 0.3s ease;
    }

    .question-image-container.visible {
      display: block;
      animation: fadeIn 0.5s ease-in;
    }

    .question-image {
      display: block;
      margin: 0 auto;
      max-width: 100%;
      max-height: 35vh;
      height: auto;
      object-fit: contain;
      border-radius: 8px;
      transition: all 0.3s ease;
      cursor: zoom-in;
      background: transparent;
    }

    @media (hover: hover) and (pointer: fine) {
      .question-image:hover {
        transform: scale(1.02);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
      }
      
      .question-image.zoomed {
        transform: scale(1.5);
        cursor: zoom-out;
        z-index: 1000;
        position: relative;
      }
    }

    .question-image.touch-zoom {
      transform: scale(1.5);
      cursor: zoom-out;
      position: relative;
      z-index: 1000;
      max-height: 80vh;
    }

    .image-loading {
      padding: 40px 20px;
      text-align: center;
      color: var(--text-muted);
      font-style: italic;
      border-radius: 10px;
      background: linear-gradient(90deg, 
        rgba(30, 41, 59, 0.3) 0%, 
        rgba(30, 41, 59, 0.5) 50%, 
        rgba(30, 41, 59, 0.3) 100%);
      animation: pulse 1.5s infinite;
      border: 2px dashed rgba(59, 130, 246, 0.3);
    }

    .image-error {
      padding: 20px;
      text-align: center;
      color: #fca5a5;
      font-size: 0.9rem;
      border-radius: 10px;
      background: var(--danger-bg);
      border: 1px solid var(--danger-border);
    }

    .option-image {
      max-width: 100%;
      max-height: 120px;
      height: auto;
      border-radius: 6px;
      margin-top: 8px;
      border: 1px solid var(--border-color);
      display: block;
      object-fit: contain;
      transition: transform 0.2s ease;
    }

    .option:hover .option-image {
      transform: scale(1.03);
    }

    /* ===== PROGRESS ===== */
    .progress {
      margin-bottom: 16px;
      font-size: 0.85rem;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .progress.hidden {
      display: none;
    }

    .progress-bar {
      flex: 1;
      height: 6px;
      background: rgba(15, 23, 42, 0.7);
      border-radius: 999px;
      overflow: hidden;
    }

    .progress-bar-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(to right, var(--accent-green), var(--accent-blue));
      transition: width 0.3s ease;
    }

    /* ===== TIMER ===== */
    .timer-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding: 8px 12px;
      background: rgba(59, 130, 246, 0.05);
      border-radius: 12px;
      border: 1px solid rgba(59, 130, 246, 0.2);
    }

    .timer-container.hidden {
      display: none;
    }

    .timer-label {
      font-size: 0.85rem;
      color: var(--accent-blue);
      white-space: nowrap;
      margin-right: 10px;
    }

    .timer-display {
      font-size: 1.1rem;
      font-weight: 700;
      color: #60a5fa;
      font-family: 'Courier New', monospace;
      letter-spacing: 1px;
      white-space: nowrap;
    }

    .timer-warning {
      color: #fbbf24;
      animation: blink 1s infinite;
    }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .timer-critical {
      color: #ef4444;
      animation: pulse 0.5s infinite;
    }

    .timer-notification {
      margin-bottom: 10px;
      padding: 8px 12px;
      background: var(--warning-bg);
      border-radius: 10px;
      border: 1px solid var(--warning-border);
      font-size: 0.85rem;
      color: #fbbf24;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* ===== QUESTION BOX ===== */
    .question-box {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 16px 16px 12px;
      border: 1px solid var(--border-color);
      margin-bottom: 16px;
      min-height: 140px;
      position: relative;
    }

    .question-text {
      font-size: 1rem;
      font-weight: 500;
      color: var(--text-primary);
      line-height: 1.5;
      padding-right: 40px;
    }

    .question-whatsapp-icon {
      position: absolute;
      top: 12px;
      right: 12px;
      width: 28px;
      height: 28px;
      cursor: pointer;
      z-index: 100;
      transition: all 0.2s ease;
      opacity: 0.8;
      background: transparent;
      border: none;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .question-whatsapp-icon:hover {
      opacity: 1;
      transform: scale(1.1);
    }

    .question-whatsapp-icon img {
      width: 28px;
      height: 28px;
      object-fit: contain;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
    }

    .options {
      list-style: none;
      padding: 0;
      margin: 0;
      display: grid;
      gap: 8px;
      margin-top: 12px;
    }

    .option {
      display: flex;
      align-items: stretch;
      min-height: 50px;
      background: var(--option-bg);
      border-radius: 12px;
      border: 1px solid var(--border-color);
      cursor: pointer;
      transition: all 0.15s ease;
      font-size: 0.95rem;
      color: var(--text-primary);
      overflow: hidden;
    }

    .option-label {
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 40px;
      background: rgba(30, 41, 59, 0.8);
      border-right: 1px solid var(--border-color);
      font-weight: 600;
      color: var(--accent-blue);
      padding: 8px;
      flex-shrink: 0;
    }

    .option-content {
      flex: 1;
      padding: 8px 12px;
      display: flex;
      align-items: center;
      min-height: 100%;
    }

    .option:hover:not(.disabled) {
      background: var(--hover-bg);
      transform: translateY(-1px);
    }

    .option.correct {
      background: rgba(34, 197, 94, 0.2);
      border-color: var(--accent-green);
    }

    .option.correct .option-label {
      background: rgba(34, 197, 94, 0.3);
      color: var(--accent-green);
    }

    .option.incorrect {
      background: rgba(239, 68, 68, 0.2);
      border-color: #ef4444;
    }

    .option.incorrect .option-label {
      background: rgba(239, 68, 68, 0.3);
      color: #fca5a5;
    }

    .option.disabled {
      pointer-events: none;
      opacity: 0.9;
    }

    .option.selected {
      border-color: var(--accent-blue);
      background: rgba(59, 130, 246, 0.15);
    }

    .option.selected .option-label {
      background: rgba(59, 130, 246, 0.25);
      color: var(--accent-blue);
    }

    .option.selected.correct {
      background: rgba(34, 197, 94, 0.3);
      border-color: var(--accent-green);
    }

    .option.selected.correct .option-label {
      background: rgba(34, 197, 94, 0.35);
      color: var(--accent-green);
    }

    .option.selected.incorrect {
      background: rgba(239, 68, 68, 0.3);
      border-color: #dc2626;
    }

    .option.selected.incorrect .option-label {
      background: rgba(239, 68, 68, 0.35);
      color: #fca5a5;
    }

    .feedback {
      min-height: 22px;
      font-size: 0.95rem;
      margin-top: 8px;
      padding: 8px 12px;
      border-radius: 8px;
      transition: all 0.3s ease;
    }

    .feedback.correct {
      color: var(--accent-green);
      background: var(--success-bg);
      border: 1px solid var(--success-border);
    }

    .feedback.incorrect {
      color: #ef4444;
      background: var(--danger-bg);
      border: 1px solid var(--danger-border);
    }

    .explanation {
      margin-top: 10px;
      padding: 10px;
      background: rgba(59, 130, 246, 0.1);
      border-radius: 8px;
      border: 1px solid rgba(59, 130, 246, 0.2);
      font-size: 0.9rem;
      color: var(--accent-blue);
      animation: fadeIn 0.3s ease-in;
    }

    .explanation strong {
      color: #60a5fa;
      font-weight: 600;
    }

    /* ===== CONTROLS - FIXED LAYOUT ===== */
    .controls {
      margin-top: 16px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
    }

    .controls.hidden {
      display: none;
    }

    .left-controls {
      display: flex;
      gap: 10px;
      justify-content: flex-start;
      flex: 2;
      min-width: 200px;
    }

    .right-controls {
      display: flex;
      justify-content: flex-end;
      flex: 1;
      min-width: 120px;
    }

    #previous-btn, #next-btn {
      flex: 1;
      border: none;
      border-radius: 40px;
      padding: 12px 16px;
      font-size: 0.95rem;
      font-weight: 500;
      cursor: pointer;
      background: var(--button-secondary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      min-width: 100px;
      transition: all 0.2s ease;
    }

    #previous-btn:hover:enabled, #next-btn:hover:enabled {
      background: var(--button-secondary-hover);
      transform: translateY(-1px);
    }

    #previous-btn:disabled, #next-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    #finish-btn {
      width: 100%;
      border: none;
      border-radius: 40px;
      padding: 12px 16px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(to right, #f59e0b, #d97706);
      color: white;
      box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
      transition: all 0.2s ease;
    }

    #finish-btn:hover:enabled {
      transform: translateY(-2px);
      box-shadow: 0 6px 14px rgba(245, 158, 11, 0.4);
    }

    #finish-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .score-box {
      margin-top: 10px;
      font-size: 0.9rem;
      color: var(--text-primary);
    }

    /* ===== FINAL SCORE ===== */
    .final-score {
      margin-top: 10px;
      padding: 20px;
      border-radius: 16px;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      font-size: 0.95rem;
    }

    .result-header {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--accent-blue);
      margin-bottom: 15px;
      text-align: center;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 10px;
    }

    .result-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      margin-bottom: 15px;
    }

    .stat-item {
      padding: 10px;
      border-radius: 10px;
      background: rgba(2, 6, 23, 0.3);
      border: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
      min-height: 45px;
    }

    body.light-mode .stat-item {
      background: #f8fafc;
    }

    .stat-label {
      font-size: 0.85rem;
      color: var(--text-muted);
      flex-shrink: 0;
      min-width: 90px;
    }

    .stat-value {
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--text-primary);
      text-align: right;
      flex: 1;
      padding-left: 8px;
    }

    .stat-percentage {
      color: var(--accent-green);
    }

    .stat-time {
      color: #f59e0b;
    }

    .result-summary {
      margin-top: 15px;
      padding: 12px;
      border-radius: 10px;
      background: rgba(2, 6, 23, 0.3);
      border: 1px solid var(--border-color);
      text-align: center;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .result-message {
      font-size: 0.95rem;
      color: var(--text-primary);
      margin-top: 10px;
      padding: 12px;
      border-radius: 10px;
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.2);
      text-align: center;
    }

    .restart-btn, .review-btn, .review-incorrect-btn, .pdf-report-btn, .questions-answers-btn {
      width: 100%;
      border-radius: 40px;
      padding: 12px 16px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      margin-top: 8px;
      border: none;
      color: white;
      transition: all 0.2s ease;
    }

    .restart-btn {
      background: linear-gradient(to right, var(--accent-blue), var(--accent-blue-hover));
    }

    .restart-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 18px rgba(37, 99, 235, 0.4);
    }

    .review-btn {
      background: linear-gradient(to right, #8b5cf6, #7c3aed);
    }

    .review-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 18px rgba(139, 92, 246, 0.4);
    }

    .review-incorrect-btn {
      background: linear-gradient(to right, #ef4444, #dc2626);
    }

    .review-incorrect-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 18px rgba(239, 68, 68, 0.4);
    }

    .pdf-report-btn {
      background: linear-gradient(to right, #dc2626, #b91c1c);
    }

    .pdf-report-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 18px rgba(220, 38, 38, 0.4);
    }

    .questions-answers-btn {
      background: linear-gradient(to right, #10b981, #059669);
    }

    .questions-answers-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 18px rgba(16, 185, 129, 0.4);
    }

    /* ===== PRELOAD / PDF OVERLAYS ===== */
    .preload-indicator {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(15, 23, 42, 0.95);
      display: none;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      z-index: 9999;
      transition: opacity 0.3s ease;
    }

    .preload-progress {
      width: 80%;
      max-width: 400px;
      background: rgba(30, 41, 59, 0.7);
      height: 8px;
      border-radius: 4px;
      margin: 20px 0;
      overflow: hidden;
    }

    .preload-progress-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--accent-blue), var(--accent-green));
      transition: width 0.3s ease;
    }

    .preload-status {
      color: var(--text-primary);
      font-size: 1rem;
      margin-top: 20px;
      text-align: center;
    }

    .preload-count {
      color: var(--accent-blue);
      font-weight: bold;
    }

    .pdf-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(15, 23, 42, 0.95);
      display: none;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      z-index: 10000;
      transition: opacity 0.3s ease;
    }

    .pdf-spinner {
      border: 6px solid rgba(59, 130, 246, 0.3);
      border-radius: 50%;
      border-top: 6px solid var(--accent-blue);
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    .pdf-status {
      color: var(--text-primary);
      font-size: 1.2rem;
      margin-bottom: 10px;
    }

    .pdf-substatus {
      color: var(--accent-blue);
      font-size: 0.9rem;
      text-align: center;
      max-width: 400px;
    }

    /* ===== RESPONSIVE DESIGN ===== */
    @media (max-width: 700px) {
      .fixed-header {
        padding: 0 12px;
        height: 70px;
      }
      
      .header-left {
        gap: 8px;
      }
      
      .logo-header {
        width: 48px;
        height: 48px;
      }
      
      .brand-main {
        font-size: 1.3rem;
      }
      
      .brand-sub {
        font-size: 0.7rem;
      }
      
      .user-info {
        display: none !important;
      }
      
      .main-content {
        margin-top: 85px;
        padding: 12px;
        gap: 15px;
      }
      
      .side-menu {
        width: 280px;
        top: 70px;
      }
      
      .menu-overlay {
        top: 70px;
      }
      
      .greeting-message {
        padding: 16px 18px;
        font-size: 1.1rem;
      }
      
      .topic-row {
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
      }
      
      .topic-select, .start-btn {
        width: 100%;
      }
      
      .start-btn {
        min-width: 100%;
      }
      
      .controls {
        flex-direction: column;
        gap: 8px;
      }
      
      .left-controls, .right-controls {
        width: 100%;
        min-width: 100%;
      }
      
      #previous-btn, #next-btn {
        flex: 1;
      }
      
      #finish-btn {
        width: 100%;
      }
      
      .class-grid {
        grid-template-columns: 1fr;
      }
      
      .subject-grid {
        grid-template-columns: 1fr;
      }
      
      .topic-info {
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
      }
      
      .topic-name, .question-count {
        width: 100%;
        text-align: center;
      }
      
      .result-stats {
        grid-template-columns: 1fr;
        gap: 8px;
      }
      
      .stat-item {
        min-height: 40px;
      }
      
      .stat-label {
        min-width: 80px;
      }
      
      .timer-container {
        flex-direction: row;
        gap: 5px;
        padding: 6px 10px;
      }
      
      .timer-label {
        font-size: 0.8rem;
        margin-right: 5px;
      }
      
      .timer-display {
        font-size: 0.95rem;
      }
      
      .question-box {
        padding: 12px;
      }
      
      .question-text {
        font-size: 0.95rem;
        padding-right: 35px;
      }
      
      .option-label {
        min-width: 35px;
        font-size: 0.9rem;
        padding: 6px;
      }
      
      .option-content {
        padding: 6px 10px;
        font-size: 0.9rem;
      }
      
      .question-navigation {
        padding: 12px;
        margin: 8px 0;
      }
      
      .question-navigation.collapsed {
        padding: 10px 12px;
      }
      
      .navigation-header {
        flex-direction: row;
        align-items: center;
      }
      
      .navigation-toggle-btn {
        font-size: 0.75rem;
        padding: 5px 10px;
      }
      
      .final-score {
        padding: 15px;
      }
      
      .result-header {
        font-size: 1.1rem;
      }
      
      .restart-btn, .review-btn, .review-incorrect-btn, .pdf-report-btn, .questions-answers-btn {
        font-size: 0.9rem;
        padding: 10px 14px;
      }
      
      .login-box {
        padding: 20px;
      }
      
      .logo-login {
        width: 70px;
        height: 70px;
      }
      
      .login-title {
        font-size: 1.5rem;
      }
      
      .login-subtitle {
        font-size: 0.9rem;
      }
      
      .login-btn {
        padding: 14px 20px;
        font-size: 1rem;
      }
    }

    @media (max-width: 400px) {
      .brand-main {
        font-size: 1.1rem;
      }
      
      .brand-sub {
        font-size: 0.65rem;
      }
      
      .logo-header {
        width: 40px;
        height: 40px;
      }
      
      .main-content {
        margin-top: 80px;
      }
      
      .greeting-message {
        font-size: 1rem;
        padding: 14px 16px;
      }
      
      .class-card, .subject-card {
        padding: 15px;
        min-height: 100px;
      }
      
      .class-icon {
        font-size: 1.8rem;
      }
      
      .subject-icon {
        font-size: 2.2rem;
      }
      
      .timer-label {
        font-size: 0.75rem;
      }
      
      .timer-display {
        font-size: 0.85rem;
      }
      
      .question-image {
        max-height: 30vh;
      }
      
      .option-label {
        min-width: 30px;
        font-size: 0.85rem;
        padding: 5px;
      }
      
      .option-content {
        padding: 5px 8px;
        font-size: 0.85rem;
      }
      
      .question-navigation {
        padding: 10px;
      }
      
      .navigation-toggle-btn {
        font-size: 0.7rem;
        padding: 4px 8px;
      }
      
      .stat-label {
        font-size: 0.8rem;
        min-width: 70px;
      }
      
      .stat-value {
        font-size: 0.85rem;
      }
    }

    @media (min-width: 701px) and (max-width: 900px) {
      .main-content {
        max-width: 700px;
      }
    }

    /* ===== LIGHT MODE SPECIFIC FIXES ===== */
    body.light-mode .option {
      background: #ffffff;
      border-color: #e2e8f0;
    }

    body.light-mode .option-label {
      background: #f1f5f9;
      color: #2563eb;
      border-right-color: #e2e8f0;
    }

    body.light-mode .question-number-btn {
      background: #ffffff;
      color: #1e293b;
      border-color: #e2e8f0;
    }

    body.light-mode .question-number-btn.current {
      background: #dbeafe;
      color: #1d4ed8;
      border-color: #3b82f6;
    }

    body.light-mode .question-number-btn.answered {
      background: #dcfce7;
      color: #166534;
      border-color: #22c55e;
    }

    body.light-mode .feedback.correct {
      background: #dcfce7;
      color: #166534;
    }

    body.light-mode .feedback.incorrect {
      background: #fee2e2;
      color: #991b1b;
    }

    body.light-mode .timer-display {
      color: #2563eb;
    }

    body.light-mode .login-btn,
    body.light-mode .start-btn,
    body.light-mode .restart-btn,
    body.light-mode .review-btn,
    body.light-mode .review-incorrect-btn,
    body.light-mode .pdf-report-btn,
    body.light-mode .questions-answers-btn {
      color: white;
    }

    body.light-mode .stat-item {
      background: #f8fafc;
    }

    body.light-mode .topic-select {
      background-color: #ffffff;
    }

    body.light-mode .form-input {
      background-color: #ffffff;
    }

    body.light-mode .contact-item span {
      color: #334155;
    }

    body.light-mode .contact-item:hover span {
      color: #2563eb;
    }
  </style>
</head>
<body>
  <!-- Image Preloading Overlay -->
  <div id="preload-overlay" class="preload-indicator">
    <div style="font-size: 1.5rem; color: #60a5fa; margin-bottom: 20px;">Loading Images...</div>
    <div class="preload-progress">
      <div id="preload-progress-fill" class="preload-progress-fill"></div>
    </div>
    <div id="preload-status" class="preload-status">
      Loading images: <span id="preload-count" class="preload-count">0/0</span>
    </div>
    <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 10px; text-align: center;">
      This will make images load instantly during the quiz
    </div>
  </div>
  
  <!-- PDF Generating Overlay -->
  <div id="pdf-overlay" class="pdf-overlay">
    <div class="pdf-spinner"></div>
    <div id="pdf-status" class="pdf-status">Generating PDF Report...</div>
    <div id="pdf-substatus" class="pdf-substatus">Please wait while we create your detailed performance report</div>
  </div>
  
  <!-- Fixed Header - Redesigned -->
  <div class="fixed-header" style="display: none;">
    <div class="header-left">
      <img src="logo.png" alt="Logo" class="logo-header" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2256%22 height=%2256%22 viewBox=%220 0 56 56%22%3E%3Crect width=%2256%22 height=%2256%22 fill=%22%233b82f6%22 rx=%2212%22/%3E%3Ctext x=%2214%22 y=%2238%22 font-size=%2230%22 fill=%22white%22%3EGS%3C/text%3E%3C/svg%3E'">
      <div class="brand-container">
        <span class="brand-main">G.S. Tutorial</span>
        <span class="brand-sub">Interactive Learning App</span>
      </div>
    </div>
    <div class="header-right">
      <div class="user-info" id="header-user-info" style="display: none;">
        <span>ðŸ‘¤</span> <span id="header-username">Guest</span>
      </div>
      <div class="menu-toggle" id="menuToggle">
        <span></span><span></span><span></span>
      </div>
    </div>
  </div>

  <!-- Side Menu -->
  <div class="side-menu" id="sideMenu">
    <div class="side-profile">
      <img src="gobind.png" alt="Gobind Sharma" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22 viewBox=%220 0 100 100%22%3E%3Ccircle cx=%2250%22 cy=%2250%22 r=%2250%22 fill=%22%233b82f6%22/%3E%3Ctext x=%2230%22 y=%2270%22 font-size=%2240%22 fill=%22white%22%3EGS%3C/text%3E%3C/svg%3E'">
      <div class="side-username" id="sideUsername">Guest</div>
    </div>
    
    <div class="side-dev">
      <p>ðŸ‘¨â€ðŸ’» Developer</p>
      
      <div class="contact-item" onclick="window.open('https://wa.me/919706195457', '_blank')">
        <img src="whatsapp.png" alt="WhatsApp" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2224%22 height=%2224%22 viewBox=%220 0 24 24%22%3E%3Cpath fill=%22%2325d366%22 d=%22M19.077 4.928C17.191 3.041 14.683 2 12.006 2c-5.26 0-9.54 4.28-9.54 9.54 0 1.68.44 3.318 1.278 4.758L2.5 21.5l5.342-1.403c1.377.744 2.926 1.137 4.523 1.137h.004c5.258 0 9.535-4.28 9.535-9.54 0-2.548-.99-4.944-2.787-6.766zM12.006 20.05h-.003c-1.415 0-2.802-.38-4.007-1.1l-.287-.17-3.173.834.85-3.1-.185-.3c-.68-1.1-1.04-2.37-1.04-3.67 0-3.95 3.22-7.17 7.18-7.17 1.91 0 3.71.75 5.06 2.11 1.35 1.36 2.1 3.16 2.1 5.08 0 3.96-3.22 7.18-7.18 7.18z%22/%3E%3C/svg%3E'">
        <span>WhatsApp</span>
      </div>
      
      <div class="contact-item" onclick="window.location.href='tel:+919706195457'">
        <img src="phone.png" alt="Call" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2224%22 height=%2224%22 viewBox=%220 0 24 24%22%3E%3Cpath fill=%22%233b82f6%22 d=%22M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z%22/%3E%3C/svg%3E'">
        <span>+91 97061 95457</span>
      </div>
      
      <div class="contact-item" onclick="window.location.href='mailto:gobind.bngn@gmail.com'">
        <img src="email.png" alt="Email" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2224%22 height=%2224%22 viewBox=%220 0 24 24%22%3E%3Cpath fill=%22%23ea4335%22 d=%22M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z%22/%3E%3C/svg%3E'">
        <span>gobind.bngn@gmail.com</span>
      </div>
    </div>

    <div class="theme-toggle" id="themeToggle">
      <span>ðŸŒ™ Dark / Light</span>
      <span id="themeIcon">ðŸŒ™</span>
    </div>

    <div class="logout-side" id="sideLogoutBtn">
      ðŸ”“ Logout
    </div>
  </div>
  <div class="menu-overlay" id="menuOverlay"></div>

  <!-- Main Content Area -->
  <div class="main-content">
    <!-- Login Container -->
    <div id="login-container">
      <div class="login-box">
        <div class="login-header">
          <img src="logo.png" alt="G. S. Tutorial Logo" class="logo-login" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2280%22 height=%2280%22 viewBox=%220 0 80 80%22%3E%3Crect width=%2280%22 height=%2280%22 fill=%22%233b82f6%22 rx=%2216%22/%3E%3Ctext x=%2220%22 y=%2252%22 font-size=%2240%22 fill=%22white%22%3EGS%3C/text%3E%3C/svg%3E'">
          <div class="login-title">G.S. Tutorial</div>
          <div class="login-subtitle">Interactive Learning Â· Created by Gobind Sharma</div>
        </div>
        
        <form id="login-form" class="login-form">
          <div class="form-group">
            <label for="username">Username</label>
            <input type="text" id="username" class="form-input" placeholder="Enter your username" required autocomplete="username">
          </div>
          
          <div class="form-group">
            <label for="password">Password</label>
            <div class="password-input-wrapper">
              <input type="password" id="password" class="form-input" placeholder="Enter your password" required autocomplete="current-password">
              <button type="button" class="password-toggle" id="password-toggle" aria-label="Show password">ðŸ‘ï¸</button>
            </div>
            <div id="attempt-counter" class="attempt-counter" style="display: none;">
              Attempts remaining: <span id="attempts-remaining">3</span>
            </div>
            <div id="cooldown-message" class="cooldown-message" style="display: none;">
              Too many failed attempts. Please wait <span id="cooldown-timer">30</span> seconds.
            </div>
          </div>
          
          <div id="login-error" class="login-error"></div>
          
          <button type="submit" class="login-btn" id="login-btn">Login</button>
          
          <a href="https://wa.me/919706195457?text=Hello%20Admin,%20I%20need%20login%20credentials%20for%20G.S.%20Tutorial%20App.%20Please%20create%20username%20and%20password%20for%20me." 
             class="request-credentials-btn" target="_blank">
            <img src="whatsapp.png" alt="WhatsApp" style="width: 24px; height: 24px;" onerror="this.style.display='none'">
            Request Login Credentials
          </a>
        </form>
        
        <div class="config-info">
          Â© 2025 G.S. Tutorial. All rights reserved.
        </div>
      </div>
    </div>
    
    <!-- Account Configuration Error Screen -->
    <div class="account-config-error" id="account-config-error">
      <div class="error-header">
        <div class="error-title">Account Configuration Required</div>
        <div class="error-subtitle">G.S. Tutorial â€“ Interactive Learning</div>
      </div>
      
      <div class="error-user-info">
        Hello <strong id="error-username">User</strong>!<br>
        Your account (Role: <strong id="error-role">User</strong>) requires proper configuration.
      </div>
      
      <div class="error-details">
        <ul id="error-list">
          <li>There seems to be an issue with your account configuration.</li>
          <li>Please contact the administrator to resolve this issue.</li>
        </ul>
      </div>
      
      <a href="https://wa.me/919706195457?text=Hello%20Admin,%20I%20need%20help%20with%20my%20account%20configuration%20for%20G.S.%20Tutorial.%20Username:%20" 
         class="whatsapp-btn" id="whatsapp-btn" target="_blank">
        <img src="whatsapp.png" alt="WhatsApp" style="width: 24px; height: 24px;" onerror="this.style.display='none'">
        Contact Admin on WhatsApp
      </a>
      
      <button class="back-to-login-btn" id="back-to-login-btn">â† Back to Login</button>
    </div>
    
    <!-- Subscription Expired Screen -->
    <div class="subscription-expired" id="subscription-expired">
      <div class="expired-header">
        <div class="expired-title">Subscription Expired</div>
        <div class="expired-subtitle">G.S. Tutorial â€“ Interactive Learning</div>
      </div>
      
      <div class="expired-user-info">
        Hello <strong id="expired-username">User</strong>!<br>
        Your account access has expired.
      </div>
      
      <div class="expired-details">
        <p><strong>Joining Date:</strong> <span id="expired-joining-date">Not available</span></p>
        <p><strong>Expiry Date:</strong> <span id="expired-last-date">Not available</span></p>
        <p>Your trial period or subscription has ended. To continue using G.S. Tutorial, please contact the administrator to extend your access.</p>
      </div>
      
      <a href="https://wa.me/919706195457?text=Hello%20Admin,%20my%20G.S.%20Tutorial%20subscription%20has%20expired.%20Username:%20" 
         class="whatsapp-btn" id="expired-whatsapp-btn" target="_blank">
        <img src="whatsapp.png" alt="WhatsApp" style="width: 24px; height: 24px;" onerror="this.style.display='none'">
        Contact Admin
      </a>
      
      <button class="back-to-login-btn" id="back-to-login-from-expired-btn">â† Back to Login</button>
    </div>
    
    <!-- Class Selection Screen - WITH GREETING -->
    <div class="class-selection" id="class-selection">
      <div class="greeting-message" id="greetingMessage"></div>
      <div class="class-title">SELECT YOUR CLASS</div>
      <div class="class-grid" id="class-grid"></div>
    </div>
    
    <!-- Subject Selection Screen -->
    <div class="subject-selection" id="subject-selection">
      <div class="screen-header">
        <div class="screen-title">Select Subject</div>
        <div class="screen-subtitle" id="current-class-display">Class</div>
      </div>
      <div class="subject-grid" id="subject-grid"></div>
      <button class="back-btn" id="back-to-classes-btn">â† Back to Classes</button>
    </div>
    
    <!-- Quiz Container -->
    <div class="quiz-container" id="quiz-container">
      <!-- Path Display -->
      <div id="current-path" class="current-path" style="display: none;"></div>
      
      <!-- TOPIC SELECTION SECTION -->
      <div class="topic-section">
        <div class="topic-info">
          <div class="topic-name" id="quiz-topic-name">No chapter selected</div>
          <div class="question-count" id="quiz-question-count">0 questions</div>
        </div>
        
        <div class="topic-row">
          <select id="topic-select" class="topic-select"><option value="">Loading chapters...</option></select>
          <button class="start-btn" id="start-btn" disabled>Start</button>
        </div>
      </div>

      <!-- QUESTION NAVIGATION SECTION -->
      <div id="question-navigation" class="question-navigation collapsed">
        <div class="navigation-header">
          <div class="navigation-title">ðŸ“‹ Question Navigation</div>
          <button id="navigation-toggle-btn" class="navigation-toggle-btn collapsed"><i>â–¶</i> Show</button>
        </div>
        <div id="question-grid" class="question-grid"></div>
        <div id="navigation-stats" class="navigation-stats"></div>
      </div>

      <!-- Timer Container -->
      <div id="timer-container" class="timer-container" style="display: none;">
        <div class="timer-label">â±ï¸ Time Remaining:</div>
        <div id="timer-display" class="timer-display">--:--:--</div>
      </div>

      <!-- RANDOMIZE TOGGLE -->
      <div class="toggle-row">
        <input type="checkbox" id="random-toggle" checked />
        <label for="random-toggle">Randomize questions & options</label>
      </div>

      <div class="progress">
        <div id="question-counter">Choose a chapter and click Start</div>
        <div class="progress-bar"><div id="progress-bar-fill" class="progress-bar-fill"></div></div>
        <div id="score-mini">Score: 0</div>
      </div>

      <div class="question-box" id="question-box">
        <!-- WhatsApp Icon Button -->
        <button id="question-whatsapp-icon" class="question-whatsapp-icon" style="display: none;" title="Report issue or ask about this question">
          <img src="whatsapp.png" alt="WhatsApp Support">
        </button>
        
        <div id="question-text" class="question-text">Please select a chapter to start.</div>
        
        <!-- QUESTION IMAGE CONTAINER -->
        <div id="question-image-container" class="question-image-container">
          <img id="question-image" class="question-image" src="" alt="Question Image" onclick="toggleImageZoom(this)">
          <div id="image-loading" class="image-loading" style="display: none;">Loading image...</div>
          <div id="image-error" class="image-error" style="display: none;">Image not available</div>
        </div>
        
        <ul id="options-list" class="options"></ul>
        <div id="feedback" class="feedback"></div>
      </div>

      <!-- BUTTON LAYOUT - FIXED -->
      <div class="controls">
        <div class="left-controls">
          <button id="previous-btn" disabled>â† Previous</button>
          <button id="next-btn" disabled>Next â†’</button>
        </div>
        <div class="right-controls">
          <button id="finish-btn" disabled>Submit</button>
        </div>
      </div>

      <div class="score-box">
        <div id="final-score" class="final-score" style="display:none;"></div>
      </div>
    </div>
  </div>

  <script>
    // ========== APPS SCRIPT CONFIGURATION ==========
    const AUTH_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx06h9aa6wDmtDz3jBwNgOuoiz7-NZY1nJaEwts3A7vIHRkWfAU5O3N4UNUooCwvEm7Lw/exec';
    const MASTER_CONFIG_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw2CCk6wZgSWwLVyi4-6izf0DNIvcG-E64_jfsT0TgclHZ_PIevnAEdLq6B2Ccc6ABK/exec';

    // ========== CACHE CONFIGURATION ==========
    let ALL_CONFIG_CACHE = null;
    let ALL_CONFIG_CACHE_TIME = null;
    const CACHE_DURATION = 30 * 60 * 1000;

    // ========== GLOBAL VARIABLES ==========
    let questions = [];
    let currentIndex = 0;
    let score = 0;
    let hasAnswered = false;
    let questionsLoaded = false;
    let attempted = 0;
    let userAnswers = [];
    let timeRemaining = 0;
    let timerInterval = null;
    let currentTopicName = "";
    let timerDuration = 0;
    let quizStartTime = null;
    let timerNotification = null;
    let isReviewMode = false;
    let isIncorrectReviewMode = false;
    let incorrectQuestionIndices = [];
    
    // Image preloading
    let imageCache = new Map();
    let totalImagesToPreload = 0;
    let imagesPreloaded = 0;
    
    // Login system
    let currentUser = null;
    let inactivityTimer = null;
    const INACTIVITY_TIMEOUT = 10 * 60 * 1000;
    
    // Login attempt tracking
    let failedAttempts = 0;
    const MAX_ATTEMPTS = 3;
    const COOLDOWN_TIME = 30;
    let isOnCooldown = false;
    let cooldownTimer = null;
    
    // Navigation
    let currentClass = "";
    let currentSubject = "";
    let chaptersList = [];
    let currentSubjectConfig = null;
    
    // Logging
    let userIP = 'Unknown';
    
    // Notification tracking
    let hasSentLoginNotification = false;
    let hasSentQuizResultNotification = false;

    // Telegram config
    let TELEGRAM_CONFIG = { ENABLED: false, BOT_TOKEN: '', CHAT_ID: '' };
    let ADMIN_CONFIG = { NOTIFY_ON_LOGIN: false, NOTIFY_ON_QUIZ_RESULT: false };

    // ========== DOM ELEMENTS ==========
    const fixedHeaderEl = document.querySelector(".fixed-header");
    const headerUserInfoEl = document.getElementById("header-user-info");
    const headerUsernameEl = document.getElementById("header-username");
    
    const loginContainerEl = document.getElementById("login-container");
    const classSelectionEl = document.getElementById("class-selection");
    const subjectSelectionEl = document.getElementById("subject-selection");
    const quizContainerEl = document.getElementById("quiz-container");
    const accountConfigErrorEl = document.getElementById("account-config-error");
    const subscriptionExpiredEl = document.getElementById("subscription-expired");
    
    const loginFormEl = document.getElementById("login-form");
    const usernameEl = document.getElementById("username");
    const passwordEl = document.getElementById("password");
    const passwordToggleEl = document.getElementById("password-toggle");
    const loginErrorEl = document.getElementById("login-error");
    const loginBtnEl = document.getElementById("login-btn");
    const attemptCounterEl = document.getElementById("attempt-counter");
    const attemptsRemainingEl = document.getElementById("attempts-remaining");
    const cooldownMessageEl = document.getElementById("cooldown-message");
    const cooldownTimerEl = document.getElementById("cooldown-timer");
    
    const accountConfigErrorUsernameEl = document.getElementById("error-username");
    const accountConfigErrorRoleEl = document.getElementById("error-role");
    const accountConfigErrorListEl = document.getElementById("error-list");
    const whatsappBtnEl = document.getElementById("whatsapp-btn");
    const backToLoginBtnEl = document.getElementById("back-to-login-btn");
    
    const expiredUsernameEl = document.getElementById("expired-username");
    const expiredJoiningDateEl = document.getElementById("expired-joining-date");
    const expiredLastDateEl = document.getElementById("expired-last-date");
    const expiredWhatsappBtnEl = document.getElementById("expired-whatsapp-btn");
    const backToLoginFromExpiredBtn = document.getElementById("back-to-login-from-expired-btn");
    
    const classGridEl = document.getElementById("class-grid");
    const subjectGridEl = document.getElementById("subject-grid");
    const currentClassDisplayEl = document.getElementById("current-class-display");
    const backToClassesBtn = document.getElementById("back-to-classes-btn");
    const currentPathEl = document.getElementById("current-path");
    
    const topicSelectEl = document.getElementById("topic-select");
    const startBtnEl = document.getElementById("start-btn");
    const randomToggleEl = document.getElementById("random-toggle");
    const toggleRowEl = document.querySelector(".toggle-row");
    const quizTopicNameEl = document.getElementById("quiz-topic-name");
    const quizQuestionCountEl = document.getElementById("quiz-question-count");
    const timerContainerEl = document.getElementById("timer-container");
    const timerDisplayEl = document.getElementById("timer-display");
    
    const questionNavigationEl = document.getElementById("question-navigation");
    const questionGridEl = document.getElementById("question-grid");
    const navigationToggleBtn = document.getElementById("navigation-toggle-btn");
    const navigationStatsEl = document.getElementById("navigation-stats");
    
    const questionTextEl = document.getElementById("question-text");
    const questionBoxEl = document.getElementById("question-box");
    const questionImageContainerEl = document.getElementById("question-image-container");
    const questionImageEl = document.getElementById("question-image");
    const imageLoadingEl = document.getElementById("image-loading");
    const imageErrorEl = document.getElementById("image-error");
    
    const optionsListEl = document.getElementById("options-list");
    const feedbackEl = document.getElementById("feedback");
    const nextBtn = document.getElementById("next-btn");
    const previousBtn = document.getElementById("previous-btn");
    const finishBtn = document.getElementById("finish-btn");
    const questionCounterEl = document.getElementById("question-counter");
    const progressEl = document.querySelector(".progress");
    const progressBarFillEl = document.getElementById("progress-bar-fill");
    const scoreMiniEl = document.getElementById("score-mini");
    const finalScoreEl = document.getElementById("final-score");
    const controlsEl = document.querySelector(".controls");
    
    const preloadOverlayEl = document.getElementById("preload-overlay");
    const preloadProgressFillEl = document.getElementById("preload-progress-fill");
    const preloadStatusEl = document.getElementById("preload-status");
    const preloadCountEl = document.getElementById("preload-count");
    
    const pdfOverlayEl = document.getElementById("pdf-overlay");
    const pdfStatusEl = document.getElementById("pdf-status");
    const pdfSubstatusEl = document.getElementById("pdf-substatus");

    const questionWhatsappIconEl = document.getElementById("question-whatsapp-icon");

    // Side menu elements
    const menuToggle = document.getElementById('menuToggle');
    const sideMenu = document.getElementById('sideMenu');
    const menuOverlay = document.getElementById('menuOverlay');
    const sideUsername = document.getElementById('sideUsername');
    const sideLogoutBtn = document.getElementById('sideLogoutBtn');
    const themeToggle = document.getElementById('themeToggle');
    const themeIcon = document.getElementById('themeIcon');
    const metaThemeColor = document.getElementById('meta-theme-color');
    const greetingMessageEl = document.getElementById('greetingMessage');

    // ========== PASSWORD TOGGLE ==========
    function togglePasswordVisibility() {
      passwordEl.type = passwordEl.type === 'password' ? 'text' : 'password';
      passwordToggleEl.textContent = passwordEl.type === 'password' ? 'ðŸ‘ï¸' : 'ðŸ™ˆ';
    }
    passwordToggleEl.addEventListener("click", togglePasswordVisibility);

    // ========== HELPER FUNCTIONS ==========
    function formatDisplayDate(val) {
      if (!val) return "Not available";
      try {
        let d = new Date(val);
        if (isNaN(d.getTime())) return "Not available";
        return d.toLocaleDateString("en-GB", { day: "numeric", month: "short", year: "numeric" });
      } catch { return "Not available"; }
    }

    function getSubjectIcon(subject) {
      const s = subject.toLowerCase();
      if (s.includes('math')) return 'ðŸ“';
      if (s.includes('science')) return 'ðŸ”¬';
      if (s.includes('physics')) return 'âš¡';
      if (s.includes('chem')) return 'ðŸ§ª';
      if (s.includes('bio')) return 'ðŸ§¬';
      if (s.includes('mech')) return 'âš™ï¸';
      if (s.includes('elect')) return 'âš¡';
      if (s.includes('english')) return 'ðŸ“–';
      if (s.includes('social')) return 'ðŸŒ';
      return 'ðŸ“š';
    }

    function getSubjectDescription(subject) {
      const s = subject.toLowerCase();
      if (s.includes('math')) return 'Mathematics';
      if (s.includes('science')) return 'Science';
      if (s.includes('physics')) return 'Physics';
      if (s.includes('chem')) return 'Chemistry';
      if (s.includes('bio')) return 'Biology';
      if (s.includes('mech')) return 'Mechanical';
      if (s.includes('elect')) return 'Electrical';
      if (s.includes('english')) return 'English';
      if (s.includes('social')) return 'Social Studies';
      return 'Interactive Learning';
    }

    // ========== JSONP REQUEST ==========
    function jsonpRequest(url, callbackName) {
      return new Promise((resolve, reject) => {
        const uniqueCallback = callbackName + '_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        const script = document.createElement('script');
        
        window[uniqueCallback] = function(data) {
          delete window[uniqueCallback];
          document.body.removeChild(script);
          data && data.success ? resolve(data) : reject(data?.error || 'Unknown error');
        };
        
        script.onerror = () => {
          delete window[uniqueCallback];
          document.body.removeChild(script);
          reject('Network error');
        };
        
        const separator = url.includes('?') ? '&' : '?';
        script.src = `${url}${separator}callback=${uniqueCallback}`;
        document.body.appendChild(script);
        
        setTimeout(() => {
          if (window[uniqueCallback]) {
            delete window[uniqueCallback];
            document.body.removeChild(script);
            reject('Request timeout');
          }
        }, 10000);
      });
    }

    // ========== LOAD CONFIG ==========
    async function loadAllConfigAtOnce() {
      if (ALL_CONFIG_CACHE && ALL_CONFIG_CACHE_TIME && Date.now() - ALL_CONFIG_CACHE_TIME < CACHE_DURATION) {
        return ALL_CONFIG_CACHE;
      }
      try {
        const data = await jsonpRequest(MASTER_CONFIG_APPS_SCRIPT_URL + '?action=getAllConfig', 'allConfigCallback');
        if (data.success) {
          ALL_CONFIG_CACHE = data;
          ALL_CONFIG_CACHE_TIME = Date.now();
          return data;
        }
        throw new Error(data.error || 'Failed to load config');
      } catch (error) {
        console.error("Config error:", error);
        return null;
      }
    }

    // ========== AUTHENTICATION ==========
    async function authenticateWithAppsScript(username, password) {
      try {
        return new Promise((resolve) => {
          const callbackName = 'auth_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
          const script = document.createElement('script');
          
          window[callbackName] = function(data) {
            delete window[callbackName];
            document.body.removeChild(script);
            resolve(data || { success: false, error: 'Invalid response' });
          };
          
          script.onerror = () => {
            delete window[callbackName];
            document.body.removeChild(script);
            resolve({ success: false, error: 'Network error' });
          };
          
          const url = `${AUTH_APPS_SCRIPT_URL}?action=authenticate&username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}&callback=${callbackName}`;
          script.src = url;
          document.body.appendChild(script);
          
          setTimeout(() => {
            if (window[callbackName]) {
              delete window[callbackName];
              document.body.removeChild(script);
              resolve({ success: false, error: 'Timeout' });
            }
          }, 10000);
        });
      } catch (error) {
        return { success: false, error: 'Connection failed' };
      }
    }

    // ========== LOAD TELEGRAM CONFIG ==========
    async function loadTelegramConfig() {
      try {
        const data = await jsonpRequest(MASTER_CONFIG_APPS_SCRIPT_URL + '?action=getTelegramConfig', 'telegramCallback');
        if (data.success) {
          TELEGRAM_CONFIG = { ENABLED: data.enabled, BOT_TOKEN: data.botToken, CHAT_ID: data.chatId };
        }
      } catch (error) {
        console.error("Telegram config error:", error);
      }
    }

    // ========== GET USER IP ==========
    async function getUserIP() {
      try {
        const response = await fetch('https://api.ipify.org?format=json');
        const data = await response.json();
        userIP = data.ip;
      } catch (error) {}
    }

    // ========== SESSION MANAGEMENT ==========
    function saveSession() {
      if (currentUser) {
        localStorage.setItem('gs_session', JSON.stringify({
          user: currentUser,
          timestamp: Date.now(),
          lastActivity: Date.now()
        }));
      }
    }

    function loadSession() {
      const data = localStorage.getItem('gs_session');
      if (data) {
        try {
          const session = JSON.parse(data);
          if (Date.now() - session.lastActivity < INACTIVITY_TIMEOUT && Date.now() - session.timestamp < 86400000) {
            currentUser = session.user;
            session.lastActivity = Date.now();
            localStorage.setItem('gs_session', JSON.stringify(session));
            return true;
          }
        } catch (e) {}
      }
      clearSession();
      return false;
    }

    function clearSession() { localStorage.removeItem('gs_session'); }
    
    function updateLastActivity() {
      const data = localStorage.getItem('gs_session');
      if (data && currentUser) {
        try {
          const session = JSON.parse(data);
          session.lastActivity = Date.now();
          localStorage.setItem('gs_session', JSON.stringify(session));
        } catch (e) {}
      }
    }

    // ========== LOGIN ATTEMPT TRACKING ==========
    function resetFailedAttempts() {
      failedAttempts = 0;
      isOnCooldown = false;
      attemptCounterEl.style.display = 'none';
      cooldownMessageEl.style.display = 'none';
      if (cooldownTimer) { clearInterval(cooldownTimer); cooldownTimer = null; }
    }

    function updateAttemptCounter() {
      const remaining = MAX_ATTEMPTS - failedAttempts;
      attemptsRemainingEl.textContent = remaining;
      if (failedAttempts > 0) {
        attemptCounterEl.style.display = 'flex';
        attemptCounterEl.className = remaining <= 1 ? 'attempt-counter critical' : remaining <= 2 ? 'attempt-counter warning' : 'attempt-counter';
      } else {
        attemptCounterEl.style.display = 'none';
      }
    }

    function startCooldown() {
      isOnCooldown = true;
      loginBtnEl.disabled = true;
      cooldownMessageEl.style.display = 'block';
      attemptCounterEl.style.display = 'none';
      let seconds = COOLDOWN_TIME;
      cooldownTimerEl.textContent = seconds;
      cooldownTimer = setInterval(() => {
        seconds--;
        cooldownTimerEl.textContent = seconds;
        if (seconds <= 0) {
          clearInterval(cooldownTimer);
          isOnCooldown = false;
          loginBtnEl.disabled = false;
          cooldownMessageEl.style.display = 'none';
          resetFailedAttempts();
          usernameEl.focus();
        }
      }, 1000);
    }

    function recordFailedAttempt() {
      failedAttempts++;
      updateAttemptCounter();
      if (failedAttempts >= MAX_ATTEMPTS) startCooldown();
    }

    // ========== USER VALIDATION ==========
    function validateUserAccount(user) {
      const validRoles = ['Admin', 'Teacher', 'User', 'Student'];
      if (!validRoles.includes(user.role)) return { valid: false, error: 'invalid_role' };
      
      const assignedClasses = (user.class || '').split(',').map(c => c.trim()).filter(c => c && !['none','null'].includes(c.toLowerCase()));
      
      if (user.role === 'Admin') return { valid: true, assignedClasses: [] };
      if (['Teacher','User'].includes(user.role)) {
        if (assignedClasses.length === 0) return { valid: false, error: 'no_class_assigned' };
        return { valid: true, assignedClasses };
      }
      if (user.role === 'Student') {
        if (assignedClasses.length === 0) return { valid: false, error: 'no_class_assigned' };
        return { valid: true, assignedClasses: [assignedClasses[0]] };
      }
      return { valid: false, error: 'unknown' };
    }

    // ========== SUBSCRIPTION EXPIRED ==========
    function showSubscriptionExpired(user, joiningDate, lastDate) {
      expiredUsernameEl.textContent = user.name;
      expiredJoiningDateEl.textContent = formatDisplayDate(joiningDate);
      expiredLastDateEl.textContent = formatDisplayDate(lastDate);
      const msg = `Hello Admin, my G.S. Tutorial subscription has expired. Username: ${user.username}`;
      expiredWhatsappBtnEl.href = `https://wa.me/919706195457?text=${encodeURIComponent(msg)}`;
      fixedHeaderEl.style.display = "none";
      loginContainerEl.style.display = "none";
      classSelectionEl.style.display = "none";
      subjectSelectionEl.style.display = "none";
      quizContainerEl.style.display = "none";
      accountConfigErrorEl.style.display = "none";
      subscriptionExpiredEl.style.display = "block";
      resetInactivityTimer();
    }

    // ========== ACCOUNT CONFIG ERROR ==========
    function showAccountConfigError(user, errorType) {
      accountConfigErrorUsernameEl.textContent = user.name;
      accountConfigErrorRoleEl.textContent = user.role;
      const msg = `Hello Admin, I need help with my account configuration. Username: ${user.username}`;
      whatsappBtnEl.href = `https://wa.me/919706195457?text=${encodeURIComponent(msg)}`;
      
      let errorHTML = '';
      if (errorType === 'invalid_role') {
        errorHTML = `<li><strong>Invalid Role:</strong> "${user.role}" is not recognized. Valid: Admin, Teacher, User, Student.</li>`;
      } else if (errorType === 'no_class_assigned') {
        errorHTML = `<li><strong>No Class Assigned:</strong> As a ${user.role}, you need a class assignment.</li>`;
      } else {
        errorHTML = `<li>Account configuration issue. Please contact admin.</li>`;
      }
      accountConfigErrorListEl.innerHTML = errorHTML;
      
      fixedHeaderEl.style.display = "none";
      loginContainerEl.style.display = "none";
      classSelectionEl.style.display = "none";
      subjectSelectionEl.style.display = "none";
      quizContainerEl.style.display = "none";
      subscriptionExpiredEl.style.display = "none";
      accountConfigErrorEl.style.display = "block";
      resetInactivityTimer();
    }

    // ========== WHATSAPP SUPPORT ==========
    function setupQuestionWhatsAppSupport() {
      questionWhatsappIconEl?.addEventListener("click", function() {
        if (!currentUser || !questionsLoaded || !questions[currentIndex]) return;
        
        const q = questions[currentIndex];
        let optionsText = q.options.map((opt, i) => 
          `${String.fromCharCode(65+i)}. ${opt}${i === q.correctIndex ? ' âœ…' : ''}`
        ).join('\n');
        
        const message = `Hello Admin,\n\nQuestion concern:\n\nðŸ‘¤ ${currentUser.name} (${currentUser.username})\nðŸ« ${currentClass}\nðŸ“š ${currentSubject}\nðŸ“– ${currentTopicName}\n\nâ“ ${q.question}\n\nðŸ“ Options:\n${optionsText}\n\nðŸ“‹ Concern: `;
        window.open(`https://wa.me/919706195457?text=${encodeURIComponent(message)}`, '_blank');
        resetInactivityTimer();
      });
    }

    // ========== PDF FUNCTIONS ==========
    function showPDFOverlay(msg = "Generating PDF...") { pdfStatusEl.textContent = msg; pdfOverlayEl.style.display = 'flex'; }
    function hidePDFOverlay() { pdfOverlayEl.style.display = 'none'; }
    function getPerformanceRemark(p) { return p >= 80 ? "Excellent!" : p >= 60 ? "Good job!" : p >= 40 ? "Satisfactory" : "Needs improvement"; }

    // ========== TELEGRAM NOTIFICATIONS ==========
    async function sendLoginNotification(user) {
      if (hasSentLoginNotification || !TELEGRAM_CONFIG.ENABLED) return;
      const now = new Date();
      const msg = `ðŸ”´ Login: ${user.name} (${user.username})\nRole: ${user.role}\nTime: ${now.toLocaleString('en-IN')}\nIP: ${userIP}`;
      const sent = await sendTelegramMessage(msg);
      if (sent) hasSentLoginNotification = true;
    }

    async function sendQuizResultNotification(stats) {
      if (hasSentQuizResultNotification || !TELEGRAM_CONFIG.ENABLED) return;
      const msg = `ðŸŸ  Result: ${currentUser.name}\nClass: ${currentClass}\nSubject: ${currentSubject}\nChapter: ${currentTopicName}\nScore: ${stats.correct}/${stats.total} (${stats.percentage}%)\nTime: ${stats.timeTaken || 'N/A'}`;
      const sent = await sendTelegramMessage(msg);
      if (sent) hasSentQuizResultNotification = true;
    }

    async function sendTelegramMessage(message) {
      if (!TELEGRAM_CONFIG.ENABLED || !TELEGRAM_CONFIG.BOT_TOKEN || !TELEGRAM_CONFIG.CHAT_ID) return false;
      try {
        const res = await fetch(`https://api.telegram.org/bot${TELEGRAM_CONFIG.BOT_TOKEN}/sendMessage`, {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ chat_id: TELEGRAM_CONFIG.CHAT_ID, text: message })
        });
        return res.ok;
      } catch { return false; }
    }

    // ========== IMAGE HANDLING ==========
    function convertImageUrl(url) {
      if (!url || url.startsWith('http')) return url;
      let path = url.trim();
      if (!path.startsWith('images/')) {
        if (/^[a-zA-Z0-9]+\.[a-z]{3,4}$/i.test(path)) path = `images/class${currentClass}/${path}`;
        else if (path.includes('/')) path = `images/${path}`;
      }
      return path;
    }

    function loadImageWithCache(url) {
      return new Promise((resolve, reject) => {
        if (imageCache.has(url)) { resolve(imageCache.get(url)); return; }
        const img = new Image();
        img.onload = () => { imageCache.set(url, img); resolve(img); };
        img.onerror = () => reject();
        img.src = url;
      });
    }

    async function preloadChapterImages(questions) {
      if (!questions?.length) return;
      const urls = new Set();
      questions.forEach(q => {
        if (q.imageUrl?.trim()) urls.add(convertImageUrl(q.imageUrl));
        q.optionImages?.forEach(img => { if (img?.trim()) urls.add(convertImageUrl(img)); });
      });
      
      totalImagesToPreload = urls.size;
      if (totalImagesToPreload === 0) return;
      
      imagesPreloaded = 0;
      preloadOverlayEl.style.display = 'flex';
      
      for (const url of urls) {
        loadImageWithCache(url).finally(() => {
          imagesPreloaded++;
          const percent = (imagesPreloaded / totalImagesToPreload) * 100;
          preloadProgressFillEl.style.width = `${percent}%`;
          preloadCountEl.textContent = `${imagesPreloaded}/${totalImagesToPreload}`;
          if (imagesPreloaded >= totalImagesToPreload) setTimeout(() => preloadOverlayEl.style.display = 'none', 500);
        });
      }
    }

    function toggleImageZoom(img) {
      img.classList.toggle(window.innerWidth > 768 ? 'zoomed' : 'touch-zoom');
    }

    // ========== LOAD CLASSES ==========
    async function loadClasses() {
      classGridEl.innerHTML = '<div class="loading-container"><div class="loading-spinner"></div><div class="loading-text">Loading classes...</div></div>';
      try {
        const data = await loadAllConfigAtOnce();
        if (!data?.classes) throw new Error("No classes");
        
        let classes = data.classes;
        if (currentUser?.role !== 'Admin') {
          const assigned = currentUser?.validatedAssignedClasses || [];
          classes = classes.filter(c => assigned.some(a => a.toString() === c.id.toString()));
        }
        
        renderClassGrid(classes);
      } catch (error) {
        classGridEl.innerHTML = '<div style="text-align:center; padding:40px; color:#fca5a5;">Error loading classes</div>';
      }
    }

    function renderClassGrid(classes) {
      classGridEl.innerHTML = '';
      if (!classes.length) {
        classGridEl.innerHTML = '<div style="text-align:center; padding:40px; color:var(--text-muted);">No classes available</div>';
        return;
      }
      
      classes.forEach(cls => {
        const card = document.createElement('div');
        card.className = 'class-card';
        card.innerHTML = `<div class="class-icon">${cls.icon || 'ðŸ“š'}</div><div class="class-name">${cls.name}</div>`;
        card.onclick = () => { showSubjectSelection(cls.id); resetInactivityTimer(); };
        classGridEl.appendChild(card);
      });
    }

    // ========== LOAD SUBJECTS ==========
    async function loadSubjects() {
      subjectGridEl.innerHTML = '<div class="loading-container"><div class="loading-spinner"></div><div class="loading-text">Loading subjects...</div></div>';
      try {
        const data = await loadAllConfigAtOnce();
        const subjects = [];
        if (data?.config) {
          const set = new Set();
          for (const key in data.config) {
            if (key.startsWith(currentClass + '_')) set.add(key.split('_')[1]);
          }
          set.forEach(s => subjects.push({
            id: s, name: s.charAt(0).toUpperCase() + s.slice(1),
            icon: getSubjectIcon(s), desc: getSubjectDescription(s)
          }));
        }
        renderSubjectGrid(subjects);
      } catch (error) {
        subjectGridEl.innerHTML = '<div style="text-align:center; color:#fca5a5;">Error</div>';
      }
    }

    function renderSubjectGrid(subjects) {
      subjectGridEl.innerHTML = '';
      if (!subjects.length) {
        subjectGridEl.innerHTML = '<div style="text-align:center; color:var(--text-muted);">No subjects</div>';
        return;
      }
      
      subjects.forEach(sub => {
        const card = document.createElement('div');
        card.className = 'subject-card';
        card.innerHTML = `<div class="subject-icon">${sub.icon}</div><div class="subject-name">${sub.name}</div>`;
        card.onclick = () => { currentSubject = sub.name; showQuizContainer(); resetInactivityTimer(); };
        subjectGridEl.appendChild(card);
      });
    }

    // ========== LOAD CHAPTERS ==========
    async function loadChapters() {
      topicSelectEl.innerHTML = '<option>Loading chapters...</option>';
      startBtnEl.disabled = true;
      
      try {
        const data = await loadAllConfigAtOnce();
        const key = `${currentClass}_${currentSubject.toLowerCase()}`;
        
        if (!data?.config?.[key]) throw new Error('No config');
        
        currentSubjectConfig = {
          sheetId: data.config[key].sheetId,
          chapters: data.config[key].chapters
        };
        
        chaptersList = Object.keys(currentSubjectConfig.chapters || {});
        if (!chaptersList.length) throw new Error('No chapters');
        
        topicSelectEl.innerHTML = '<option value="">-- Select Chapter --</option>';
        chaptersList.forEach(ch => {
          topicSelectEl.innerHTML += `<option value="${ch}">${ch}</option>`;
        });
        startBtnEl.disabled = false;
        quizTopicNameEl.textContent = "No chapter selected";
        quizQuestionCountEl.textContent = `${chaptersList.length} chapters`;
        questionTextEl.textContent = "Select a chapter to start.";
      } catch (err) {
        topicSelectEl.innerHTML = '<option>Error loading chapters</option>';
        quizTopicNameEl.textContent = "Error";
        quizTopicNameEl.style.background = 'rgba(239,68,68,0.1)';
        quizTopicNameEl.style.color = '#fca5a5';
      }
      resetInactivityTimer();
    }

    // ========== LOAD QUESTIONS ==========
    async function loadQuestionsFromGoogleSheet(chapter) {
      if (!chapter) { alert("Select a chapter"); return; }
      
      currentTopicName = chapter;
      const gid = currentSubjectConfig?.chapters?.[chapter];
      const sheetId = currentSubjectConfig?.sheetId;
      if (!gid || !sheetId) { alert("Invalid config"); return; }
      
      quizTopicNameEl.textContent = chapter;
      resetQuizState();
      
      try {
        questionTextEl.textContent = `Loading ${chapter}...`;
        const res = await fetch(`https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&gid=${gid}`);
        const text = await res.text();
        const json = JSON.parse(text.substring(47).slice(0, -2));
        const rows = json.table.rows;
        
        if (rows.length < 3) throw new Error("No questions");
        
        // Get timer if available
        if (rows[1]?.c?.[7]?.v) timerDuration = parseInt(rows[1].c[7].v) * 60 * 1000;
        
        // Parse questions
        const rawQuestions = [];
        for (let i = 2; i < rows.length; i++) {
          const r = rows[i].c;
          if (!r || !r[0]?.v) continue;
          
          const options = [r[1]?.v || '', r[2]?.v || ''];
          if (r[3]?.v) options.push(r[3].v);
          if (r[4]?.v) options.push(r[4].v);
          
          let correct = 0;
          const ans = (r[5]?.v || 'A').toString().toUpperCase();
          if (ans === 'B' || ans === '2') correct = 1;
          else if (ans === 'C' || ans === '3') correct = 2;
          else if (ans === 'D' || ans === '4') correct = 3;
          
          rawQuestions.push({
            question: r[0].v,
            options,
            correctIndex: correct,
            explanation: r[6]?.v || '',
            imageUrl: r[8]?.v || '',
            optionImages: [r[9]?.v, r[10]?.v, r[11]?.v, r[12]?.v].filter(Boolean)
          });
        }
        
        if (!rawQuestions.length) throw new Error("No valid questions");
        
        // Randomize if enabled
        if (randomToggleEl.checked) {
          shuffleArray(rawQuestions);
          rawQuestions.forEach(q => {
            const idxs = q.options.map((_, i) => i);
            shuffleArray(idxs);
            q.options = idxs.map(i => q.options[i]);
            q.optionImages = idxs.map(i => q.optionImages[i] || '');
            q.correctIndex = idxs.indexOf(q.correctIndex);
          });
        }
        
        questions = rawQuestions;
        userAnswers = new Array(questions.length);
        questionsLoaded = true;
        currentIndex = 0;
        score = 0;
        scoreMiniEl.textContent = 'Score: 0';
        
        quizQuestionCountEl.textContent = `${questions.length} questions`;
        showQuestionNavigation();
        await preloadChapterImages(questions);
        
        if (timerDuration > 0) {
          showTimerNotification();
          startTimer();
        }
        
        renderQuestion();
        resetInactivityTimer();
        
      } catch (err) {
        questionTextEl.textContent = `Error: ${err.message}`;
        quizTopicNameEl.textContent = "Error";
        quizTopicNameEl.style.background = 'rgba(239,68,68,0.1)';
        quizTopicNameEl.style.color = '#fca5a5';
      }
    }

    function shuffleArray(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
    }

    // ========== TIMER FUNCTIONS ==========
    function startTimer() {
      if (timerDuration <= 0) return;
      timeRemaining = timerDuration;
      timerContainerEl.style.display = 'flex';
      updateTimerDisplay();
      
      timerInterval = setInterval(() => {
        timeRemaining -= 1000;
        if (timeRemaining <= 0) {
          clearInterval(timerInterval);
          autoFinishQuiz();
        }
        updateTimerDisplay();
      }, 1000);
    }

    function updateTimerDisplay() {
      const h = Math.floor(timeRemaining / 3600000);
      const m = Math.floor((timeRemaining % 3600000) / 60000);
      const s = Math.floor((timeRemaining % 60000) / 1000);
      timerDisplayEl.textContent = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
      
      timerDisplayEl.classList.remove('timer-warning', 'timer-critical');
      if (timeRemaining <= 1800000) timerDisplayEl.classList.add('timer-warning');
      if (timeRemaining <= 600000) timerDisplayEl.classList.add('timer-critical');
    }

    function stopTimer() {
      if (timerInterval) clearInterval(timerInterval);
      timerContainerEl.style.display = 'none';
    }

    function showTimerNotification() {
      const h = Math.floor(timerDuration / 3600000);
      const m = Math.floor((timerDuration % 3600000) / 60000);
      const timeStr = h ? `${h}h ${m}m` : m ? `${m}m` : '<1m';
      
      timerNotification = document.createElement('div');
      timerNotification.className = 'timer-notification';
      timerNotification.innerHTML = `<span>â±ï¸ Timer: <strong>${timeStr}</strong></span>`;
      document.querySelector('.toggle-row')?.after(timerNotification);
    }

    function removeTimerNotification() { timerNotification?.remove(); }

    function autoFinishQuiz() { showFinalResult(); stopTimer(); removeTimerNotification(); }

    function formatTimeTaken() {
      if (!quizStartTime) return '';
      const taken = Date.now() - quizStartTime;
      const h = Math.floor(taken / 3600000);
      const m = Math.floor((taken % 3600000) / 60000);
      const s = Math.floor((taken % 60000) / 1000);
      return h ? `${h}h ${m}m` : m ? `${m}m ${s}s` : `${s}s`;
    }

    // ========== NAVIGATION FUNCTIONS ==========
    function toggleQuestionNavigation() {
      questionNavigationEl.classList.toggle('collapsed');
      navigationToggleBtn.innerHTML = questionNavigationEl.classList.contains('collapsed') 
        ? '<i>â–¶</i> Show' : '<i>â–¼</i> Hide';
      if (!questionNavigationEl.classList.contains('collapsed')) updateQuestionNavigation();
    }

    function updateQuestionNavigation() {
      if (!questions.length) return;
      
      questionGridEl.innerHTML = '';
      for (let i = 0; i < questions.length; i++) {
        const btn = document.createElement('button');
        btn.className = 'question-number-btn';
        btn.textContent = i + 1;
        if (i === currentIndex) btn.classList.add('current');
        if (userAnswers[i] !== undefined) {
          if (userAnswers[i] === questions[i].correctIndex) btn.classList.add('answered');
          else { btn.style.background = 'rgba(239,68,68,0.2)'; btn.style.color = '#fca5a5'; }
        }
        btn.onclick = () => { currentIndex = i; renderQuestion(); };
        questionGridEl.appendChild(btn);
      }
      updateNavigationStats();
    }

    function updateNavigationStats() {
      if (!questions.length) return;
      
      let correct = 0, incorrect = 0, unanswered = 0;
      for (let i = 0; i < questions.length; i++) {
        if (userAnswers[i] === undefined) unanswered++;
        else if (userAnswers[i] === questions[i].correctIndex) correct++;
        else incorrect++;
      }
      
      navigationStatsEl.innerHTML = `
        <div class="stat-badge current">â— Current: ${currentIndex+1}</div>
        <div class="stat-badge answered">â— Correct: ${correct}</div>
        <div class="stat-badge" style="background:rgba(239,68,68,0.15);color:#fca5a5;">â— Incorrect: ${incorrect}</div>
        <div class="stat-badge not-answered">â— Unanswered: ${unanswered}</div>
      `;
    }

    function showQuestionNavigation() {
      questionNavigationEl.style.display = 'block';
      questionNavigationEl.classList.add('collapsed');
      navigationToggleBtn.innerHTML = '<i>â–¶</i> Show';
    }

    // ========== SCREEN NAVIGATION ==========
    function showClassSelection() {
      classSelectionEl.style.display = 'block';
      subjectSelectionEl.style.display = 'none';
      quizContainerEl.style.display = 'none';
      resetQuizState();
      resetInactivityTimer();
    }

    function showSubjectSelection(className) {
      currentClass = className;
      currentClassDisplayEl.textContent = className === 'JE' ? 'Junior Engineer' : `Class ${className}`;
      classSelectionEl.style.display = 'none';
      subjectSelectionEl.style.display = 'block';
      quizContainerEl.style.display = 'none';
      loadSubjects();
      resetInactivityTimer();
    }

    function showQuizContainer() {
      subjectSelectionEl.style.display = 'none';
      quizContainerEl.style.display = 'block';
      
      currentPathEl.innerHTML = `
        <span class="path-link" onclick="showClassSelection()">Classes</span>
        <span class="path-separator">â€º</span>
        <span class="path-link" onclick="showSubjectSelection('${currentClass}')">
          ${currentClass === 'JE' ? 'Junior Engineer' : 'Class ' + currentClass}
        </span>
        <span class="path-separator">â€º</span>
        <span>${currentSubject}</span>
      `;
      currentPathEl.style.display = 'flex';
      
      loadChapters();
      resetInactivityTimer();
    }

    // ========== QUIZ FUNCTIONS ==========
    function resetQuizState() {
      questions = [];
      currentIndex = 0;
      score = 0;
      hasAnswered = false;
      questionsLoaded = false;
      attempted = 0;
      userAnswers = [];
      timeRemaining = 0;
      timerDuration = 0;
      quizStartTime = null;
      isReviewMode = false;
      isIncorrectReviewMode = false;
      incorrectQuestionIndices = [];
      hasSentQuizResultNotification = false;
      
      questionTextEl.textContent = "Select a chapter to start";
      questionImageContainerEl.classList.remove('visible');
      questionImageEl.src = '';
      optionsListEl.innerHTML = '';
      feedbackEl.innerHTML = '';
      nextBtn.disabled = true;
      previousBtn.disabled = true;
      finishBtn.disabled = true;
      finishBtn.textContent = "Submit";
      finalScoreEl.style.display = 'none';
      progressBarFillEl.style.width = '0%';
      questionCounterEl.textContent = "Choose a chapter";
      scoreMiniEl.textContent = "Score: 0";
      timerContainerEl.style.display = 'none';
      toggleRowEl.classList.remove('hidden');
      progressEl.classList.remove('hidden');
      controlsEl.classList.remove('hidden');
      questionBoxEl.style.display = 'block';
      
      questionNavigationEl.classList.remove('expanded');
      questionNavigationEl.classList.add('collapsed');
      navigationToggleBtn.innerHTML = '<i>â–¶</i> Show';
      removeTimerNotification();
      questionWhatsappIconEl.style.display = 'none';
      
      finishBtn.onclick = () => {
        if (!questionsLoaded) return;
        if (confirm("Finish quiz?")) showFinalResult();
        resetInactivityTimer();
      };
    }

    function renderQuestion() {
      if (!questions.length) return;
      
      const q = questions[currentIndex];
      hasAnswered = false;
      feedbackEl.innerHTML = '';
      feedbackEl.className = 'feedback';
      
      if (isIncorrectReviewMode) {
        const pos = incorrectQuestionIndices.indexOf(currentIndex) + 1;
        questionCounterEl.textContent = `Incorrect Q${pos}/${incorrectQuestionIndices.length}`;
        progressBarFillEl.style.width = `${(pos / incorrectQuestionIndices.length) * 100}%`;
      } else {
        questionCounterEl.textContent = `Q${currentIndex+1}/${questions.length}`;
        progressBarFillEl.style.width = `${((currentIndex+1) / questions.length) * 100}%`;
      }
      
      questionTextEl.innerHTML = q.question.replace(/\n/g, '<br>').replace(/\|\|/g, '<br><br>');
      questionWhatsappIconEl.style.display = 'block';
      
      // Handle image
      if (q.imageUrl?.trim()) {
        const url = convertImageUrl(q.imageUrl);
        questionImageContainerEl.classList.add('visible');
        questionImageEl.style.display = 'none';
        imageLoadingEl.style.display = 'block';
        imageErrorEl.style.display = 'none';
        
        loadImageWithCache(url).then(() => {
          questionImageEl.src = url;
          questionImageEl.style.display = 'block';
          imageLoadingEl.style.display = 'none';
        }).catch(() => {
          imageLoadingEl.style.display = 'none';
          imageErrorEl.style.display = 'block';
        });
      } else {
        questionImageContainerEl.classList.remove('visible');
      }
      
      // Render options
      optionsListEl.innerHTML = '';
      q.options.forEach((opt, i) => {
        const li = document.createElement('li');
        li.className = 'option';
        if (userAnswers[currentIndex] === i) li.classList.add('selected');
        
        li.innerHTML = `
          <div class="option-label">${String.fromCharCode(65+i)}.</div>
          <div class="option-content">${opt}</div>
        `;
        
        li.onclick = () => {
          if (hasAnswered || isReviewMode) return;
          document.querySelectorAll('.option').forEach(o => o.classList.remove('selected'));
          li.classList.add('selected');
          userAnswers[currentIndex] = i;
          handleAnswer(i);
        };
        
        optionsListEl.appendChild(li);
      });
      
      previousBtn.disabled = currentIndex === 0;
      nextBtn.disabled = !isReviewMode;
      finishBtn.disabled = false;
      
      if (userAnswers[currentIndex] !== undefined) {
        showAnswerState(userAnswers[currentIndex]);
        if (!isReviewMode) nextBtn.disabled = false;
      } else if (isReviewMode) {
        showAnswerState(-1);
        feedbackEl.innerHTML = `âœ… Correct Answer: ${q.options[q.correctIndex]}`;
        if (q.explanation) {
          feedbackEl.innerHTML += `<div class="explanation">ðŸ“˜ ${q.explanation}</div>`;
        }
      }
      
      updateQuestionNavigation();
      resetInactivityTimer();
    }

    function handleAnswer(selected) {
      const q = questions[currentIndex];
      hasAnswered = true;
      attempted++;
      
      if (selected === q.correctIndex) {
        score++;
        feedbackEl.innerHTML = 'âœ… Correct!';
        feedbackEl.className = 'feedback correct';
      } else {
        feedbackEl.innerHTML = `âŒ Wrong. Correct: ${q.options[q.correctIndex]}`;
        feedbackEl.className = 'feedback incorrect';
      }
      
      if (q.explanation) {
        feedbackEl.innerHTML += `<div class="explanation">ðŸ“˜ ${q.explanation}</div>`;
      }
      
      scoreMiniEl.textContent = `Score: ${score}`;
      showAnswerState(selected);
      nextBtn.disabled = false;
      updateQuestionNavigation();
    }

    function showAnswerState(selected) {
      const q = questions[currentIndex];
      document.querySelectorAll('.option').forEach((opt, i) => {
        opt.classList.remove('correct', 'incorrect', 'selected');
        if (i === q.correctIndex) opt.classList.add('correct');
        if (i === selected && selected !== q.correctIndex) opt.classList.add('incorrect');
        if (i === selected) opt.classList.add('selected');
      });
    }

    function goToNext() {
      if (isIncorrectReviewMode) {
        const pos = incorrectQuestionIndices.indexOf(currentIndex);
        if (pos < incorrectQuestionIndices.length - 1) {
          currentIndex = incorrectQuestionIndices[pos + 1];
        } else {
          currentIndex = incorrectQuestionIndices[0];
        }
      } else if (currentIndex < questions.length - 1) {
        currentIndex++;
      } else if (!isReviewMode) {
        showFinalResult();
        return;
      } else {
        currentIndex = 0;
      }
      renderQuestion();
    }

    function goToPrev() {
      if (isIncorrectReviewMode) {
        const pos = incorrectQuestionIndices.indexOf(currentIndex);
        if (pos > 0) {
          currentIndex = incorrectQuestionIndices[pos - 1];
        } else {
          currentIndex = incorrectQuestionIndices[incorrectQuestionIndices.length - 1];
        }
      } else if (currentIndex > 0) {
        currentIndex--;
      }
      renderQuestion();
    }

    function calculateStats() {
      let correct = 0;
      for (let i = 0; i < questions.length; i++) {
        if (userAnswers[i] !== undefined && userAnswers[i] === questions[i].correctIndex) correct++;
      }
      return {
        total: questions.length,
        correct,
        percentage: ((correct / questions.length) * 100).toFixed(2),
        timeTaken: formatTimeTaken()
      };
    }

    function showFinalResult() {
      stopTimer();
      removeTimerNotification();
      const stats = calculateStats();
      
      toggleRowEl.classList.add('hidden');
      progressEl.classList.add('hidden');
      questionNavigationEl.style.display = 'none';
      timerContainerEl.classList.add('hidden');
      controlsEl.classList.add('hidden');
      questionBoxEl.style.display = 'none';
      questionWhatsappIconEl.style.display = 'none';
      
      finalScoreEl.style.display = 'block';
      finalScoreEl.innerHTML = `
        <div class="result-header">Results - ${currentTopicName}</div>
        <div class="result-stats">
          <div class="stat-item"><span class="stat-label">Total</span><span class="stat-value">${stats.total}</span></div>
          <div class="stat-item"><span class="stat-label">Correct</span><span class="stat-value">${stats.correct}</span></div>
          <div class="stat-item"><span class="stat-label">Percentage</span><span class="stat-value stat-percentage">${stats.percentage}%</span></div>
          <div class="stat-item"><span class="stat-label">Time</span><span class="stat-value stat-time">${stats.timeTaken || 'N/A'}</span></div>
        </div>
        <div class="result-message">${getPerformanceRemark(parseFloat(stats.percentage))}</div>
        <button class="restart-btn" onclick="restartQuiz()">Restart Quiz</button>
      `;
      
      resetInactivityTimer();
      sendQuizResultNotification(stats);
      setTimeout(generatePDF, 2000);
    }

    function restartQuiz() {
      isReviewMode = false;
      isIncorrectReviewMode = false;
      userAnswers = [];
      score = 0;
      currentIndex = 0;
      scoreMiniEl.textContent = 'Score: 0';
      
      finishBtn.textContent = "Submit";
      finishBtn.onclick = () => {
        if (!questionsLoaded) return;
        if (confirm("Finish quiz?")) showFinalResult();
        resetInactivityTimer();
      };
      
      finalScoreEl.style.display = 'none';
      toggleRowEl.classList.remove('hidden');
      progressEl.classList.remove('hidden');
      questionNavigationEl.style.display = 'block';
      questionNavigationEl.classList.add('collapsed');
      timerContainerEl.classList.remove('hidden');
      controlsEl.classList.remove('hidden');
      questionBoxEl.style.display = 'block';
      
      if (timerDuration > 0) {
        showTimerNotification();
        startTimer();
      }
      
      renderQuestion();
      resetInactivityTimer();
    }

    async function generatePDF() {
      if (!currentUser || !questions.length) return;
      
      showPDFOverlay();
      try {
        const stats = calculateStats();
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        doc.setFontSize(20);
        doc.text("G.S. Tutorial - Report", 20, 20);
        doc.setFontSize(12);
        doc.text(`Name: ${currentUser.name}`, 20, 35);
        doc.text(`Class: ${currentClass} | Subject: ${currentSubject}`, 20, 45);
        doc.text(`Chapter: ${currentTopicName}`, 20, 55);
        doc.text(`Score: ${stats.correct}/${stats.total} (${stats.percentage}%)`, 20, 65);
        doc.text(`Time: ${stats.timeTaken || 'N/A'}`, 20, 75);
        
        const filename = `GS_${currentUser.username}_${Date.now()}.pdf`;
        doc.save(filename);
        
        hidePDFOverlay();
      } catch (error) {
        hidePDFOverlay();
      }
    }

    // ========== LOGIN FUNCTION ==========
    function login(user, isRestore = false) {
      const validation = validateUserAccount(user);
      if (!validation.valid) {
        if (user.subscriptionReason === 'expired') {
          showSubscriptionExpired(user, user.joiningDate, user.lastDate);
        } else {
          showAccountConfigError(user, validation.error);
        }
        return;
      }
      
      currentUser = user;
      currentUser.validatedAssignedClasses = validation.assignedClasses;
      
      headerUsernameEl.textContent = user.name;
      sideUsername.textContent = user.name;
      greetingMessageEl.innerHTML = `Welcome, <span>${user.name}</span> (${user.role})`;
      
      fixedHeaderEl.style.display = 'flex';
      headerUserInfoEl.style.display = 'block';
      loginContainerEl.style.display = 'none';
      accountConfigErrorEl.style.display = 'none';
      subscriptionExpiredEl.style.display = 'none';
      classSelectionEl.style.display = 'block';
      
      resetFailedAttempts();
      resetInactivityTimer();
      loadClasses();
      saveSession();
      
      if (!isRestore) sendLoginNotification(user);
    }

    // ========== LOGOUT FUNCTION ==========
    function logout() {
      if (timerInterval) clearInterval(timerInterval);
      if (inactivityTimer) clearTimeout(inactivityTimer);
      if (cooldownTimer) clearInterval(cooldownTimer);
      
      imageCache.clear();
      clearSession();
      
      currentUser = null;
      fixedHeaderEl.style.display = 'none';
      classSelectionEl.style.display = 'none';
      subjectSelectionEl.style.display = 'none';
      quizContainerEl.style.display = 'none';
      accountConfigErrorEl.style.display = 'none';
      subscriptionExpiredEl.style.display = 'none';
      loginContainerEl.style.display = 'flex';
      
      loginFormEl.reset();
      passwordEl.type = 'password';
      passwordToggleEl.textContent = 'ðŸ‘ï¸';
      loginErrorEl.style.display = 'none';
      
      sideMenu.classList.remove('open');
      menuOverlay.classList.remove('open');
      usernameEl.focus();
    }

    function autoLogout() {
      if (currentUser) {
        alert("Logged out due to inactivity");
        logout();
      }
    }

    function resetInactivityTimer() {
      if (inactivityTimer) clearTimeout(inactivityTimer);
      if (currentUser) inactivityTimer = setTimeout(autoLogout, INACTIVITY_TIMEOUT);
    }

    function handleUserActivity() {
      updateLastActivity();
      resetInactivityTimer();
    }

    // ========== EVENT LISTENERS ==========
    loginFormEl.addEventListener("submit", async (e) => {
      e.preventDefault();
      
      if (isOnCooldown) {
        loginErrorEl.textContent = "Please wait for cooldown";
        loginErrorEl.style.display = 'block';
        return;
      }
      
      const u = usernameEl.value.trim();
      const p = passwordEl.value.trim();
      
      if (!u || !p) {
        loginErrorEl.textContent = "Enter both fields";
        loginErrorEl.style.display = 'block';
        return;
      }
      
      loginErrorEl.style.display = 'none';
      loginBtnEl.disabled = true;
      loginBtnEl.textContent = 'Loading...';
      
      const result = await authenticateWithAppsScript(u, p);
      
      if (result?.success) {
        resetFailedAttempts();
        if (!result.subscriptionValid) {
          showSubscriptionExpired(result.user, result.user.joiningDate, result.user.lastDate);
        } else {
          login(result.user, false);
        }
      } else {
        recordFailedAttempt();
        loginErrorEl.textContent = failedAttempts >= MAX_ATTEMPTS 
          ? `Too many attempts. Wait ${COOLDOWN_TIME}s` 
          : (result?.error || 'Invalid credentials');
        loginErrorEl.style.display = 'block';
      }
      
      loginBtnEl.disabled = false;
      loginBtnEl.textContent = 'Login';
    });

    startBtnEl.addEventListener("click", () => {
      const ch = topicSelectEl.value;
      if (!ch) { alert("Select a chapter"); return; }
      if (timerInterval) clearInterval(timerInterval);
      removeTimerNotification();
      resetQuizState();
      loadQuestionsFromGoogleSheet(ch);
      resetInactivityTimer();
    });

    nextBtn.addEventListener("click", goToNext);
    previousBtn.addEventListener("click", goToPrev);
    navigationToggleBtn.addEventListener("click", toggleQuestionNavigation);
    randomToggleEl.addEventListener("change", () => resetInactivityTimer());

    backToClassesBtn.addEventListener("click", () => { showClassSelection(); resetInactivityTimer(); });
    backToLoginBtnEl.addEventListener("click", () => { accountConfigErrorEl.style.display = 'none'; loginContainerEl.style.display = 'flex'; resetInactivityTimer(); });
    backToLoginFromExpiredBtn.addEventListener("click", () => { subscriptionExpiredEl.style.display = 'none'; loginContainerEl.style.display = 'flex'; resetInactivityTimer(); });

    setupQuestionWhatsAppSupport();

    document.addEventListener('click', (e) => {
      if (questionImageEl.classList.contains('zoomed') && !e.target.closest('#question-image-container')) {
        questionImageEl.classList.remove('zoomed', 'touch-zoom');
      }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') questionImageEl.classList.remove('zoomed', 'touch-zoom');
    });

    // ========== SIDE MENU ==========
    function toggleMenu() {
      sideMenu.classList.toggle('open');
      menuOverlay.classList.toggle('open');
    }
    menuToggle.addEventListener('click', toggleMenu);
    menuOverlay.addEventListener('click', toggleMenu);
    sideLogoutBtn.addEventListener('click', () => {
      toggleMenu();
      logout();
    });

    // ========== THEME TOGGLE ==========
    function setTheme(theme) {
      if (theme === 'light') {
        document.body.classList.add('light-mode');
        themeIcon.textContent = 'â˜€ï¸';
        metaThemeColor.setAttribute('content', '#f0f4fa');
        localStorage.setItem('theme', 'light');
      } else {
        document.body.classList.remove('light-mode');
        themeIcon.textContent = 'ðŸŒ™';
        metaThemeColor.setAttribute('content', '#0f172a');
        localStorage.setItem('theme', 'dark');
      }
    }
    
    themeToggle.addEventListener('click', () => {
      setTheme(document.body.classList.contains('light-mode') ? 'dark' : 'light');
    });
    
    setTheme(localStorage.getItem('theme') || 'dark');

    // ========== INITIALIZATION ==========
    async function init() {
      await loadTelegramConfig();
      await getUserIP();
      
      if (loadSession()) {
        login(currentUser, true);
      } else {
        usernameEl.focus();
      }
      
      document.addEventListener('mousemove', handleUserActivity);
      document.addEventListener('keypress', handleUserActivity);
      document.addEventListener('click', handleUserActivity);
      document.addEventListener('touchstart', handleUserActivity);
      
      resetFailedAttempts();
    }

    document.addEventListener("DOMContentLoaded", init);

    // Expose functions globally
    window.showClassSelection = showClassSelection;
    window.toggleImageZoom = toggleImageZoom;
    window.restartQuiz = restartQuiz;
  </script>
  
  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("service-worker.js").catch(() => {});
    }
  </script>
</body>
</html>
