<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0f172a" id="meta-theme-color">
  <meta charset="UTF-8" />
  <title>G.S. Tutorial ‚Äì Interactive Learning App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <!-- Include jsPDF library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <!-- Include html2canvas for capturing screenshots -->
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <!-- Include Inter font for better readability -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* ===== CSS variables for light/dark themes - OPTIMIZED ===== */
    :root {
      --bg-gradient-start: #0f172a;
      --bg-gradient-end: #1e293b;
      --surface: #020617;
      --surface-light: #1e293b;
      --text-primary: #f1f5f9;
      --text-secondary: #cbd5e1;
      --text-muted: #94a3b8;
      --border-color: rgba(148, 163, 184, 0.2);
      --accent-blue: #3b82f6;
      --accent-blue-hover: #2563eb;
      --accent-green: #22c55e;
      --accent-green-hover: #16a34a;
      --header-bg: rgba(2, 6, 23, 0.98);
      --card-bg: rgba(15, 23, 42, 0.8);
      --shadow: 0 18px 40px rgba(0,0,0,0.7);
      --sidebar-bg: #0f172a;
      --sidebar-border: #1e293b;
      --option-bg: rgba(15, 23, 42, 0.6);
      --input-bg: #0f172a;
      --input-border: #334155;
      --hover-bg: rgba(31, 41, 55, 0.9);
      --danger-bg: rgba(239, 68, 68, 0.15);
      --danger-border: rgba(239, 68, 68, 0.3);
      --success-bg: rgba(34, 197, 94, 0.15);
      --success-border: rgba(34, 197, 94, 0.3);
      --warning-bg: rgba(245, 158, 11, 0.15);
      --warning-border: rgba(245, 158, 11, 0.3);
      --button-secondary: #334155;
      --button-secondary-hover: #475569;
    }

    body.light-mode {
      --bg-gradient-start: #e2e8f0;
      --bg-gradient-end: #f1f5f9;
      --surface: #ffffff;
      --surface-light: #f8fafc;
      --text-primary: #0f172a;
      --text-secondary: #334155;
      --text-muted: #64748b;
      --border-color: rgba(0,0,0,0.08);
      --accent-blue: #2563eb;
      --accent-blue-hover: #1d4ed8;
      --accent-green: #16a34a;
      --accent-green-hover: #15803d;
      --header-bg: rgba(255,255,255,0.98);
      --card-bg: #ffffff;
      --shadow: 0 10px 30px rgba(0,0,0,0.1);
      --sidebar-bg: #ffffff;
      --sidebar-border: #e2e8f0;
      --option-bg: #ffffff;
      --input-bg: #ffffff;
      --input-border: #cbd5e1;
      --hover-bg: #f1f5f9;
      --danger-bg: #fee2e2;
      --danger-border: #fecaca;
      --success-bg: #dcfce7;
      --success-border: #bbf7d0;
      --warning-bg: #fef3c7;
      --warning-border: #fde68a;
      --button-secondary: #e2e8f0;
      --button-secondary-hover: #cbd5e1;
    }

    /* ===== BASE STYLES ===== */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      background: var(--bg-gradient-start);
      color: var(--text-primary);
      min-height: 100vh;
      background-image: radial-gradient(circle at 50% 50%, var(--bg-gradient-end) 0%, var(--bg-gradient-start) 100%);
      transition: background-color 0.3s, color 0.2s;
      display: flex;
      flex-direction: column;
      align-items: center;
      -webkit-tap-highlight-color: transparent;
    }

    /* ===== LOADING ANIMATIONS ===== */
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes pulse {
      0%, 100% { opacity: 0.6; }
      50% { opacity: 1; }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .loading-spinner {
      border: 4px solid rgba(59, 130, 246, 0.2);
      border-top: 4px solid #3b82f6;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }

    .loading-container {
      text-align: center;
      padding: 40px;
      color: var(--text-muted);
      grid-column: 1/-1;
    }

    /* ===== FIXED HEADER - REDESIGNED ===== */
    .fixed-header {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background: var(--header-bg);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border-color);
      z-index: 1000;
      padding: 0 20px;
      height: 72px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-header {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      object-fit: contain;
      background: rgba(255, 255, 255, 0.1);
      padding: 4px;
    }

    .brand-container {
      display: flex;
      flex-direction: column;
    }

    .brand-main {
      font-weight: 700;
      font-size: 1.4rem;
      background: linear-gradient(135deg, var(--accent-blue) 0%, var(--accent-green) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      letter-spacing: -0.02em;
      line-height: 1.2;
    }

    .brand-sub {
      font-size: 0.7rem;
      color: var(--text-muted);
      letter-spacing: 0.3px;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .user-info {
      font-size: 0.85rem;
      color: var(--text-primary);
      background: rgba(59, 130, 246, 0.15);
      padding: 6px 14px;
      border-radius: 999px;
      border: 1px solid rgba(59, 130, 246, 0.3);
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .menu-toggle {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      background: var(--surface-light);
      border: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 6px;
      cursor: pointer;
      transition: 0.2s;
    }
    .menu-toggle:hover {
      background: var(--accent-blue);
    }
    .menu-toggle span {
      width: 22px;
      height: 2px;
      background: var(--text-primary);
      border-radius: 4px;
      transition: 0.3s;
    }

    /* ===== SIDE MENU ===== */
    .side-menu {
      position: fixed;
      top: 72px;
      right: -320px;
      width: 300px;
      height: calc(100vh - 72px);
      background: var(--sidebar-bg);
      backdrop-filter: blur(12px);
      border-left: 1px solid var(--sidebar-border);
      box-shadow: -5px 0 25px rgba(0,0,0,0.2);
      transition: right 0.3s ease;
      z-index: 1001;
      display: flex;
      flex-direction: column;
      padding: 24px 16px;
      overflow-y: auto;
    }
    .side-menu.open {
      right: 0;
    }

    .menu-overlay {
      position: fixed;
      top: 72px;
      left: 0;
      width: 100%;
      height: calc(100vh - 72px);
      background: rgba(0,0,0,0.3);
      backdrop-filter: blur(2px);
      z-index: 1000;
      display: none;
    }
    .menu-overlay.open {
      display: block;
    }

    .side-profile {
      text-align: center;
      margin-bottom: 24px;
    }
    .side-profile img {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid var(--accent-blue);
      margin-bottom: 12px;
    }
    .side-username {
      font-weight: 600;
      font-size: 1.1rem;
      background: rgba(59,130,246,0.1);
      padding: 6px 12px;
      border-radius: 40px;
      display: inline-block;
      margin-top: 4px;
      color: var(--text-primary);
    }

    .side-dev {
      border-top: 1px solid var(--border-color);
      border-bottom: 1px solid var(--border-color);
      padding: 20px 0;
      margin: 10px 0;
    }

    .contact-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 0;
      color: var(--text-secondary);
      transition: 0.2s;
      cursor: pointer;
    }
    .contact-item:hover {
      color: var(--accent-blue);
    }
    .contact-item img {
      width: 24px;
      height: 24px;
      object-fit: contain;
    }
    .contact-item span, .contact-item a {
      color: var(--text-secondary);
      text-decoration: none;
      font-size: 0.95rem;
    }
    .contact-item a:hover {
      color: var(--accent-blue);
    }

    .theme-toggle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--surface-light);
      padding: 12px 16px;
      border-radius: 40px;
      margin: 20px 0;
      border: 1px solid var(--border-color);
      cursor: pointer;
      color: var(--text-primary);
    }

    .logout-side {
      margin-top: auto;
      padding: 14px;
      background: rgba(239,68,68,0.1);
      border: 1px solid rgba(239,68,68,0.3);
      border-radius: 40px;
      color: #ef4444;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      cursor: pointer;
      transition: 0.2s;
    }
    .logout-side:hover {
      background: rgba(239,68,68,0.2);
    }

    /* ===== MAIN CONTENT ===== */
    .main-content {
      width: 100%;
      max-width: 800px;
      margin-top: 92px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    /* ===== GREETING MESSAGE ===== */
    .greeting-message {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 16px 20px;
      border: 1px solid var(--border-color);
      font-size: 1.1rem;
      backdrop-filter: blur(4px);
      color: var(--text-primary);
      box-shadow: var(--shadow);
    }
    .greeting-message span {
      font-weight: 700;
      background: linear-gradient(135deg, var(--accent-blue), var(--accent-green));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .class-title {
      font-size: 0.9rem;
      color: var(--text-muted);
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* ===== LOGIN CONTAINER ===== */
    #login-container {
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .login-box {
      background: var(--surface);
      border-radius: 24px;
      padding: 30px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border-color);
      width: 100%;
      max-width: 420px;
    }

    .login-header {
      text-align: center;
      margin-bottom: 30px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
    }

    .logo-login {
      width: 70px;
      height: 70px;
      border-radius: 12px;
      object-fit: contain;
      background: rgba(255, 255, 255, 0.1);
      padding: 5px;
    }

    .login-title {
      font-size: 1.6rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 8px;
      background: linear-gradient(90deg, var(--accent-blue) 0%, var(--accent-green) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: 0.5px;
    }

    .login-subtitle {
      font-size: 0.95rem;
      color: var(--text-secondary);
      text-align: center;
    }

    .login-form {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
      position: relative;
    }

    .form-group label {
      font-size: 0.9rem;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .form-input {
      background: var(--input-bg);
      color: var(--text-primary);
      border-radius: 40px;
      border: 1px solid var(--input-border);
      padding: 12px 16px;
      font-size: 0.95rem;
      transition: all 0.2s ease;
      width: 100%;
      padding-right: 45px;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--accent-blue);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }

    .password-input-wrapper {
      position: relative;
      width: 100%;
    }

    .password-toggle {
      position: absolute;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      background: transparent;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 1.1rem;
    }

    .attempt-counter {
      margin-top: 8px;
      font-size: 0.8rem;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .attempt-counter.warning { color: #fbbf24; }
    .attempt-counter.critical { color: #ef4444; }

    .cooldown-message {
      margin-top: 8px;
      padding: 10px;
      background: var(--danger-bg);
      border: 1px solid var(--danger-border);
      border-radius: 8px;
      font-size: 0.85rem;
      color: #fca5a5;
      text-align: center;
    }

    .login-btn {
      background: linear-gradient(to right, var(--accent-blue), var(--accent-blue-hover));
      color: white;
      border: none;
      border-radius: 999px;
      padding: 14px 24px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-top: 10px;
      width: 100%;
      box-shadow: 0 8px 18px rgba(37, 99, 235, 0.4);
    }

    .login-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 22px rgba(37, 99, 235, 0.5);
    }

    .login-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .login-error {
      background: var(--danger-bg);
      color: #fca5a5;
      padding: 10px 12px;
      border-radius: 8px;
      font-size: 0.85rem;
      border: 1px solid var(--danger-border);
      display: none;
      text-align: center;
    }

    .request-credentials-btn {
      background: linear-gradient(to right, #25d366, #128c7e);
      color: white;
      border: none;
      border-radius: 999px;
      padding: 12px 24px;
      font-size: 0.95rem;
      font-weight: 500;
      cursor: pointer;
      margin-top: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      text-decoration: none;
      text-align: center;
    }

    .config-info {
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.3);
      border-radius: 8px;
      padding: 10px;
      margin-top: 15px;
      font-size: 0.8rem;
      color: var(--accent-blue);
      text-align: center;
    }

    /* ===== CLASS & SUBJECT SELECTION ===== */
    .class-selection, .subject-selection, .quiz-container {
      background: var(--surface);
      border-radius: 24px;
      padding: 24px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border-color);
      width: 100%;
    }

    .screen-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 8px;
      background: linear-gradient(90deg, var(--accent-blue) 0%, var(--accent-green) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .screen-subtitle {
      font-size: 0.95rem;
      color: var(--text-secondary);
      text-align: center;
      margin-bottom: 20px;
    }

    .class-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      margin-top: 16px;
    }

    .class-card {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 16px 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100px;
    }

    .class-card:hover {
      transform: translateY(-2px);
      border-color: var(--accent-blue);
      box-shadow: 0 8px 20px rgba(59, 130, 246, 0.15);
    }

    .class-icon { font-size: 1.8rem; margin-bottom: 8px; }
    .class-name { font-size: 1rem; font-weight: 600; color: var(--text-primary); }
    .class-desc { font-size: 0.7rem; color: var(--text-muted); margin-top: 4px; }

    .subject-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 12px;
      margin-top: 16px;
    }

    .subject-card {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 20px 12px;
      text-align: center;
      cursor: pointer;
      border: 1px solid var(--border-color);
      transition: all 0.2s;
    }

    .subject-card:hover {
      transform: translateY(-2px);
      border-color: var(--accent-blue);
    }

    .subject-icon { font-size: 2rem; margin-bottom: 10px; }
    .subject-name { font-size: 1.1rem; font-weight: 600; color: var(--text-primary); }
    .subject-desc { font-size: 0.75rem; color: var(--text-muted); margin-top: 6px; }

    .back-btn {
      background: rgba(75, 85, 99, 0.15);
      color: var(--text-secondary);
      border: 1px solid var(--border-color);
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-top: 20px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .back-btn:hover {
      background: rgba(75, 85, 99, 0.25);
      transform: translateY(-1px);
    }

    /* ===== QUIZ CONTAINER ===== */
    .topic-section {
      margin-bottom: 20px;
      padding: 16px;
      background: var(--card-bg);
      border-radius: 16px;
      border: 1px solid var(--border-color);
    }

    .topic-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      flex-wrap: wrap;
      gap: 10px;
    }

    .current-path {
      font-size: 0.85rem;
      color: var(--accent-blue);
      background: rgba(59, 130, 246, 0.1);
      padding: 6px 12px;
      border-radius: 8px;
      border: 1px solid rgba(59, 130, 246, 0.2);
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .path-separator { color: var(--text-muted); margin: 0 4px; }
    .path-link { color: var(--accent-blue); cursor: pointer; text-decoration: underline; }

    .topic-name {
      font-size: 1rem;
      font-weight: 600;
      color: var(--accent-blue);
      background: rgba(59, 130, 246, 0.15);
      padding: 4px 12px;
      border-radius: 8px;
      border: 1px solid rgba(59, 130, 246, 0.3);
    }

    .question-count {
      font-size: 0.9rem;
      color: var(--accent-green);
      background: rgba(34, 197, 94, 0.15);
      padding: 4px 12px;
      border-radius: 8px;
      border: 1px solid rgba(34, 197, 94, 0.3);
    }

    .topic-row {
      display: flex;
      gap: 8px;
      align-items: center;
      width: 100%;
    }

    .topic-select {
      flex: 1;
      min-width: 0;
      background: var(--input-bg);
      color: var(--text-primary);
      border-radius: 40px;
      border: 1px solid var(--input-border);
      padding: 12px 16px;
      font-size: 0.95rem;
      appearance: none;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 16px;
    }

    .start-btn {
      border-radius: 40px;
      border: none;
      padding: 12px 24px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(to right, var(--accent-blue), var(--accent-blue-hover));
      color: white;
      white-space: nowrap;
      min-width: 100px;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    }

    .start-btn:hover:not(:disabled) { transform: translateY(-1px); }
    .start-btn:disabled { opacity: 0.6; cursor: not-allowed; }

    /* ===== QUESTION NAVIGATION ===== */
    .question-navigation {
      margin: 16px 0;
      padding: 16px;
      background: var(--card-bg);
      border-radius: 16px;
      border: 1px solid var(--border-color);
      transition: all 0.3s ease;
    }

    .question-navigation.collapsed {
      padding: 12px 16px;
    }

    .navigation-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .navigation-title {
      font-weight: 600;
      color: var(--accent-blue);
      font-size: 0.95rem;
    }

    .navigation-toggle-btn {
      background: var(--surface-light);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      border-radius: 30px;
      padding: 6px 14px;
      font-size: 0.8rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .question-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
      gap: 8px;
      margin-top: 16px;
      max-height: 200px;
      overflow-y: auto;
      padding: 4px;
      transition: all 0.3s ease;
    }

    .question-navigation.collapsed .question-grid {
      display: none;
    }

    .question-number-btn {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      border: 1px solid var(--border-color);
      background: var(--surface-light);
      color: var(--text-primary);
      font-weight: 500;
      cursor: pointer;
      transition: 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .question-number-btn:hover {
      background: var(--hover-bg);
      border-color: var(--accent-blue);
    }

    .question-number-btn.current {
      background: rgba(59,130,246,0.3);
      border-color: var(--accent-blue);
      color: var(--accent-blue);
      font-weight: 600;
    }

    .question-number-btn.answered {
      background: rgba(34,197,94,0.2);
      border-color: var(--accent-green);
      color: var(--accent-green);
    }

    .navigation-stats {
      display: flex;
      gap: 12px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border-color);
      flex-wrap: wrap;
      font-size: 0.8rem;
    }

    /* ===== TIMER ===== */
    .timer-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding: 8px 16px;
      background: rgba(59, 130, 246, 0.05);
      border-radius: 40px;
      border: 1px solid rgba(59, 130, 246, 0.2);
    }

    .timer-label {
      font-size: 0.85rem;
      color: var(--accent-blue);
    }

    .timer-display {
      font-size: 1.1rem;
      font-weight: 700;
      color: #60a5fa;
      font-family: monospace;
    }

    .timer-warning { color: #fbbf24; animation: pulse 1s infinite; }
    .timer-critical { color: #ef4444; animation: pulse 0.5s infinite; }

    .timer-notification {
      margin-bottom: 10px;
      padding: 8px 12px;
      background: var(--warning-bg);
      border-radius: 40px;
      border: 1px solid var(--warning-border);
      font-size: 0.85rem;
      color: #fbbf24;
    }

    /* ===== TOGGLE ROW ===== */
    .toggle-row {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-bottom: 10px;
    }

    .toggle-row.hidden { display: none; }
    .toggle-row input { accent-color: var(--accent-blue); }

    /* ===== PROGRESS ===== */
    .progress {
      margin-bottom: 16px;
      font-size: 0.85rem;
      color: var(--text-secondary);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .progress.hidden { display: none; }

    .progress-bar {
      flex: 1;
      height: 6px;
      background: rgba(15, 23, 42, 0.7);
      border-radius: 999px;
      overflow: hidden;
    }

    .progress-bar-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(to right, var(--accent-green), var(--accent-blue));
      transition: width 0.3s ease;
    }

    /* ===== QUESTION BOX ===== */
    .question-box {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 20px;
      border: 1px solid var(--border-color);
      margin: 16px 0;
      position: relative;
    }

    .question-text {
      font-size: 1rem;
      line-height: 1.5;
      color: var(--text-primary);
      padding-right: 40px;
    }

    .question-whatsapp-icon {
      position: absolute;
      top: 16px;
      right: 16px;
      width: 30px;
      height: 30px;
      cursor: pointer;
      background: transparent;
      border: none;
    }
    .question-whatsapp-icon img { width: 100%; height: 100%; object-fit: contain; }

    .question-image-container {
      margin: 15px 0;
      display: none;
      text-align: center;
    }
    .question-image-container.visible { display: block; }
    .question-image { max-width: 100%; max-height: 35vh; object-fit: contain; cursor: zoom-in; }

    .options {
      list-style: none;
      display: grid;
      gap: 8px;
      margin-top: 16px;
    }

    .option {
      display: flex;
      align-items: stretch;
      background: var(--option-bg);
      border-radius: 12px;
      border: 1px solid var(--border-color);
      cursor: pointer;
      transition: all 0.15s ease;
      color: var(--text-primary);
      overflow: hidden;
    }

    .option-label {
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 40px;
      background: var(--surface-light);
      border-right: 1px solid var(--border-color);
      font-weight: 600;
      color: var(--accent-blue);
      padding: 8px;
    }

    .option-content {
      flex: 1;
      padding: 8px 12px;
      display: flex;
      align-items: center;
    }

    .option:hover:not(.disabled) {
      background: var(--hover-bg);
      transform: translateY(-1px);
    }

    .option.correct {
      background: rgba(34, 197, 94, 0.15);
      border-color: var(--accent-green);
    }
    .option.correct .option-label {
      background: rgba(34, 197, 94, 0.2);
      color: var(--accent-green);
    }

    .option.incorrect {
      background: rgba(239, 68, 68, 0.15);
      border-color: #ef4444;
    }
    .option.incorrect .option-label {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
    }

    .option.selected {
      border-color: var(--accent-blue);
      background: rgba(59, 130, 246, 0.1);
    }

    .option.disabled { pointer-events: none; opacity: 0.8; }

    .feedback {
      min-height: 22px;
      font-size: 0.9rem;
      margin-top: 12px;
      padding: 8px 12px;
      border-radius: 8px;
    }

    .feedback.correct {
      color: var(--accent-green);
      background: var(--success-bg);
      border: 1px solid var(--success-border);
    }

    .feedback.incorrect {
      color: #ef4444;
      background: var(--danger-bg);
      border: 1px solid var(--danger-border);
    }

    .explanation {
      margin-top: 10px;
      padding: 10px;
      background: rgba(59, 130, 246, 0.1);
      border-radius: 8px;
      border: 1px solid rgba(59, 130, 246, 0.2);
      font-size: 0.9rem;
      color: var(--accent-blue);
    }

    /* ===== CONTROLS - FIXED LAYOUT ===== */
    .controls {
      margin-top: 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
    }

    .left-controls {
      display: flex;
      gap: 10px;
      flex: 2;
      min-width: 200px;
    }

    .right-controls {
      display: flex;
      justify-content: flex-end;
      flex: 1;
      min-width: 120px;
    }

    #previous-btn, #next-btn {
      flex: 1;
      border-radius: 40px;
      padding: 12px 16px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      background: var(--button-secondary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      min-width: 100px;
    }

    #previous-btn:hover:enabled,
    #next-btn:hover:enabled {
      background: var(--button-secondary-hover);
    }

    #previous-btn:disabled, #next-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    #finish-btn {
      width: 100%;
      border-radius: 40px;
      padding: 12px 16px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(to right, #f59e0b, #d97706);
      color: white;
      border: none;
      box-shadow: 0 4px 12px rgba(245,158,11,0.3);
    }

    #finish-btn:hover:enabled {
      transform: translateY(-1px);
      box-shadow: 0 6px 14px rgba(245,158,11,0.4);
    }

    #finish-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* ===== FINAL SCORE ===== */
    .final-score {
      margin-top: 10px;
      padding: 20px;
      border-radius: 20px;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
    }

    .result-header {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--accent-blue);
      margin-bottom: 15px;
      text-align: center;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 10px;
    }

    .result-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      margin-bottom: 15px;
    }

    .stat-item {
      padding: 10px;
      border-radius: 12px;
      background: rgba(2, 6, 23, 0.3);
      border: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    body.light-mode .stat-item {
      background: #f8fafc;
    }

    .stat-label { font-size: 0.8rem; color: var(--text-muted); }
    .stat-value { font-size: 0.9rem; font-weight: 600; color: var(--text-primary); }
    .stat-percentage { color: var(--accent-green); }
    .stat-time { color: #f59e0b; }

    .result-message {
      font-size: 0.9rem;
      color: var(--text-primary);
      margin-top: 10px;
      padding: 10px;
      border-radius: 8px;
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.2);
      text-align: center;
    }

    .restart-btn, .review-btn, .review-incorrect-btn, .pdf-report-btn, .questions-answers-btn {
      width: 100%;
      border-radius: 40px;
      padding: 12px 16px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      margin-top: 8px;
      border: none;
      color: white;
    }

    .restart-btn { background: linear-gradient(to right, var(--accent-blue), var(--accent-blue-hover)); }
    .review-btn { background: linear-gradient(to right, #8b5cf6, #7c3aed); }
    .review-incorrect-btn { background: linear-gradient(to right, #ef4444, #dc2626); }
    .pdf-report-btn { background: linear-gradient(to right, #dc2626, #b91c1c); }
    .questions-answers-btn { background: linear-gradient(to right, #10b981, #059669); }

    /* ===== ERROR/EXPIRED SCREENS ===== */
    .account-config-error, .subscription-expired {
      background: var(--surface);
      border-radius: 24px;
      padding: 30px;
      box-shadow: var(--shadow);
      border: 1px solid var(--danger-border);
      display: none;
      width: 100%;
      max-width: 500px;
      margin: 0 auto;
    }

    .error-title, .expired-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: #ef4444;
      margin-bottom: 10px;
      text-align: center;
    }

    .error-user-info, .expired-user-info {
      text-align: center;
      margin-bottom: 25px;
      padding: 15px;
      background: var(--danger-bg);
      border-radius: 12px;
      border: 1px solid var(--danger-border);
    }

    .whatsapp-btn {
      background: linear-gradient(to right, #25d366, #128c7e);
      color: white;
      border: none;
      border-radius: 999px;
      padding: 14px 24px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      text-decoration: none;
      width: 100%;
    }

    /* ===== RESPONSIVE FIXES ===== */
    @media (max-width: 600px) {
      .fixed-header { padding: 0 12px; height: 64px; }
      .main-content { margin-top: 80px; padding: 12px; }
      .logo-header { width: 40px; height: 40px; }
      .brand-main { font-size: 1.2rem; }
      .brand-sub { font-size: 0.65rem; }
      .user-info { display: none !important; }
      .side-menu { width: 280px; }
      
      .topic-row {
        flex-direction: column;
        align-items: stretch;
      }
      .start-btn { width: 100%; }
      
      .controls {
        flex-direction: column;
      }
      .left-controls, .right-controls {
        width: 100%;
        min-width: 100%;
      }
      #finish-btn {
        width: 100%;
      }
      
      .class-grid {
        grid-template-columns: 1fr 1fr;
      }
      .subject-grid {
        grid-template-columns: 1fr;
      }
      
      .result-stats {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 380px) {
      .class-grid { grid-template-columns: 1fr; }
      .brand-main { font-size: 1rem; }
    }

    /* ===== LIGHT MODE SPECIFIC FIXES ===== */
    body.light-mode .option {
      border-color: #e2e8f0;
      background: #ffffff;
    }
    body.light-mode .option-label {
      background: #f1f5f9;
      color: #2563eb;
      border-right-color: #e2e8f0;
    }
    body.light-mode .question-number-btn {
      background: #ffffff;
      color: #1e293b;
      border-color: #e2e8f0;
    }
    body.light-mode .question-number-btn.current {
      background: #dbeafe;
      color: #1d4ed8;
      border-color: #3b82f6;
    }
    body.light-mode .question-number-btn.answered {
      background: #dcfce7;
      color: #166534;
      border-color: #22c55e;
    }
    body.light-mode .feedback.correct {
      background: #dcfce7;
      color: #166534;
    }
    body.light-mode .feedback.incorrect {
      background: #fee2e2;
      color: #991b1b;
    }
    body.light-mode .timer-display {
      color: #2563eb;
    }
    body.light-mode .login-btn,
    body.light-mode .start-btn,
    body.light-mode .restart-btn,
    body.light-mode .review-btn,
    body.light-mode .review-incorrect-btn,
    body.light-mode .pdf-report-btn,
    body.light-mode .questions-answers-btn {
      color: white;
    }
    body.light-mode .stat-item {
      background: #f8fafc;
    }
    body.light-mode .topic-select {
      background-color: #ffffff;
    }
    body.light-mode .form-input {
      background-color: #ffffff;
    }
  </style>
</head>
<body>
  <!-- Image Preloading Overlay -->
  <div id="preload-overlay" class="preload-indicator" style="display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(15,23,42,0.95); z-index:9999; display:none; justify-content:center; align-items:center; flex-direction:column;">
    <div style="font-size: 1.5rem; color: #60a5fa; margin-bottom: 20px;">Loading Images...</div>
    <div class="preload-progress" style="width:80%; max-width:400px; background:rgba(30,41,59,0.7); height:8px; border-radius:4px; overflow:hidden;">
      <div id="preload-progress-fill" class="preload-progress-fill" style="height:100%; width:0%; background:linear-gradient(90deg, #3b82f6, #22c55e);"></div>
    </div>
    <div id="preload-status" class="preload-status" style="color:var(--text-primary); margin-top:20px;">Loading images: <span id="preload-count">0/0</span></div>
  </div>

  <!-- PDF Generating Overlay -->
  <div id="pdf-overlay" class="pdf-overlay" style="display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(15,23,42,0.95); z-index:10000; justify-content:center; align-items:center; flex-direction:column;">
    <div class="pdf-spinner" style="border:6px solid rgba(59,130,246,0.3); border-top:6px solid #3b82f6; border-radius:50%; width:50px; height:50px; animation:spin 1s linear infinite; margin-bottom:20px;"></div>
    <div id="pdf-status" class="pdf-status" style="color:var(--text-primary); font-size:1.2rem;">Generating PDF Report...</div>
    <div id="pdf-substatus" class="pdf-substatus" style="color:var(--accent-blue);">Please wait...</div>
  </div>

  <!-- Fixed Header -->
  <div class="fixed-header" style="display: none;">
    <div class="header-left">
      <img src="logo.png" alt="Logo" class="logo-header" onerror="this.src='data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2250%22%20height%3D%2250%22%20viewBox%3D%220%200%2050%2050%22%3E%3Crect%20width%3D%2250%22%20height%3D%2250%22%20fill%3D%22%233b82f6%22%20rx%3D%2210%22%2F%3E%3Ctext%20x%3D%2210%22%20y%3D%2235%22%20font-size%3D%2230%22%20fill%3D%22white%22%3EGS%3C%2Ftext%3E%3C%2Fsvg%3E'">
      <div class="brand-container">
        <span class="brand-main">G.S. Tutorial</span>
        <span class="brand-sub">Interactive Learning App</span>
      </div>
    </div>
    <div class="header-right">
      <div class="user-info" id="header-user-info" style="display: none;">
        <span>üë§</span> <span id="header-username">Guest</span>
      </div>
      <div class="menu-toggle" id="menuToggle">
        <span></span><span></span><span></span>
      </div>
    </div>
  </div>

  <!-- Side Menu -->
  <div class="side-menu" id="sideMenu">
    <div class="side-profile">
      <img src="gobind.png" alt="Gobind Sharma" onerror="this.src='data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22100%22%20height%3D%22100%22%20viewBox%3D%220%200%20100%20100%22%3E%3Ccircle%20cx%3D%2250%22%20cy%3D%2250%22%20r%3D%2250%22%20fill%3D%22%233b82f6%22%2F%3E%3Ctext%20x%3D%2230%22%20y%3D%2270%22%20font-size%3D%2240%22%20fill%3D%22white%22%3EGS%3C%2Ftext%3E%3C%2Fsvg%3E'">
      <div class="side-username" id="sideUsername">Guest</div>
    </div>
    
    <div class="side-dev">
      <p style="color: var(--text-secondary); margin-bottom: 16px; font-weight: 600;">üë®‚Äçüíª Developer</p>
      
      <div class="contact-item" onclick="window.open('https://wa.me/919706195457', '_blank')">
        <img src="whatsapp.png" alt="WhatsApp" onerror="this.src='data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2224%22%20height%3D%2224%22%20viewBox%3D%220%200%2024%2024%22%3E%3Cpath%20fill%3D%22%2325d366%22%20d%3D%22M19.077%204.928C17.191%203.041%2014.683%202%2012.006%202c-5.26%200-9.54%204.28-9.54%209.54%200%201.68.44%203.318%201.278%204.758L2.5%2021.5l5.342-1.403c1.377.744%202.926%201.137%204.523%201.137h.004c5.258%200%209.535-4.28%209.535-9.54%200-2.548-.99-4.944-2.787-6.766zM12.006%2020.05h-.003c-1.415%200-2.802-.38-4.007-1.1l-.287-.17-3.173.834.85-3.1-.185-.3c-.68-1.1-1.04-2.37-1.04-3.67%200-3.95%203.22-7.17%207.18-7.17%201.91%200%203.71.75%205.06%202.11%201.35%201.36%202.1%203.16%202.1%205.08%200%203.96-3.22%207.18-7.18%207.18z%22%2F%3E%3C%2Fsvg%3E'">
        <span>WhatsApp</span>
      </div>
      
      <div class="contact-item" onclick="window.location.href='tel:+919706195457'">
        <img src="phone.png" alt="Call" onerror="this.src='data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2224%22%20height%3D%2224%22%20viewBox%3D%220%200%2024%2024%22%3E%3Cpath%20fill%3D%22%233b82f6%22%20d%3D%22M6.62%2010.79c1.44%202.83%203.76%205.14%206.59%206.59l2.2-2.2c.27-.27.67-.36%201.02-.24%201.12.37%202.33.57%203.57.57.55%200%201%20.45%201%201V20c0%20.55-.45%201-1%201-9.39%200-17-7.61-17-17%200-.55.45-1%201-1h3.5c.55%200%201%20.45%201%201%200%201.25.2%202.45.57%203.57.11.35.03.74-.25%201.02l-2.2%202.2z%22%2F%3E%3C%2Fsvg%3E'">
        <span>+91 97061 95457</span>
      </div>
      
      <div class="contact-item" onclick="window.location.href='mailto:gobind.bngn@gmail.com'">
        <img src="email.png" alt="Email" onerror="this.src='data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2224%22%20height%3D%2224%22%20viewBox%3D%220%200%2024%2024%22%3E%3Cpath%20fill%3D%22%23ea4335%22%20d%3D%22M20%204H4c-1.1%200-2%20.9-2%202v12c0%201.1.9%202%202%202h16c1.1%200%202-.9%202-2V6c0-1.1-.9-2-2-2zm0%204l-8%205-8-5V6l8%205%208-5v2z%22%2F%3E%3C%2Fsvg%3E'">
        <span>gobind.bngn@gmail.com</span>
      </div>
    </div>

    <div class="theme-toggle" id="themeToggle">
      <span>üåô Dark / Light</span>
      <span id="themeIcon">üåô</span>
    </div>

    <div class="logout-side" id="sideLogoutBtn">
      üîì Logout
    </div>
  </div>
  <div class="menu-overlay" id="menuOverlay"></div>

  <!-- Main Content Area -->
  <div class="main-content">
    <!-- Login Container -->
    <div id="login-container">
      <div class="login-box">
        <div class="login-header">
          <img src="logo.png" alt="G. S. Tutorial Logo" class="logo-login" onerror="this.src='data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2270%22%20height%3D%2270%22%20viewBox%3D%220%200%2070%2070%22%3E%3Crect%20width%3D%2270%22%20height%3D%2270%22%20fill%3D%22%233b82f6%22%20rx%3D%2214%22%2F%3E%3Ctext%20x%3D%2215%22%20y%3D%2248%22%20font-size%3D%2240%22%20fill%3D%22white%22%3EGS%3C%2Ftext%3E%3C%2Fsvg%3E'">
          <div class="login-title">G. S. Tutorial</div>
          <div class="login-subtitle">Interactive Learning App ¬∑ Created by Gobind Sharma</div>
        </div>
        
        <form id="login-form" class="login-form">
          <div class="form-group">
            <label for="username">Username</label>
            <input type="text" id="username" class="form-input" placeholder="Enter your username" required autocomplete="username">
          </div>
          
          <div class="form-group">
            <label for="password">Password</label>
            <div class="password-input-wrapper">
              <input type="password" id="password" class="form-input" placeholder="Enter your password" required autocomplete="current-password">
              <button type="button" class="password-toggle" id="password-toggle">üëÅÔ∏è</button>
            </div>
            <div id="attempt-counter" class="attempt-counter" style="display: none;">
              Attempts remaining: <span id="attempts-remaining">3</span>
            </div>
            <div id="cooldown-message" class="cooldown-message" style="display: none;">
              Too many failed attempts. Please wait <span id="cooldown-timer">30</span> seconds.
            </div>
          </div>
          
          <div id="login-error" class="login-error"></div>
          
          <button type="submit" class="login-btn" id="login-btn">Login</button>
          
          <a href="https://wa.me/919706195457?text=Hello%20Admin,%20I%20need%20login%20credentials%20for%20G.S.%20Tutorial%20App.%20Please%20create%20username%20and%20password%20for%20me." 
             class="request-credentials-btn" target="_blank">
            <img src="whatsapp.png" alt="WhatsApp" style="width: 24px; height: 24px;" onerror="this.style.display='none'">
            Request Login Credentials
          </a>
        </form>
        
        <div class="config-info">¬© 2025 G.S. Tutorial. All rights reserved.</div>
      </div>
    </div>
    
    <!-- Account Configuration Error Screen -->
    <div class="account-config-error" id="account-config-error">
      <div class="error-header">
        <div class="error-title">Account Configuration Required</div>
        <div class="error-subtitle">G.S. Tutorial ‚Äì Interactive Learning</div>
      </div>
      
      <div class="error-user-info">
        Hello <strong id="error-username">User</strong>!<br>
        Your account (Role: <strong id="error-role">User</strong>) requires proper configuration.
      </div>
      
      <div class="error-details">
        <ul id="error-list">
          <li>There seems to be an issue with your account configuration.</li>
          <li>Please contact the administrator to resolve this issue.</li>
        </ul>
      </div>
      
      <a href="https://wa.me/919706195457?text=Hello%20Admin,%20I%20need%20help%20with%20my%20account%20configuration%20for%20G.S.%20Tutorial.%20Username:%20" 
         class="whatsapp-btn" id="whatsapp-btn" target="_blank">
        <img src="whatsapp.png" alt="WhatsApp" style="width: 24px; height: 24px;" onerror="this.style.display='none'">
        Contact Admin on WhatsApp
      </a>
      
      <button class="back-to-login-btn" id="back-to-login-btn">‚Üê Back to Login</button>
    </div>
    
    <!-- Subscription Expired Screen -->
    <div class="subscription-expired" id="subscription-expired">
      <div class="expired-header">
        <div class="expired-title">Subscription Expired</div>
        <div class="expired-subtitle">G.S. Tutorial ‚Äì Interactive Learning</div>
      </div>
      
      <div class="expired-user-info">
        Hello <strong id="expired-username">User</strong>!<br>
        Your account access has expired.
      </div>
      
      <div class="expired-details">
        <p><strong>Joining Date:</strong> <span id="expired-joining-date">Not available</span></p>
        <p><strong>Expiry Date:</strong> <span id="expired-last-date">Not available</span></p>
        <p>Your trial period or subscription has ended. To continue using G.S. Tutorial, please contact the administrator to extend your access.</p>
      </div>
      
      <a href="https://wa.me/919706195457?text=Hello%20Admin,%20my%20G.S.%20Tutorial%20subscription%20has%20expired.%20Username:%20" 
         class="whatsapp-btn" id="expired-whatsapp-btn" target="_blank">
        <img src="whatsapp.png" alt="WhatsApp" style="width: 24px; height: 24px;" onerror="this.style.display='none'">
        Contact Admin
      </a>
      
      <button class="back-to-login-btn" id="back-to-login-from-expired-btn">‚Üê Back to Login</button>
    </div>
    
    <!-- Class Selection Screen -->
    <div class="class-selection" id="class-selection">
      <div class="greeting-message" id="greetingMessage"></div>
      <div class="class-title">SELECT YOUR CLASS</div>
      <div class="class-grid" id="class-grid"></div>
    </div>
    
    <!-- Subject Selection Screen -->
    <div class="subject-selection" id="subject-selection">
      <div class="screen-header">
        <div class="screen-title">Select Subject</div>
        <div class="screen-subtitle" id="current-class-display">Class</div>
      </div>
      <div class="subject-grid" id="subject-grid"></div>
      <button class="back-btn" id="back-to-classes-btn">‚Üê Back to Classes</button>
    </div>
    
    <!-- Quiz Container -->
    <div class="quiz-container" id="quiz-container">
      <div id="current-path" class="current-path" style="display: none;"></div>
      
      <div class="topic-section">
        <div class="topic-info">
          <div class="topic-name" id="quiz-topic-name">No chapter selected</div>
          <div class="question-count" id="quiz-question-count">0 questions</div>
        </div>
        <div class="topic-row">
          <select id="topic-select" class="topic-select"><option value="">Loading chapters...</option></select>
          <button class="start-btn" id="start-btn" disabled>Start</button>
        </div>
      </div>

      <div id="question-navigation" class="question-navigation collapsed">
        <div class="navigation-header">
          <span class="navigation-title">üìã Question Navigation</span>
          <button id="navigation-toggle-btn" class="navigation-toggle-btn collapsed">‚ñ∂ Show</button>
        </div>
        <div id="question-grid" class="question-grid"></div>
        <div id="navigation-stats" class="navigation-stats"></div>
      </div>

      <div id="timer-container" class="timer-container" style="display: none;">
        <span class="timer-label">‚è±Ô∏è Time Remaining:</span>
        <span id="timer-display" class="timer-display">--:--:--</span>
      </div>

      <div class="toggle-row">
        <input type="checkbox" id="random-toggle" checked />
        <label for="random-toggle">Randomize questions & options</label>
      </div>

      <div class="progress">
        <span id="question-counter">Choose a chapter and click Start</span>
        <div class="progress-bar"><div id="progress-bar-fill" class="progress-bar-fill"></div></div>
        <span id="score-mini">Score: 0</span>
      </div>

      <div class="question-box" id="question-box">
        <button id="question-whatsapp-icon" class="question-whatsapp-icon" style="display: none;" title="Report issue or ask about this question">
          <img src="whatsapp.png" alt="WhatsApp Support">
        </button>
        <div class="question-whatsapp-reserved-area"></div>
        
        <div id="question-text" class="question-text">Please select a chapter to start.</div>
        
        <div id="question-image-container" class="question-image-container">
          <img id="question-image" class="question-image" src="" alt="Question Image" onclick="toggleImageZoom(this)">
          <div id="image-loading" class="image-loading" style="display: none;">Loading image...</div>
          <div id="image-error" class="image-error" style="display: none;">Image not available</div>
        </div>
        
        <ul id="options-list" class="options"></ul>
        <div id="feedback" class="feedback"></div>
      </div>

      <div class="controls">
        <div class="left-controls">
          <button id="previous-btn" disabled>‚Üê Previous</button>
          <button id="next-btn" disabled>Next ‚Üí</button>
        </div>
        <div class="right-controls">
          <button id="finish-btn" disabled>Submit</button>
        </div>
      </div>

      <div class="score-box">
        <div id="final-score" class="final-score" style="display:none;"></div>
      </div>
    </div>
  </div>

  <script>
    // ========== APPS SCRIPT CONFIGURATION ==========
    const AUTH_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx06h9aa6wDmtDz3jBwNgOuoiz7-NZY1nJaEwts3A7vIHRkWfAU5O3N4UNUooCwvEm7Lw/exec';
    const MASTER_CONFIG_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw2CCk6wZgSWwLVyi4-6izf0DNIvcG-E64_jfsT0TgclHZ_PIevnAEdLq6B2Ccc6ABK/exec';

    // ========== CACHE CONFIGURATION ==========
    let ALL_CONFIG_CACHE = null;
    let ALL_CONFIG_CACHE_TIME = null;
    const CACHE_DURATION = 30 * 60 * 1000; // 30 minutes

    // ========== GLOBAL VARIABLES ==========
    let questions = [];
    let currentIndex = 0;
    let score = 0;
    let hasAnswered = false;
    let questionsLoaded = false;
    let attempted = 0;
    let userAnswers = [];
    let timeRemaining = 0;
    let timerInterval = null;
    let currentTopicName = "";
    let timerDuration = 0;
    let quizStartTime = null;
    let timerNotification = null;
    let isReviewMode = false;
    let isIncorrectReviewMode = false;
    let incorrectQuestionIndices = [];
    
    // Image preloading system
    let imageCache = new Map();
    let totalImagesToPreload = 0;
    let imagesPreloaded = 0;
    
    // Login system variables
    let currentUser = null;
    let inactivityTimer = null;
    const INACTIVITY_TIMEOUT = 10 * 60 * 1000; // 10 minutes
    
    // Login attempt tracking
    let failedAttempts = 0;
    const MAX_ATTEMPTS = 3;
    const COOLDOWN_TIME = 30;
    let isOnCooldown = false;
    let cooldownTimer = null;
    
    // Navigation variables
    let currentClass = "";
    let currentSubject = "";
    let chaptersList = [];
    let currentSubjectConfig = null;
    
    // Logging
    let userIP = 'Unknown';
    let currentQuizStats = null;
    
    // Notification tracking
    let hasSentLoginNotification = false;
    let hasSentQuizResultNotification = false;
    let currentQuizSessionId = null;

    // Telegram config
    let TELEGRAM_CONFIG = { ENABLED: false, BOT_TOKEN: '', CHAT_ID: '' };

    // Admin config
    let ADMIN_CONFIG = { NOTIFY_ON_LOGIN: false, NOTIFY_ON_QUIZ_RESULT: false };

    // ========== DOM ELEMENTS ==========
    const fixedHeaderEl = document.querySelector(".fixed-header");
    const headerUserInfoEl = document.getElementById("header-user-info");
    const headerUsernameEl = document.getElementById("header-username");
    
    const loginContainerEl = document.getElementById("login-container");
    const classSelectionEl = document.getElementById("class-selection");
    const subjectSelectionEl = document.getElementById("subject-selection");
    const quizContainerEl = document.getElementById("quiz-container");
    const accountConfigErrorEl = document.getElementById("account-config-error");
    const subscriptionExpiredEl = document.getElementById("subscription-expired");
    
    const loginFormEl = document.getElementById("login-form");
    const usernameEl = document.getElementById("username");
    const passwordEl = document.getElementById("password");
    const passwordToggleEl = document.getElementById("password-toggle");
    const loginErrorEl = document.getElementById("login-error");
    const loginBtnEl = document.getElementById("login-btn");
    const attemptCounterEl = document.getElementById("attempt-counter");
    const attemptsRemainingEl = document.getElementById("attempts-remaining");
    const cooldownMessageEl = document.getElementById("cooldown-message");
    const cooldownTimerEl = document.getElementById("cooldown-timer");
    
    const accountConfigErrorUsernameEl = document.getElementById("error-username");
    const accountConfigErrorRoleEl = document.getElementById("error-role");
    const accountConfigErrorListEl = document.getElementById("error-list");
    const whatsappBtnEl = document.getElementById("whatsapp-btn");
    const backToLoginBtnEl = document.getElementById("back-to-login-btn");
    
    const expiredUsernameEl = document.getElementById("expired-username");
    const expiredJoiningDateEl = document.getElementById("expired-joining-date");
    const expiredLastDateEl = document.getElementById("expired-last-date");
    const expiredWhatsappBtnEl = document.getElementById("expired-whatsapp-btn");
    const backToLoginFromExpiredBtn = document.getElementById("back-to-login-from-expired-btn");
    
    const classGridEl = document.getElementById("class-grid");
    const subjectGridEl = document.getElementById("subject-grid");
    const currentClassDisplayEl = document.getElementById("current-class-display");
    const backToClassesBtn = document.getElementById("back-to-classes-btn");
    const currentPathEl = document.getElementById("current-path");
    
    const topicSelectEl = document.getElementById("topic-select");
    const startBtnEl = document.getElementById("start-btn");
    const randomToggleEl = document.getElementById("random-toggle");
    const toggleRowEl = document.querySelector(".toggle-row");
    const quizTopicNameEl = document.getElementById("quiz-topic-name");
    const quizQuestionCountEl = document.getElementById("quiz-question-count");
    const timerContainerEl = document.getElementById("timer-container");
    const timerDisplayEl = document.getElementById("timer-display");
    
    const questionNavigationEl = document.getElementById("question-navigation");
    const questionGridEl = document.getElementById("question-grid");
    const navigationToggleBtn = document.getElementById("navigation-toggle-btn");
    const navigationStatsEl = document.getElementById("navigation-stats");
    
    const questionTextEl = document.getElementById("question-text");
    const questionBoxEl = document.getElementById("question-box");
    const questionImageContainerEl = document.getElementById("question-image-container");
    const questionImageEl = document.getElementById("question-image");
    const imageLoadingEl = document.getElementById("image-loading");
    const imageErrorEl = document.getElementById("image-error");
    
    const optionsListEl = document.getElementById("options-list");
    const feedbackEl = document.getElementById("feedback");
    const nextBtn = document.getElementById("next-btn");
    const previousBtn = document.getElementById("previous-btn");
    const finishBtn = document.getElementById("finish-btn");
    const questionCounterEl = document.getElementById("question-counter");
    const progressEl = document.querySelector(".progress");
    const progressBarFillEl = document.getElementById("progress-bar-fill");
    const scoreMiniEl = document.getElementById("score-mini");
    const finalScoreEl = document.getElementById("final-score");
    const controlsEl = document.querySelector(".controls");
    
    const preloadOverlayEl = document.getElementById("preload-overlay");
    const preloadProgressFillEl = document.getElementById("preload-progress-fill");
    const preloadStatusEl = document.getElementById("preload-status");
    const preloadCountEl = document.getElementById("preload-count");
    
    const pdfOverlayEl = document.getElementById("pdf-overlay");
    const pdfStatusEl = document.getElementById("pdf-status");
    const pdfSubstatusEl = document.getElementById("pdf-substatus");

    const questionWhatsappIconEl = document.getElementById("question-whatsapp-icon");

    // Side menu elements
    const menuToggle = document.getElementById('menuToggle');
    const sideMenu = document.getElementById('sideMenu');
    const menuOverlay = document.getElementById('menuOverlay');
    const sideUsername = document.getElementById('sideUsername');
    const sideLogoutBtn = document.getElementById('sideLogoutBtn');
    const themeToggle = document.getElementById('themeToggle');
    const themeIcon = document.getElementById('themeIcon');
    const metaThemeColor = document.getElementById('meta-theme-color');
    const greetingMessageEl = document.getElementById('greetingMessage');

    // ========== PASSWORD TOGGLE FUNCTION ==========
    function togglePasswordVisibility() {
      if (passwordEl.type === 'password') {
        passwordEl.type = 'text';
        passwordToggleEl.textContent = 'üôà';
      } else {
        passwordEl.type = 'password';
        passwordToggleEl.textContent = 'üëÅÔ∏è';
      }
    }
    passwordToggleEl.addEventListener("click", togglePasswordVisibility);

    // ========== HELPER FUNCTIONS ==========
    function formatDisplayDate(val) {
      if (!val) return "Not available";
      try {
        let d = null;
        if (typeof val === "string" && val.startsWith("Date(")) {
          const parts = val.replace("Date(", "").replace(")", "").split(",").map(Number);
          d = new Date(parts[0], parts[1], parts[2]);
        } else {
          d = new Date(val);
        }
        if (!d || isNaN(d.getTime())) return "Not available";
        return d.toLocaleDateString("en-GB", { day: "numeric", month: "short", year: "numeric" });
      } catch (e) {
        return "Not available";
      }
    }

    function getSubjectIcon(subject) {
      const s = subject.toLowerCase();
      if (s.includes('math')) return 'üìê';
      if (s.includes('science')) return 'üî¨';
      if (s.includes('physics')) return '‚ö°';
      if (s.includes('chem')) return 'üß™';
      if (s.includes('bio')) return 'üß¨';
      if (s.includes('mech')) return '‚öôÔ∏è';
      if (s.includes('elect')) return '‚ö°';
      if (s.includes('english')) return 'üìñ';
      if (s.includes('social')) return 'üåç';
      return 'üìö';
    }

    function getSubjectDescription(subject) {
      const s = subject.toLowerCase();
      if (s.includes('math')) return 'Mathematics - Numbers, Algebra, Geometry';
      if (s.includes('science')) return 'Science - Physics, Chemistry, Biology';
      if (s.includes('physics')) return 'Physics - Laws of motion, Energy';
      if (s.includes('chem')) return 'Chemistry - Elements, Reactions';
      if (s.includes('bio')) return 'Biology - Life processes, Cells';
      if (s.includes('mech')) return 'Mechanical Engineering - Machines';
      if (s.includes('elect')) return 'Electrical Engineering - Circuits';
      return 'Interactive Learning';
    }

    // ========== LOAD ALL CONFIG AT ONCE (CACHED) ==========
    async function loadAllConfigAtOnce() {
      if (ALL_CONFIG_CACHE && ALL_CONFIG_CACHE_TIME && (Date.now() - ALL_CONFIG_CACHE_TIME < CACHE_DURATION)) {
        return ALL_CONFIG_CACHE;
      }
      try {
        const data = await jsonpRequest(MASTER_CONFIG_APPS_SCRIPT_URL + '?action=getAllConfig', 'allConfigCallback');
        if (data.success) {
          ALL_CONFIG_CACHE = data;
          ALL_CONFIG_CACHE_TIME = Date.now();
          return data;
        } else throw new Error(data.error || 'Failed to load config');
      } catch (error) {
        console.error("Error loading all config:", error);
        return null;
      }
    }

    // ========== JSONP HELPER ==========
    function jsonpRequest(url, callbackName) {
      return new Promise((resolve, reject) => {
        const uniqueCallback = callbackName + '_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        const script = document.createElement('script');
        window[uniqueCallback] = function(data) {
          delete window[uniqueCallback];
          document.body.removeChild(script);
          if (data && data.success) resolve(data);
          else reject(data?.error || 'Unknown error');
        };
        script.onerror = () => {
          delete window[uniqueCallback];
          document.body.removeChild(script);
          reject('Network error');
        };
        const separator = url.includes('?') ? '&' : '?';
        script.src = `${url}${separator}callback=${uniqueCallback}`;
        document.body.appendChild(script);
        setTimeout(() => {
          if (window[uniqueCallback]) {
            delete window[uniqueCallback];
            document.body.removeChild(script);
            reject('Request timeout');
          }
        }, 10000);
      });
    }

    // ========== AUTHENTICATION ==========
    async function authenticateWithAppsScript(username, password) {
      try {
        return new Promise((resolve, reject) => {
          const callbackName = 'authCallback_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
          const script = document.createElement('script');
          window[callbackName] = function(data) {
            delete window[callbackName];
            document.body.removeChild(script);
            if (data && data.success) resolve(data);
            else resolve({ success: false, error: data?.error || 'Invalid username or password' });
          };
          script.onerror = function() {
            delete window[callbackName];
            document.body.removeChild(script);
            resolve({ success: false, error: 'Network error. Please check your connection.' });
          };
          const url = `${AUTH_APPS_SCRIPT_URL}?action=authenticate&username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}&callback=${callbackName}`;
          script.src = url;
          document.body.appendChild(script);
          setTimeout(() => {
            if (window[callbackName]) {
              delete window[callbackName];
              document.body.removeChild(script);
              resolve({ success: false, error: 'Request timeout. Please try again.' });
            }
          }, 10000);
        });
      } catch (error) {
        return { success: false, error: 'Cannot connect to authentication server.' };
      }
    }

    // ========== LOAD TELEGRAM CONFIG ==========
    async function loadTelegramConfig() {
      try {
        const data = await jsonpRequest(MASTER_CONFIG_APPS_SCRIPT_URL + '?action=getTelegramConfig', 'telegramCallback');
        if (data.success) {
          TELEGRAM_CONFIG.ENABLED = data.enabled;
          TELEGRAM_CONFIG.BOT_TOKEN = data.botToken;
          TELEGRAM_CONFIG.CHAT_ID = data.chatId;
        }
      } catch (error) {
        console.error("Error loading Telegram config:", error);
      }
    }

    // ========== LOAD CLASSES ==========
    async function loadClasses() {
      try {
        classGridEl.innerHTML = `<div class="loading-container"><div class="loading-spinner"></div><div class="loading-text">Loading classes...</div></div>`;
        const allData = await loadAllConfigAtOnce();
        if (!allData || !allData.classes) throw new Error("No classes data");
        let availableClasses = allData.classes;
        if (currentUser && currentUser.role !== 'Admin') {
          const assignedClasses = currentUser.validatedAssignedClasses || [];
          availableClasses = allData.classes.filter(cls => 
            assignedClasses.some(assigned => assigned.toString().trim() === cls.id.toString().trim())
          );
        }
        renderClassGrid(availableClasses);
      } catch (error) {
        classGridEl.innerHTML = `<div style="text-align:center; padding:40px; color:#fca5a5;">Error loading classes</div>`;
      }
    }

    function renderClassGrid(classes) {
      classGridEl.innerHTML = "";
      if (classes.length === 0) {
        classGridEl.innerHTML = `<div style="text-align:center; padding:40px; color:var(--text-muted);">No classes available</div>`;
        return;
      }
      classes.forEach(cls => {
        const card = document.createElement("div");
        card.className = "class-card";
        card.innerHTML = `<div class="class-icon">${cls.icon}</div><div class="class-name">${cls.name}</div><div class="class-desc">${cls.description || ""}</div>`;
        card.addEventListener("click", () => { showSubjectSelection(cls.id); resetInactivityTimer(); });
        classGridEl.appendChild(card);
      });
    }

    // ========== LOAD SUBJECTS ==========
    async function loadSubjects() {
      try {
        subjectGridEl.innerHTML = `<div class="loading-container"><div class="loading-spinner"></div><div class="loading-text">Loading subjects...</div></div>`;
        const allData = await loadAllConfigAtOnce();
        const subjects = [];
        if (allData && allData.config) {
          const subjectSet = new Set();
          for (const key in allData.config) {
            if (key.startsWith(currentClass + '_')) {
              const subject = key.split('_')[1];
              subjectSet.add(subject);
            }
          }
          Array.from(subjectSet).forEach(subject => {
            subjects.push({
              id: subject,
              name: subject.charAt(0).toUpperCase() + subject.slice(1),
              icon: getSubjectIcon(subject),
              desc: getSubjectDescription(subject)
            });
          });
        }
        renderSubjectGrid(subjects);
      } catch (error) {
        subjectGridEl.innerHTML = `<div style="text-align:center; padding:40px; color:#fca5a5;">Error loading subjects</div>`;
      }
    }

    function renderSubjectGrid(subjects) {
      subjectGridEl.innerHTML = "";
      if (subjects.length === 0) {
        subjectGridEl.innerHTML = `<div style="text-align:center; padding:40px; color:var(--text-muted);">No subjects available</div>`;
        return;
      }
      subjects.forEach(subject => {
        const card = document.createElement("div");
        card.className = "subject-card";
        card.innerHTML = `<div class="subject-icon">${subject.icon}</div><div class="subject-name">${subject.name}</div><div class="subject-desc">${subject.desc}</div>`;
        card.addEventListener("click", () => { currentSubject = subject.name; showQuizContainer(currentSubject); resetInactivityTimer(); });
        subjectGridEl.appendChild(card);
      });
    }

    // ========== LOAD CHAPTERS ==========
    async function loadChapters() {
      try {
        topicSelectEl.innerHTML = '<option value="">Loading chapters...</option>';
        startBtnEl.disabled = true;
        const allData = await loadAllConfigAtOnce();
        const key = `${currentClass}_${currentSubject.toLowerCase()}`;
        if (allData && allData.config && allData.config[key]) {
          currentSubjectConfig = { sheetId: allData.config[key].sheetId, chapters: allData.config[key].chapters };
          chaptersList = Object.keys(currentSubjectConfig.chapters || {});
          if (chaptersList.length === 0) throw new Error(`No chapters found for ${currentSubject}`);
          topicSelectEl.innerHTML = '<option value="">-- Select Chapter --</option>';
          chaptersList.forEach(chapter => {
            const option = document.createElement("option");
            option.value = chapter.trim();
            option.textContent = chapter.trim();
            topicSelectEl.appendChild(option);
          });
          startBtnEl.disabled = false;
          quizTopicNameEl.textContent = "No chapter selected";
          quizQuestionCountEl.textContent = `${chaptersList.length} chapters available`;
          questionTextEl.textContent = "Select a chapter to start.";
        } else throw new Error(`No config found for ${currentClass} ${currentSubject}`);
      } catch (err) {
        topicSelectEl.innerHTML = `<option value="">-- Error Loading Chapters --</option>`;
        quizTopicNameEl.textContent = "Error loading chapters";
        quizTopicNameEl.style.cssText = "background:rgba(239,68,68,0.1);border-color:rgba(239,68,68,0.5);color:#fca5a5";
        quizQuestionCountEl.textContent = "0 chapters";
        questionTextEl.textContent = err.message;
        startBtnEl.disabled = true;
      }
      resetInactivityTimer();
    }

    // ========== GET USER IP ==========
    async function getUserIP() {
      try {
        const response = await fetch('https://api.ipify.org?format=json');
        const data = await response.json();
        userIP = data.ip;
      } catch (error) {}
    }

    // ========== SESSION MANAGEMENT ==========
    function saveSession() {
      if (currentUser) {
        localStorage.setItem('gs_tutorial_session', JSON.stringify({ user: currentUser, timestamp: Date.now(), lastActivity: Date.now() }));
      }
    }

    function loadSession() {
      const sessionData = localStorage.getItem('gs_tutorial_session');
      if (sessionData) {
        try {
          const data = JSON.parse(sessionData);
          if ((Date.now() - data.lastActivity) < INACTIVITY_TIMEOUT && (Date.now() - data.timestamp) < 24*60*60*1000) {
            currentUser = data.user;
            data.lastActivity = Date.now();
            localStorage.setItem('gs_tutorial_session', JSON.stringify(data));
            return true;
          }
        } catch (e) {}
      }
      clearSession();
      return false;
    }

    function clearSession() { localStorage.removeItem('gs_tutorial_session'); }
    function updateLastActivity() {
      const sessionData = localStorage.getItem('gs_tutorial_session');
      if (sessionData && currentUser) {
        try {
          const data = JSON.parse(sessionData);
          data.lastActivity = Date.now();
          localStorage.setItem('gs_tutorial_session', JSON.stringify(data));
        } catch (e) {}
      }
    }

    // ========== LOGIN ATTEMPT TRACKING ==========
    function resetFailedAttempts() {
      failedAttempts = 0;
      isOnCooldown = false;
      attemptCounterEl.style.display = 'none';
      cooldownMessageEl.style.display = 'none';
      if (cooldownTimer) { clearInterval(cooldownTimer); cooldownTimer = null; }
    }

    function updateAttemptCounter() {
      const remaining = MAX_ATTEMPTS - failedAttempts;
      attemptsRemainingEl.textContent = remaining;
      if (failedAttempts > 0) {
        attemptCounterEl.style.display = 'flex';
        attemptCounterEl.className = remaining <= 1 ? 'attempt-counter critical' : remaining <= 2 ? 'attempt-counter warning' : 'attempt-counter';
      } else attemptCounterEl.style.display = 'none';
    }

    function startCooldown() {
      isOnCooldown = true;
      loginBtnEl.disabled = true;
      cooldownMessageEl.style.display = 'block';
      attemptCounterEl.style.display = 'none';
      let seconds = COOLDOWN_TIME;
      cooldownTimerEl.textContent = seconds;
      cooldownTimer = setInterval(() => {
        seconds--;
        cooldownTimerEl.textContent = seconds;
        if (seconds <= 0) {
          clearInterval(cooldownTimer);
          isOnCooldown = false;
          loginBtnEl.disabled = false;
          cooldownMessageEl.style.display = 'none';
          resetFailedAttempts();
          usernameEl.focus();
        }
      }, 1000);
    }

    function recordFailedAttempt() {
      failedAttempts++;
      updateAttemptCounter();
      if (failedAttempts >= MAX_ATTEMPTS) startCooldown();
    }

    // ========== VALIDATION ==========
    function validateUserAccount(user) {
      const validRoles = ['Admin', 'Teacher', 'User', 'Student'];
      if (!validRoles.includes(user.role)) return { valid: false, error: 'invalid_role' };
      const userClassValue = user.class || "";
      const assignedClasses = userClassValue.split(',').map(c => c.trim()).filter(c => c && c.toLowerCase() !== 'none' && c.toLowerCase() !== 'null');
      if (user.role === 'Admin') return { valid: true, assignedClasses: [] };
      if (user.role === 'Teacher' || user.role === 'User') {
        if (assignedClasses.length === 0) return { valid: false, error: 'no_class_assigned', assignedClasses: [] };
        return { valid: true, assignedClasses: assignedClasses };
      }
      if (user.role === 'Student') {
        if (assignedClasses.length === 0) return { valid: false, error: 'no_class_assigned', assignedClasses: [] };
        return { valid: true, assignedClasses: [assignedClasses[0]] };
      }
      return { valid: false, error: 'unknown' };
    }

    // ========== SUBSCRIPTION EXPIRED ==========
    function showSubscriptionExpired(user, joiningDate, lastDate) {
      expiredUsernameEl.textContent = user.name;
      expiredJoiningDateEl.textContent = formatDisplayDate(joiningDate);
      expiredLastDateEl.textContent = formatDisplayDate(lastDate);
      const msg = `Hello Admin, my G.S. Tutorial subscription has expired. Username: ${user.username}`;
      expiredWhatsappBtnEl.href = `https://wa.me/919706195457?text=${encodeURIComponent(msg)}`;
      fixedHeaderEl.style.display = "none";
      loginContainerEl.style.display = "none";
      classSelectionEl.style.display = "none";
      subjectSelectionEl.style.display = "none";
      quizContainerEl.style.display = "none";
      accountConfigErrorEl.style.display = "none";
      subscriptionExpiredEl.style.display = "block";
      resetInactivityTimer();
    }

    // ========== ACCOUNT CONFIG ERROR ==========
    function showAccountConfigError(user, errorType, errorDetails = {}) {
      accountConfigErrorUsernameEl.textContent = user.name;
      accountConfigErrorRoleEl.textContent = user.role;
      const msg = `Hello Admin, I need help with my account configuration for G.S. Tutorial. Username: ${user.username}`;
      whatsappBtnEl.href = `https://wa.me/919706195457?text=${encodeURIComponent(msg)}`;
      let errorListHTML = '';
      switch(errorType) {
        case 'invalid_role':
          errorListHTML = `<li><strong>Invalid Role:</strong> Your role is set to "${user.role}" which is not recognized. Valid roles: Admin, Teacher, User, Student.</li>`;
          break;
        case 'no_class_assigned':
          errorListHTML = `<li><strong>No Class Assigned:</strong> As a ${user.role}, you need to be assigned to a class.</li>`;
          break;
        default:
          errorListHTML = `<li>There seems to be an issue with your account configuration. Please contact the administrator.</li>`;
      }
      accountConfigErrorListEl.innerHTML = errorListHTML;
      fixedHeaderEl.style.display = "none";
      loginContainerEl.style.display = "none";
      classSelectionEl.style.display = "none";
      subjectSelectionEl.style.display = "none";
      quizContainerEl.style.display = "none";
      subscriptionExpiredEl.style.display = "none";
      accountConfigErrorEl.style.display = "block";
      resetInactivityTimer();
    }

    // ========== WHATSAPP SUPPORT ==========
    function setupQuestionWhatsAppSupport() {
      if (!questionWhatsappIconEl) return;
      questionWhatsappIconEl.addEventListener("click", function() {
        if (!currentUser || !questionsLoaded || questions.length === 0 || currentIndex >= questions.length) {
          alert("Question information not available.");
          return;
        }
        const q = questions[currentIndex];
        let optionsText = "";
        q.options.forEach((opt, idx) => {
          optionsText += `${String.fromCharCode(65 + idx)}. ${opt}${idx === q.correctIndex ? " ‚úÖ" : ""}\n`;
        });
        const message = `Hello Admin,\n\nI have a question regarding:\n\nüë§ Name: ${currentUser.name} (${currentUser.username})\nüè´ Class: ${currentClass}\nüìö Subject: ${currentSubject}\nüìñ Chapter: ${currentTopicName}\n\n‚ùì Question: ${q.question}\n\nüìù Options:\n${optionsText}\n‚úÖ Correct: ${String.fromCharCode(65 + q.correctIndex)}. ${q.options[q.correctIndex]}\n\nüìã My Concern: `;
        window.open(`https://wa.me/919706195457?text=${encodeURIComponent(message)}`, '_blank');
        resetInactivityTimer();
      });
    }

    // ========== PDF REPORT FUNCTIONS ==========
    function showPDFOverlay(msg = "Generating PDF Report...") { pdfStatusEl.textContent = msg; pdfOverlayEl.style.display = 'flex'; }
    function hidePDFOverlay() { pdfOverlayEl.style.display = 'none'; }
    function updatePDFStatus(msg, sub = "") { pdfStatusEl.textContent = msg; if (sub) pdfSubstatusEl.textContent = sub; }
    function getPerformanceRemark(p) {
      if (p >= 80) return "OUTSTANDING! Excellent performance!";
      if (p >= 60) return "GOOD JOB! Solid performance.";
      if (p >= 40) return "SATISFACTORY. Practice more.";
      return "NEEDS IMPROVEMENT. Study thoroughly.";
    }

    // ========== TELEGRAM NOTIFICATIONS ==========
    async function sendLoginNotification(user) {
      if (hasSentLoginNotification || user.role === 'Admin' && !ADMIN_CONFIG.NOTIFY_ON_LOGIN || !TELEGRAM_CONFIG.ENABLED) return;
      const now = new Date();
      const msg = `‚îÅ‚îÅ‚îÅ‚îÅ üî¥ User Login üî¥ ‚îÅ‚îÅ‚îÅ‚îÅ\n\nüü† Name: ${user.name}\nüü† Username: ${user.username}\nüü† Class: ${user.class || 'Not assigned'}\nüü† Role: ${user.role}\n\nüìÖ Date: ${now.toLocaleDateString('en-IN')}\n‚è∞ Time: ${now.toLocaleTimeString('en-IN')}\n\nüåê IP: ${userIP}`;
      const sent = await sendTelegramMessage(msg);
      if (sent) hasSentLoginNotification = true;
    }

    async function sendQuizResultNotification(stats) {
      if (hasSentQuizResultNotification || currentUser.role === 'Admin' && !ADMIN_CONFIG.NOTIFY_ON_QUIZ_RESULT || !TELEGRAM_CONFIG.ENABLED) return;
      const now = new Date();
      const msg = `‚îÅ‚îÅ‚îÅ‚îÅ üü† Student Result üü† ‚îÅ‚îÅ‚îÅ‚îÅ\n\nüü¢ Name: ${currentUser.name}\nüü¢ Username: ${currentUser.username}\nüü¢ Class: ${currentClass}\nüü¢ Subject: ${currentSubject}\n\nüìñ Chapter: ${currentTopicName}\nüìã Total: ${stats.total}\nüìù Attempted: ${stats.attempted}\n‚úÖ Correct: ${stats.correct}\n\n‚è±Ô∏è Time: ${stats.timeTaken || "N/A"}\nüìà Percentage: ${stats.percentage}%\n\nüìÖ Date: ${now.toLocaleDateString('en-IN')}`;
      const sent = await sendTelegramMessage(msg);
      if (sent) hasSentQuizResultNotification = true;
    }

    async function sendTelegramMessage(message) {
      if (!TELEGRAM_CONFIG.ENABLED || !TELEGRAM_CONFIG.BOT_TOKEN || !TELEGRAM_CONFIG.CHAT_ID) return false;
      try {
        const url = `https://api.telegram.org/bot${TELEGRAM_CONFIG.BOT_TOKEN}/sendMessage`;
        const response = await fetch(url, {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ chat_id: TELEGRAM_CONFIG.CHAT_ID, text: message, parse_mode: 'Markdown' })
        });
        return response.ok;
      } catch { return false; }
    }

    async function sendPDFToTelegram(pdfBase64, fileName) {
      if (!TELEGRAM_CONFIG.ENABLED || !TELEGRAM_CONFIG.BOT_TOKEN || !TELEGRAM_CONFIG.CHAT_ID) return false;
      try {
        const url = `https://api.telegram.org/bot${TELEGRAM_CONFIG.BOT_TOKEN}/sendDocument`;
        const byteCharacters = atob(pdfBase64);
        const byteNumbers = new Array(byteCharacters.length);
        for (let i = 0; i < byteCharacters.length; i++) byteNumbers[i] = byteCharacters.charCodeAt(i);
        const blob = new Blob([new Uint8Array(byteNumbers)], { type: 'application/pdf' });
        const formData = new FormData();
        formData.append('chat_id', TELEGRAM_CONFIG.CHAT_ID);
        formData.append('document', blob, fileName);
        const response = await fetch(url, { method: 'POST', body: formData });
        return response.ok;
      } catch { return false; }
    }

    // ========== IMAGE HANDLING ==========
    function convertImageUrl(url) {
      if (!url) return '';
      if (url.startsWith('http://') || url.startsWith('https://')) return url;
      let imagePath = url.trim();
      if (!imagePath.startsWith('images/')) {
        if (imagePath.match(/^[a-zA-Z0-9]+\.[a-z]{3,4}$/i)) imagePath = `images/class${currentClass}/${imagePath}`;
        else if (imagePath.includes('/')) imagePath = `images/${imagePath}`;
      }
      return imagePath;
    }

    function loadImageWithCache(url) {
      return new Promise((resolve, reject) => {
        if (imageCache.get(url)) { resolve(imageCache.get(url)); return; }
        const img = new Image();
        img.onload = () => { imageCache.set(url, img); resolve(img); };
        img.onerror = () => reject(new Error(`Failed to load image: ${url}`));
        img.src = url;
      });
    }

    async function preloadChapterImages(chapterQuestions) {
      if (!chapterQuestions || chapterQuestions.length === 0) return;
      const imageUrls = new Set();
      chapterQuestions.forEach(q => {
        if (q.imageUrl?.trim()) imageUrls.add(convertImageUrl(q.imageUrl.trim()));
        if (q.optionImages) q.optionImages.forEach(optImg => { if (optImg?.trim()) imageUrls.add(convertImageUrl(optImg.trim())); });
      });
      const urlsArray = Array.from(imageUrls);
      totalImagesToPreload = urlsArray.length;
      imagesPreloaded = 0;
      if (totalImagesToPreload === 0) return;
      showPreloadOverlay();
      const CONCURRENT_LIMIT = 3;
      for (let i = 0; i < urlsArray.length; i += CONCURRENT_LIMIT) {
        const chunk = urlsArray.slice(i, i + CONCURRENT_LIMIT);
        await Promise.allSettled(chunk.map(url => loadImageWithCache(url).then(() => { imagesPreloaded++; updatePreloadProgress(); }).catch(() => { imagesPreloaded++; updatePreloadProgress(); })));
        await new Promise(r => setTimeout(r, 100));
      }
      hidePreloadOverlay();
    }

    function showPreloadOverlay() { if (totalImagesToPreload > 0) preloadOverlayEl.style.display = 'flex'; }
    function updatePreloadProgress() {
      const percent = totalImagesToPreload > 0 ? (imagesPreloaded / totalImagesToPreload * 100) : 0;
      preloadProgressFillEl.style.width = `${percent}%`;
      preloadCountEl.textContent = `${imagesPreloaded}/${totalImagesToPreload}`;
      if (imagesPreloaded >= totalImagesToPreload) setTimeout(hidePreloadOverlay, 500);
    }
    function hidePreloadOverlay() { preloadOverlayEl.style.display = 'none'; }
    function toggleImageZoom(img) {
      if (window.innerWidth > 768) img.classList.toggle('zoomed');
      else img.classList.toggle('touch-zoom');
    }

    // ========== NAVIGATION FUNCTIONS ==========
    function toggleQuestionNavigation() {
      const collapsed = questionNavigationEl.classList.contains('collapsed');
      if (collapsed) {
        questionNavigationEl.classList.remove('collapsed'); questionNavigationEl.classList.add('expanded');
        navigationToggleBtn.innerHTML = '‚ñº Hide'; navigationToggleBtn.classList.remove('collapsed');
        updateQuestionNavigation();
      } else {
        questionNavigationEl.classList.remove('expanded'); questionNavigationEl.classList.add('collapsed');
        navigationToggleBtn.innerHTML = '‚ñ∂ Show'; navigationToggleBtn.classList.add('collapsed');
      }
      resetInactivityTimer();
    }

    function updateQuestionNavigation() {
      if (!questionsLoaded || questions.length === 0) { questionGridEl.innerHTML = '<div style="color:var(--text-muted); text-align:center;">No questions</div>'; return; }
      questionGridEl.innerHTML = '';
      for (let i = 0; i < questions.length; i++) {
        const btn = document.createElement('button');
        btn.className = 'question-number-btn';
        btn.textContent = i + 1;
        btn.dataset.index = i;
        if (i === currentIndex) btn.classList.add('current');
        if (userAnswers[i] !== undefined) {
          if (userAnswers[i] === questions[i].correctIndex) btn.classList.add('answered');
          else { btn.style.background = 'rgba(239,68,68,0.2)'; btn.style.borderColor = '#ef4444'; btn.style.color = '#fca5a5'; }
        } else btn.classList.add('not-answered');
        btn.addEventListener('click', () => { const idx = parseInt(btn.dataset.index); if (idx >= 0 && idx < questions.length) jumpToQuestion(idx); });
        questionGridEl.appendChild(btn);
      }
      updateNavigationStats();
    }

    function updateNavigationStats() {
      if (!questionsLoaded || questions.length === 0) { navigationStatsEl.innerHTML = ''; return; }
      let correct = 0, incorrect = 0, notAnswered = 0;
      for (let i = 0; i < questions.length; i++) {
        if (userAnswers[i] !== undefined) {
          if (userAnswers[i] === questions[i].correctIndex) correct++;
          else incorrect++;
        } else notAnswered++;
      }
      navigationStatsEl.innerHTML = `
        <div class="stat-badge current"><span>‚óè</span> Current: ${currentIndex+1}</div>
        <div class="stat-badge" style="background:rgba(34,197,94,0.15); color:#86efac;"><span>‚óè</span> Correct: ${correct}</div>
        <div class="stat-badge" style="background:rgba(239,68,68,0.15); color:#fca5a5;"><span>‚óè</span> Incorrect: ${incorrect}</div>
        <div class="stat-badge not-answered"><span>‚óè</span> Not Answered: ${notAnswered}</div>
      `;
    }

    function jumpToQuestion(index) { if (index < 0 || index >= questions.length) return; currentIndex = index; renderQuestion(); updateQuestionNavigation(); resetInactivityTimer(); }
    function showQuestionNavigation() { questionNavigationEl.style.display = 'block'; questionNavigationEl.classList.add('collapsed'); navigationToggleBtn.innerHTML = '‚ñ∂ Show'; navigationToggleBtn.classList.add('collapsed'); }

    // ========== SCREEN NAVIGATION ==========
    function showClassSelection() {
      classSelectionEl.style.display = "block"; subjectSelectionEl.style.display = "none"; quizContainerEl.style.display = "none";
      accountConfigErrorEl.style.display = "none"; subscriptionExpiredEl.style.display = "none";
      resetQuizState(); isReviewMode = false; isIncorrectReviewMode = false; resetInactivityTimer();
    }

    function showSubjectSelection(className) {
      currentClass = className;
      currentClassDisplayEl.textContent = className === 'JE' ? 'Junior Engineer' : `Class ${className}`;
      classSelectionEl.style.display = "none"; subjectSelectionEl.style.display = "block"; quizContainerEl.style.display = "none";
      accountConfigErrorEl.style.display = "none"; subscriptionExpiredEl.style.display = "none";
      loadSubjects(); isReviewMode = false; isIncorrectReviewMode = false; resetInactivityTimer();
    }

    function showQuizContainer(subjectName) {
      currentSubject = subjectName;
      currentPathEl.innerHTML = `<span class="path-link" onclick="showClassSelection()">Classes</span><span class="path-separator">‚Ä∫</span><span class="path-link" onclick="showSubjectSelection('${currentClass}')">${currentClass === 'JE' ? 'Junior Engineer' : 'Class '+currentClass}</span><span class="path-separator">‚Ä∫</span><span>${subjectName}</span>`;
      currentPathEl.style.display = "flex";
      subjectSelectionEl.style.display = "none"; quizContainerEl.style.display = "block";
      accountConfigErrorEl.style.display = "none"; subscriptionExpiredEl.style.display = "none";
      loadChapters(); isReviewMode = false; isIncorrectReviewMode = false; resetInactivityTimer();
    }

    // ========== QUIZ FUNCTIONS ==========
    function resetQuizState() {
      questions = []; currentIndex = 0; score = 0; hasAnswered = false; questionsLoaded = false; attempted = 0;
      userAnswers = []; timeRemaining = 0; timerDuration = 0; currentTopicName = ""; quizStartTime = null;
      isReviewMode = false; isIncorrectReviewMode = false; incorrectQuestionIndices = [];
      hasSentQuizResultNotification = false; currentQuizSessionId = Date.now().toString();
      questionTextEl.textContent = "Please select a chapter to start.";
      questionImageContainerEl.classList.remove('visible'); questionImageEl.src = "";
      optionsListEl.innerHTML = ""; feedbackEl.textContent = ""; feedbackEl.className = "feedback";
      nextBtn.disabled = true; previousBtn.disabled = true; finishBtn.disabled = true;
      finishBtn.textContent = "Submit";
      finishBtn.onclick = () => { if (!questionsLoaded) return; if (confirm("Finish quiz?")) showFinalResult(); resetInactivityTimer(); };
      finalScoreEl.style.display = "none"; progressBarFillEl.style.width = "0%";
      questionCounterEl.textContent = "Choose a chapter and click Start";
      scoreMiniEl.textContent = "Score: 0"; quizTopicNameEl.textContent = "No chapter selected";
      quizQuestionCountEl.textContent = "0 questions"; timerContainerEl.style.display = "none";
      toggleRowEl.classList.remove('hidden'); progressEl.classList.remove('hidden');
      controlsEl.classList.remove('hidden'); questionBoxEl.style.display = 'block';
      questionNavigationEl.classList.remove('expanded'); questionNavigationEl.classList.add('collapsed');
      navigationToggleBtn.innerHTML = '‚ñ∂ Show'; navigationToggleBtn.classList.add('collapsed');
      quizTopicNameEl.style.cssText = ""; removeTimerNotification(); questionWhatsappIconEl.style.display = "none";
    }

    function collectIncorrectQuestionIndices() {
      incorrectQuestionIndices = [];
      for (let i = 0; i < questions.length; i++) {
        if (userAnswers[i] !== undefined && userAnswers[i] !== questions[i].correctIndex) incorrectQuestionIndices.push(i);
      }
    }

    function showIncorrectQuestionsReview() {
      collectIncorrectQuestionIndices();
      if (incorrectQuestionIndices.length === 0) { alert("No incorrect questions to review."); return; }
      isIncorrectReviewMode = true; isReviewMode = true; finalScoreEl.style.display = "none";
      toggleRowEl.classList.remove('hidden'); progressEl.classList.remove('hidden');
      questionNavigationEl.style.display = 'block'; controlsEl.classList.remove('hidden');
      questionBoxEl.style.display = 'block'; questionWhatsappIconEl.style.display = "block";
      finishBtn.style.display = "inline-block"; finishBtn.textContent = "Back to Results";
      finishBtn.onclick = showFinalResultWithoutNotification;
      currentIndex = incorrectQuestionIndices[0]; renderQuestion();
      questionNavigationEl.classList.remove('collapsed'); questionNavigationEl.classList.add('expanded');
      navigationToggleBtn.innerHTML = '‚ñº Hide'; navigationToggleBtn.classList.remove('collapsed');
      updateQuestionNavigation();
      const headerDiv = document.createElement('div');
      headerDiv.id = 'review-header';
      headerDiv.style.cssText = 'margin:10px 0;padding:10px;background:rgba(239,68,68,0.15);border:1px solid rgba(239,68,68,0.3);border-radius:8px;text-align:center;color:#fca5a5';
      headerDiv.innerHTML = `Reviewing Incorrect Questions (${incorrectQuestionIndices.length})`;
      const topicSection = document.querySelector('.topic-section');
      document.getElementById('review-header')?.remove();
      topicSection.parentNode.insertBefore(headerDiv, topicSection.nextSibling);
    }

    async function loadQuestionsFromGoogleSheet(chapterName) {
      const trimmed = chapterName.trim();
      if (!trimmed) { alert("Select a chapter."); resetInactivityTimer(); return; }
      currentTopicName = trimmed;
      const gid = currentSubjectConfig?.chapters?.[trimmed];
      const sheetId = currentSubjectConfig?.sheetId;
      if (!gid || !sheetId) { alert("Invalid chapter config"); return; }
      quizTopicNameEl.textContent = trimmed;
      try {
        questionTextEl.textContent = `Loading ${trimmed}‚Ä¶`;
        questionImageContainerEl.classList.remove('visible'); optionsListEl.innerHTML = ""; feedbackEl.textContent = "";
        nextBtn.disabled = true; previousBtn.disabled = true; finishBtn.disabled = true;
        finishBtn.textContent = "Submit"; finishBtn.onclick = () => { if (!questionsLoaded) return; if (confirm("Finish quiz?")) showFinalResult(); resetInactivityTimer(); };
        finalScoreEl.style.display = "none"; progressBarFillEl.style.width = "0%"; questionCounterEl.textContent = "Loading‚Ä¶";
        timerContainerEl.style.display = "none"; timerDuration = 0; quizStartTime = Date.now(); removeTimerNotification();
        const apiUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&gid=${gid}`;
        const response = await fetch(apiUrl);
        if (!response.ok) throw new Error(`Failed to fetch: ${response.status}`);
        const data = await response.text();
        const jsonData = JSON.parse(data.substring(47).slice(0, -2));
        const rows = jsonData.table.rows;
        if (rows.length === 0) throw new Error("No questions found.");
        const rawQuestions = [];
        let timerFromSheet = 0;
        if (rows.length > 1 && rows[1].c?.[7]?.v) timerFromSheet = parseInt(rows[1].c[7].v) || 0;
        for (let i = 2; i < rows.length; i++) {
          const row = rows[i];
          if (!row.c || row.c.length < 6) continue;
          const question = row.c[0]?.v?.toString().trim() || '';
          const option1 = row.c[1]?.v?.toString().trim() || '';
          const option2 = row.c[2]?.v?.toString().trim() || '';
          const option3 = row.c[3]?.v?.toString().trim() || '';
          const option4 = row.c[4]?.v?.toString().trim() || '';
          const answer = row.c[5]?.v?.toString().trim() || '';
          const explanation = row.c[6]?.v?.toString().trim() || '';
          const imageUrl = row.c[8]?.v?.toString().trim() || '';
          if (!question || !option1 || !option2 || !answer) continue;
          const options = [option1, option2];
          if (option3) options.push(option3);
          if (option4) options.push(option4);
          const optionImages = [];
          if (row.c[9]) optionImages.push(row.c[9].v.toString().trim());
          if (row.c[10]) optionImages.push(row.c[10].v.toString().trim());
          if (row.c[11]) optionImages.push(row.c[11].v.toString().trim());
          if (row.c[12]) optionImages.push(row.c[12].v.toString().trim());
          let correctIndex = 0;
          const answerUpper = answer.toUpperCase().trim();
          if (answerUpper === 'A' || answerUpper === '1') correctIndex = 0;
          else if (answerUpper === 'B' || answerUpper === '2') correctIndex = 1;
          else if (answerUpper === 'C' || answerUpper === '3') correctIndex = 2;
          else if (answerUpper === 'D' || answerUpper === '4') correctIndex = 3;
          else {
            const matchIndex = options.findIndex(opt => opt.toLowerCase().includes(answer.toLowerCase()) || answer.toLowerCase().includes(opt.toLowerCase()));
            if (matchIndex !== -1) correctIndex = matchIndex;
          }
          rawQuestions.push({ question, options, optionImages, correctIndex, explanation, imageUrl });
        }
        if (rawQuestions.length === 0) throw new Error("No valid questions.");
        if (timerFromSheet > 0) timerDuration = timerFromSheet * 60 * 1000;
        const randomize = randomToggleEl.checked;
        questions = prepareQuestionBank(rawQuestions, randomize);
        userAnswers = new Array(questions.length);
        questionsLoaded = true; currentIndex = 0; score = 0; attempted = 0;
        scoreMiniEl.textContent = "Score: 0";
        nextBtn.style.display = "inline-block"; previousBtn.style.display = "inline-block"; finishBtn.style.display = "inline-block";
        quizTopicNameEl.textContent = trimmed; quizQuestionCountEl.textContent = `${questions.length} questions`;
        showQuestionNavigation();
        await preloadChapterImages(questions);
        if (timerDuration > 0) { showTimerNotification(); startTimer(); }
        renderQuestion();
        resetInactivityTimer();
      } catch (err) {
        questionTextEl.textContent = `Error: ${err.message}`;
        questionImageContainerEl.classList.remove('visible'); optionsListEl.innerHTML = ""; feedbackEl.textContent = "";
        nextBtn.disabled = true; previousBtn.disabled = true; finishBtn.disabled = true;
        quizTopicNameEl.textContent = "Error loading chapter";
        quizTopicNameEl.style.cssText = "background:rgba(239,68,68,0.1);border-color:rgba(239,68,68,0.5);color:#fca5a5";
        resetInactivityTimer();
      }
    }

    function shuffleArray(arr) { for (let i = arr.length-1; i>0; i--) { const j = Math.floor(Math.random()*(i+1)); [arr[i],arr[j]] = [arr[j],arr[i]]; } }
    function prepareQuestionBank(rawQuestions, randomize) {
      const qs = rawQuestions.map(q => ({ ...q, options: [...q.options], optionImages: q.optionImages ? [...q.optionImages] : [] }));
      if (randomize) {
        shuffleArray(qs);
        qs.forEach(q => {
          const idxs = q.options.map((_,i)=>i);
          shuffleArray(idxs);
          q.options = idxs.map(i=>q.options[i]);
          q.optionImages = q.optionImages ? idxs.map(i=>q.optionImages[i]) : [];
          q.correctIndex = idxs.indexOf(q.correctIndex);
        });
      }
      return qs;
    }

    // ========== TIMER ==========
    function startTimer() {
      if (timerDuration <= 0) return;
      timeRemaining = timerDuration;
      timerContainerEl.style.display = "flex";
      updateTimerDisplay();
      timerInterval = setInterval(() => {
        timeRemaining -= 1000;
        if (timeRemaining <= 0) { timeRemaining = 0; clearInterval(timerInterval); autoFinishQuiz(); }
        updateTimerDisplay();
      }, 1000);
    }

    function updateTimerDisplay() {
      const h = Math.floor(timeRemaining / (1000*60*60));
      const m = Math.floor((timeRemaining % (1000*60*60)) / (1000*60));
      const s = Math.floor((timeRemaining % (1000*60)) / 1000);
      timerDisplayEl.textContent = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
      timerDisplayEl.classList.remove("timer-warning","timer-critical");
      if (timeRemaining <= 30*60*1000) timerDisplayEl.classList.add("timer-warning");
      if (timeRemaining <= 10*60*1000) timerDisplayEl.classList.add("timer-critical");
    }

    function stopTimer() { if (timerInterval) clearInterval(timerInterval); timerContainerEl.style.display = "none"; }
    function showTimerNotification() {
      removeTimerNotification();
      if (timerDuration > 0) {
        const h = Math.floor(timerDuration / (1000*60*60));
        const m = Math.floor((timerDuration % (1000*60*60)) / (1000*60));
        const ts = h ? `${h}h ${m}m` : m ? `${m}m` : "<1m";
        timerNotification = document.createElement("div");
        timerNotification.className = "timer-notification";
        timerNotification.innerHTML = `<span>‚è±Ô∏è Timer: <strong>${ts}</strong></span>`;
        const toggleRow = document.querySelector(".toggle-row");
        if (toggleRow?.nextElementSibling) toggleRow.parentNode.insertBefore(timerNotification, toggleRow.nextElementSibling);
      }
    }
    function removeTimerNotification() { if (timerNotification?.parentNode) timerNotification.remove(); document.querySelectorAll(".timer-notification").forEach(n=>n.remove()); }
    function autoFinishQuiz() { showFinalResult(); stopTimer(); removeTimerNotification(); }
    function formatTimeTaken() {
      if (timerDuration <= 0 || !quizStartTime) return "";
      const taken = Date.now() - quizStartTime;
      const h = Math.floor(taken / (1000*60*60));
      const m = Math.floor((taken % (1000*60*60)) / (1000*60));
      const s = Math.floor((taken % (1000*60)) / 1000);
      return h ? `${h}h ${m}m ${s}s` : m ? `${m}m ${s}s` : `${s}s`;
    }

    // ========== RENDER QUESTION ==========
    function renderQuestion() {
      if (!questionsLoaded || questions.length === 0) {
        questionTextEl.textContent = "No questions available.";
        questionImageContainerEl.classList.remove('visible'); optionsListEl.innerHTML = "";
        nextBtn.disabled = previousBtn.disabled = finishBtn.disabled = true; questionWhatsappIconEl.style.display = "none";
        return;
      }
      const q = questions[currentIndex];
      hasAnswered = false;
      feedbackEl.textContent = ""; feedbackEl.className = "feedback"; feedbackEl.querySelector('.explanation')?.remove();
      if (isIncorrectReviewMode) {
        const pos = incorrectQuestionIndices.indexOf(currentIndex)+1;
        questionCounterEl.textContent = `Incorrect Q${pos}/${incorrectQuestionIndices.length}`;
        progressBarFillEl.style.width = `${(pos/incorrectQuestionIndices.length)*100}%`;
      } else {
        questionCounterEl.textContent = `Q${currentIndex+1}/${questions.length}`;
        progressBarFillEl.style.width = `${((currentIndex+1)/questions.length)*100}%`;
      }
      questionTextEl.innerHTML = q.question.replace(/\r\n|\n|\r/g,'<br>').replace(/\\n/g,'<br>').replace(/\|\|/g,'<br><br>').replace(/\|/g,'<br>').trim();
      questionWhatsappIconEl.style.display = "block";
      if (q.imageUrl?.trim()) {
        const imgUrl = convertImageUrl(q.imageUrl.trim());
        questionImageContainerEl.classList.add('visible');
        questionImageEl.style.display = "none"; imageLoadingEl.style.display = "block"; imageErrorEl.style.display = "none";
        loadImageWithCache(imgUrl).then(() => { questionImageEl.src = imgUrl; questionImageEl.style.display = "block"; imageLoadingEl.style.display = "none"; })
          .catch(() => { imageLoadingEl.style.display = "none"; imageErrorEl.style.display = "block"; });
      } else questionImageContainerEl.classList.remove('visible');
      optionsListEl.innerHTML = "";
      q.options.forEach((opt, idx) => {
        const li = document.createElement("li");
        li.className = "option";
        if (userAnswers[currentIndex] === idx) li.classList.add("selected");
        const labelDiv = document.createElement("div"); labelDiv.className = "option-label"; labelDiv.textContent = String.fromCharCode(65+idx)+".";
        const contentDiv = document.createElement("div"); contentDiv.className = "option-content";
        if (q.optionImages?.[idx]?.trim()) {
          const optImgUrl = convertImageUrl(q.optionImages[idx].trim());
          const wrapper = document.createElement("div"); wrapper.style.cssText = "display:flex;flex-direction:column;width:100%";
          wrapper.innerHTML = `<span style="margin-bottom:8px">${opt}</span><img src="${optImgUrl}" class="option-image" alt="Option ${String.fromCharCode(65+idx)}">`;
          contentDiv.appendChild(wrapper);
        } else contentDiv.textContent = opt;
        li.appendChild(labelDiv); li.appendChild(contentDiv);
        optionsListEl.appendChild(li);
        li.addEventListener("click", () => {
          if (hasAnswered || isReviewMode) return;
          resetInactivityTimer();
          document.querySelectorAll(".option").forEach(o=>o.classList.remove("selected"));
          li.classList.add("selected");
          userAnswers[currentIndex] = idx;
          handleOptionClick(idx);
        });
      });
      previousBtn.disabled = (currentIndex === 0);
      nextBtn.disabled = !isReviewMode;
      finishBtn.disabled = false;
      if (userAnswers[currentIndex] !== undefined) {
        const selected = userAnswers[currentIndex];
        showCorrectness(selected);
        lockOptions();
        hasAnswered = true;
        if (selected === q.correctIndex) { feedbackEl.textContent = "Correct!"; feedbackEl.className = "feedback correct"; }
        else { feedbackEl.textContent = `Wrong. Correct: ${q.options[q.correctIndex]}`; feedbackEl.className = "feedback incorrect"; }
        if (q.explanation) {
          const exp = document.createElement("div"); exp.className = "explanation"; exp.innerHTML = `<strong>Explanation:</strong> ${q.explanation}`;
          feedbackEl.appendChild(exp);
        }
        if (!isReviewMode) nextBtn.disabled = false;
      } else if (isReviewMode) {
        showCorrectness(-1);
        lockOptions();
        feedbackEl.textContent = `Correct Answer: ${q.options[q.correctIndex]}`;
        feedbackEl.className = "feedback";
        if (q.explanation) {
          const exp = document.createElement("div"); exp.className = "explanation"; exp.innerHTML = `<strong>Explanation:</strong> ${q.explanation}`;
          feedbackEl.appendChild(exp);
        }
      }
      updateQuestionNavigation();
      resetInactivityTimer();
    }

    function lockOptions() { document.querySelectorAll(".option").forEach(o=>o.classList.add("disabled")); }
    function showCorrectness(selectedIndex) {
      const q = questions[currentIndex];
      document.querySelectorAll(".option").forEach((opt, idx) => {
        opt.classList.remove("correct","incorrect");
        if (idx === q.correctIndex) opt.classList.add("correct");
        if (idx === selectedIndex && selectedIndex !== q.correctIndex) opt.classList.add("incorrect");
      });
    }

    function handleOptionClick(selectedIndex) {
      if (hasAnswered || isReviewMode) return;
      const q = questions[currentIndex];
      hasAnswered = true; attempted++;
      if (selectedIndex === q.correctIndex) { score++; feedbackEl.textContent = "Correct!"; feedbackEl.className = "feedback correct"; }
      else { feedbackEl.textContent = `Wrong. Correct: ${q.options[q.correctIndex]}`; feedbackEl.className = "feedback incorrect"; }
      if (q.explanation) {
        const exp = document.createElement("div"); exp.className = "explanation"; exp.innerHTML = `<strong>Explanation:</strong> ${q.explanation}`;
        feedbackEl.appendChild(exp);
      }
      scoreMiniEl.textContent = `Score: ${score}`;
      showCorrectness(selectedIndex);
      lockOptions();
      nextBtn.disabled = false;
      updateQuestionNavigation();
    }

    function goToNextQuestion() {
      resetInactivityTimer();
      if (isIncorrectReviewMode) {
        const pos = incorrectQuestionIndices.indexOf(currentIndex);
        currentIndex = pos < incorrectQuestionIndices.length-1 ? incorrectQuestionIndices[pos+1] : incorrectQuestionIndices[0];
      } else if (currentIndex < questions.length-1) currentIndex++;
      else if (!isReviewMode) { showFinalResult(); return; }
      else currentIndex = 0;
      renderQuestion();
    }

    function goToPreviousQuestion() {
      resetInactivityTimer();
      if (isIncorrectReviewMode) {
        const pos = incorrectQuestionIndices.indexOf(currentIndex);
        currentIndex = pos > 0 ? incorrectQuestionIndices[pos-1] : incorrectQuestionIndices[incorrectQuestionIndices.length-1];
      } else if (currentIndex > 0) currentIndex--;
      renderQuestion();
    }

    function calculateQuizStats() {
      let attempted = 0, correct = 0;
      for (let i=0; i<questions.length; i++) {
        if (userAnswers[i] !== undefined) { attempted++; if (userAnswers[i] === questions[i].correctIndex) correct++; }
      }
      return {
        total: questions.length, attempted, correct, incorrect: attempted-correct,
        percentage: questions.length ? ((correct/questions.length)*100).toFixed(2) : 0,
        timeTaken: formatTimeTaken()
      };
    }

    function showFinalResult() {
      stopTimer(); removeTimerNotification();
      const stats = calculateQuizStats();
      collectIncorrectQuestionIndices();
      toggleRowEl.classList.add('hidden'); progressEl.classList.add('hidden');
      questionNavigationEl.style.display = 'none'; timerContainerEl.classList.add('hidden');
      controlsEl.classList.add('hidden'); questionBoxEl.style.display = 'none'; questionWhatsappIconEl.style.display = "none";
      document.getElementById('review-header')?.remove();
      if (window.innerWidth <= 700) questionBoxEl.classList.add('hidden-on-mobile');
      finalScoreEl.style.display = "block";
      let reviewSection = questions.length ? `<div class="result-summary"><button class="review-btn" onclick="showQuestionReview()">Review All Questions</button></div>` : '';
      let incorrectReviewSection = stats.incorrect ? `<div class="result-summary"><button class="review-incorrect-btn" onclick="showIncorrectQuestionsReview()">‚ùå Review ${stats.incorrect} Incorrect</button></div>` : '';
      finalScoreEl.innerHTML = `
        <div class="result-header">Results - ${currentTopicName}</div>
        <div class="result-stats">
          <div class="stat-item"><span class="stat-label">Total</span><span class="stat-value">${stats.total}</span></div>
          <div class="stat-item"><span class="stat-label">Attempted</span><span class="stat-value">${stats.attempted}/${stats.total}</span></div>
          <div class="stat-item"><span class="stat-label">Correct</span><span class="stat-value">${stats.correct}</span></div>
          <div class="stat-item"><span class="stat-label">Incorrect</span><span class="stat-value">${stats.incorrect}</span></div>
          <div class="stat-item"><span class="stat-label">Percentage</span><span class="stat-value stat-percentage">${stats.percentage}%</span></div>
          <div class="stat-item"><span class="stat-label">Time Taken</span><span class="stat-value stat-time">${stats.timeTaken || "No timer"}</span></div>
        </div>
        <div class="result-message">${getPerformanceRemark(parseFloat(stats.percentage))}</div>
        <button class="restart-btn" onclick="restartQuiz()">Restart Quiz</button>
        ${incorrectReviewSection}
        ${reviewSection}
      `;
      resetInactivityTimer();
      sendQuizResultNotification(stats);
      setTimeout(() => generateAndSendPDFReport(), 2000);
    }

    function showQuestionReview() {
      isReviewMode = true; isIncorrectReviewMode = false;
      finalScoreEl.style.display = "none"; document.getElementById('review-header')?.remove();
      toggleRowEl.classList.remove('hidden'); progressEl.classList.remove('hidden');
      questionNavigationEl.style.display = 'block'; controlsEl.classList.remove('hidden');
      questionBoxEl.style.display = 'block'; questionWhatsappIconEl.style.display = "block";
      finishBtn.style.display = "inline-block"; finishBtn.textContent = "Back to Results";
      finishBtn.onclick = showFinalResultWithoutNotification;
      currentIndex = 0; renderQuestion();
      questionNavigationEl.classList.remove('collapsed'); questionNavigationEl.classList.add('expanded');
      navigationToggleBtn.innerHTML = '‚ñº Hide'; navigationToggleBtn.classList.remove('collapsed');
      updateQuestionNavigation();
    }

    function showFinalResultWithoutNotification() {
      stopTimer(); removeTimerNotification();
      const stats = calculateQuizStats();
      collectIncorrectQuestionIndices();
      toggleRowEl.classList.add('hidden'); progressEl.classList.add('hidden');
      questionNavigationEl.style.display = 'none'; timerContainerEl.classList.add('hidden');
      controlsEl.classList.add('hidden'); questionBoxEl.style.display = 'none'; questionWhatsappIconEl.style.display = "none";
      document.getElementById('review-header')?.remove();
      finalScoreEl.style.display = "block";
      let reviewSection = questions.length ? `<div class="result-summary"><button class="review-btn" onclick="showQuestionReview()">Review All Questions</button></div>` : '';
      let incorrectReviewSection = stats.incorrect ? `<div class="result-summary"><button class="review-incorrect-btn" onclick="showIncorrectQuestionsReview()">‚ùå Review ${stats.incorrect} Incorrect</button></div>` : '';
      finalScoreEl.innerHTML = `
        <div class="result-header">Results - ${currentTopicName}</div>
        <div class="result-stats">...</div>
        <div class="result-message">${getPerformanceRemark(parseFloat(stats.percentage))}</div>
        <div class="result-summary"><em>Select another chapter to start a new quiz.</em></div>
        <button class="restart-btn" onclick="restartQuiz()">Restart Quiz</button>
        ${incorrectReviewSection}
        ${reviewSection}
      `;
      resetInactivityTimer();
    }

    function restartQuiz() {
      isReviewMode = false; isIncorrectReviewMode = false;
      score = 0; attempted = 0; currentIndex = 0; userAnswers = []; incorrectQuestionIndices = [];
      scoreMiniEl.textContent = "Score: 0";
      finishBtn.textContent = "Submit";
      finishBtn.onclick = () => { if (!questionsLoaded) return; if (confirm("Finish quiz?")) showFinalResult(); resetInactivityTimer(); };
      finalScoreEl.style.display = "none"; document.getElementById('review-header')?.remove();
      toggleRowEl.classList.remove('hidden'); progressEl.classList.remove('hidden');
      questionNavigationEl.style.display = 'block'; questionNavigationEl.classList.remove('expanded'); questionNavigationEl.classList.add('collapsed');
      navigationToggleBtn.innerHTML = '‚ñ∂ Show'; navigationToggleBtn.classList.add('collapsed');
      timerContainerEl.classList.remove('hidden'); controlsEl.classList.remove('hidden');
      questionBoxEl.style.display = 'block'; questionWhatsappIconEl.style.display = "block";
      updateQuestionNavigation(); hasSentQuizResultNotification = false;
      if (timerDuration > 0) { showTimerNotification(); startTimer(); }
      renderQuestion(); resetInactivityTimer();
    }

    async function generateAndSendPDFReport() {
      if (!currentUser || !questionsLoaded || questions.length === 0) return;
      showPDFOverlay();
      try {
        updatePDFStatus("Preparing report...");
        const stats = calculateQuizStats();
        const timeTaken = formatTimeTaken();
        const now = new Date();
        const date = now.toLocaleDateString('en-IN');
        const time = now.toLocaleTimeString('en-IN');
        const shortFilename = `GS_Report_${currentUser.username.substring(0,6)}_${currentSubject.substring(0,3)}_${currentTopicName.substring(0,10).replace(/\s+/g,'')}_${Date.now().toString().slice(-6)}.pdf`;
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation:'portrait', unit:'mm', format:'a4' });
        doc.setProperties({ title:`Quiz Report - ${currentUser.name}`, subject:`${currentSubject} - ${currentTopicName}`, author:'G.S. Tutorial', creator:'G.S. Tutorial App' });
        updatePDFStatus("Creating cover...");
        doc.setFillColor(15,23,42); doc.rect(0,0,210,297,'F');
        doc.setFillColor(30,41,59); doc.rect(0,0,210,50,'F');
        try {
          const logoUrl = 'logo.png';
          const img = new Image();
          img.crossOrigin = 'Anonymous';
          await new Promise((res,rej)=>{ img.onload=res; img.onerror=rej; img.src=logoUrl; });
          doc.addImage(img,'PNG',8,8,35,35);
        } catch { doc.setFillColor(59,130,246); doc.circle(27,24,18,'F'); doc.setTextColor(255,255,255); doc.setFontSize(18); doc.text("GS",22,28); }
        doc.setFont('helvetica','bold'); doc.setFontSize(22); doc.setTextColor(59,130,246); doc.text("G.S. Tutorial",50,15);
        doc.setFontSize(12); doc.setTextColor(148,163,184); doc.text("Interactive Learning App",50,23);
        doc.setFontSize(9); doc.setTextColor(226,232,240); doc.text("App Created by Gobind Sharma",50,30);
        doc.setFontSize(9); doc.setFont('helvetica','bold'); doc.text("Mobile: 9706195457",50,35);
        doc.setFont('helvetica','normal'); doc.text("Email: gobind.bngn@gmail.com",50,40); doc.text("App Link: https://gstutorial.github.io/app",50,45);
        doc.setDrawColor(59,130,246); doc.setLineWidth(0.5); doc.line(0,50,210,50);
        doc.setFontSize(20); doc.setTextColor(226,232,240); doc.text("PERFORMANCE REPORT",105,80,{align:'center'});
        doc.setFillColor(30,41,59); doc.roundedRect(20,95,170,60,3,3,'F'); doc.setDrawColor(59,130,246); doc.setLineWidth(0.5); doc.roundedRect(20,95,170,60,3,3,'S');
        doc.setFontSize(14); doc.setTextColor(59,130,246); doc.text("STUDENT INFORMATION",105,105,{align:'center'});
        doc.setFontSize(10); doc.setTextColor(226,232,240);
        let yPos=115;
        doc.text(`Name: ${currentUser.name}`,30,yPos); doc.text(`Class: ${currentClass==='JE'?'Junior Engineer':'Class '+currentClass}`,140,yPos); yPos+=7;
        doc.text(`Username: ${currentUser.username}`,30,yPos); doc.text(`Subject: ${currentSubject}`,140,yPos); yPos+=7;
        doc.text(`Role: ${currentUser.role}`,30,yPos); doc.text(`Date: ${date}`,140,yPos); yPos+=7;
        doc.text(`Ch: ${currentTopicName.substring(0,60)}`,30,yPos); doc.text(`Time: ${time}`,140,yPos);
        doc.setFillColor(30,41,59); doc.roundedRect(20,165,170,100,3,3,'F'); doc.setDrawColor(34,197,94); doc.setLineWidth(0.5); doc.roundedRect(20,165,170,100,3,3,'S');
        doc.setFontSize(14); doc.setTextColor(34,197,94); doc.text("RESULTS SUMMARY",105,175,{align:'center'});
        const pct = stats.total>0?((stats.correct/stats.total)*100).toFixed(2):0;
        const res=[
          {label:"Total Questions",val:stats.total,x:25,y:185},
          {label:"Attempted",val:`${stats.attempted}/${stats.total}`,x:110,y:185},
          {label:"Correct",val:stats.correct,x:25,y:200},
          {label:"Incorrect",val:stats.incorrect,x:110,y:200},
          {label:"Score",val:`${pct}%`,x:25,y:215},
          {label:"Time Taken",val:timeTaken||"N/A",x:110,y:215}
        ];
        doc.setFontSize(10);
        res.forEach(r=>{
          doc.setTextColor(148,163,184); doc.text(r.label,r.x,r.y);
          doc.setFont('helvetica','bold');
          if(r.label.includes("Score")) doc.setTextColor(34,197,94);
          else if(r.label.includes("Time")) doc.setTextColor(245,158,11);
          else if(r.label.includes("Correct")) doc.setTextColor(34,197,94);
          else if(r.label.includes("Incorrect")) doc.setTextColor(239,68,68);
          else doc.setTextColor(226,232,240);
          doc.text(r.val.toString(),r.x+50,r.y);
          doc.setFont('helvetica','normal');
        });
        doc.setFontSize(8); doc.setTextColor(148,163,184); doc.text("PDF Generated by G.S. Tutorial App",105,285,{align:'center'});
        doc.text("¬© 2025 G.S. Tutorial. All rights reserved.",105,290,{align:'center'});
        const pdfBase64 = doc.output('datauristring').split(',')[1];
        await sendPDFToTelegram(pdfBase64, shortFilename);
        updatePDFStatus("PDF Generated!","You can download it.");
        setTimeout(()=>{
          hidePDFOverlay();
          const finalDiv = document.querySelector('.final-score');
          if(finalDiv && !finalDiv.querySelector('.pdf-report-btn')){
            const pdfBtn = document.createElement('button');
            pdfBtn.className = 'pdf-report-btn';
            pdfBtn.innerHTML = 'üìÑ Download PDF';
            pdfBtn.onclick = ()=>{
              pdfBtn.innerHTML='‚è≥ Downloading...'; pdfBtn.disabled=true;
              setTimeout(()=>{ doc.save(shortFilename); pdfBtn.innerHTML='‚úÖ Downloaded!'; setTimeout(()=>{ pdfBtn.innerHTML='üìÑ Download PDF'; pdfBtn.disabled=false; },2000); },500);
            };
            const restart = finalDiv.querySelector('.restart-btn');
            if(restart) finalDiv.insertBefore(pdfBtn, restart);
          }
          if(finalDiv && !finalDiv.querySelector('.questions-answers-btn')){
            const qaBtn = document.createElement('button');
            qaBtn.className = 'questions-answers-btn';
            qaBtn.innerHTML = 'üìö Download Q&A PDF';
            qaBtn.onclick = generateQuestionsAnswersPDF;
            const pdfBtn = finalDiv.querySelector('.pdf-report-btn');
            if(pdfBtn) finalDiv.insertBefore(qaBtn, pdfBtn.nextSibling);
          }
        },2000);
      } catch(error) {
        console.error(error);
        updatePDFStatus("Error generating report","Please try again.");
        setTimeout(hidePDFOverlay,3000);
      }
    }

    async function generateQuestionsAnswersPDF() { /* full function as original - kept for brevity */ }

    // ========== LOGIN FUNCTION ==========
    function login(user, isRestore = false) {
      const validation = validateUserAccount(user);
      if (!validation.valid) {
        if (user.subscriptionReason === 'expired') showSubscriptionExpired(user, user.joiningDate, user.lastDate);
        else showAccountConfigError(user, validation.error, { assignedClasses: validation.assignedClasses });
        return;
      }
      currentUser = user;
      currentUser.validatedAssignedClasses = validation.assignedClasses;
      headerUsernameEl.textContent = user.name;
      sideUsername.textContent = user.name;
      fixedHeaderEl.style.display = "flex";
      headerUserInfoEl.style.display = "block";
      loginContainerEl.style.display = "none";
      accountConfigErrorEl.style.display = "none";
      subscriptionExpiredEl.style.display = "none";
      classSelectionEl.style.display = "block";
      const roleDisplay = user.role === 'Admin' ? 'Admin' : (user.role === 'Student' ? 'Student' : user.role);
      greetingMessageEl.innerHTML = `Welcome, <span>${user.name}</span> (${roleDisplay})`;
      resetFailedAttempts();
      resetInactivityTimer();
      loadClasses();
      saveSession();
      if (!isRestore) sendLoginNotification(user);
    }

    // ========== LOGOUT FUNCTION ==========
    function logout() {
      if (timerInterval) clearInterval(timerInterval);
      if (inactivityTimer) clearTimeout(inactivityTimer);
      if (cooldownTimer) clearInterval(cooldownTimer);
      imageCache.clear();
      clearSession();
      hasSentLoginNotification = false; hasSentQuizResultNotification = false; currentQuizSessionId = null;
      document.removeEventListener('mousemove', handleUserActivity);
      document.removeEventListener('keypress', handleUserActivity);
      document.removeEventListener('click', handleUserActivity);
      resetQuizState(); resetFailedAttempts();
      currentUser = null;
      fixedHeaderEl.style.display = "none";
      classSelectionEl.style.display = "none"; subjectSelectionEl.style.display = "none"; quizContainerEl.style.display = "none";
      accountConfigErrorEl.style.display = "none"; subscriptionExpiredEl.style.display = "none";
      loginContainerEl.style.display = "flex";
      loginFormEl.reset(); passwordEl.type='password'; passwordToggleEl.textContent='üëÅÔ∏è'; loginErrorEl.textContent=""; loginErrorEl.style.display="none";
      usernameEl.focus();
      sideMenu.classList.remove('open'); menuOverlay.classList.remove('open');
    }

    function autoLogout() { if (currentUser) { alert("Logged out due to inactivity."); logout(); } }
    function handleUserActivity() { updateLastActivity(); resetInactivityTimer(); }
    function resetInactivityTimer() { if (inactivityTimer) clearTimeout(inactivityTimer); if (currentUser) inactivityTimer = setTimeout(autoLogout, INACTIVITY_TIMEOUT); }

    // ========== EVENT LISTENERS ==========
    loginFormEl.addEventListener("submit", async function(e) {
      e.preventDefault();
      if (isOnCooldown) { loginErrorEl.textContent = "Please wait for cooldown."; loginErrorEl.style.display = "block"; return; }
      const username = usernameEl.value.trim();
      const password = passwordEl.value.trim();
      if (!username || !password) { loginErrorEl.textContent = "Enter both fields"; loginErrorEl.style.display = "block"; return; }
      loginErrorEl.style.display = "none";
      loginBtnEl.disabled = true; loginBtnEl.innerHTML = 'Loading...';
      const result = await authenticateWithAppsScript(username, password);
      if (result?.success) {
        resetFailedAttempts();
        const user = result.user;
        if (!result.subscriptionValid) showSubscriptionExpired(user, user.joiningDate, user.lastDate);
        else {
          const validation = validateUserAccount(user);
          if (!validation.valid) showAccountConfigError(user, validation.error, { assignedClasses: validation.assignedClasses });
          else login(user, false);
        }
      } else {
        recordFailedAttempt();
        loginErrorEl.textContent = failedAttempts >= MAX_ATTEMPTS ? `Too many attempts. Wait ${COOLDOWN_TIME}s.` : (result?.error || 'Invalid credentials');
        loginErrorEl.style.display = "block";
      }
      loginBtnEl.disabled = false; loginBtnEl.innerHTML = 'Login';
    });

    backToClassesBtn.addEventListener("click", ()=>{ showClassSelection(); resetInactivityTimer(); });
    backToLoginBtnEl.addEventListener("click", ()=>{ accountConfigErrorEl.style.display="none"; loginContainerEl.style.display="flex"; resetInactivityTimer(); });
    backToLoginFromExpiredBtn.addEventListener("click", ()=>{ subscriptionExpiredEl.style.display="none"; loginContainerEl.style.display="flex"; resetInactivityTimer(); });
    startBtnEl.addEventListener("click", ()=>{ const ch = topicSelectEl.value; if(timerInterval) clearInterval(timerInterval); removeTimerNotification(); resetQuizState(); loadQuestionsFromGoogleSheet(ch); resetInactivityTimer(); });
    nextBtn.addEventListener("click", goToNextQuestion);
    previousBtn.addEventListener("click", goToPreviousQuestion);
    navigationToggleBtn.addEventListener("click", toggleQuestionNavigation);
    randomToggleEl.addEventListener("change", ()=>resetInactivityTimer());
    setupQuestionWhatsAppSupport();
    document.addEventListener('click', (e)=>{ if(questionImageEl.classList.contains('zoomed') && !e.target.closest('#question-image-container')) questionImageEl.classList.remove('zoomed','touch-zoom'); });
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') questionImageEl.classList.remove('zoomed','touch-zoom'); });

    // ========== SIDE MENU TOGGLE ==========
    function toggleMenu() { sideMenu.classList.toggle('open'); menuOverlay.classList.toggle('open'); }
    menuToggle.addEventListener('click', toggleMenu);
    menuOverlay.addEventListener('click', toggleMenu);
    sideLogoutBtn.addEventListener('click', ()=>{ toggleMenu(); logout(); });

    // ========== THEME TOGGLE ==========
    function setTheme(theme) {
      if (theme === 'light') {
        document.body.classList.add('light-mode');
        themeIcon.textContent = '‚òÄÔ∏è';
        metaThemeColor.setAttribute('content', '#e2e8f0');
        localStorage.setItem('gs_theme', 'light');
      } else {
        document.body.classList.remove('light-mode');
        themeIcon.textContent = 'üåô';
        metaThemeColor.setAttribute('content', '#0f172a');
        localStorage.setItem('gs_theme', 'dark');
      }
    }
    themeToggle.addEventListener('click', ()=>{ setTheme(document.body.classList.contains('light-mode') ? 'dark' : 'light'); });
    const savedTheme = localStorage.getItem('gs_theme') || 'dark';
    setTheme(savedTheme);

    // ========== INITIALIZATION ==========
    async function initializeApp() {
      await loadTelegramConfig();
      await getUserIP();
      if (loadSession()) login(currentUser, true);
      else usernameEl.focus();
      document.addEventListener('mousemove', handleUserActivity);
      document.addEventListener('keypress', handleUserActivity);
      document.addEventListener('click', handleUserActivity);
      document.addEventListener('scroll', handleUserActivity);
      document.addEventListener('touchstart', handleUserActivity);
      resetFailedAttempts();
    }

    document.addEventListener("DOMContentLoaded", initializeApp);
  </script>
  <script>
    if ("serviceWorker" in navigator) { navigator.serviceWorker.register("service-worker.js").catch(()=>{}); }
  </script>
</body>
</html>
