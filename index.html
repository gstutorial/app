<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0f172a" id="meta-theme-color">
  <meta charset="UTF-8" />
  <title>G.S. Tutorial â€“ Interactive Learning App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes" />
  <!-- Allow screenshots by removing restrictions -->
  <style>
    /* Remove any user-select restrictions */
    * {
      -webkit-user-select: text !important;
      -moz-user-select: text !important;
      -ms-user-select: text !important;
      user-select: text !important;
      -webkit-touch-callout: default !important;
    }
  </style>
  <!-- Include jsPDF library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <!-- Include html2canvas for capturing screenshots -->
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <!-- Include Noto Sans font for better Unicode support -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
  <style>
    /* ===== ORIGINAL STYLES - COMPLETELY PRESERVED ===== */
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      -webkit-user-select: text !important;
      -moz-user-select: text !important;
      -ms-user-select: text !important;
      user-select: text !important;
      -webkit-touch-callout: default !important;
    }

    body {
      margin: 0;
      padding: 0;
      background: #0f172a;
      color: #e5e7eb;
      min-height: 100vh;
      background-image: radial-gradient(circle at 50% 50%, #1e293b 0%, #0f172a 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    body.light-mode {
      background: #f3f4f6;
      background-image: radial-gradient(circle at 50% 50%, #ffffff 0%, #f3f4f6 100%);
      color: #1f2937;
    }

    /* ===== ORIGINAL LOADING ANIMATIONS ===== */
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes pulse {
      0%, 100% { opacity: 0.6; }
      50% { opacity: 1; }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes shimmer {
      0% { background-position: -1000px 0; }
      100% { background-position: 1000px 0; }
    }

    .loading-spinner {
      border: 4px solid rgba(59, 130, 246, 0.2);
      border-top: 4px solid #3b82f6;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }

    .loading-spinner-small {
      border: 3px solid rgba(59, 130, 246, 0.2);
      border-top: 3px solid #3b82f6;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      display: inline-block;
      margin-right: 10px;
    }

    .loading-pulse {
      animation: pulse 1.5s ease-in-out infinite;
    }

    .loading-shimmer {
      background: linear-gradient(90deg, 
        rgba(30, 41, 59, 0.3) 0%, 
        rgba(30, 41, 59, 0.5) 50%, 
        rgba(30, 41, 59, 0.3) 100%);
      background-size: 1000px 100%;
      animation: shimmer 2s infinite;
    }

    .loading-container {
      text-align: center;
      padding: 40px;
      color: #9ca3af;
      grid-column: 1/-1;
    }

    .loading-text {
      font-size: 1.1rem;
      margin-top: 15px;
      color: #93c5fd;
    }

    .loading-subtext {
      font-size: 0.9rem;
      margin-top: 8px;
      color: #6b7280;
    }

    /* ORIGINAL SKELETON LOADING */
    .skeleton-card {
      background: rgba(15, 23, 42, 0.5);
      border-radius: 12px;
      padding: 20px;
      min-height: 120px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      border: 1px solid rgba(75, 85, 99, 0.3);
    }

    .skeleton-icon {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      background: rgba(75, 85, 99, 0.5);
      margin-bottom: 10px;
      animation: pulse 1.5s infinite;
    }

    .skeleton-title {
      width: 80px;
      height: 20px;
      background: rgba(75, 85, 99, 0.5);
      border-radius: 4px;
      margin-bottom: 8px;
      animation: pulse 1.5s infinite;
    }

    .skeleton-desc {
      width: 120px;
      height: 16px;
      background: rgba(75, 85, 99, 0.5);
      border-radius: 4px;
      animation: pulse 1.5s infinite;
    }

    /* ORIGINAL CARD ANIMATIONS */
    .class-card, .subject-card {
      transition: all 0.2s ease;
      opacity: 0;
      animation: fadeIn 0.3s ease forwards;
    }

    .class-card:nth-child(1) { animation-delay: 0.05s; }
    .class-card:nth-child(2) { animation-delay: 0.1s; }
    .class-card:nth-child(3) { animation-delay: 0.15s; }
    .class-card:nth-child(4) { animation-delay: 0.2s; }
    .class-card:nth-child(5) { animation-delay: 0.25s; }
    .class-card:nth-child(6) { animation-delay: 0.3s; }
    .class-card:nth-child(7) { animation-delay: 0.35s; }
    .class-card:nth-child(8) { animation-delay: 0.4s; }

    .subject-card:nth-child(1) { animation-delay: 0.05s; }
    .subject-card:nth-child(2) { animation-delay: 0.1s; }
    .subject-card:nth-child(3) { animation-delay: 0.15s; }
    .subject-card:nth-child(4) { animation-delay: 0.2s; }
    .subject-card:nth-child(5) { animation-delay: 0.25s; }
    .subject-card:nth-child(6) { animation-delay: 0.3s; }

    /* ===== MODIFIED HEADER - REMOVED USERNAME AND LOGOUT BUTTON ===== */
    .fixed-header {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background: rgba(2, 6, 23, 0.98);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(148, 163, 184, 0.2);
      z-index: 1000;
      padding: 8px 16px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    body.light-mode .fixed-header {
      background: rgba(255, 255, 255, 0.98);
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }

    .header-content {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 0;
      flex: 1;
    }

    .logo-header {
      width: 50px;
      height: 50px;
      border-radius: 8px;
      object-fit: contain;
      flex-shrink: 0;
      background: rgba(255, 255, 255, 0.05);
      padding: 3px;
    }

    .logo-login {
      width: 70px;
      height: 70px;
      border-radius: 12px;
      object-fit: contain;
      background: rgba(255, 255, 255, 0.1);
      padding: 5px;
    }

    .header-title-container {
      display: flex;
      flex-direction: column;
      min-width: 0;
      flex: 1;
    }

    .header-title {
      font-size: 1.3rem;
      font-weight: 700;
      background: linear-gradient(90deg, #3b82f6 0%, #22c55e 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      line-height: 1.2;
      margin: 0;
      letter-spacing: 0.5px;
    }

    .header-subtitle {
      font-size: 0.8rem;
      color: #9ca3af;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      line-height: 1.2;
      margin-top: 2px;
    }

    body.light-mode .header-subtitle {
      color: #6b7280;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-shrink: 0;
    }

    /* REMOVED user-info and logout-btn - keeping only menu toggle */
    .menu-toggle {
      width: 44px;
      height: 44px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(148, 163, 184, 0.2);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .menu-toggle:hover {
      background: rgba(59, 130, 246, 0.2);
    }

    .menu-toggle span {
      width: 22px;
      height: 2px;
      background: #e5e7eb;
      border-radius: 4px;
      transition: 0.3s;
    }

    body.light-mode .menu-toggle span {
      background: #1f2937;
    }

    /* ===== IMPROVED SIDE MENU - FIXED LIGHT MODE TEXT ===== */
    .side-menu {
      position: fixed;
      top: 70px;
      right: -320px;
      width: 300px;
      height: calc(100vh - 70px);
      background: #020617;
      border-left: 1px solid rgba(148, 163, 184, 0.2);
      box-shadow: -5px 0 25px rgba(0, 0, 0, 0.3);
      transition: right 0.3s ease;
      z-index: 1001;
      display: flex;
      flex-direction: column;
      padding: 24px 16px;
      overflow-y: auto;
    }

    body.light-mode .side-menu {
      background: #ffffff;
      border-left: 1px solid rgba(0, 0, 0, 0.1);
    }

    .side-menu.open {
      right: 0;
    }

    .menu-overlay {
      position: fixed;
      top: 70px;
      left: 0;
      width: 100%;
      height: calc(100vh - 70px);
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      display: none;
    }

    .menu-overlay.open {
      display: block;
    }

    /* Side menu profile section */
    .side-profile {
      text-align: center;
      margin-bottom: 24px;
      padding-bottom: 20px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.2);
    }

    body.light-mode .side-profile {
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }

    .side-profile img {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid #3b82f6;
      margin-bottom: 12px;
    }

    .side-profile h3 {
      color: #e5e7eb;
      margin: 8px 0 4px;
      font-size: 1.2rem;
    }

    body.light-mode .side-profile h3 {
      color: #1f2937;
    }

    .side-profile p {
      color: #9ca3af;
      margin: 0;
      font-size: 0.9rem;
    }

    body.light-mode .side-profile p {
      color: #6b7280;
    }

    /* Developer section */
    .side-dev {
      padding: 16px 0;
      margin: 8px 0;
    }

    .side-dev h4 {
      color: #e5e7eb;
      margin: 0 0 16px 0;
      font-size: 1rem;
      text-align: left;
    }

    body.light-mode .side-dev h4 {
      color: #1f2937;
    }

    .contact-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 0;
      color: #d1d5db;
      cursor: pointer;
      transition: all 0.2s;
      text-align: left;
    }

    body.light-mode .contact-item {
      color: #4b5563;
    }

    .contact-item:hover {
      color: #3b82f6;
      transform: translateX(4px);
    }

    .contact-item img {
      width: 24px;
      height: 24px;
      object-fit: contain;
    }

    .contact-item span {
      color: #d1d5db;
      font-size: 0.95rem;
    }

    body.light-mode .contact-item span {
      color: #4b5563;
    }

    /* Theme toggle - fixed for light mode */
    .theme-toggle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(255, 255, 255, 0.05);
      padding: 14px 16px;
      border-radius: 12px;
      margin: 16px 0;
      border: 1px solid rgba(148, 163, 184, 0.2);
      cursor: pointer;
      color: #e5e7eb;
    }

    body.light-mode .theme-toggle {
      background: #f3f4f6;
      color: #1f2937;
      border: 1px solid rgba(0, 0, 0, 0.1);
    }

    /* Current user section */
    .current-user {
      margin: 16px 0;
      padding: 16px;
      background: rgba(59, 130, 246, 0.1);
      border-radius: 12px;
      border: 1px solid rgba(59, 130, 246, 0.3);
    }

    .current-user-label {
      font-size: 0.85rem;
      color: #9ca3af;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    body.light-mode .current-user-label {
      color: #6b7280;
    }

    .current-user-name {
      color: #93c5fd;
      font-weight: 600;
      font-size: 1.1rem;
    }

    body.light-mode .current-user-name {
      color: #2563eb;
    }

    /* Logout button */
    .logout-side {
      padding: 14px 16px;
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 12px;
      color: #fca5a5;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      cursor: pointer;
      transition: all 0.2s;
      margin-top: auto;
    }

    .logout-side:hover {
      background: rgba(239, 68, 68, 0.2);
    }

    body.light-mode .logout-side {
      color: #dc2626;
      background: rgba(239, 68, 68, 0.1);
    }

    /* Spacing between sections */
    .side-profile,
    .side-dev,
    .theme-toggle,
    .current-user,
    .logout-side {
      margin-bottom: 16px;
    }

    /* ===== MODIFIED QUESTION NAVIGATION BUTTON COLORS ===== */
    .question-number-btn {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      border: 1px solid rgba(75, 85, 99, 0.5);
      background: rgba(15, 23, 42, 0.7);
      color: #9ca3af; /* Default grey */
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    body.light-mode .question-number-btn {
      background: #ffffff;
      color: #6b7280;
      border: 1px solid #d1d5db;
    }

    .question-number-btn:hover {
      background: rgba(31, 41, 55, 0.9);
      transform: translateY(-2px);
      border-color: #3b82f6;
    }

    body.light-mode .question-number-btn:hover {
      background: #f3f4f6;
    }

    .question-number-btn.current {
      background: #3b82f6; /* Blue for current question */
      border-color: #3b82f6;
      color: white;
      font-weight: 600;
      box-shadow: 0 0 10px rgba(59, 130, 246, 0.3);
    }

    body.light-mode .question-number-btn.current {
      background: #3b82f6;
      color: white;
    }

    .question-number-btn.answered {
      background: rgba(34, 197, 94, 0.2);
      border-color: #22c55e;
      color: #22c55e; /* Green for correct */
    }

    body.light-mode .question-number-btn.answered {
      background: #dcfce7;
      color: #166534;
    }

    .question-number-btn.incorrect {
      background: rgba(239, 68, 68, 0.2);
      border-color: #ef4444;
      color: #ef4444; /* Red for incorrect */
    }

    body.light-mode .question-number-btn.incorrect {
      background: #fee2e2;
      color: #991b1b;
    }

    .question-number-btn.not-answered {
      background: rgba(75, 85, 99, 0.2);
      border-color: rgba(75, 85, 99, 0.5);
      color: #9ca3af; /* Grey for not answered */
    }

    /* ===== REST OF ORIGINAL STYLES (PRESERVED) ===== */
    .main-content {
      width: 100%;
      max-width: 720px;
      margin-top: 90px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    #login-container {
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 20px;
    }

    .login-box {
      background: #020617;
      border-radius: 18px;
      padding: 30px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.7);
      border: 1px solid rgba(148, 163, 184, 0.3);
      width: 100%;
      max-width: 420px;
    }

    body.light-mode .login-box {
      background: #ffffff;
      border: 1px solid rgba(0, 0, 0, 0.1);
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.1);
    }

    .login-header {
      text-align: center;
      margin-bottom: 30px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
    }

    .login-title {
      font-size: 1.6rem;
      font-weight: 700;
      color: #e5e7eb;
      background: linear-gradient(90deg, #3b82f6 0%, #22c55e 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: 0.5px;
    }

    body.light-mode .login-title {
      color: #1f2937;
    }

    .login-subtitle {
      font-size: 0.95rem;
      color: #9ca3af;
      text-align: center;
    }

    body.light-mode .login-subtitle {
      color: #6b7280;
    }

    .login-form {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
      position: relative;
    }

    .form-group label {
      font-size: 0.9rem;
      color: #d1d5db;
      font-weight: 500;
    }

    body.light-mode .form-group label {
      color: #4b5563;
    }

    .form-input {
      background: #111827;
      color: #e5e7eb;
      border-radius: 10px;
      border: 1px solid rgba(75, 85, 99, 0.9);
      padding: 12px 16px;
      font-size: 0.95rem;
      transition: all 0.2s ease;
      width: 100%;
      padding-right: 45px;
    }

    body.light-mode .form-input {
      background: #f3f4f6;
      color: #1f2937;
      border: 1px solid #d1d5db;
    }

    .form-input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }

    .form-input::placeholder {
      color: #6b7280;
    }

    .password-input-wrapper {
      position: relative;
      width: 100%;
    }

    .password-toggle {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: transparent;
      border: none;
      color: #9ca3af;
      cursor: pointer;
      padding: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
      transition: color 0.2s ease;
      z-index: 10;
    }

    .password-toggle:hover {
      color: #60a5fa;
    }

    .password-toggle:active {
      transform: translateY(-50%) scale(0.95);
    }

    .attempt-counter {
      margin-top: 8px;
      font-size: 0.8rem;
      color: #9ca3af;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .attempt-counter.warning {
      color: #fbbf24;
    }

    .attempt-counter.critical {
      color: #ef4444;
    }

    .cooldown-message {
      margin-top: 8px;
      padding: 10px;
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 8px;
      font-size: 0.85rem;
      color: #fca5a5;
      text-align: center;
      animation: pulse 2s infinite;
    }

    .login-btn {
      background: linear-gradient(to right, #3b82f6, #2563eb);
      color: white;
      border: none;
      border-radius: 999px;
      padding: 14px 24px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-top: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: 0 8px 18px rgba(37, 99, 235, 0.4);
      width: 100%;
    }

    .login-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 22px rgba(37, 99, 235, 0.5);
    }

    .login-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .login-error {
      background: rgba(239, 68, 68, 0.1);
      color: #fca5a5;
      padding: 10px 12px;
      border-radius: 8px;
      font-size: 0.85rem;
      border: 1px solid rgba(239, 68, 68, 0.3);
      display: none;
      text-align: center;
    }

    .account-config-error {
      background: #020617;
      border-radius: 18px;
      padding: 30px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.7);
      border: 1px solid rgba(239, 68, 68, 0.3);
      display: none;
      width: 100%;
      max-width: 500px;
      margin: 0 auto;
    }

    .error-header {
      text-align: center;
      margin-bottom: 25px;
    }

    .error-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: #ef4444;
      margin-bottom: 10px;
      letter-spacing: 0.5px;
    }

    .error-subtitle {
      font-size: 1rem;
      color: #e5e7eb;
      text-align: center;
      margin-bottom: 5px;
    }

    body.light-mode .error-subtitle {
      color: #1f2937;
    }

    .error-user-info {
      text-align: center;
      margin-bottom: 25px;
      padding: 15px;
      background: rgba(239, 68, 68, 0.1);
      border-radius: 12px;
      border: 1px solid rgba(239, 68, 68, 0.2);
    }

    .error-user-info strong {
      color: #fca5a5;
      font-size: 1.1rem;
    }

    .error-details {
      background: rgba(30, 41, 59, 0.5);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 25px;
      border: 1px solid rgba(75, 85, 99, 0.5);
    }

    .error-details ul {
      margin: 0;
      padding-left: 20px;
      color: #d1d5db;
      line-height: 1.6;
    }

    .error-details li {
      margin-bottom: 10px;
    }

    .error-details strong {
      color: #fca5a5;
    }

    .whatsapp-btn {
      background: linear-gradient(to right, #25d366, #128c7e);
      color: white;
      border: none;
      border-radius: 999px;
      padding: 14px 24px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      box-shadow: 0 8px 18px rgba(37, 211, 102, 0.4);
      width: 100%;
      text-decoration: none;
      text-align: center;
    }

    .whatsapp-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 22px rgba(37, 211, 102, 0.5);
    }

    .whatsapp-btn img {
      width: 24px;
      height: 24px;
      object-fit: contain;
    }

    .subscription-expired {
      background: #020617;
      border-radius: 18px;
      padding: 30px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.7);
      border: 1px solid rgba(239, 68, 68, 0.3);
      display: none;
      width: 100%;
      max-width: 500px;
      margin: 0 auto;
    }

    .expired-header {
      text-align: center;
      margin-bottom: 25px;
    }

    .expired-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: #ef4444;
      margin-bottom: 10px;
      letter-spacing: 0.5px;
    }

    .expired-subtitle {
      font-size: 1rem;
      color: #e5e7eb;
      text-align: center;
      margin-bottom: 5px;
    }

    .expired-user-info {
      text-align: center;
      margin-bottom: 25px;
      padding: 15px;
      background: rgba(239, 68, 68, 0.1);
      border-radius: 12px;
      border: 1px solid rgba(239, 68, 68, 0.2);
    }

    .expired-user-info strong {
      color: #fca5a5;
      font-size: 1.1rem;
    }

    .expired-details {
      background: rgba(30, 41, 59, 0.5);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 25px;
      border: 1px solid rgba(75, 85, 99, 0.5);
      text-align: center;
    }

    .expired-details p {
      margin: 0;
      color: #d1d5db;
      line-height: 1.6;
      margin-bottom: 15px;
    }

    .back-to-login-btn {
      background: rgba(75, 85, 99, 0.15);
      color: #d1d5db;
      border: 1px solid rgba(75, 85, 99, 0.3);
      border-radius: 999px;
      padding: 12px 24px;
      font-size: 0.95rem;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-top: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 100%;
    }

    .back-to-login-btn:hover {
      background: rgba(75, 85, 99, 0.25);
      transform: translateY(-1px);
    }

    .config-info {
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.3);
      border-radius: 8px;
      padding: 10px;
      margin-top: 15px;
      font-size: 0.8rem;
      color: #93c5fd;
      text-align: center;
    }

    body.light-mode .config-info {
      color: #2563eb;
    }

    .request-credentials-btn {
      background: linear-gradient(to right, #25d366, #128c7e);
      color: white;
      border: none;
      border-radius: 999px;
      padding: 12px 24px;
      font-size: 0.95rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-top: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      box-shadow: 0 8px 18px rgba(37, 211, 102, 0.4);
      width: 100%;
      text-decoration: none;
      text-align: center;
    }

    .request-credentials-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 22px rgba(37, 211, 102, 0.5);
    }

    .request-credentials-btn img {
      width: 24px;
      height: 24px;
      object-fit: contain;
    }

    /* ===== GREETING MESSAGE ===== */
    .greeting-message {
      background: #020617;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid rgba(148, 163, 184, 0.3);
      text-align: center;
      font-size: 1.1rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    body.light-mode .greeting-message {
      background: #ffffff;
      border: 1px solid rgba(0, 0, 0, 0.1);
    }

    .greeting-message span {
      font-weight: 700;
      background: linear-gradient(90deg, #3b82f6, #22c55e);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    /* ===== ORIGINAL CLASS SELECTION ===== */
    .class-selection {
      background: #020617;
      border-radius: 18px;
      padding: 30px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(148, 163, 184, 0.3);
      display: none;
      width: 100%;
    }

    body.light-mode .class-selection {
      background: #ffffff;
      border: 1px solid rgba(0, 0, 0, 0.1);
    }

    .screen-header {
      text-align: center;
      margin-bottom: 30px;
    }

    .screen-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: #e5e7eb;
      margin-bottom: 8px;
      background: linear-gradient(90deg, #3b82f6 0%, #22c55e 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: 0.5px;
    }

    body.light-mode .screen-title {
      color: #1f2937;
    }

    .screen-subtitle {
      font-size: 0.95rem;
      color: #9ca3af;
      text-align: center;
      margin-bottom: 20px;
    }

    .class-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 16px;
      margin-top: 20px;
    }

    .class-card {
      background: rgba(15, 23, 42, 0.7);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 1px solid rgba(75, 85, 99, 0.5);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 120px;
    }

    body.light-mode .class-card {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
    }

    .class-card:hover {
      transform: translateY(-4px);
      background: rgba(31, 41, 55, 0.9);
      border-color: #3b82f6;
      box-shadow: 0 8px 20px rgba(59, 130, 246, 0.3);
    }

    body.light-mode .class-card:hover {
      background: #ffffff;
      border-color: #3b82f6;
    }

    .class-icon {
      font-size: 2rem;
      margin-bottom: 10px;
    }

    .class-name {
      font-size: 1.1rem;
      font-weight: 600;
      color: #e5e7eb;
    }

    body.light-mode .class-name {
      color: #1f2937;
    }

    .class-desc {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-top: 5px;
    }

    /* ===== ORIGINAL SUBJECT SELECTION ===== */
    .subject-selection {
      background: #020617;
      border-radius: 18px;
      padding: 30px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(148, 163, 184, 0.3);
      display: none;
      width: 100%;
    }

    body.light-mode .subject-selection {
      background: #ffffff;
      border: 1px solid rgba(0, 0, 0, 0.1);
    }

    .subject-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-top: 20px;
    }

    .subject-card {
      background: rgba(15, 23, 42, 0.7);
      border-radius: 12px;
      padding: 25px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 1px solid rgba(75, 85, 99, 0.5);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 140px;
    }

    body.light-mode .subject-card {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
    }

    .subject-card:hover {
      transform: translateY(-4px);
      background: rgba(31, 41, 55, 0.9);
      box-shadow: 0 8px 20px rgba(59, 130, 246, 0.3);
    }

    body.light-mode .subject-card:hover {
      background: #ffffff;
    }

    .subject-icon {
      font-size: 2.5rem;
      margin-bottom: 15px;
    }

    .subject-name {
      font-size: 1.2rem;
      font-weight: 600;
      color: #e5e7eb;
    }

    body.light-mode .subject-name {
      color: #1f2937;
    }

    .subject-desc {
      font-size: 0.85rem;
      color: #9ca3af;
      margin-top: 8px;
    }

    .back-btn {
      background: rgba(75, 85, 99, 0.15);
      color: #d1d5db;
      border: 1px solid rgba(75, 85, 99, 0.3);
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-top: 20px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    body.light-mode .back-btn {
      color: #4b5563;
      border: 1px solid #e5e7eb;
      background: #f3f4f6;
    }

    .back-btn:hover {
      background: rgba(75, 85, 99, 0.25);
      transform: translateY(-1px);
    }

    /* ===== ORIGINAL QUIZ CONTAINER ===== */
    .quiz-container {
      background: #020617;
      border-radius: 18px;
      padding: 20px 22px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(148, 163, 184, 0.3);
      display: none;
      width: 100%;
    }

    body.light-mode .quiz-container {
      background: #ffffff;
      border: 1px solid rgba(0, 0, 0, 0.1);
    }

    .topic-section {
      margin-bottom: 20px;
      padding: 15px;
      background: rgba(15, 23, 42, 0.7);
      border-radius: 12px;
      border: 1px solid rgba(75, 85, 99, 0.5);
    }

    body.light-mode .topic-section {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
    }

    .topic-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      flex-wrap: wrap;
      gap: 10px;
    }

    .current-path {
      font-size: 0.85rem;
      color: #93c5fd;
      background: rgba(59, 130, 246, 0.1);
      padding: 6px 12px;
      border-radius: 8px;
      border: 1px solid rgba(59, 130, 246, 0.2);
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    body.light-mode .current-path {
      color: #2563eb;
      background: rgba(59, 130, 246, 0.1);
    }

    .path-separator {
      color: #6b7280;
      margin: 0 4px;
    }

    .path-link {
      color: #93c5fd;
      cursor: pointer;
      text-decoration: underline;
      transition: color 0.2s ease;
    }

    .path-link:hover {
      color: #60a5fa;
    }

    body.light-mode .path-link {
      color: #2563eb;
    }

    .topic-name {
      font-size: 1rem;
      font-weight: 600;
      color: #3b82f6;
      background: rgba(59, 130, 246, 0.15);
      padding: 4px 12px;
      border-radius: 8px;
      border: 1px solid rgba(59, 130, 246, 0.3);
    }

    .question-count {
      font-size: 0.9rem;
      color: #22c55e;
      background: rgba(34, 197, 94, 0.15);
      padding: 4px 12px;
      border-radius: 8px;
      border: 1px solid rgba(34, 197, 94, 0.3);
    }

    .topic-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    .topic-select {
      background: rgba(15, 23, 42, 0.7);
      color: #e5e7eb;
      border-radius: 8px;
      border: 1px solid rgba(75, 85, 99, 0.9);
      padding: 8px 12px;
      font-size: 0.9rem;
      flex: 1;
      min-width: 200px;
    }

    body.light-mode .topic-select {
      background: #ffffff;
      color: #1f2937;
      border: 1px solid #d1d5db;
    }

    .start-btn {
      border-radius: 999px;
      border: none;
      padding: 8px 16px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      background: linear-gradient(to right, #3b82f6, #2563eb);
      color: white;
      box-shadow: 0 8px 18px rgba(37, 99, 235, 0.4);
      white-space: nowrap;
    }

    .start-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 22px rgba(37, 99, 235, 0.5);
    }

    .start-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* ===== ORIGINAL QUESTION NAVIGATION ===== */
    .question-navigation {
      margin: 15px 0;
      padding: 15px;
      background: rgba(15, 23, 42, 0.7);
      border-radius: 12px;
      border: 1px solid rgba(75, 85, 99, 0.5);
      overflow: hidden;
      transition: all 0.3s ease;
      display: block;
    }

    body.light-mode .question-navigation {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
    }

    .question-navigation.collapsed {
      padding: 12px 15px;
    }

    .question-navigation.expanded {
      max-height: none;
    }

    .navigation-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      flex-wrap: wrap;
      gap: 10px;
    }

    .navigation-title {
      font-size: 0.9rem;
      font-weight: 600;
      color: #93c5fd;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .navigation-title i {
      font-size: 1rem;
    }

    body.light-mode .navigation-title {
      color: #2563eb;
    }

    .question-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
      gap: 8px;
      max-height: 200px;
      overflow-y: auto;
      padding: 5px;
      transition: all 0.3s ease;
    }

    .question-navigation.collapsed .question-grid,
    .question-navigation.collapsed .navigation-stats {
      display: none;
    }

    .navigation-toggle-btn {
      background: rgba(139, 92, 246, 0.15);
      color: #a78bfa;
      border: 1px solid rgba(139, 92, 246, 0.3);
      border-radius: 8px;
      padding: 6px 12px;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .navigation-toggle-btn:hover {
      background: rgba(139, 92, 246, 0.25);
      transform: translateY(-1px);
    }

    .navigation-toggle-btn i {
      font-size: 0.9rem;
      transition: transform 0.3s ease;
    }

    .navigation-toggle-btn.collapsed i {
      transform: rotate(-90deg);
    }

    .navigation-stats {
      display: flex;
      gap: 12px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid rgba(75, 85, 99, 0.3);
      flex-wrap: wrap;
      transition: all 0.3s ease;
    }

    .stat-badge {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.8rem;
      padding: 4px 8px;
      border-radius: 6px;
    }

    .stat-badge.answered {
      background: rgba(34, 197, 94, 0.15);
      color: #86efac;
    }

    .stat-badge.not-answered {
      background: rgba(239, 68, 68, 0.15);
      color: #fca5a5;
    }

    .stat-badge.current {
      background: rgba(59, 130, 246, 0.15);
      color: #93c5fd;
    }

    .stat-badge.incorrect {
      background: rgba(239, 68, 68, 0.15);
      color: #fca5a5;
    }

    .toggle-row {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.85rem;
      color: #cbd5f5;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    body.light-mode .toggle-row {
      color: #4b5563;
    }

    .toggle-row.hidden {
      display: none;
    }

    .toggle-row input {
      transform: scale(1.1);
      cursor: pointer;
      accent-color: #3b82f6;
    }

    .toggle-row label {
      cursor: pointer;
    }

    /* ===== ORIGINAL QUESTION IMAGE ===== */
    .question-image-container {
      margin: 15px 0;
      display: none;
      text-align: center;
      width: 100%;
      max-width: 100%;
      overflow: hidden;
      border-radius: 12px;
      background: rgba(15, 23, 42, 0.5);
      border: 2px solid rgba(59, 130, 246, 0.2);
      padding: 8px;
      transition: all 0.3s ease;
    }

    .question-image-container.visible {
      display: block;
      animation: fadeIn 0.5s ease-in;
    }

    .question-image {
      display: block;
      margin: 0 auto;
      max-width: 100%;
      max-height: 35vh;
      height: auto;
      object-fit: contain;
      border-radius: 8px;
      transition: all 0.3s ease;
      cursor: zoom-in;
      background: transparent;
    }

    @media (hover: hover) and (pointer: fine) {
      .question-image:hover {
        transform: scale(1.02);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
      }
      
      .question-image.zoomed {
        transform: scale(1.5);
        cursor: zoom-out;
        z-index: 1000;
        position: relative;
      }
    }

    .question-image.touch-zoom {
      transform: scale(1.5);
      cursor: zoom-out;
      position: relative;
      z-index: 1000;
      max-height: 80vh;
    }

    .image-loading {
      padding: 40px 20px;
      text-align: center;
      color: #9ca3af;
      font-style: italic;
      border-radius: 10px;
      background: linear-gradient(90deg, 
        rgba(30, 41, 59, 0.3) 0%, 
        rgba(30, 41, 59, 0.5) 50%, 
        rgba(30, 41, 59, 0.3) 100%);
      animation: pulse 1.5s infinite;
      border: 2px dashed rgba(59, 130, 246, 0.3);
    }

    .image-error {
      padding: 20px;
      text-align: center;
      color: #fca5a5;
      font-size: 0.9rem;
      border-radius: 10px;
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .option-image {
      max-width: 100%;
      max-height: 120px;
      height: auto;
      border-radius: 6px;
      margin-top: 8px;
      border: 1px solid rgba(148, 163, 184, 0.3);
      display: block;
      object-fit: contain;
      transition: transform 0.2s ease;
    }

    .option:hover .option-image {
      transform: scale(1.03);
    }

    /* ===== ORIGINAL PROGRESS ===== */
    .progress {
      margin-bottom: 16px;
      font-size: 0.85rem;
      color: #9ca3af;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    body.light-mode .progress {
      color: #6b7280;
    }

    .progress.hidden {
      display: none;
    }

    .progress-bar {
      flex: 1;
      height: 6px;
      background: rgba(15, 23, 42, 0.7);
      border-radius: 999px;
      overflow: hidden;
    }

    body.light-mode .progress-bar {
      background: #e5e7eb;
    }

    .progress-bar-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(to right, #22c55e, #3b82f6);
      transition: width 0.3s ease;
    }

    /* ===== ORIGINAL TIMER ===== */
    .timer-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding: 8px 12px;
      background: rgba(59, 130, 246, 0.05);
      border-radius: 12px;
      border: 1px solid rgba(59, 130, 246, 0.2);
    }

    body.light-mode .timer-container {
      background: #f3f4f6;
      border: 1px solid #d1d5db;
    }

    .timer-container.hidden {
      display: none;
    }

    .timer-label {
      font-size: 0.85rem;
      color: #93c5fd;
      white-space: nowrap;
      margin-right: 10px;
    }

    body.light-mode .timer-label {
      color: #2563eb;
    }

    .timer-display {
      font-size: 1.1rem;
      font-weight: 700;
      color: #60a5fa;
      font-family: 'Courier New', monospace;
      letter-spacing: 1px;
      white-space: nowrap;
    }

    body.light-mode .timer-display {
      color: #2563eb;
    }

    .timer-warning {
      color: #fbbf24;
      animation: blink 1s infinite;
    }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .timer-critical {
      color: #ef4444;
      animation: pulse 0.5s infinite;
    }

    .timer-notification {
      margin-bottom: 10px;
      padding: 8px 12px;
      background: rgba(245, 158, 11, 0.1);
      border-radius: 10px;
      border: 1px solid rgba(245, 158, 11, 0.3);
      font-size: 0.85rem;
      color: #fbbf24;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* ===== ORIGINAL QUESTION BOX ===== */
    .question-box {
      background: rgba(15, 23, 42, 0.7);
      border-radius: 14px;
      padding: 14px 14px 10px;
      border: 1px solid rgba(75, 85, 99, 0.7);
      margin-bottom: 16px;
      min-height: 140px;
      position: relative;
    }

    body.light-mode .question-box {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
    }

    .question-text {
      font-size: 1rem;
      font-weight: 500;
      color: #f9fafb;
      line-height: 1.5;
      padding-right: 40px;
    }

    body.light-mode .question-text {
      color: #1f2937;
    }

    .question-whatsapp-icon {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 25px;
      height: 25px;
      cursor: pointer;
      z-index: 100;
      transition: all 0.2s ease;
      opacity: 0.8;
      background: transparent;
      border: none;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .question-whatsapp-icon:hover {
      opacity: 1;
      transform: scale(1.1);
    }

    .question-whatsapp-icon img {
      width: 25px;
      height: 25px;
      object-fit: contain;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
    }

    .question-whatsapp-reserved-area {
      position: absolute;
      top: 0;
      right: 0;
      width: 30px;
      height: 30px;
      pointer-events: none;
      z-index: 50;
    }

    .options {
      list-style: none;
      padding: 0;
      margin: 0;
      display: grid;
      gap: 8px;
      margin-top: 10px;
    }

    .option {
      display: flex;
      align-items: stretch;
      min-height: 50px;
      background: rgba(15, 23, 42, 0.5);
      border-radius: 12px;
      border: 1px solid rgba(75, 85, 99, 0.9);
      cursor: pointer;
      transition: all 0.15s ease, border-color 0.15s ease, transform 0.05s ease;
      font-size: 0.92rem;
      color: #e5e7eb;
      overflow: hidden;
    }

    body.light-mode .option {
      background: #ffffff;
      color: #1f2937;
      border: 1px solid #d1d5db;
    }

    .option-label {
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 40px;
      background: rgba(30, 41, 59, 0.8);
      border-right: 1px solid rgba(75, 85, 99, 0.5);
      font-weight: 600;
      color: #93c5fd;
      padding: 8px;
      flex-shrink: 0;
    }

    body.light-mode .option-label {
      background: #e5e7eb;
      color: #2563eb;
      border-right: 1px solid #d1d5db;
    }

    .option-content {
      flex: 1;
      padding: 8px 12px;
      display: flex;
      align-items: center;
      min-height: 100%;
    }

    .option:hover:not(.disabled) {
      background: rgba(31, 41, 55, 0.9);
      transform: translateY(-1px);
    }

    body.light-mode .option:hover:not(.disabled) {
      background: #f3f4f6;
    }

    .option.correct {
      background: rgba(22, 163, 74, 0.25);
      border-color: #22c55e;
    }

    .option.correct .option-label {
      background: rgba(22, 163, 74, 0.3);
      color: #86efac;
    }

    body.light-mode .option.correct {
      background: #dcfce7;
    }

    body.light-mode .option.correct .option-label {
      background: #bbf7d0;
      color: #166534;
    }

    .option.incorrect {
      background: rgba(220, 38, 38, 0.2);
      border-color: #f97373;
    }

    .option.incorrect .option-label {
      background: rgba(220, 38, 38, 0.3);
      color: #fca5a5;
    }

    body.light-mode .option.incorrect {
      background: #fee2e2;
    }

    body.light-mode .option.incorrect .option-label {
      background: #fecaca;
      color: #991b1b;
    }

    .option.disabled {
      pointer-events: none;
      opacity: 0.9;
    }

    .option.selected {
      border-color: #3b82f6;
      background: rgba(59, 130, 246, 0.15);
    }

    .option.selected .option-label {
      background: rgba(59, 130, 246, 0.25);
      color: #93c5fd;
    }

    .option.selected.correct {
      background: rgba(22, 163, 74, 0.35);
      border-color: #16a34a;
    }

    .option.selected.correct .option-label {
      background: rgba(22, 163, 74, 0.4);
      color: #86efac;
    }

    .option.selected.incorrect {
      background: rgba(220, 38, 38, 0.3);
      border-color: #dc2626;
    }

    .option.selected.incorrect .option-label {
      background: rgba(220, 38, 38, 0.4);
      color: #fca5a5;
    }

    .feedback {
      min-height: 22px;
      font-size: 0.9rem;
      margin-top: 6px;
      padding: 8px 12px;
      border-radius: 8px;
      transition: all 0.3s ease;
    }

    .feedback.correct {
      color: #22c55e;
      background: rgba(22, 163, 74, 0.1);
      border: 1px solid rgba(22, 163, 74, 0.2);
    }

    body.light-mode .feedback.correct {
      color: #166534;
      background: #dcfce7;
    }

    .feedback.incorrect {
      color: #fb7185;
      background: rgba(220, 38, 38, 0.1);
      border: 1px solid rgba(220, 38, 38, 0.2);
    }

    body.light-mode .feedback.incorrect {
      color: #991b1b;
      background: #fee2e2;
    }

    .explanation {
      margin-top: 10px;
      padding: 10px;
      background: rgba(59, 130, 246, 0.1);
      border-radius: 8px;
      border: 1px solid rgba(59, 130, 246, 0.2);
      font-size: 0.9rem;
      color: #93c5fd;
      animation: fadeIn 0.3s ease-in;
    }

    body.light-mode .explanation {
      color: #2563eb;
    }

    .explanation strong {
      color: #60a5fa;
      font-weight: 600;
    }

    /* ===== ORIGINAL CONTROLS ===== */
    .controls {
      margin-top: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }

    .controls.hidden {
      display: none;
    }

    .left-controls {
      display: flex;
      gap: 10px;
      justify-content: flex-start;
      flex: 1;
    }

    .right-controls {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      flex: 1;
    }

    button {
      transition: background 0.15s ease, transform 0.05s ease, box-shadow 0.1s ease;
    }

    #previous-btn {
      border: none;
      border-radius: 999px;
      padding: 8px 18px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      background: #1f2937;
      color: #e5e7eb;
      border: 1px solid rgba(75, 85, 99, 0.8);
      min-width: 120px;
    }

    body.light-mode #previous-btn {
      background: #f3f4f6;
      color: #1f2937;
      border: 1px solid #d1d5db;
    }

    #previous-btn:hover:enabled {
      background: #111827;
    }

    #previous-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    #next-btn {
      border: none;
      border-radius: 999px;
      padding: 8px 18px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      background: #1f2937;
      color: #e5e7eb;
      border: 1px solid rgba(75, 85, 99, 0.8);
      min-width: 120px;
    }

    body.light-mode #next-btn {
      background: #f3f4f6;
      color: #1f2937;
      border: 1px solid #d1d5db;
    }

    #next-btn:hover:enabled {
      background: #111827;
    }

    #next-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    #finish-btn {
      border: none;
      border-radius: 999px;
      padding: 8px 18px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      background: linear-gradient(to right, #f59e0b, #d97706);
      color: white;
      box-shadow: 0 8px 18px rgba(245, 158, 11, 0.4);
      min-width: 120px;
    }

    #finish-btn:hover:enabled {
      transform: translateY(-1px);
      box-shadow: 0 10px 22px rgba(245, 158, 11, 0.5);
    }

    #finish-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .score-box {
      margin-top: 10px;
      font-size: 0.9rem;
      color: #e5e7eb;
    }

    body.light-mode .score-box {
      color: #1f2937;
    }

    /* ===== ORIGINAL FINAL SCORE ===== */
    .final-score {
      margin-top: 10px;
      padding: 15px;
      border-radius: 14px;
      background: rgba(15, 23, 42, 0.7);
      border: 1px solid rgba(75, 85, 99, 0.7);
      font-size: 0.9rem;
    }

    body.light-mode .final-score {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
    }

    .result-header {
      font-size: 1.1rem;
      font-weight: 600;
      color: #3b82f6;
      margin-bottom: 15px;
      text-align: center;
      border-bottom: 1px solid rgba(75, 85, 99, 0.5);
      padding-bottom: 10px;
    }

    .result-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      margin-bottom: 15px;
    }

    .stat-item {
      padding: 8px;
      border-radius: 8px;
      background: rgba(2, 6, 23, 0.5);
      border: 1px solid rgba(75, 85, 99, 0.5);
      display: flex;
      justify-content: space-between;
      align-items: center;
      min-height: 40px;
    }

    body.light-mode .stat-item {
      background: #ffffff;
      border: 1px solid #e5e7eb;
    }

    .stat-label {
      font-size: 0.8rem;
      color: #9ca3af;
      flex-shrink: 0;
      min-width: 100px;
    }

    body.light-mode .stat-label {
      color: #6b7280;
    }

    .stat-value {
      font-size: 0.9rem;
      font-weight: 600;
      color: #e5e7eb;
      text-align: right;
      flex: 1;
      padding-left: 8px;
    }

    body.light-mode .stat-value {
      color: #1f2937;
    }

    .stat-percentage {
      color: #22c55e;
    }

    .stat-time {
      color: #f59e0b;
    }

    .result-summary {
      margin-top: 15px;
      padding: 12px;
      border-radius: 10px;
      background: rgba(2, 6, 23, 0.5);
      border: 1px solid rgba(75, 85, 99, 0.5);
      text-align: center;
      font-size: 0.85rem;
      color: #9ca3af;
    }

    body.light-mode .result-summary {
      background: #f9fafb;
      color: #6b7280;
    }

    .result-message {
      font-size: 0.9rem;
      color: #e5e7eb;
      margin-top: 10px;
      padding: 10px;
      border-radius: 8px;
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.2);
      text-align: center;
    }

    body.light-mode .result-message {
      color: #1f2937;
    }

    .restart-btn {
      background: linear-gradient(to right, #3b82f6, #2563eb);
      color: white;
      border: none;
      border-radius: 999px;
      padding: 10px 20px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      margin-top: 10px;
      transition: all 0.2s ease;
      box-shadow: 0 8px 18px rgba(37, 99, 235, 0.4);
      width: 100%;
    }

    .restart-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 22px rgba(37, 99, 235, 0.5);
    }

    .review-btn {
      background: linear-gradient(to right, #8b5cf6, #7c3aed);
      color: white;
      border: none;
      border-radius: 999px;
      padding: 10px 20px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      margin-top: 8px;
      transition: all 0.2s ease;
      box-shadow: 0 8px 18px rgba(139, 92, 246, 0.4);
      width: 100%;
    }

    .review-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 22px rgba(139, 92, 246, 0.5);
    }

    .review-incorrect-btn {
      background: linear-gradient(to right, #ef4444, #dc2626);
      color: white;
      border: none;
      border-radius: 999px;
      padding: 10px 20px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      margin-top: 8px;
      transition: all 0.2s ease;
      box-shadow: 0 8px 18px rgba(239, 68, 68, 0.4);
      width: 100%;
    }

    .review-incorrect-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 22px rgba(239, 68, 68, 0.5);
    }

    .review-incorrect-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .pdf-report-btn {
      background: linear-gradient(to right, #dc2626, #b91c1c);
      color: white;
      border: none;
      border-radius: 999px;
      padding: 10px 20px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      margin-top: 8px;
      transition: all 0.2s ease;
      box-shadow: 0 8px 18px rgba(220, 38, 38, 0.4);
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .pdf-report-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 22px rgba(220, 38, 38, 0.5);
    }

    .pdf-report-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .questions-answers-btn {
      background: linear-gradient(to right, #10b981, #059669);
      color: white;
      border: none;
      border-radius: 999px;
      padding: 10px 20px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      margin-top: 8px;
      transition: all 0.2s ease;
      box-shadow: 0 8px 18px rgba(16, 185, 129, 0.4);
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .questions-answers-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 22px rgba(16, 185, 129, 0.5);
    }

    /* ===== ORIGINAL PRELOAD INDICATOR ===== */
    .preload-indicator {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(15, 23, 42, 0.95);
      display: none;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      z-index: 9999;
      transition: opacity 0.3s ease;
    }

    .preload-progress {
      width: 80%;
      max-width: 400px;
      background: rgba(30, 41, 59, 0.7);
      height: 8px;
      border-radius: 4px;
      margin: 20px 0;
      overflow: hidden;
    }

    .preload-progress-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #3b82f6, #22c55e);
      transition: width 0.3s ease;
    }

    .preload-status {
      color: #e5e7eb;
      font-size: 1rem;
      margin-top: 20px;
      text-align: center;
    }

    .preload-count {
      color: #93c5fd;
      font-weight: bold;
    }

    /* ===== ORIGINAL PDF OVERLAY ===== */
    .pdf-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(15, 23, 42, 0.95);
      display: none;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      z-index: 10000;
      transition: opacity 0.3s ease;
    }

    .pdf-spinner {
      border: 6px solid rgba(59, 130, 246, 0.3);
      border-radius: 50%;
      border-top: 6px solid #3b82f6;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    .pdf-status {
      color: #e5e7eb;
      font-size: 1.2rem;
      margin-bottom: 10px;
    }

    .pdf-substatus {
      color: #93c5fd;
      font-size: 0.9rem;
      text-align: center;
      max-width: 400px;
    }

    /* ===== ORIGINAL RESPONSIVE ===== */
    @media (max-width: 700px) {
      .fixed-header {
        padding: 8px 12px;
      }
      
      .header-content {
        flex-direction: column;
        gap: 8px;
      }
      
      .header-left {
        width: 100%;
        justify-content: center;
        text-align: center;
      }
      
      .header-right {
        width: 100%;
        justify-content: center;
      }
      
      .logo-header {
        width: 40px;
        height: 40px;
      }
      
      .header-title {
        font-size: 1.1rem;
      }
      
      .header-subtitle {
        font-size: 0.7rem;
      }
      
      .main-content {
        margin-top: 110px;
        padding: 12px;
        gap: 15px;
      }
      
      .quiz-container,
      .class-selection,
      .subject-selection,
      .account-config-error {
        padding: 15px;
        border-radius: 14px;
      }
      
      .login-box {
        padding: 20px;
        margin: 0 12px;
      }
      
      .logo-login {
        width: 60px;
        height: 60px;
      }
      
      .login-title,
      .screen-title,
      .error-title {
        font-size: 1.3rem;
      }
      
      .controls {
        flex-direction: column;
        gap: 8px;
      }
      
      .left-controls, .right-controls {
        width: 100%;
        justify-content: center;
      }
      
      button {
        flex: 1;
        min-width: 0;
        font-size: 0.85rem;
        padding: 8px 12px;
      }
      
      .class-grid {
        grid-template-columns: 1fr;
      }
      
      .subject-grid {
        grid-template-columns: 1fr;
      }
      
      .topic-info {
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
      }
      
      .topic-name, .question-count {
        width: 100%;
        text-align: center;
        font-size: 0.9rem;
      }
      
      .topic-row {
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
      }
      
      .topic-row .topic-select,
      .topic-row .start-btn {
        width: 100%;
      }
      
      .topic-select {
        min-width: 0;
        width: 100%;
      }
      
      .start-btn {
        width: 100%;
      }
      
      .timer-container {
        flex-direction: row;
        gap: 5px;
        align-items: center;
        padding: 6px 10px;
      }
      
      .timer-label {
        font-size: 0.8rem;
        margin-right: 5px;
        white-space: nowrap;
        flex-shrink: 0;
      }
      
      .timer-display {
        font-size: 0.95rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        flex: 1;
        min-width: 0;
        text-align: right;
      }
      
      .question-box {
        padding: 12px;
        min-height: 120px;
      }
      
      .question-text {
        font-size: 0.95rem;
        padding-right: 35px;
      }
      
      .question-whatsapp-icon {
        top: 8px;
        right: 8px;
        width: 22px;
        height: 22px;
      }
      
      .question-whatsapp-icon img {
        width: 22px;
        height: 22px;
      }
      
      .option {
        min-height: 45px;
      }
      
      .option-label {
        min-width: 35px;
        font-size: 0.85rem;
        padding: 6px;
      }
      
      .option-content {
        padding: 6px 10px;
        font-size: 0.9rem;
      }
      
      .final-score {
        padding: 12px;
      }
      
      .result-stats {
        grid-template-columns: 1fr;
        gap: 6px;
      }
      
      .stat-item {
        padding: 6px;
        min-height: 35px;
      }
      
      .stat-label {
        font-size: 0.75rem;
        min-width: 80px;
      }
      
      .stat-value {
        font-size: 0.8rem;
      }
      
      .result-header {
        font-size: 1rem;
        padding-bottom: 8px;
        margin-bottom: 12px;
      }
      
      .result-message {
        font-size: 0.85rem;
        padding: 8px;
        margin-top: 8px;
      }
      
      .result-summary {
        padding: 10px;
        font-size: 0.8rem;
        margin-top: 12px;
      }
      
      .restart-btn,
      .review-btn,
      .review-incorrect-btn,
      .pdf-report-btn,
      .questions-answers-btn {
        font-size: 0.85rem;
        padding: 8px 16px;
        margin-top: 6px;
      }
      
      .password-toggle {
        top: 50%;
        right: 10px;
      }
      
      .question-image {
        max-height: 35vh;
      }
      
      .question-navigation {
        padding: 12px;
        margin: 10px 0;
      }
      
      .question-navigation.collapsed {
        padding: 10px 12px;
      }
      
      .question-box.hidden-on-mobile {
        display: none;
      }
      
      .error-details {
        padding: 15px;
      }
      
      .error-user-info {
        padding: 12px;
      }
    }

    @media (min-width: 701px) {
      .main-content {
        margin: 100px auto 20px;
        padding: 20px;
      }
      
      .header-title {
        font-size: 1.4rem;
      }
      
      .header-subtitle {
        font-size: 0.85rem;
      }
      
      .result-stats {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    @media (max-width: 400px) {
      .header-title {
        font-size: 1rem;
      }
      
      .header-subtitle {
        font-size: 0.65rem;
      }
      
      .logo-header {
        width: 35px;
        height: 35px;
      }
      
      .main-content {
        padding: 10px;
        margin-top: 105px;
      }
      
      .quiz-container,
      .class-selection,
      .subject-selection,
      .account-config-error {
        padding: 12px;
      }
      
      .login-box {
        padding: 15px;
      }
      
      .logo-login {
        width: 50px;
        height: 50px;
      }
      
      .timer-label {
        font-size: 0.75rem;
      }
      
      .timer-display {
        font-size: 0.85rem;
      }
      
      .class-card,
      .subject-card {
        padding: 15px;
        min-height: 100px;
      }
      
      .class-icon {
        font-size: 1.5rem;
      }
      
      .subject-icon {
        font-size: 2rem;
      }
      
      .password-toggle {
        top: 50%;
        right: 8px;
        font-size: 1rem;
      }
      
      .question-image {
        max-height: 30vh;
      }
      
      .question-text {
        font-size: 0.95rem;
        padding-right: 30px;
      }
      
      .question-whatsapp-icon {
        top: 6px;
        right: 6px;
        width: 20px;
        height: 20px;
      }
      
      .question-whatsapp-icon img {
        width: 20px;
        height: 20px;
      }
      
      .option-label {
        min-width: 30px;
        font-size: 0.8rem;
        padding: 4px;
      }
      
      .option-content {
        padding: 5px 8px;
        font-size: 0.85rem;
      }
      
      .question-navigation {
        padding: 10px;
        margin: 8px 0;
      }
      
      .question-navigation.collapsed {
        padding: 8px 10px;
      }
      
      .navigation-header {
        flex-direction: row;
        align-items: center;
        gap: 8px;
      }
      
      .navigation-toggle-btn {
        width: auto;
        justify-content: center;
        font-size: 0.7rem;
        padding: 4px 8px;
      }
      
      .final-score {
        padding: 10px;
      }
      
      .result-stats {
        gap: 4px;
      }
      
      .stat-item {
        padding: 4px 6px;
        min-height: 30px;
      }
      
      .stat-label {
        font-size: 0.7rem;
        min-width: 70px;
      }
      
      .stat-value {
        font-size: 0.75rem;
      }
      
      .result-header {
        font-size: 0.95rem;
        margin-bottom: 10px;
      }
      
      .result-message {
        font-size: 0.8rem;
        padding: 6px;
      }
      
      .result-summary {
        padding: 8px;
        font-size: 0.75rem;
      }
    }
  </style>
  <!-- Cache busting meta tags -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
</head>
<body>
  <!-- Image Preloading Overlay -->
  <div id="preload-overlay" class="preload-indicator">
    <div style="font-size: 1.5rem; color: #60a5fa; margin-bottom: 20px;">Loading Images...</div>
    <div class="preload-progress">
      <div id="preload-progress-fill" class="preload-progress-fill"></div>
    </div>
    <div id="preload-status" class="preload-status">
      Loading images: <span id="preload-count" class="preload-count">0/0</span>
    </div>
    <div style="font-size: 0.8rem; color: #9ca3af; margin-top: 10px; text-align: center;">
      This will make images load instantly during the quiz
    </div>
  </div>
  
  <!-- PDF Generating Overlay -->
  <div id="pdf-overlay" class="pdf-overlay">
    <div class="pdf-spinner"></div>
    <div id="pdf-status" class="pdf-status">Generating PDF Report...</div>
    <div id="pdf-substatus" class="pdf-substatus">Please wait while we create your detailed performance report</div>
  </div>
  
  <!-- Fixed Header - REMOVED username and logout button -->
  <div class="fixed-header" style="display: none;">
    <div class="header-content">
      <div class="header-left">
        <img src="logo.png" alt="Logo" class="logo-header">
        <div class="header-title-container">
          <div class="header-title">G.S. Tutorial â€“ Interactive Learning App</div>
          <div class="header-subtitle">Created by Gobind Sharma</div>
        </div>
      </div>
      <div class="header-right">
        <!-- REMOVED user-info and logout-btn - only menu toggle remains -->
        <div class="menu-toggle" id="menuToggle">
          <span></span><span></span><span></span>
        </div>
      </div>
    </div>
  </div>

  <!-- IMPROVED Side Menu - Fixed light mode text, proper spacing -->
  <div class="side-menu" id="sideMenu">
    <!-- Profile Section -->
    <div class="side-profile">
      <img src="gobind.png" alt="Gobind Sharma" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22 viewBox=%220 0 100 100%22%3E%3Ccircle cx=%2250%22 cy=%2250%22 r=%2250%22 fill=%22%233b82f6%22/%3E%3Ctext x=%2230%22 y=%2270%22 font-size=%2240%22 fill=%22white%22%3EGS%3C/text%3E%3C/svg%3E'">
      <h3>Gobind Sharma</h3>
      <p>Developer</p>
    </div>

    <!-- Developer Contact Section -->
    <div class="side-dev">
      <h4>ðŸ“± Contact Developer</h4>
      <div class="contact-item" onclick="window.open('https://wa.me/919706195457', '_blank')">
        <img src="whatsapp.png" alt="WhatsApp" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2224%22 height=%2224%22 viewBox=%220 0 24 24%22%3E%3Cpath fill=%22%2325d366%22 d=%22M19.077 4.928C17.191 3.041 14.683 2 12.006 2c-5.26 0-9.54 4.28-9.54 9.54 0 1.68.44 3.318 1.278 4.758L2.5 21.5l5.342-1.403c1.377.744 2.926 1.137 4.523 1.137h.004c5.258 0 9.535-4.28 9.535-9.54 0-2.548-.99-4.944-2.787-6.766zM12.006 20.05h-.003c-1.415 0-2.802-.38-4.007-1.1l-.287-.17-3.173.834.85-3.1-.185-.3c-.68-1.1-1.04-2.37-1.04-3.67 0-3.95 3.22-7.17 7.18-7.17 1.91 0 3.71.75 5.06 2.11 1.35 1.36 2.1 3.16 2.1 5.08 0 3.96-3.22 7.18-7.18 7.18z%22/%3E%3C/svg%3E'"><span>WhatsApp</span>
      </div>
      <div class="contact-item" onclick="window.location.href='tel:+919706195457'">
        <img src="phone.png" alt="Call" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2224%22 height=%2224%22 viewBox=%220 0 24 24%22%3E%3Cpath fill=%22%233b82f6%22 d=%22M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z%22/%3E%3C/svg%3E'"><span>+91 97061 95457</span>
      </div>
      <div class="contact-item" onclick="window.location.href='mailto:gobind.bngn@gmail.com'">
        <img src="email.png" alt="Email" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2224%22 height=%2224%22 viewBox=%220 0 24 24%22%3E%3Cpath fill=%22%23ea4335%22 d=%22M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z%22/%3E%3C/svg%3E'"><span>gobind.bngn@gmail.com</span>
      </div>
    </div>

    <!-- Theme Toggle -->
    <div class="theme-toggle" id="themeToggle">
      <span>ðŸŒ™ Dark / Light</span>
      <span id="themeIcon">ðŸŒ™</span>
    </div>

    <!-- Current User Section -->
    <div class="current-user">
      <div class="current-user-label">Currently logged in</div>
      <div class="current-user-name" id="sideUsername">Guest</div>
    </div>

    <!-- Logout Button -->
    <div class="logout-side" id="sideLogoutBtn">
      ðŸ”“ Logout
    </div>
  </div>
  <div class="menu-overlay" id="menuOverlay"></div>

  <!-- Main Content Area -->
  <div class="main-content">
    <!-- Login Container -->
    <div id="login-container">
      <div class="login-box">
        <div class="login-header">
          <img src="logo.png" alt="G. S. Tutorial Logo" class="logo-login">
          <div class="login-title">G. S. Tutorial Login</div>
          <div class="login-subtitle">Created by Gobind Sharma</div>
        </div>
        
        <form id="login-form" class="login-form">
          <div class="form-group">
            <label for="username">Username</label>
            <input type="text" id="username" class="form-input" placeholder="Enter your username" required autocomplete="username">
          </div>
          
          <div class="form-group">
            <label for="password">Password</label>
            <div class="password-input-wrapper">
              <input type="password" id="password" class="form-input" placeholder="Enter your password" required autocomplete="current-password">
              <button type="button" class="password-toggle" id="password-toggle" aria-label="Show password">ðŸ‘ï¸</button>
            </div>
            <div id="attempt-counter" class="attempt-counter" style="display: none;">
              Attempts remaining: <span id="attempts-remaining">3</span>
            </div>
            <div id="cooldown-message" class="cooldown-message" style="display: none;">
              Too many failed attempts. Please wait <span id="cooldown-timer">30</span> seconds.
            </div>
          </div>
          
          <div id="login-error" class="login-error"></div>
          
          <button type="submit" class="login-btn" id="login-btn">Login</button>
          
          <a href="https://wa.me/919706195457?text=Hello%20Admin,%20I%20need%20login%20credentials%20for%20G.S.%20Tutorial%20App.%20Please%20create%20username%20and%20password%20for%20me." 
             class="request-credentials-btn" target="_blank">
            <img src="whatsapp.png" alt="WhatsApp" style="width: 24px; height: 24px;">
            Request Login Credentials
          </a>
        </form>
        
        <div class="config-info">
          Â© 2025 G.S. Tutorial. All rights reserved.
        </div>
      </div>
    </div>
    
    <!-- Account Configuration Error Screen -->
    <div class="account-config-error" id="account-config-error">
      <div class="error-header">
        <div class="error-title">Account Configuration Required</div>
        <div class="error-subtitle">G.S. Tutorial â€“ Interactive Learning</div>
      </div>
      
      <div class="error-user-info">
        Hello <strong id="error-username">User</strong>!<br>
        Your account (Role: <strong id="error-role">User</strong>) requires proper configuration.
      </div>
      
      <div class="error-details">
        <ul id="error-list">
          <li>There seems to be an issue with your account configuration.</li>
          <li>Please contact the administrator to resolve this issue.</li>
        </ul>
      </div>
      
      <a href="https://wa.me/919706195457?text=Hello%20Admin,%20I%20need%20help%20with%20my%20account%20configuration%20for%20G.S.%20Tutorial.%20Username:%20" 
         class="whatsapp-btn" id="whatsapp-btn" target="_blank">
        <img src="whatsapp.png" alt="WhatsApp" style="width: 24px; height: 24px;">
        Contact Admin on WhatsApp
      </a>
      
      <button class="back-to-login-btn" id="back-to-login-btn">
        â† Back to Login
      </button>
    </div>
    
    <!-- Subscription Expired Screen -->
    <div class="subscription-expired" id="subscription-expired">
      <div class="expired-header">
        <div class="expired-title">Subscription Expired</div>
        <div class="expired-subtitle">G.S. Tutorial â€“ Interactive Learning</div>
      </div>
      
      <div class="expired-user-info">
        Hello <strong id="expired-username">User</strong>!<br>
        Your account access has expired.
      </div>
      
      <div class="expired-details">
        <p><strong>Joining Date:</strong> <span id="expired-joining-date">Not available</span></p>
        <p><strong>Expiry Date:</strong> <span id="expired-last-date">Not available</span></p>
        <p>Your trial period or subscription has ended. To continue using G.S. Tutorial, please contact the administrator to extend your access.</p>
      </div>
      
      <a href="https://wa.me/919706195457?text=Hello%20Admin,%20my%20G.S.%20Tutorial%20subscription%20has%20expired.%20Username:%20" 
         class="whatsapp-btn" id="expired-whatsapp-btn" target="_blank">
        <img src="whatsapp.png" alt="WhatsApp" style="width: 24px; height: 24px;">
        Contact Admin
      </a>
      
      <button class="back-to-login-btn" id="back-to-login-from-expired-btn">
        â† Back to Login
      </button>
    </div>
    
    <!-- Class Selection Screen -->
    <div class="class-selection" id="class-selection">
      <div class="greeting-message" id="greetingMessage"></div>
      <div class="screen-header">
        <div class="screen-title">Select Your Class</div>
        <div class="screen-subtitle">Choose your class and Start</div>
      </div>
      <div class="class-grid" id="class-grid">
        <!-- Classes will be loaded dynamically -->
      </div>
    </div>
    
    <!-- Subject Selection Screen -->
    <div class="subject-selection" id="subject-selection">
      <div class="screen-header">
        <div class="screen-title">Select Subject</div>
        <div class="screen-subtitle" id="current-class-display">Class</div>
      </div>
      <div class="subject-grid" id="subject-grid">
        <!-- Subjects will be loaded dynamically -->
      </div>
      <button class="back-btn" id="back-to-classes-btn">
        â† Back to Classes
      </button>
    </div>
    
    <!-- Quiz Container -->
    <div class="quiz-container" id="quiz-container">
      <!-- Path Display -->
      <div id="current-path" class="current-path" style="display: none;"></div>
      
      <!-- TOPIC SELECTION SECTION -->
      <div class="topic-section">
        <div class="topic-info">
          <div class="topic-name" id="quiz-topic-name">No chapter selected</div>
          <div class="question-count" id="quiz-question-count">0 questions</div>
        </div>
        
        <div class="topic-row">
          <select id="topic-select" class="topic-select">
            <option value="">Loading chapters...</option>
          </select>
          <button class="start-btn" id="start-btn" disabled>Start</button>
        </div>
      </div>

      <!-- QUESTION NAVIGATION SECTION -->
      <div id="question-navigation" class="question-navigation collapsed">
        <div class="navigation-header">
          <div class="navigation-title">
            Question Navigation
          </div>
          <button id="navigation-toggle-btn" class="navigation-toggle-btn collapsed">
            <i>â–¶</i> Show Navigation
          </button>
        </div>
        <div id="question-grid" class="question-grid">
          <!-- Question buttons will be loaded dynamically -->
        </div>
        <div id="navigation-stats" class="navigation-stats">
          <!-- Stats will be loaded dynamically -->
        </div>
      </div>

      <!-- Timer Container -->
      <div id="timer-container" class="timer-container" style="display: none;">
        <div class="timer-label">Time Remaining:</div>
        <div id="timer-display" class="timer-display">--:--:--</div>
      </div>

      <!-- RANDOMIZE TOGGLE -->
      <div class="toggle-row">
        <input type="checkbox" id="random-toggle" checked />
        <label for="random-toggle">Randomize questions & options</label>
      </div>

      <div class="progress">
        <div id="question-counter">Choose a chapter and click Start</div>
        <div class="progress-bar">
          <div id="progress-bar-fill" class="progress-bar-fill"></div>
        </div>
        <div id="score-mini">Score: 0</div>
      </div>

      <div class="question-box" id="question-box">
        <!-- WhatsApp Icon Button -->
        <button id="question-whatsapp-icon" class="question-whatsapp-icon" style="display: none;" 
                title="Report issue or ask about this question">
          <img src="whatsapp.png" alt="WhatsApp Support">
        </button>
        <!-- Reserved area for WhatsApp icon -->
        <div class="question-whatsapp-reserved-area"></div>
        
        <div id="question-text" class="question-text">
          Please select a chapter to start.
        </div>
        
        <!-- QUESTION IMAGE CONTAINER -->
        <div id="question-image-container" class="question-image-container">
          <img id="question-image" class="question-image" src="" alt="Question Image" 
               onclick="toggleImageZoom(this)">
          <div id="image-loading" class="image-loading" style="display: none;">
            <div>Loading image...</div>
          </div>
          <div id="image-error" class="image-error" style="display: none;">
            <div>Image not available</div>
          </div>
        </div>
        
        <ul id="options-list" class="options"></ul>
        <div id="feedback" class="feedback"></div>
      </div>

      <!-- BUTTON LAYOUT -->
      <div class="controls">
        <div class="left-controls">
          <button id="previous-btn" disabled>â† Previous</button>
          <button id="next-btn" disabled>Next â†’</button>
        </div>
        <div class="right-controls">
          <button id="finish-btn" disabled>Submit</button>
        </div>
      </div>

      <div class="score-box">
        <div id="final-score" class="final-score" style="display:none;"></div>
      </div>
    </div>
  </div>

  <script>
    // ========== APPS SCRIPT CONFIGURATION ==========
    const AUTH_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx06h9aa6wDmtDz3jBwNgOuoiz7-NZY1nJaEwts3A7vIHRkWfAU5O3N4UNUooCwvEm7Lw/exec';
    const MASTER_CONFIG_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw2CCk6wZgSWwLVyi4-6izf0DNIvcG-E64_jfsT0TgclHZ_PIevnAEdLq6B2Ccc6ABK/exec';

    // ========== CACHE CONFIGURATION ==========
    let ALL_CONFIG_CACHE = null;
    let ALL_CONFIG_CACHE_TIME = null;
    const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes

    // ========== GLOBAL VARIABLES ==========
    let questions = [];
    let currentIndex = 0;
    let score = 0;
    let hasAnswered = false;
    let questionsLoaded = false;
    let attempted = 0;
    let userAnswers = [];
    let timeRemaining = 0;
    let timerInterval = null;
    let currentTopicName = "";
    let timerDuration = 0;
    let quizStartTime = null;
    let timerNotification = null;
    let isReviewMode = false;
    let isIncorrectReviewMode = false;
    let incorrectQuestionIndices = [];
    
    // Image preloading system
    let imageCache = new Map();
    let totalImagesToPreload = 0;
    let imagesPreloaded = 0;
    
    // Login system variables
    let currentUser = null;
    let inactivityTimer = null;
    const INACTIVITY_TIMEOUT = 10 * 60 * 1000; // 10 minutes
    
    // Login attempt tracking
    let failedAttempts = 0;
    const MAX_ATTEMPTS = 3;
    const COOLDOWN_TIME = 30;
    let isOnCooldown = false;
    let cooldownTimer = null;
    
    // Navigation variables
    let currentClass = "";
    let currentSubject = "";
    let chaptersList = [];
    let currentSubjectConfig = null;
    
    // Logging
    let userIP = 'Unknown';
    let currentQuizStats = null;
    
    // Notification tracking
    let hasSentLoginNotification = false;
    let hasSentQuizResultNotification = false;
    let currentQuizSessionId = null;

    // Telegram config
    let TELEGRAM_CONFIG = {
        ENABLED: false,
        BOT_TOKEN: '',
        CHAT_ID: ''
    };

    // Admin config
    let ADMIN_CONFIG = {
        NOTIFY_ON_LOGIN: false,
        NOTIFY_ON_QUIZ_RESULT: false
    };

    // ========== DOM ELEMENTS ==========
    const fixedHeaderEl = document.querySelector(".fixed-header");
    const headerUserInfoEl = document.getElementById("header-user-info");
    const headerUsernameEl = document.getElementById("header-username");
    const headerLogoutBtnEl = document.getElementById("header-logout-btn");
    
    const loginContainerEl = document.getElementById("login-container");
    const classSelectionEl = document.getElementById("class-selection");
    const subjectSelectionEl = document.getElementById("subject-selection");
    const quizContainerEl = document.getElementById("quiz-container");
    const accountConfigErrorEl = document.getElementById("account-config-error");
    const subscriptionExpiredEl = document.getElementById("subscription-expired");
    
    const loginFormEl = document.getElementById("login-form");
    const usernameEl = document.getElementById("username");
    const passwordEl = document.getElementById("password");
    const passwordToggleEl = document.getElementById("password-toggle");
    const loginErrorEl = document.getElementById("login-error");
    const loginBtnEl = document.getElementById("login-btn");
    const attemptCounterEl = document.getElementById("attempt-counter");
    const attemptsRemainingEl = document.getElementById("attempts-remaining");
    const cooldownMessageEl = document.getElementById("cooldown-message");
    const cooldownTimerEl = document.getElementById("cooldown-timer");
    
    const accountConfigErrorUsernameEl = document.getElementById("error-username");
    const accountConfigErrorRoleEl = document.getElementById("error-role");
    const accountConfigErrorListEl = document.getElementById("error-list");
    const whatsappBtnEl = document.getElementById("whatsapp-btn");
    const backToLoginBtnEl = document.getElementById("back-to-login-btn");
    
    const expiredUsernameEl = document.getElementById("expired-username");
    const expiredJoiningDateEl = document.getElementById("expired-joining-date");
    const expiredLastDateEl = document.getElementById("expired-last-date");
    const expiredWhatsappBtnEl = document.getElementById("expired-whatsapp-btn");
    const backToLoginFromExpiredBtn = document.getElementById("back-to-login-from-expired-btn");
    
    const classGridEl = document.getElementById("class-grid");
    const subjectGridEl = document.getElementById("subject-grid");
    const currentClassDisplayEl = document.getElementById("current-class-display");
    const backToClassesBtn = document.getElementById("back-to-classes-btn");
    const currentPathEl = document.getElementById("current-path");
    
    const topicSelectEl = document.getElementById("topic-select");
    const startBtnEl = document.getElementById("start-btn");
    const randomToggleEl = document.getElementById("random-toggle");
    const toggleRowEl = document.querySelector(".toggle-row");
    const quizTopicNameEl = document.getElementById("quiz-topic-name");
    const quizQuestionCountEl = document.getElementById("quiz-question-count");
    const timerContainerEl = document.getElementById("timer-container");
    const timerDisplayEl = document.getElementById("timer-display");
    
    const questionNavigationEl = document.getElementById("question-navigation");
    const questionGridEl = document.getElementById("question-grid");
    const navigationToggleBtn = document.getElementById("navigation-toggle-btn");
    const navigationStatsEl = document.getElementById("navigation-stats");
    
    const questionTextEl = document.getElementById("question-text");
    const questionBoxEl = document.getElementById("question-box");
    const questionImageContainerEl = document.getElementById("question-image-container");
    const questionImageEl = document.getElementById("question-image");
    const imageLoadingEl = document.getElementById("image-loading");
    const imageErrorEl = document.getElementById("image-error");
    
    const optionsListEl = document.getElementById("options-list");
    const feedbackEl = document.getElementById("feedback");
    const nextBtn = document.getElementById("next-btn");
    const previousBtn = document.getElementById("previous-btn");
    const finishBtn = document.getElementById("finish-btn");
    const questionCounterEl = document.getElementById("question-counter");
    const progressEl = document.querySelector(".progress");
    const progressBarFillEl = document.getElementById("progress-bar-fill");
    const scoreMiniEl = document.getElementById("score-mini");
    const finalScoreEl = document.getElementById("final-score");
    const controlsEl = document.querySelector(".controls");
    
    const preloadOverlayEl = document.getElementById("preload-overlay");
    const preloadProgressFillEl = document.getElementById("preload-progress-fill");
    const preloadStatusEl = document.getElementById("preload-status");
    const preloadCountEl = document.getElementById("preload-count");
    
    const pdfOverlayEl = document.getElementById("pdf-overlay");
    const pdfStatusEl = document.getElementById("pdf-status");
    const pdfSubstatusEl = document.getElementById("pdf-substatus");

    const questionWhatsappIconEl = document.getElementById("question-whatsapp-icon");

    // Side menu elements
    const menuToggle = document.getElementById('menuToggle');
    const sideMenu = document.getElementById('sideMenu');
    const menuOverlay = document.getElementById('menuOverlay');
    const sideUsername = document.getElementById('sideUsername');
    const sideLogoutBtn = document.getElementById('sideLogoutBtn');
    const themeToggle = document.getElementById('themeToggle');
    const themeIcon = document.getElementById('themeIcon');
    const metaThemeColor = document.getElementById('meta-theme-color');
    const greetingMessageEl = document.getElementById('greetingMessage');

    // ========== PASSWORD TOGGLE FUNCTION ==========
    function togglePasswordVisibility() {
      if (passwordEl.type === 'password') {
        passwordEl.type = 'text';
        passwordToggleEl.textContent = 'ðŸ™ˆ';
      } else {
        passwordEl.type = 'password';
        passwordToggleEl.textContent = 'ðŸ‘ï¸';
      }
    }

    // ========== HELPER FUNCTIONS ==========
    function formatDisplayDate(val) {
      if (!val) return "Not available";
      try {
        let d = null;
        if (typeof val === "string" && val.startsWith("Date(")) {
          const parts = val.replace("Date(", "").replace(")", "").split(",").map(Number);
          d = new Date(parts[0], parts[1], parts[2]);
        } else {
          d = new Date(val);
        }
        if (!d || isNaN(d.getTime())) return "Not available";
        return d.toLocaleDateString("en-GB", { day: "numeric", month: "short", year: "numeric" });
      } catch (e) {
        return "Not available";
      }
    }

    function getSubjectIcon(subject) {
      const subjectLower = subject.toLowerCase();
      if (subjectLower.includes('math')) return 'ðŸ“';
      if (subjectLower.includes('science')) return 'ðŸ”¬';
      if (subjectLower.includes('physics')) return 'âš¡';
      if (subjectLower.includes('chem')) return 'ðŸ§ª';
      if (subjectLower.includes('bio')) return 'ðŸ§¬';
      if (subjectLower.includes('mech')) return 'âš™ï¸';
      if (subjectLower.includes('elect')) return 'âš¡';
      if (subjectLower.includes('english')) return 'ðŸ“–';
      if (subjectLower.includes('social')) return 'ðŸŒ';
      return 'ðŸ“š';
    }

    function getSubjectDescription(subject) {
      const subjectLower = subject.toLowerCase();
      if (subjectLower.includes('math')) return 'Mathematics - Numbers, Algebra, Geometry';
      if (subjectLower.includes('science')) return 'Science - Physics, Chemistry, Biology';
      if (subjectLower.includes('physics')) return 'Physics - Laws of motion, Energy';
      if (subjectLower.includes('chem')) return 'Chemistry - Elements, Reactions';
      if (subjectLower.includes('bio')) return 'Biology - Life processes, Cells';
      if (subjectLower.includes('mech')) return 'Mechanical Engineering - Machines';
      if (subjectLower.includes('elect')) return 'Electrical Engineering - Circuits';
      return 'Interactive Learning';
    }

    // ========== LOAD ALL CONFIG AT ONCE (CACHED) ==========
    async function loadAllConfigAtOnce() {
      // Check cache first
      if (ALL_CONFIG_CACHE && ALL_CONFIG_CACHE_TIME && 
          (Date.now() - ALL_CONFIG_CACHE_TIME < CACHE_DURATION)) {
        console.log("Using cached config");
        return ALL_CONFIG_CACHE;
      }

      try {
        // Add timestamp to bypass cache
        const data = await jsonpRequest(
          MASTER_CONFIG_APPS_SCRIPT_URL + '?action=getAllConfig&_t=' + Date.now(),
          'allConfigCallback'
        );
        
        if (data.success) {
          ALL_CONFIG_CACHE = data;
          ALL_CONFIG_CACHE_TIME = Date.now();
          console.log("All config loaded and cached for 5 minutes");
          return data;
        } else {
          throw new Error(data.error || 'Failed to load config');
        }
      } catch (error) {
        console.error("Error loading all config:", error);
        return null;
      }
    }

    // ========== SUBSCRIPTION EXPIRED FUNCTIONS ==========
    function showSubscriptionExpired(user, joiningDate, lastDate) {
        expiredUsernameEl.textContent = user.name;
        expiredJoiningDateEl.textContent = formatDisplayDate(joiningDate);
        expiredLastDateEl.textContent = formatDisplayDate(lastDate);
        
        const whatsappMessage = `Hello Admin, my G.S. Tutorial subscription has expired. Username: ${user.username}`;
        const encodedMessage = encodeURIComponent(whatsappMessage);
        expiredWhatsappBtnEl.href = `https://wa.me/919706195457?text=${encodedMessage}`;
        
        fixedHeaderEl.style.display = "none";
        loginContainerEl.style.display = "none";
        classSelectionEl.style.display = "none";
        subjectSelectionEl.style.display = "none";
        quizContainerEl.style.display = "none";
        accountConfigErrorEl.style.display = "none";
        subscriptionExpiredEl.style.display = "block";
        
        resetInactivityTimer();
    }

    // ========== ACCOUNT CONFIGURATION ERROR FUNCTIONS ==========
    function showAccountConfigError(user, errorType, errorDetails = {}) {
        accountConfigErrorUsernameEl.textContent = user.name;
        accountConfigErrorRoleEl.textContent = user.role;
        
        const whatsappMessage = `Hello Admin, I need help with my account configuration for G.S. Tutorial. Username: ${user.username}`;
        const encodedMessage = encodeURIComponent(whatsappMessage);
        whatsappBtnEl.href = `https://wa.me/919706195457?text=${encodedMessage}`;
        
        let errorListHTML = '';
        
        switch(errorType) {
            case 'invalid_role':
                errorListHTML = `
                    <li><strong>Invalid Role:</strong> Your role is set to "${user.role}" which is not recognized.</li>
                    <li>Valid roles are: <strong>Admin, Teacher, User, Student</strong>.</li>
                    <li>Please contact the administrator to update your role in the Google Sheet.</li>
                `;
                break;
                
            case 'no_class_assigned':
                if (user.role === 'Student') {
                    errorListHTML = `
                        <li><strong>No Class Assigned:</strong> As a <strong>Student</strong>, you need to be assigned to a specific class.</li>
                        <li>Your account currently has <strong>no class</strong> assigned in the Google Sheet.</li>
                        <li>Please ask the administrator to assign you to a class.</li>
                    `;
                } else if (user.role === 'Teacher' || user.role === 'User') {
                    errorListHTML = `
                        <li><strong>No Classes Assigned:</strong> As a <strong>${user.role}</strong>, you need to be assigned to one or more classes.</li>
                        <li>Your account currently has <strong>no classes</strong> assigned in the Google Sheet.</li>
                        <li>Please ask the administrator to assign you to at least one class.</li>
                    `;
                }
                break;
                
            case 'class_not_in_system':
                const assignedClasses = errorDetails.assignedClasses || [];
                const availableClasses = errorDetails.availableClasses || [];
                
                errorListHTML = `
                    <li><strong>Class Assignment Issue:</strong> The classes assigned to you are not available in the system.</li>
                    <li><strong>Assigned to you:</strong> ${assignedClasses.join(', ') || 'None'}</li>
                    <li><strong>Available classes:</strong> ${availableClasses.map(c => c.name).join(', ')}</li>
                    <li>Please contact the administrator to update your class assignment.</li>
                `;
                break;
                
            default:
                errorListHTML = `
                    <li>There seems to be an issue with your account configuration.</li>
                    <li>Please contact the administrator to resolve this issue.</li>
                `;
        }
        
        accountConfigErrorListEl.innerHTML = errorListHTML;
        
        fixedHeaderEl.style.display = "none";
        loginContainerEl.style.display = "none";
        classSelectionEl.style.display = "none";
        subjectSelectionEl.style.display = "none";
        quizContainerEl.style.display = "none";
        subscriptionExpiredEl.style.display = "none";
        accountConfigErrorEl.style.display = "block";
        
        resetInactivityTimer();
    }

    // ========== WHATSAPP QUESTION SUPPORT FUNCTION ==========
    function setupQuestionWhatsAppSupport() {
      if (!questionWhatsappIconEl) return;
      
      questionWhatsappIconEl.addEventListener("click", function() {
        if (!currentUser || !questionsLoaded || questions.length === 0 || currentIndex >= questions.length) {
          alert("Question information not available.");
          return;
        }
        
        const q = questions[currentIndex];
        let optionsText = "";
        q.options.forEach((opt, idx) => {
          const optionLetter = String.fromCharCode(65 + idx);
          const isCorrect = (idx === q.correctIndex);
          optionsText += `${optionLetter}. ${opt}${isCorrect ? " âœ…" : ""}\n`;
        });
        
        const message = `Hello Admin,\n\nI have a question/concern regarding this question:\n\n` +
          `ðŸ‘¤ *Name:* ${currentUser.name} (${currentUser.username})\n` +
          `ðŸ« *Class:* ${currentClass}\n` +
          `ðŸ“š *Subject:* ${currentSubject}\n` +
          `ðŸ“– *Chapter:* ${currentTopicName}\n\n` +         
          `â“ *Question:* ${q.question}\n\n` +
          `ðŸ“ *Options:*\n${optionsText}\n` +
          `âœ… *Correct Answer:* ${String.fromCharCode(65 + q.correctIndex)}. ${q.options[q.correctIndex]}\n\n` +
          `ðŸ“‹ *My Concern:* `;
        
        const encodedMessage = encodeURIComponent(message);
        const whatsappUrl = `https://wa.me/919706195457?text=${encodedMessage}`;
        window.open(whatsappUrl, '_blank');
        
        resetInactivityTimer();
      });
    }

    // ========== PDF REPORT FUNCTIONS ==========
    function showPDFOverlay(message = "Generating PDF Report...") {
      pdfStatusEl.textContent = message;
      pdfOverlayEl.style.display = 'flex';
    }

    function hidePDFOverlay() {
      pdfOverlayEl.style.display = 'none';
    }

    function updatePDFStatus(message, submessage = "") {
      pdfStatusEl.textContent = message;
      if (submessage) {
        pdfSubstatusEl.textContent = submessage;
      }
    }

    function getPerformanceRemark(percentage) {
      if (percentage >= 80) return "OUTSTANDING! Excellent performance! Keep up the great work!";
      if (percentage >= 60) return "GOOD JOB! Solid performance with room for improvement.";
      if (percentage >= 40) return "SATISFACTORY. Review the chapter and practice more.";
      return "NEEDS IMPROVEMENT. Study the chapter thoroughly and retry.";
    }

    // ========== AUTHENTICATION FUNCTIONS ==========
    async function authenticateWithAppsScript(username, password) {
      try {
        return new Promise((resolve, reject) => {
          const callbackName = 'authCallback_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
          
          const script = document.createElement('script');
          
          window[callbackName] = function(data) {
            delete window[callbackName];
            document.body.removeChild(script);
            
            if (data && data.success) {
              resolve(data);
            } else {
              resolve({ 
                success: false, 
                error: data?.error || 'Invalid username or password' 
              });
            }
          };
          
          script.onerror = function() {
            delete window[callbackName];
            document.body.removeChild(script);
            resolve({ 
              success: false, 
              error: 'Network error. Please check your connection.' 
            });
          };
          
          const url = `${AUTH_APPS_SCRIPT_URL}?action=authenticate&username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}&_t=${Date.now()}&callback=${callbackName}`;
          script.src = url;
          document.body.appendChild(script);
          
          setTimeout(() => {
            if (window[callbackName]) {
              delete window[callbackName];
              document.body.removeChild(script);
              resolve({ 
                success: false, 
                error: 'Request timeout. Please try again.' 
              });
            }
          }, 10000);
        });

      } catch (error) {
        console.error('Authentication error:', error);
        return {
          success: false,
          error: 'Cannot connect to authentication server. Please try again later.'
        };
      }
    }

    // ========== JSONP HELPER FUNCTION ==========
    function jsonpRequest(url, callbackName) {
      return new Promise((resolve, reject) => {
        const uniqueCallback = callbackName + '_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        
        const script = document.createElement('script');
        
        window[uniqueCallback] = function(data) {
          delete window[uniqueCallback];
          document.body.removeChild(script);
          
          if (data && data.success) {
            resolve(data);
          } else {
            reject(data?.error || 'Unknown error');
          }
        };
        
        script.onerror = function() {
          delete window[uniqueCallback];
          document.body.removeChild(script);
          reject('Network error');
        };
        
        const separator = url.includes('?') ? '&' : '?';
        script.src = `${url}${separator}callback=${uniqueCallback}`;
        document.body.appendChild(script);
        
        setTimeout(() => {
          if (window[uniqueCallback]) {
            delete window[uniqueCallback];
            document.body.removeChild(script);
            reject('Request timeout');
          }
        }, 10000);
      });
    }

    // ========== LOAD TELEGRAM CONFIG ==========
    async function loadTelegramConfig() {
      try {
        const data = await jsonpRequest(
          MASTER_CONFIG_APPS_SCRIPT_URL + '?action=getTelegramConfig&_t=' + Date.now(),
          'telegramCallback'
        );
        
        if (data.success) {
          TELEGRAM_CONFIG.ENABLED = data.enabled;
          TELEGRAM_CONFIG.BOT_TOKEN = data.botToken;
          TELEGRAM_CONFIG.CHAT_ID = data.chatId;
          console.log("Telegram config loaded successfully");
        }
      } catch (error) {
        console.error("Error loading Telegram config:", error);
      }
    }

    // ========== LOAD CLASSES (OPTIMIZED) ==========
    async function loadClasses() {
      try {
        // Show loading animation
        classGridEl.innerHTML = `
          <div class="loading-container">
            <div class="loading-spinner"></div>
            <div class="loading-text">Loading classes...</div>
            <div class="loading-subtext">Please wait</div>
          </div>
        `;

        const allData = await loadAllConfigAtOnce();
        
        if (!allData || !allData.classes) {
          throw new Error("No classes data");
        }

        let availableClasses = allData.classes;

        // Filter based on user role
        if (currentUser && currentUser.role !== 'Admin') {
          const assignedClasses = currentUser.validatedAssignedClasses || [];
          availableClasses = allData.classes.filter(cls => 
            assignedClasses.some(assigned => assigned.toString().trim() === cls.id.toString().trim())
          );
        }

        renderClassGrid(availableClasses);

      } catch (error) {
        console.error("Error in loadClasses:", error);
        classGridEl.innerHTML = `
          <div style="text-align: center; padding: 40px; color: #fca5a5;">
            <div style="font-size: 1.2rem; margin-bottom: 10px;">Error loading classes</div>
            <button onclick="location.reload()" style="margin-top: 20px; padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer;">Retry</button>
          </div>
        `;
      }
    }

    function renderClassGrid(classes) {
      classGridEl.innerHTML = "";

      if (classes.length === 0) {
        classGridEl.innerHTML = `
          <div style="text-align: center; padding: 40px; color: #9ca3af; grid-column: 1/-1;">
            <div style="font-size: 1.2rem; margin-bottom: 10px;">No classes available</div>
            <div>You don't have access to any classes. Please contact the administrator.</div>
          </div>
        `;
        return;
      }

      classes.forEach(cls => {
        const card = document.createElement("div");
        card.className = "class-card";
        card.innerHTML = `
          <div class="class-icon">${cls.icon}</div>
          <div class="class-name">${cls.name}</div>
          <div class="class-desc">${cls.description || ""}</div>
        `;

        card.addEventListener("click", () => {
          showSubjectSelection(cls.id);
          resetInactivityTimer();
        });

        classGridEl.appendChild(card);
      });
    }

    // ========== LOAD SUBJECTS (OPTIMIZED) ==========
    async function loadSubjects() {
      try {
        // Show loading animation
        subjectGridEl.innerHTML = `
          <div class="loading-container">
            <div class="loading-spinner"></div>
            <div class="loading-text">Loading subjects...</div>
            <div class="loading-subtext">Please wait</div>
          </div>
        `;

        const allData = await loadAllConfigAtOnce();
        
        // Extract subjects for current class from cached data
        const subjects = [];
        
        if (allData && allData.config) {
          const subjectSet = new Set();
          for (const key in allData.config) {
            if (key.startsWith(currentClass + '_')) {
              const subject = key.split('_')[1];
              subjectSet.add(subject);
            }
          }
          
          Array.from(subjectSet).forEach(subject => {
            subjects.push({
              id: subject,
              name: subject.charAt(0).toUpperCase() + subject.slice(1),
              icon: getSubjectIcon(subject),
              desc: getSubjectDescription(subject)
            });
          });
        }

        renderSubjectGrid(subjects);

      } catch (error) {
        console.error("Error loading subjects:", error);
        subjectGridEl.innerHTML = `
          <div style="text-align: center; padding: 40px; color: #fca5a5;">
            Error loading subjects. Please try again.
          </div>
        `;
      }
    }

    function renderSubjectGrid(subjects) {
      subjectGridEl.innerHTML = "";

      if (subjects.length === 0) {
        subjectGridEl.innerHTML = `
          <div style="text-align: center; padding: 40px; color: #fca5a5; grid-column: 1/-1;">
            No subjects available for this class.
          </div>
        `;
        return;
      }

      subjects.forEach(subject => {
        const card = document.createElement("div");
        card.className = "subject-card";
        card.innerHTML = `
          <div class="subject-icon">${subject.icon}</div>
          <div class="subject-name">${subject.name}</div>
          <div class="subject-desc">${subject.desc}</div>
        `;

        card.addEventListener("click", () => {
          currentSubject = subject.name;
          showQuizContainer(currentSubject);
          resetInactivityTimer();
        });

        subjectGridEl.appendChild(card);
      });
    }

    // ========== LOAD CHAPTERS (OPTIMIZED) ==========
    async function loadChapters() {
      try {
        // Show loading in dropdown
        topicSelectEl.innerHTML = '<option value="">Loading chapters...</option>';
        startBtnEl.disabled = true;

        const allData = await loadAllConfigAtOnce();
        const key = `${currentClass}_${currentSubject.toLowerCase()}`;
        
        if (allData && allData.config && allData.config[key]) {
          currentSubjectConfig = {
            sheetId: allData.config[key].sheetId,
            chapters: allData.config[key].chapters
          };
          
          chaptersList = Object.keys(currentSubjectConfig.chapters || {});
          
          if (chaptersList.length === 0) {
            throw new Error(`No chapters found for ${currentSubject}`);
          }
          
          populateChapterDropdown();
        } else {
          throw new Error(`No config found for ${currentClass} ${currentSubject}`);
        }

      } catch (err) {
        console.error("Error loading chapters:", err);
        showChapterError(err.message);
      }
      
      resetInactivityTimer();
    }

    function populateChapterDropdown() {
      topicSelectEl.innerHTML = '<option value="">-- Select Chapter --</option>';
      if (chaptersList?.length) {
        chaptersList.forEach(chapter => {
          const option = document.createElement("option");
          option.value = chapter.trim();
          option.textContent = chapter.trim();
          topicSelectEl.appendChild(option);
        });
        startBtnEl.disabled = false;
        quizTopicNameEl.textContent = "No chapter selected";
        quizQuestionCountEl.textContent = `${chaptersList.length} chapters available`;
        questionTextEl.textContent = "Select a chapter to start.";
      } else {
        startBtnEl.disabled = true;
        quizTopicNameEl.textContent = "Error: No chapters found";
        quizQuestionCountEl.textContent = "0 chapters";
      }
    }

    function showChapterError(errorMessage) {
      topicSelectEl.innerHTML = `<option value="">-- Error Loading Chapters --</option><option value="">${errorMessage}</option>`;
      quizTopicNameEl.textContent = "Error";
      quizTopicNameEl.style.cssText = "background:rgba(239,68,68,0.1);border-color:rgba(239,68,68,0.5);color:#fca5a5";
      quizQuestionCountEl.textContent = "0 chapters";
      questionTextEl.textContent = errorMessage;
      startBtnEl.disabled = true;
    }

    // ========== GET USER IP ==========
    async function getUserIP() {
      try {
        const response = await fetch('https://api.ipify.org?format=json&_t=' + Date.now());
        const data = await response.json();
        userIP = data.ip;
      } catch (error) {
        console.log("Could not fetch IP:", error);
      }
    }

    // ========== SESSION MANAGEMENT ==========
    function saveSession() {
      if (currentUser) {
        const sessionData = {
          user: currentUser,
          timestamp: Date.now(),
          lastActivity: Date.now()
        };
        localStorage.setItem('gs_tutorial_session', JSON.stringify(sessionData));
      }
    }

    function loadSession() {
      const sessionData = localStorage.getItem('gs_tutorial_session');
      if (sessionData) {
        try {
          const data = JSON.parse(sessionData);
          const sessionAge = Date.now() - data.timestamp;
          const timeSinceLastActivity = Date.now() - (data.lastActivity || data.timestamp);

          if (timeSinceLastActivity < INACTIVITY_TIMEOUT && sessionAge < 24 * 60 * 60 * 1000) {
            currentUser = data.user;
            data.lastActivity = Date.now();
            localStorage.setItem('gs_tutorial_session', JSON.stringify(data));
            return true;
          }
        } catch (e) {}
      }
      clearSession();
      return false;
    }

    function clearSession() {
      localStorage.removeItem('gs_tutorial_session');
    }

    function updateLastActivity() {
      const sessionData = localStorage.getItem('gs_tutorial_session');
      if (sessionData && currentUser) {
        try {
          const data = JSON.parse(sessionData);
          data.lastActivity = Date.now();
          localStorage.setItem('gs_tutorial_session', JSON.stringify(data));
        } catch (e) {}
      }
    }

    // ========== LOGIN ATTEMPT TRACKING ==========
    function resetFailedAttempts() {
      failedAttempts = 0;
      isOnCooldown = false;
      attemptCounterEl.style.display = 'none';
      cooldownMessageEl.style.display = 'none';
      updateAttemptCounter();
      if (cooldownTimer) {
        clearInterval(cooldownTimer);
        cooldownTimer = null;
      }
    }

    function updateAttemptCounter() {
      const remaining = MAX_ATTEMPTS - failedAttempts;
      attemptsRemainingEl.textContent = remaining;

      if (failedAttempts > 0) {
        attemptCounterEl.style.display = 'flex';
        attemptCounterEl.className = remaining <= 1 ? 'attempt-counter critical' : 
                                    remaining <= 2 ? 'attempt-counter warning' : 'attempt-counter';
      } else {
        attemptCounterEl.style.display = 'none';
      }
    }

    function startCooldown() {
      isOnCooldown = true;
      loginBtnEl.disabled = true;
      cooldownMessageEl.style.display = 'block';
      attemptCounterEl.style.display = 'none';

      let seconds = COOLDOWN_TIME;
      cooldownTimerEl.textContent = seconds;

      cooldownTimer = setInterval(() => {
        seconds--;
        cooldownTimerEl.textContent = seconds;

        if (seconds <= 0) {
          clearInterval(cooldownTimer);
          isOnCooldown = false;
          loginBtnEl.disabled = false;
          cooldownMessageEl.style.display = 'none';
          resetFailedAttempts();
          usernameEl.focus();
        }
      }, 1000);
    }

    function recordFailedAttempt() {
      failedAttempts++;
      updateAttemptCounter();
      if (failedAttempts >= MAX_ATTEMPTS) startCooldown();
    }

    // ========== VALIDATION FUNCTIONS ==========
    function validateUserAccount(user) {
      const validRoles = ['Admin', 'Teacher', 'User', 'Student'];
      if (!validRoles.includes(user.role)) {
        return { valid: false, error: 'invalid_role' };
      }

      const userClassValue = user.class || "";
      const assignedClasses = userClassValue
        .split(',')
        .map(c => c.trim())
        .filter(c => c && c.toLowerCase() !== 'none' && c.toLowerCase() !== 'null');

      if (user.role === 'Admin') {
        return { valid: true, assignedClasses: [] };
      }

      if (user.role === 'Teacher' || user.role === 'User') {
        if (assignedClasses.length === 0) {
          return { valid: false, error: 'no_class_assigned', assignedClasses: [] };
        }
        return { valid: true, assignedClasses: assignedClasses };
      }

      if (user.role === 'Student') {
        if (assignedClasses.length === 0) {
          return { valid: false, error: 'no_class_assigned', assignedClasses: [] };
        }
        return { valid: true, assignedClasses: [assignedClasses[0]] };
      }

      return { valid: false, error: 'unknown' };
    }

    // ========== MODIFIED LOGIN FUNCTION ==========
    function login(user, isRestore = false) {
      const validation = validateUserAccount(user);

      if (!validation.valid) {
        if (user.subscriptionReason === 'expired') {
          showSubscriptionExpired(user, user.joiningDate, user.lastDate);
        } else {
          showAccountConfigError(user, validation.error, {
            assignedClasses: validation.assignedClasses
          });
        }
        return;
      }

      currentUser = user;
      currentUser.validatedAssignedClasses = validation.assignedClasses;
      
      // Update side menu username
      sideUsername.textContent = user.name;

      fixedHeaderEl.style.display = "block";
      loginContainerEl.style.display = "none";
      accountConfigErrorEl.style.display = "none";
      subscriptionExpiredEl.style.display = "none";
      classSelectionEl.style.display = "block";

      // Set greeting message
      const roleDisplay = user.role === 'Admin' ? 'Admin' : (user.role === 'Student' ? 'Student' : user.role);
      greetingMessageEl.innerHTML = `Welcome, <span>${user.name}</span> (${roleDisplay})`;

      resetFailedAttempts();
      resetInactivityTimer();
      loadClasses();
      saveSession();

      if (!isRestore) sendLoginNotification(user);
    }

    // ========== MODIFIED LOGOUT FUNCTION ==========
    function logout() {
      if (timerInterval) clearInterval(timerInterval);
      if (inactivityTimer) clearTimeout(inactivityTimer);
      if (cooldownTimer) clearInterval(cooldownTimer);

      imageCache.clear();
      clearSession();

      hasSentLoginNotification = false;
      hasSentQuizResultNotification = false;
      currentQuizSessionId = null;

      document.removeEventListener('mousemove', handleUserActivity);
      document.removeEventListener('keypress', handleUserActivity);
      document.removeEventListener('click', handleUserActivity);

      resetQuizState();
      resetFailedAttempts();

      currentUser = null;

      fixedHeaderEl.style.display = "none";
      classSelectionEl.style.display = "none";
      subjectSelectionEl.style.display = "none";
      quizContainerEl.style.display = "none";
      accountConfigErrorEl.style.display = "none";
      subscriptionExpiredEl.style.display = "none";
      loginContainerEl.style.display = "flex";

      loginFormEl.reset();
      passwordEl.type = 'password';
      passwordToggleEl.textContent = 'ðŸ‘ï¸';
      loginErrorEl.textContent = "";
      loginErrorEl.style.display = "none";

      usernameEl.focus();
      
      // Close side menu
      sideMenu.classList.remove('open');
      menuOverlay.classList.remove('open');
    }

    function autoLogout() {
      if (currentUser) {
        alert("You have been automatically logged out due to inactivity (10 minutes).");
        logout();
      }
    }

    function handleUserActivity() {
      updateLastActivity();
      resetInactivityTimer();
    }

    function resetInactivityTimer() {
      if (inactivityTimer) clearTimeout(inactivityTimer);
      if (currentUser) inactivityTimer = setTimeout(autoLogout, INACTIVITY_TIMEOUT);
    }

    // ========== TELEGRAM NOTIFICATION FUNCTIONS ==========
    async function sendLoginNotification(user) {
      if (hasSentLoginNotification) return;
      if (user.role === 'Admin' && !ADMIN_CONFIG.NOTIFY_ON_LOGIN) return;
      if (!TELEGRAM_CONFIG.ENABLED) return;

      const now = new Date();
      const date = now.toLocaleDateString('en-IN');
      const time = now.toLocaleTimeString('en-IN');

      const message = `â”â”â”â” ðŸ”´ User Login ðŸ”´ â”â”â”â”\n\n` +
        `ðŸŸ  Name: ${user.name}\n` +
        `ðŸŸ  Username: ${user.username}\n` +
        `ðŸŸ  Class: ${user.class || 'Not assigned'}\n` +
        `ðŸŸ  Role: ${user.role}\n\n` +
        `ðŸ“… Date: ${date}\n` +
        `â° Time: ${time}\n\n` +
        `ðŸŒ IP: ${userIP}`;

      const sent = await sendTelegramMessage(message);
      if (sent) hasSentLoginNotification = true;
    }

    async function sendQuizResultNotification(stats) {
      if (hasSentQuizResultNotification) return;
      if (currentUser.role === 'Admin' && !ADMIN_CONFIG.NOTIFY_ON_QUIZ_RESULT) return;
      if (!TELEGRAM_CONFIG.ENABLED) return;

      const now = new Date();
      const date = now.toLocaleDateString('en-IN');

      const message = `â”â”â”â” ðŸŸ  Student Result ðŸŸ  â”â”â”â”\n\n` +
        `ðŸŸ¢ Name: ${currentUser.name}\n` +
        `ðŸŸ¢ Username: ${currentUser.username}\n` +
        `ðŸŸ¢ Class: ${currentClass}\n` +
        `ðŸŸ¢ Subject: ${currentSubject}\n\n` +
        `ðŸ“– Chapter: ${currentTopicName}\n` +
        `ðŸ“‹ Total Questions: ${stats.total}\n` +
        `ðŸ“ Attempted: ${stats.attempted}\n` +
        `âœ… Correct: ${stats.correct}\n\n` +
        `â±ï¸ Time Taken: ${stats.timeTaken || "N/A"}\n` +
        `ðŸ“ˆ Percentage: ${stats.percentage}%\n\n` +
        `ðŸ“… Date: ${date}\n\n` +
        `_A detailed PDF report has been generated and is attached._`;

      const sent = await sendTelegramMessage(message);
      if (sent) hasSentQuizResultNotification = true;
    }

    async function sendTelegramMessage(message) {
      try {
        if (!TELEGRAM_CONFIG.ENABLED || !TELEGRAM_CONFIG.BOT_TOKEN || !TELEGRAM_CONFIG.CHAT_ID) {
          return false;
        }

        const url = `https://api.telegram.org/bot${TELEGRAM_CONFIG.BOT_TOKEN}/sendMessage`;
        const response = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            chat_id: TELEGRAM_CONFIG.CHAT_ID, 
            text: message, 
            parse_mode: 'Markdown' 
          })
        });
        
        if (response.ok) {
          console.log("Telegram message sent successfully");
          return true;
        } else {
          return false;
        }
      } catch (error) {
        console.error("Error sending Telegram message:", error);
        return false;
      }
    }

    async function sendPDFToTelegram(pdfBase64, fileName) {
      try {
        if (!TELEGRAM_CONFIG.ENABLED || !TELEGRAM_CONFIG.BOT_TOKEN || !TELEGRAM_CONFIG.CHAT_ID) return false;

        const url = `https://api.telegram.org/bot${TELEGRAM_CONFIG.BOT_TOKEN}/sendDocument`;
        
        const byteCharacters = atob(pdfBase64);
        const byteNumbers = new Array(byteCharacters.length);
        for (let i = 0; i < byteCharacters.length; i++) {
          byteNumbers[i] = byteCharacters.charCodeAt(i);
        }
        const byteArray = new Uint8Array(byteNumbers);
        const blob = new Blob([byteArray], { type: 'application/pdf' });
        
        const formData = new FormData();
        formData.append('chat_id', TELEGRAM_CONFIG.CHAT_ID);
        formData.append('document', blob, fileName);
        
        const response = await fetch(url, {
          method: 'POST',
          body: formData
        });
        
        return response.ok;
      } catch (error) {
        console.error("Error sending PDF to Telegram:", error);
        return false;
      }
    }

    // ========== IMAGE HANDLING FUNCTIONS ==========
    function convertImageUrl(url) {
      if (!url) return '';
      if (url.startsWith('http://') || url.startsWith('https://')) return url;

      let imagePath = url.trim();
      if (!imagePath.startsWith('images/')) {
        if (imagePath.match(/^[a-zA-Z0-9]+\.[a-z]{3,4}$/i)) {
          imagePath = `images/class${currentClass}/${imagePath}`;
        } else if (imagePath.includes('/')) {
          imagePath = `images/${imagePath}`;
        }
      }
      return imagePath + '?t=' + Date.now();
    }

    function loadImageWithCache(url) {
      return new Promise((resolve, reject) => {
        const cached = imageCache.get(url);
        if (cached) {
          resolve(cached);
          return;
        }

        const img = new Image();
        img.onload = function() {
          imageCache.set(url, img);
          resolve(img);
        };
        img.onerror = function() {
          reject(new Error(`Failed to load image: ${url}`));
        };
        img.src = url;
      });
    }

    async function preloadChapterImages(chapterQuestions) {
      if (!chapterQuestions || chapterQuestions.length === 0) return;

      const imageUrls = new Set();
      chapterQuestions.forEach(q => {
        if (q.imageUrl && q.imageUrl.trim() !== '') {
          imageUrls.add(convertImageUrl(q.imageUrl.trim()));
        }
        if (q.optionImages) {
          q.optionImages.forEach(optImg => {
            if (optImg && optImg.trim() !== '') {
              imageUrls.add(convertImageUrl(optImg.trim()));
            }
          });
        }
      });

      const urlsArray = Array.from(imageUrls);
      totalImagesToPreload = urlsArray.length;
      imagesPreloaded = 0;

      if (totalImagesToPreload === 0) return;

      showPreloadOverlay();
      updatePreloadProgress();

      const CONCURRENT_LIMIT = 3;
      const chunks = [];
      for (let i = 0; i < urlsArray.length; i += CONCURRENT_LIMIT) {
        chunks.push(urlsArray.slice(i, i + CONCURRENT_LIMIT));
      }

      for (const chunk of chunks) {
        await Promise.allSettled(
          chunk.map(url => 
            loadImageWithCache(url)
              .then(() => { imagesPreloaded++; updatePreloadProgress(); })
              .catch(() => { imagesPreloaded++; updatePreloadProgress(); })
          )
        );
        await new Promise(resolve => setTimeout(resolve, 100));
      }

      hidePreloadOverlay();
    }

    function showPreloadOverlay() {
      if (totalImagesToPreload > 0) preloadOverlayEl.style.display = 'flex';
    }

    function updatePreloadProgress() {
      const percent = totalImagesToPreload > 0 ? Math.round((imagesPreloaded / totalImagesToPreload) * 100) : 0;
      preloadProgressFillEl.style.width = `${percent}%`;
      preloadCountEl.textContent = `${imagesPreloaded}/${totalImagesToPreload}`;
      preloadStatusEl.textContent = `Loading images: ${imagesPreloaded}/${totalImagesToPreload}`;
      if (imagesPreloaded >= totalImagesToPreload) setTimeout(hidePreloadOverlay, 500);
    }

    function hidePreloadOverlay() {
      preloadOverlayEl.style.display = 'none';
    }

    function toggleImageZoom(imgElement) {
      if (window.innerWidth > 768) {
        imgElement.classList.toggle('zoomed');
      } else {
        imgElement.classList.toggle('touch-zoom');
      }
    }

    // ========== QUESTION NAVIGATION FUNCTIONS ==========
    function toggleQuestionNavigation() {
      const isCollapsed = questionNavigationEl.classList.contains('collapsed');
      if (isCollapsed) {
        questionNavigationEl.classList.remove('collapsed');
        questionNavigationEl.classList.add('expanded');
        navigationToggleBtn.innerHTML = '<i>â–¼</i> Hide Navigation';
        navigationToggleBtn.classList.remove('collapsed');
        updateQuestionNavigation();
      } else {
        questionNavigationEl.classList.remove('expanded');
        questionNavigationEl.classList.add('collapsed');
        navigationToggleBtn.innerHTML = '<i>â–¶</i> Show Navigation';
        navigationToggleBtn.classList.add('collapsed');
      }
      resetInactivityTimer();
    }

    function updateQuestionNavigation() {
      if (!questionsLoaded || questions.length === 0) {
        questionGridEl.innerHTML = '<div style="color: #9ca3af; text-align: center; padding: 20px;">No questions loaded</div>';
        return;
      }

      questionGridEl.innerHTML = '';

      for (let i = 0; i < questions.length; i++) {
        const button = document.createElement('button');
        button.className = 'question-number-btn';
        button.textContent = i + 1;
        button.dataset.index = i;

        if (i === currentIndex) button.classList.add('current');

        if (userAnswers[i] !== undefined) {
          if (userAnswers[i] === questions[i].correctIndex) {
            button.classList.add('answered');
          } else {
            button.classList.add('incorrect');
          }
        } else {
          button.classList.add('not-answered');
        }

        button.addEventListener('click', () => {
          const targetIndex = parseInt(button.dataset.index);
          if (targetIndex >= 0 && targetIndex < questions.length) jumpToQuestion(targetIndex);
        });

        questionGridEl.appendChild(button);
      }

      updateNavigationStats();
    }

    function updateNavigationStats() {
      if (!questionsLoaded || questions.length === 0) {
        navigationStatsEl.innerHTML = '';
        return;
      }

      let correctCount = 0, incorrectCount = 0, notAnsweredCount = 0;

      for (let i = 0; i < questions.length; i++) {
        if (userAnswers[i] !== undefined) {
          if (userAnswers[i] === questions[i].correctIndex) correctCount++;
          else incorrectCount++;
        } else {
          notAnsweredCount++;
        }
      }

      navigationStatsEl.innerHTML = `
        <div class="stat-badge current"><span>â—</span><span>Current: ${currentIndex + 1}</span></div>
        <div class="stat-badge answered"><span>â—</span><span>Correct: ${correctCount}</span></div>
        <div class="stat-badge incorrect"><span>â—</span><span>Incorrect: ${incorrectCount}</span></div>
        <div class="stat-badge not-answered"><span>â—</span><span>Not Answered: ${notAnsweredCount}</span></div>
      `;
    }

    function jumpToQuestion(index) {
      if (index < 0 || index >= questions.length) return;
      currentIndex = index;
      renderQuestion();
      updateQuestionNavigation();
      resetInactivityTimer();
    }

    function showQuestionNavigation() {
      questionNavigationEl.style.display = 'block';
      questionNavigationEl.classList.add('collapsed');
      navigationToggleBtn.innerHTML = '<i>â–¶</i> Show Navigation';
      navigationToggleBtn.classList.add('collapsed');
    }

    // ========== NAVIGATION FUNCTIONS ==========
    function showClassSelection() {
      classSelectionEl.style.display = "block";
      subjectSelectionEl.style.display = "none";
      quizContainerEl.style.display = "none";
      accountConfigErrorEl.style.display = "none";
      subscriptionExpiredEl.style.display = "none";
      resetQuizState();
      isReviewMode = false;
      isIncorrectReviewMode = false;
      resetInactivityTimer();
    }

    function showSubjectSelection(className) {
      currentClass = className;
      currentClassDisplayEl.textContent = className === 'JE' ? 'Junior Engineer' : `Class ${className}`;

      classSelectionEl.style.display = "none";
      subjectSelectionEl.style.display = "block";
      quizContainerEl.style.display = "none";
      accountConfigErrorEl.style.display = "none";
      subscriptionExpiredEl.style.display = "none";

      loadSubjects();
      isReviewMode = false;
      isIncorrectReviewMode = false;
      resetInactivityTimer();
    }

    function showQuizContainer(subjectName) {
      currentSubject = subjectName;

      currentPathEl.innerHTML = `
        <span class="path-link" onclick="showClassSelection()">Classes</span>
        <span class="path-separator">â€º</span>
        <span class="path-link" onclick="showSubjectSelection('${currentClass}')">${currentClass === 'JE' ? 'Junior Engineer' : 'Class ' + currentClass}</span>
        <span class="path-separator">â€º</span>
        <span>${subjectName}</span>
      `;
      currentPathEl.style.display = "flex";

      subjectSelectionEl.style.display = "none";
      quizContainerEl.style.display = "block";
      accountConfigErrorEl.style.display = "none";
      subscriptionExpiredEl.style.display = "none";

      loadChapters();
      isReviewMode = false;
      isIncorrectReviewMode = false;
      resetInactivityTimer();
    }

    // ========== QUIZ FUNCTIONS ==========
    function resetQuizState() {
      questions = [];
      currentIndex = 0;
      score = 0;
      hasAnswered = false;
      questionsLoaded = false;
      attempted = 0;
      userAnswers = [];
      timeRemaining = 0;
      timerDuration = 0;
      currentTopicName = "";
      quizStartTime = null;
      isReviewMode = false;
      isIncorrectReviewMode = false;
      incorrectQuestionIndices = [];

      hasSentQuizResultNotification = false;
      currentQuizSessionId = Date.now().toString();

      questionTextEl.textContent = "Please select a chapter to start.";
      questionImageContainerEl.classList.remove('visible');
      questionImageEl.src = "";
      optionsListEl.innerHTML = "";
      feedbackEl.textContent = "";
      feedbackEl.className = "feedback";
      nextBtn.disabled = true;
      previousBtn.disabled = true;
      finishBtn.disabled = true;
      finishBtn.textContent = "Submit";
      finishBtn.onclick = () => {
        if (!questionsLoaded) return;
        if (confirm("Are you sure you want to finish the quiz?")) showFinalResult();
        resetInactivityTimer();
      };
      finalScoreEl.style.display = "none";
      progressBarFillEl.style.width = "0%";
      questionCounterEl.textContent = "Choose a chapter and click Start";
      scoreMiniEl.textContent = "Score: 0";
      quizTopicNameEl.textContent = "No chapter selected";
      quizQuestionCountEl.textContent = "0 questions";
      timerContainerEl.style.display = "none";

      toggleRowEl.classList.remove('hidden');
      progressEl.classList.remove('hidden');
      controlsEl.classList.remove('hidden');
      questionBoxEl.style.display = 'block';
      questionBoxEl.classList.remove('hidden-on-mobile');

      questionNavigationEl.classList.remove('expanded');
      questionNavigationEl.classList.add('collapsed');
      navigationToggleBtn.innerHTML = '<i>â–¶</i> Show Navigation';
      navigationToggleBtn.classList.add('collapsed');

      quizTopicNameEl.style.cssText = "";
      removeTimerNotification();
      questionWhatsappIconEl.style.display = "none";
    }

    function collectIncorrectQuestionIndices() {
      incorrectQuestionIndices = [];
      for (let i = 0; i < questions.length; i++) {
        if (userAnswers[i] !== undefined && userAnswers[i] !== questions[i].correctIndex) {
          incorrectQuestionIndices.push(i);
        }
      }
    }

    function showIncorrectQuestionsReview() {
      collectIncorrectQuestionIndices();
      if (incorrectQuestionIndices.length === 0) {
        alert("Congratulations! You have no incorrect questions to review.");
        return;
      }

      isIncorrectReviewMode = true;
      isReviewMode = true;
      finalScoreEl.style.display = "none";

      toggleRowEl.classList.remove('hidden');
      progressEl.classList.remove('hidden');
      questionNavigationEl.style.display = 'block';
      controlsEl.classList.remove('hidden');
      questionBoxEl.style.display = 'block';
      questionBoxEl.classList.remove('hidden-on-mobile');
      questionWhatsappIconEl.style.display = "block";

      finishBtn.style.display = "inline-block";
      finishBtn.textContent = "Back to Results";
      finishBtn.onclick = showFinalResultWithoutNotification;

      currentIndex = incorrectQuestionIndices[0];
      renderQuestion();

      questionNavigationEl.classList.remove('collapsed');
      questionNavigationEl.classList.add('expanded');
      navigationToggleBtn.innerHTML = '<i>â–¼</i> Hide Navigation';
      navigationToggleBtn.classList.remove('collapsed');
      updateQuestionNavigation();

      const headerDiv = document.createElement('div');
      headerDiv.id = 'review-header';
      headerDiv.style.cssText = 'margin:10px 0;padding:10px;background:rgba(239,68,68,0.15);border:1px solid rgba(239,68,68,0.3);border-radius:8px;text-align:center;color:#fca5a5';
      headerDiv.innerHTML = `Reviewing Incorrect Questions (${incorrectQuestionIndices.length} questions)`;

      const topicSection = document.querySelector('.topic-section');
      const existingHeader = document.getElementById('review-header');
      if (existingHeader) existingHeader.remove();
      topicSection.parentNode.insertBefore(headerDiv, topicSection.nextSibling);
    }

    async function loadQuestionsFromGoogleSheet(chapterName) {
      const trimmed = chapterName.trim();
      if (!trimmed) {
        alert("Please select a chapter.");
        resetInactivityTimer();
        return;
      }

      currentTopicName = trimmed;

      const gid = currentSubjectConfig?.chapters?.[trimmed];
      const sheetId = currentSubjectConfig?.sheetId;

      if (!gid || !sheetId) {
        alert("Invalid chapter configuration");
        return;
      }

      quizTopicNameEl.textContent = trimmed;

      try {
        questionTextEl.textContent = `Loading ${trimmed}â€¦`;
        questionImageContainerEl.classList.remove('visible');
        optionsListEl.innerHTML = "";
        feedbackEl.textContent = "";
        nextBtn.disabled = true;
        previousBtn.disabled = true;
        finishBtn.disabled = true;
        finishBtn.textContent = "Submit";
        finishBtn.onclick = () => {
          if (!questionsLoaded) return;
          if (confirm("Are you sure you want to finish the quiz?")) showFinalResult();
          resetInactivityTimer();
        };
        finalScoreEl.style.display = "none";
        progressBarFillEl.style.width = "0%";
        questionCounterEl.textContent = "Loadingâ€¦";

        timerContainerEl.style.display = "none";
        timerDuration = 0;
        quizStartTime = Date.now();
        removeTimerNotification();

        const apiUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&gid=${gid}&_t=${Date.now()}`;
        const response = await fetch(apiUrl);
        if (!response.ok) throw new Error(`Failed to fetch Google Sheet. Status: ${response.status}`);

        const data = await response.text();
        const jsonData = JSON.parse(data.substring(47).slice(0, -2));
        const rows = jsonData.table.rows;

        if (rows.length === 0) throw new Error("No questions found.");

        const rawQuestions = [];
        let timerFromSheet = 0;

        if (rows.length > 1 && rows[1].c?.[7]?.v) {
          timerFromSheet = parseInt(rows[1].c[7].v) || 0;
        }

        for (let i = 2; i < rows.length; i++) {
          const row = rows[i];
          if (!row.c || row.c.length < 6) continue;

          const question = row.c[0]?.v?.toString().trim() || '';
          const option1 = row.c[1]?.v?.toString().trim() || '';
          const option2 = row.c[2]?.v?.toString().trim() || '';
          const option3 = row.c[3]?.v?.toString().trim() || '';
          const option4 = row.c[4]?.v?.toString().trim() || '';
          const answer = row.c[5]?.v?.toString().trim() || '';
          const explanation = row.c[6]?.v?.toString().trim() || '';
          const imageUrl = row.c[8]?.v?.toString().trim() || '';

          if (!question || !option1 || !option2 || !answer) continue;

          const options = [option1, option2];
          if (option3) options.push(option3);
          if (option4) options.push(option4);

          const optionImages = [];
          if (row.c[9]) optionImages.push(row.c[9].v.toString().trim());
          if (row.c[10]) optionImages.push(row.c[10].v.toString().trim());
          if (row.c[11]) optionImages.push(row.c[11].v.toString().trim());
          if (row.c[12]) optionImages.push(row.c[12].v.toString().trim());

          let correctIndex = 0;
          const answerUpper = answer.toUpperCase().trim();

          if (answerUpper === 'A' || answerUpper === '1') correctIndex = 0;
          else if (answerUpper === 'B' || answerUpper === '2') correctIndex = 1;
          else if (answerUpper === 'C' || answerUpper === '3') correctIndex = 2;
          else if (answerUpper === 'D' || answerUpper === '4') correctIndex = 3;
          else {
            const matchIndex = options.findIndex(opt => 
              opt.toLowerCase().includes(answer.toLowerCase()) || 
              answer.toLowerCase().includes(opt.toLowerCase())
            );
            if (matchIndex !== -1) correctIndex = matchIndex;
          }

          rawQuestions.push({ question, options, optionImages, correctIndex, explanation, imageUrl });
        }

        if (rawQuestions.length === 0) throw new Error("No valid questions found.");

        if (timerFromSheet > 0) timerDuration = timerFromSheet * 60 * 1000;

        const randomize = randomToggleEl.checked;
        questions = prepareQuestionBank(rawQuestions, randomize);
        userAnswers = new Array(questions.length);

        questionsLoaded = true;
        currentIndex = 0;
        score = 0;
        attempted = 0;
        scoreMiniEl.textContent = "Score: 0";
        nextBtn.style.display = "inline-block";
        previousBtn.style.display = "inline-block";
        finishBtn.style.display = "inline-block";

        quizTopicNameEl.textContent = trimmed;
        quizQuestionCountEl.textContent = `${questions.length} questions`;

        showQuestionNavigation();
        await preloadChapterImages(questions);

        if (timerDuration > 0) {
          showTimerNotification();
          startTimer();
        }

        renderQuestion();
        resetInactivityTimer();
      } catch (err) {
        questionTextEl.textContent = `Error: ${err.message}`;
        questionImageContainerEl.classList.remove('visible');
        optionsListEl.innerHTML = "";
        feedbackEl.textContent = "";
        nextBtn.disabled = true;
        previousBtn.disabled = true;
        finishBtn.disabled = true;
        quizTopicNameEl.textContent = "Error loading chapter";
        quizTopicNameEl.style.cssText = "background:rgba(239,68,68,0.1);border-color:rgba(239,68,68,0.5);color:#fca5a5";
        resetInactivityTimer();
      }
    }

    function shuffleArray(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
    }

    function prepareQuestionBank(rawQuestions, randomize) {
      const qs = rawQuestions.map(q => ({
        question: q.question,
        options: [...q.options],
        optionImages: q.optionImages ? [...q.optionImages] : [],
        imageUrl: q.imageUrl,
        correctIndex: q.correctIndex,
        explanation: q.explanation
      }));

      if (randomize) {
        shuffleArray(qs);
        qs.forEach(q => {
          const idxs = q.options.map((_, idx) => idx);
          shuffleArray(idxs);

          const newOptions = idxs.map(i => q.options[i]);
          const newOptionImages = q.optionImages ? idxs.map(i => q.optionImages[i]) : [];
          const newCorrectIndex = idxs.indexOf(q.correctIndex);

          q.options = newOptions;
          q.optionImages = newOptionImages;
          q.correctIndex = newCorrectIndex;
        });
      }

      return qs;
    }

    // ========== TIMER FUNCTIONS ==========
    function startTimer() {
      if (timerDuration <= 0) return;
      timeRemaining = timerDuration;
      timerContainerEl.style.display = "flex";
      updateTimerDisplay();

      timerInterval = setInterval(() => {
        timeRemaining -= 1000;
        if (timeRemaining <= 0) {
          timeRemaining = 0;
          clearInterval(timerInterval);
          autoFinishQuiz();
        }
        updateTimerDisplay();
      }, 1000);
    }

    function updateTimerDisplay() {
      const hours = Math.floor(timeRemaining / (1000 * 60 * 60));
      const minutes = Math.floor((timeRemaining % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((timeRemaining % (1000 * 60)) / 1000);
      timerDisplayEl.textContent = `${hours.toString().padStart(2,'0')}:${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;

      timerDisplayEl.classList.remove("timer-warning", "timer-critical");
      if (timeRemaining <= 30 * 60 * 1000) timerDisplayEl.classList.add("timer-warning");
      if (timeRemaining <= 10 * 60 * 1000) timerDisplayEl.classList.add("timer-critical");
    }

    function stopTimer() {
      if (timerInterval) clearInterval(timerInterval);
      timerContainerEl.style.display = "none";
    }

    function showTimerNotification() {
      removeTimerNotification();
      if (timerDuration > 0) {
        const hours = Math.floor(timerDuration / (1000 * 60 * 60));
        const minutes = Math.floor((timerDuration % (1000 * 60 * 60)) / (1000 * 60));
        let timeString = hours ? `${hours}h ${minutes}m` : minutes ? `${minutes}m` : "<1m";

        timerNotification = document.createElement("div");
        timerNotification.className = "timer-notification";
        timerNotification.innerHTML = `<span>Timer set: <strong>${timeString}</strong> for this chapter</span>`;

        const toggleRow = document.querySelector(".toggle-row");
        if (toggleRow?.nextElementSibling) {
          toggleRow.parentNode.insertBefore(timerNotification, toggleRow.nextElementSibling);
        }
      }
    }

    function removeTimerNotification() {
      if (timerNotification?.parentNode) timerNotification.remove();
      document.querySelectorAll(".timer-notification").forEach(n => n.remove());
    }

    function autoFinishQuiz() {
      showFinalResult();
      stopTimer();
      removeTimerNotification();
    }

    function formatTimeTaken() {
      if (timerDuration <= 0 || !quizStartTime) return "";
      const timeTaken = Date.now() - quizStartTime;
      const hours = Math.floor(timeTaken / (1000 * 60 * 60));
      const minutes = Math.floor((timeTaken % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((timeTaken % (1000 * 60)) / 1000);
      return hours ? `${hours}h ${minutes}m ${seconds}s` : minutes ? `${minutes}m ${seconds}s` : `${seconds}s`;
    }

    // ========== UI FUNCTIONS ==========
    function renderQuestion() {
      if (!questionsLoaded || questions.length === 0) {
        questionTextEl.textContent = "No questions available.";
        questionImageContainerEl.classList.remove('visible');
        optionsListEl.innerHTML = "";
        nextBtn.disabled = previousBtn.disabled = finishBtn.disabled = true;
        questionWhatsappIconEl.style.display = "none";
        return;
      }

      const q = questions[currentIndex];
      hasAnswered = false;
      feedbackEl.textContent = "";
      feedbackEl.className = "feedback";
      feedbackEl.querySelector('.explanation')?.remove();

      if (isIncorrectReviewMode) {
        const pos = incorrectQuestionIndices.indexOf(currentIndex) + 1;
        questionCounterEl.textContent = `Incorrect Q${pos}/${incorrectQuestionIndices.length}`;
        progressBarFillEl.style.width = `${(pos / incorrectQuestionIndices.length) * 100}%`;
      } else {
        questionCounterEl.textContent = `Q${currentIndex + 1}/${questions.length}`;
        progressBarFillEl.style.width = `${((currentIndex + 1) / questions.length) * 100}%`;
      }

      questionTextEl.innerHTML = q.question
        .replace(/\r\n|\n|\r/g, '<br>').replace(/\\n/g, '<br>')
        .replace(/\|\|/g, '<br><br>').replace(/\|/g, '<br>')
        .replace(/<br\s*\/?>/gi, '<br>').replace(/ {2,}/g, ' ').trim();

      questionWhatsappIconEl.style.display = "block";

      if (q.imageUrl?.trim()) {
        const imageUrl = convertImageUrl(q.imageUrl.trim());
        questionImageContainerEl.classList.add('visible');
        questionImageEl.style.display = "none";
        imageLoadingEl.style.display = "block";
        imageErrorEl.style.display = "none";

        loadImageWithCache(imageUrl)
          .then(() => {
            questionImageEl.src = imageUrl;
            questionImageEl.style.display = "block";
            imageLoadingEl.style.display = "none";
          })
          .catch(() => {
            imageLoadingEl.style.display = "none";
            imageErrorEl.style.display = "block";
          });
      } else {
        questionImageContainerEl.classList.remove('visible');
      }

      optionsListEl.innerHTML = "";
      q.options.forEach((opt, idx) => {
        const li = document.createElement("li");
        li.className = "option";
        if (userAnswers[currentIndex] === idx) li.classList.add("selected");

        const labelDiv = document.createElement("div");
        labelDiv.className = "option-label";
        labelDiv.textContent = String.fromCharCode(65 + idx) + ".";

        const contentDiv = document.createElement("div");
        contentDiv.className = "option-content";

        if (q.optionImages?.[idx]?.trim()) {
          const optionImageUrl = convertImageUrl(q.optionImages[idx].trim());
          const wrapper = document.createElement("div");
          wrapper.style.cssText = "display:flex;flex-direction:column;width:100%";
          wrapper.innerHTML = `<span style="margin-bottom:8px">${opt}</span><img src="${optionImageUrl}" class="option-image" alt="Option ${String.fromCharCode(65+idx)}">`;
          contentDiv.appendChild(wrapper);
        } else {
          contentDiv.textContent = opt;
        }

        li.appendChild(labelDiv);
        li.appendChild(contentDiv);
        optionsListEl.appendChild(li);

        li.addEventListener("click", () => {
          if (hasAnswered || isReviewMode) return;
          resetInactivityTimer();
          document.querySelectorAll(".option").forEach(optEl => optEl.classList.remove("selected"));
          li.classList.add("selected");
          userAnswers[currentIndex] = idx;
          handleOptionClick(idx);
        });
      });

      previousBtn.disabled = (currentIndex === 0);
      nextBtn.disabled = !isReviewMode;
      finishBtn.disabled = false;

      if (userAnswers[currentIndex] !== undefined) {
        const selected = userAnswers[currentIndex];
        showCorrectness(selected);
        lockOptions();
        hasAnswered = true;

        if (selected === q.correctIndex) {
          feedbackEl.textContent = "Correct!";
          feedbackEl.className = "feedback correct";
        } else {
          feedbackEl.textContent = `Wrong. Correct: ${q.options[q.correctIndex]}`;
          feedbackEl.className = "feedback incorrect";
        }

        if (q.explanation) {
          const exp = document.createElement("div");
          exp.className = "explanation";
          exp.innerHTML = `<strong>Explanation:</strong> ${q.explanation}`;
          feedbackEl.appendChild(exp);
        }

        if (!isReviewMode) nextBtn.disabled = false;
      } else if (isReviewMode) {
        showCorrectness(-1);
        lockOptions();
        
        feedbackEl.textContent = `Correct Answer: ${q.options[q.correctIndex]}`;
        feedbackEl.className = "feedback";
        
        if (q.explanation) {
          const exp = document.createElement("div");
          exp.className = "explanation";
          exp.innerHTML = `<strong>Explanation:</strong> ${q.explanation}`;
          feedbackEl.appendChild(exp);
        }
      }

      updateQuestionNavigation();
      resetInactivityTimer();
    }

    function lockOptions() {
      document.querySelectorAll(".option").forEach(opt => opt.classList.add("disabled"));
    }

    function showCorrectness(selectedIndex) {
      const q = questions[currentIndex];
      document.querySelectorAll(".option").forEach((optEl, idx) => {
        optEl.classList.remove("correct", "incorrect");
        if (idx === q.correctIndex) {
          optEl.classList.add("correct");
        }
        if (idx === selectedIndex && selectedIndex !== q.correctIndex) {
          optEl.classList.add("incorrect");
        }
      });
    }

    function handleOptionClick(selectedIndex) {
      if (hasAnswered || isReviewMode) return;
      const q = questions[currentIndex];
      hasAnswered = true;
      attempted++;

      if (selectedIndex === q.correctIndex) {
        score++;
        feedbackEl.textContent = "Correct!";
        feedbackEl.className = "feedback correct";
      } else {
        feedbackEl.textContent = `Wrong. Correct: ${q.options[q.correctIndex]}`;
        feedbackEl.className = "feedback incorrect";
      }

      if (q.explanation) {
        const exp = document.createElement("div");
        exp.className = "explanation";
        exp.innerHTML = `<strong>Explanation:</strong> ${q.explanation}`;
        feedbackEl.appendChild(exp);
      }

      scoreMiniEl.textContent = `Score: ${score}`;
      showCorrectness(selectedIndex);
      lockOptions();
      nextBtn.disabled = false;
      updateQuestionNavigation();
    }

    function goToNextQuestion() {
      resetInactivityTimer();
      if (isIncorrectReviewMode) {
        const pos = incorrectQuestionIndices.indexOf(currentIndex);
        currentIndex = pos < incorrectQuestionIndices.length - 1 ? 
          incorrectQuestionIndices[pos + 1] : incorrectQuestionIndices[0];
      } else if (currentIndex < questions.length - 1) {
        currentIndex++;
      } else if (!isReviewMode) {
        showFinalResult();
        return;
      } else {
        currentIndex = 0;
      }
      renderQuestion();
    }

    function goToPreviousQuestion() {
      resetInactivityTimer();
      if (isIncorrectReviewMode) {
        const pos = incorrectQuestionIndices.indexOf(currentIndex);
        currentIndex = pos > 0 ? incorrectQuestionIndices[pos - 1] : incorrectQuestionIndices[incorrectQuestionIndices.length - 1];
      } else if (currentIndex > 0) {
        currentIndex--;
      }
      renderQuestion();
    }

    function calculateQuizStats() {
      let attempted = 0, correct = 0;
      for (let i = 0; i < questions.length; i++) {
        if (userAnswers[i] !== undefined) {
          attempted++;
          if (userAnswers[i] === questions[i].correctIndex) correct++;
        }
      }
      return {
        total: questions.length,
        attempted,
        correct,
        incorrect: attempted - correct,
        percentage: questions.length ? ((correct / questions.length) * 100).toFixed(2) : 0,
        timeTaken: formatTimeTaken()
      };
    }

    function showFinalResult() {
      stopTimer();
      removeTimerNotification();
      const stats = calculateQuizStats();
      collectIncorrectQuestionIndices();

      toggleRowEl.classList.add('hidden');
      progressEl.classList.add('hidden');
      questionNavigationEl.style.display = 'none';
      timerContainerEl.classList.add('hidden');
      controlsEl.classList.add('hidden');
      questionBoxEl.style.display = 'none';
      questionWhatsappIconEl.style.display = "none";

      document.getElementById('review-header')?.remove();
      if (window.innerWidth <= 700) questionBoxEl.classList.add('hidden-on-mobile');

      finalScoreEl.style.display = "block";

      let reviewSection = questions.length ? `<div class="result-summary"><button class="review-btn" onclick="showQuestionReview()">Review All Questions with Explanations</button></div>` : '';
      let incorrectReviewSection = stats.incorrect ? `<div class="result-summary"><button class="review-incorrect-btn" onclick="showIncorrectQuestionsReview()">âŒ Review ${stats.incorrect} Incorrect Questions</button></div>` : '';

      finalScoreEl.innerHTML = `
        <div class="result-header">Results - ${currentTopicName}</div>
        <div class="result-stats">
          <div class="stat-item"><div class="stat-label">Total</div><div class="stat-value">${stats.total}</div></div>
          <div class="stat-item"><div class="stat-label">Attempted</div><div class="stat-value">${stats.attempted}/${stats.total}</div></div>
          <div class="stat-item"><div class="stat-label">Correct</div><div class="stat-value">${stats.correct}</div></div>
          <div class="stat-item"><div class="stat-label">Incorrect</div><div class="stat-value">${stats.incorrect}</div></div>
          <div class="stat-item"><div class="stat-label">Percentage</div><div class="stat-value stat-percentage">${stats.percentage}%</div></div>
          <div class="stat-item"><div class="stat-label">Time Taken</div><div class="stat-value stat-time">${stats.timeTaken || "No timer"}</div></div>
        </div>
        <div class="result-message">${getPerformanceRemark(parseFloat(stats.percentage))}</div>
        <button class="restart-btn" onclick="restartQuiz()">Restart Quiz</button>
        ${incorrectReviewSection}
        ${reviewSection}
      `;

      resetInactivityTimer();
      
      sendQuizResultNotification(stats);
      
      setTimeout(() => {
        generateAndSendPDFReport();
      }, 2000);
    }

    function showQuestionReview() {
      isReviewMode = true;
      isIncorrectReviewMode = false;
      finalScoreEl.style.display = "none";
      document.getElementById('review-header')?.remove();

      toggleRowEl.classList.remove('hidden');
      progressEl.classList.remove('hidden');
      questionNavigationEl.style.display = 'block';
      controlsEl.classList.remove('hidden');
      questionBoxEl.style.display = 'block';
      questionBoxEl.classList.remove('hidden-on-mobile');
      questionWhatsappIconEl.style.display = "block";

      finishBtn.style.display = "inline-block";
      finishBtn.textContent = "Back to Results";
      finishBtn.onclick = showFinalResultWithoutNotification;

      currentIndex = 0;
      renderQuestion();

      questionNavigationEl.classList.remove('collapsed');
      questionNavigationEl.classList.add('expanded');
      navigationToggleBtn.innerHTML = '<i>â–¼</i> Hide Navigation';
      navigationToggleBtn.classList.remove('collapsed');
      updateQuestionNavigation();
    }

    function showFinalResultWithoutNotification() {
      stopTimer();
      removeTimerNotification();
      const stats = calculateQuizStats();
      collectIncorrectQuestionIndices();

      toggleRowEl.classList.add('hidden');
      progressEl.classList.add('hidden');
      questionNavigationEl.style.display = 'none';
      timerContainerEl.classList.add('hidden');
      controlsEl.classList.add('hidden');
      questionBoxEl.style.display = 'none';
      questionWhatsappIconEl.style.display = "none";

      document.getElementById('review-header')?.remove();
      if (window.innerWidth <= 700) questionBoxEl.classList.add('hidden-on-mobile');

      finalScoreEl.style.display = "block";

      let reviewSection = questions.length ? `<div class="result-summary"><button class="review-btn" onclick="showQuestionReview()">Review All Questions with Explanations</button></div>` : '';
      let incorrectReviewSection = stats.incorrect ? `<div class="result-summary"><button class="review-incorrect-btn" onclick="showIncorrectQuestionsReview()">âŒ Review ${stats.incorrect} Incorrect Questions</button></div>` : '';

      finalScoreEl.innerHTML = `
        <div class="result-header">Results - ${currentTopicName}</div>
        <div class="result-stats">
          <div class="stat-item"><div class="stat-label">Total</div><div class="stat-value">${stats.total}</div></div>
          <div class="stat-item"><div class="stat-label">Attempted</div><div class="stat-value">${stats.attempted}/${stats.total}</div></div>
          <div class="stat-item"><div class="stat-label">Correct</div><div class="stat-value">${stats.correct}</div></div>
          <div class="stat-item"><div class="stat-label">Incorrect</div><div class="stat-value">${stats.incorrect}</div></div>
          <div class="stat-item"><div class="stat-label">Percentage</div><div class="stat-value stat-percentage">${stats.percentage}%</div></div>
          <div class="stat-item"><div class="stat-label">Time Taken</div><div class="stat-value stat-time">${stats.timeTaken || "No timer"}</div></div>
        </div>
        <div class="result-message">${getPerformanceRemark(parseFloat(stats.percentage))}</div>
        <div class="result-summary"><em>Select another chapter to start a new quiz.</em></div>
        <button class="restart-btn" onclick="restartQuiz()">Restart Quiz</button>
        ${incorrectReviewSection}
        ${reviewSection}
      `;

      resetInactivityTimer();
    }

    function restartQuiz() {
      isReviewMode = false;
      isIncorrectReviewMode = false;
      score = 0;
      attempted = 0;
      currentIndex = 0;
      userAnswers = [];
      incorrectQuestionIndices = [];
      scoreMiniEl.textContent = "Score: 0";

      finishBtn.textContent = "Submit";
      finishBtn.onclick = () => {
        if (!questionsLoaded) return;
        if (confirm("Are you sure you want to finish the quiz?")) showFinalResult();
        resetInactivityTimer();
      };

      finalScoreEl.style.display = "none";
      document.getElementById('review-header')?.remove();

      toggleRowEl.classList.remove('hidden');
      progressEl.classList.remove('hidden');
      questionNavigationEl.style.display = 'block';
      questionNavigationEl.classList.remove('expanded');
      questionNavigationEl.classList.add('collapsed');
      navigationToggleBtn.innerHTML = '<i>â–¶</i> Show Navigation';
      navigationToggleBtn.classList.add('collapsed');

      timerContainerEl.classList.remove('hidden');
      controlsEl.classList.remove('hidden');
      questionBoxEl.style.display = 'block';
      questionBoxEl.classList.remove('hidden-on-mobile');
      questionWhatsappIconEl.style.display = "block";

      updateQuestionNavigation();
      hasSentQuizResultNotification = false;

      if (timerDuration > 0) {
        showTimerNotification();
        startTimer();
      }

      renderQuestion();
      resetInactivityTimer();
    }

    async function generateAndSendPDFReport() {
      if (!currentUser || !questionsLoaded || questions.length === 0) return;

      showPDFOverlay();

      try {
        updatePDFStatus("Preparing report data...");
        const stats = calculateQuizStats();
        const timeTaken = formatTimeTaken();
        const now = new Date();
        const date = now.toLocaleDateString('en-IN');
        const time = now.toLocaleTimeString('en-IN');

        const shortFilename = `GS_Report_${currentUser.username.substring(0, 6)}_${currentSubject.substring(0, 3)}_${currentTopicName.substring(0, 10).replace(/\s+/g, '')}_${Date.now().toString().slice(-6)}.pdf`;

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({
          orientation: 'portrait',
          unit: 'mm',
          format: 'a4'
        });

        doc.setProperties({
          title: `Quiz Report - ${currentUser.name}`,
          subject: `${currentSubject} - ${currentTopicName}`,
          author: 'G.S. Tutorial',
          creator: 'G.S. Tutorial App'
        });
        
        // ========== PAGE 1: COVER AND SUMMARY ==========
        updatePDFStatus("Creating cover page...");
        
        // Background color
        doc.setFillColor(15, 23, 42);
        doc.rect(0, 0, 210, 297, 'F');
        
        // Header with gradient effect
        doc.setFillColor(30, 41, 59);
        doc.rect(0, 0, 210, 50, 'F');
        
        // Logo image
        try {
          const logoUrl = 'logo.png';
          const img = new Image();
          img.crossOrigin = 'Anonymous';
          
          await new Promise((resolve, reject) => {
            img.onload = resolve;
            img.onerror = reject;
            img.src = logoUrl;
          });
          
          doc.addImage(img, 'PNG', 8, 8, 35, 35);
        } catch (error) {
          doc.setFillColor(59, 130, 246);
          doc.circle(27, 24, 18, 'F');
          doc.setTextColor(255, 255, 255);
          doc.setFontSize(18);
          doc.text("GS", 22, 28);
        }
        
        // Title
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(22);
        doc.setTextColor(59, 130, 246);
        doc.text("G.S. Tutorial", 50, 15);
        
        doc.setFontSize(12);
        doc.setTextColor(148, 163, 184);
        doc.text("Interactive Learning App", 50, 23);
        
        doc.setFontSize(9);
        doc.setTextColor(226, 232, 240);
        doc.text("App Created by Gobind Sharma", 50, 30);
        
        doc.setFontSize(9);
        doc.setFont('helvetica', 'bold');
        doc.text("Mobile: 9706195457", 50, 35);
        doc.setFont('helvetica', 'normal');
        doc.text("Email: gobind.bngn@gmail.com", 50, 40);
        doc.text("App Link: https://gstutorial.github.io/app", 50, 45);
        
        doc.setDrawColor(59, 130, 246);
        doc.setLineWidth(0.5);
        doc.line(0, 50, 210, 50);
        
        doc.setFontSize(20);
        doc.setTextColor(226, 232, 240);
        doc.text("PERFORMANCE REPORT", 105, 80, { align: 'center' });
        
        // Student info box
        updatePDFStatus("Adding student information...");
        
        doc.setFillColor(30, 41, 59);
        doc.roundedRect(20, 95, 170, 60, 3, 3, 'F');
        doc.setDrawColor(59, 130, 246);
        doc.setLineWidth(0.5);
        doc.roundedRect(20, 95, 170, 60, 3, 3, 'S');
        
        doc.setFontSize(14);
        doc.setTextColor(59, 130, 246);
        doc.text("STUDENT INFORMATION", 105, 105, { align: 'center' });
        
        doc.setFontSize(10);
        doc.setTextColor(226, 232, 240);

        const leftColumn = [
          `Name: ${currentUser.name}`,
          `Username: ${currentUser.username}`,
          `Role: ${currentUser.role}`,
          `Ch: ${currentTopicName.substring(0, 60)}`
        ];

        const rightColumn = [
          `Class: ${currentClass === 'JE' ? 'Junior Engineer' : 'Class ' + currentClass}`,
          `Subject: ${currentSubject}`,
          `Date: ${date}`,
          `Time: ${time}`
        ];

        let yPos = 115;
        for (let i = 0; i < 4; i++) {
          doc.text(leftColumn[i], 30, yPos);
          doc.text(rightColumn[i], 140, yPos);
          yPos += 7;
        }

        // Results box
        doc.setFillColor(30, 41, 59);
        doc.roundedRect(20, 165, 170, 100, 3, 3, 'F');
        doc.setDrawColor(34, 197, 94);
        doc.setLineWidth(0.5);
        doc.roundedRect(20, 165, 170, 100, 3, 3, 'S');

        doc.setFontSize(14);
        doc.setTextColor(34, 197, 94);
        doc.text("RESULTS SUMMARY", 105, 175, { align: 'center' });

        const percentageVsTotal = stats.total > 0 ? ((stats.correct / stats.total) * 100).toFixed(2) : 0;

        const results = [
          { label: "Total Questions", value: stats.total, x: 25, y: 185 },
          { label: "Attempted", value: `${stats.attempted} out of ${stats.total}`, x: 110, y: 185 },
          { label: "Correct Answers", value: stats.correct, x: 25, y: 200 },
          { label: "Incorrect Answers", value: stats.incorrect, x: 110, y: 200 },
          { label: "Score (Based on Total)", value: `${percentageVsTotal}%`, x: 25, y: 215 },
          { label: "Time Taken", value: timeTaken || "N/A", x: 110, y: 215 }
        ];

        doc.setFontSize(10);

        results.forEach(result => {
          doc.setTextColor(148, 163, 184);
          doc.text(result.label, result.x, result.y);

          doc.setFont('helvetica', 'bold');
          if (result.label.includes("Score")) {
            doc.setTextColor(34, 197, 94);
          } else if (result.label.includes("Time")) {
            doc.setTextColor(245, 158, 11);
          } else if (result.label.includes("Correct")) {
            doc.setTextColor(34, 197, 94);
          } else if (result.label.includes("Incorrect")) {
            doc.setTextColor(239, 68, 68);
          } else {
            doc.setTextColor(226, 232, 240);
          }
          doc.text(result.value.toString(), result.x + 50, result.y);
          doc.setFont('helvetica', 'normal');
        });

        doc.setFontSize(8);
        doc.setTextColor(148, 163, 184);
        doc.text("PDF Generated by G.S. Tutorial App", 105, 285, { align: 'center' });
        doc.text("Â© 2025 G.S. Tutorial. All rights reserved.", 105, 290, { align: 'center' });

        // Convert PDF to base64 for Telegram
        const pdfBase64 = doc.output('datauristring').split(',')[1];
        
        // Send to Telegram
        await sendPDFToTelegram(pdfBase64, shortFilename);

        updatePDFStatus("PDF Generated successfully!", "You can download it below.");
        setTimeout(() => {
          hidePDFOverlay();

          // Add download button to results
          const finalScoreDiv = document.querySelector('.final-score');
          const existingPdfBtn = finalScoreDiv.querySelector('.pdf-report-btn');
          if (!existingPdfBtn) {
            const pdfButton = document.createElement('button');
            pdfButton.className = 'pdf-report-btn';
            pdfButton.innerHTML = 'ðŸ“„ Download PDF Report';
            pdfButton.onclick = () => {
              const originalText = pdfButton.innerHTML;
              pdfButton.innerHTML = 'â³ Downloading...';
              pdfButton.disabled = true;

              setTimeout(() => {
                doc.save(shortFilename);
                pdfButton.innerHTML = 'âœ… Downloaded!';
                setTimeout(() => {
                  pdfButton.innerHTML = originalText;
                  pdfButton.disabled = false;
                }, 2000);
              }, 500);
            };

            const restartBtn = finalScoreDiv.querySelector('.restart-btn');
            if (restartBtn) {
              finalScoreDiv.insertBefore(pdfButton, restartBtn);
            }
          }

          // Add Q&A PDF button
          const qaButton = document.createElement('button');
          qaButton.className = 'questions-answers-btn';
          qaButton.innerHTML = 'ðŸ“š Download Q&A PDF';
          qaButton.onclick = generateQuestionsAnswersPDF;
          const restartBtn = finalScoreDiv.querySelector('.restart-btn');
          if (restartBtn) {
            restartBtn.parentNode.insertBefore(qaButton, restartBtn.nextSibling);
          }
        }, 2000);

      } catch (error) {
        console.error("Error generating PDF:", error);
        updatePDFStatus("Error generating report", "Please try again.");
        setTimeout(hidePDFOverlay, 3000);
      }
    }

    async function generateQuestionsAnswersPDF() {
      if (!currentUser || !questionsLoaded || questions.length === 0) {
        alert("No questions available to generate Q&A PDF.");
        return;
      }

      showPDFOverlay("Generating Questions & Answers PDF...");

      try {
        updatePDFStatus("Preparing questions and answers...");
        const now = new Date();
        const date = now.toLocaleDateString('en-IN');
        const time = now.toLocaleTimeString('en-IN');

        const shortFilename = `GS_QA_${currentUser.username.substring(0, 6)}_${currentSubject.substring(0, 3)}_${currentTopicName.substring(0, 10).replace(/\s+/g, '')}_${Date.now().toString().slice(-6)}.pdf`;

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({
          orientation: 'portrait',
          unit: 'mm',
          format: 'a4'
        });

        doc.setProperties({
          title: `Questions & Answers - ${currentTopicName}`,
          subject: `${currentSubject} - ${currentTopicName}`,
          author: 'G.S. Tutorial',
          creator: 'G.S. Tutorial App'
        });

        // ========== PAGE 1: COVER ==========
        updatePDFStatus("Creating cover page...");
        
        doc.setFillColor(15, 23, 42);
        doc.rect(0, 0, 210, 297, 'F');
        
        doc.setFillColor(30, 41, 59);
        doc.rect(0, 0, 210, 50, 'F');
        
        try {
          const logoUrl = 'logo.png';
          const img = new Image();
          img.crossOrigin = 'Anonymous';
          
          await new Promise((resolve, reject) => {
            img.onload = resolve;
            img.onerror = reject;
            img.src = logoUrl;
          });
          
          doc.addImage(img, 'PNG', 8, 8, 35, 35);
        } catch (error) {
          doc.setFillColor(59, 130, 246);
          doc.circle(27, 24, 18, 'F');
          doc.setTextColor(255, 255, 255);
          doc.setFontSize(18);
          doc.text("GS", 22, 28);
        }
        
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(22);
        doc.setTextColor(59, 130, 246);
        doc.text("G.S. Tutorial", 50, 15);
        
        doc.setFontSize(12);
        doc.setTextColor(148, 163, 184);
        doc.text("Interactive Learning App", 50, 23);
        
        doc.setFontSize(9);
        doc.setTextColor(226, 232, 240);
        doc.text("App Created by Gobind Sharma", 50, 30);
        
        doc.setFontSize(9);
        doc.setFont('helvetica', 'bold');
        doc.text("Mobile: 9706195457", 50, 35);
        doc.setFont('helvetica', 'normal');
        doc.text("Email: gobind.bngn@gmail.com", 50, 40);
        doc.text("App Link: https://gstutorial.github.io/app", 50, 45);
        
        doc.setDrawColor(59, 130, 246);
        doc.setLineWidth(0.5);
        doc.line(0, 50, 210, 50);
        
        doc.setFontSize(24);
        doc.setTextColor(226, 232, 240);
        doc.text("QUESTIONS & ANSWERS", 105, 80, { align: 'center' });

        doc.setFontSize(18);
        doc.setTextColor(34, 197, 94);
        const chapterLines = doc.splitTextToSize(currentTopicName, 170);
        let chapterY = 95;
        chapterLines.forEach(line => {
          doc.text(line, 105, chapterY, { align: 'center' });
          chapterY += 8;
        });

        doc.setFillColor(30, 41, 59);
        doc.roundedRect(35, chapterY + 10, 140, 45, 3, 3, 'F');
        doc.setDrawColor(59, 130, 246);
        doc.setLineWidth(0.5);
        doc.roundedRect(35, chapterY + 10, 140, 45, 3, 3, 'S');

        doc.setFontSize(12);
        doc.setTextColor(59, 130, 246);
        doc.text("STUDENT INFORMATION", 105, chapterY + 18, { align: 'center' });

        doc.setFontSize(10);
        doc.setTextColor(226, 232, 240);

        const leftColumn = [
          `Name: ${currentUser.name}`,
          `Class: ${currentClass === 'JE' ? 'Junior Engineer' : 'Class ' + currentClass}`,
          `Subject: ${currentSubject}`
        ];

        const rightColumn = [
          `Date: ${date}`,
          `Time: ${time}`
        ];

        let infoY = chapterY + 28;
        const lineHeight = 6;

        for (let i = 0; i < 3; i++) {
          if (leftColumn[i]) {
            doc.text(leftColumn[i], 45, infoY);
          }
          if (i < 2 && rightColumn[i]) {
            doc.text(rightColumn[i], 110, infoY);
          }
          infoY += lineHeight;
        }

        doc.setFontSize(8);
        doc.setTextColor(148, 163, 184);
        doc.text("Â© 2025 G.S. Tutorial. All rights reserved.", 105, 285, { align: 'center' });

        // Content pages
        doc.addPage();

        doc.setFillColor(15, 23, 42);
        doc.rect(0, 0, 210, 297, 'F');

        doc.setFillColor(30, 41, 59);
        doc.rect(0, 0, 210, 20, 'F');

        doc.setFontSize(10);
        doc.setTextColor(148, 163, 184);
        doc.text(`Chapter: ${currentTopicName}`, 20, 12);

        let yPos = 30;
        const pageHeight = 280;
        const margin = 20;
        const textWidth = 120;

        for (let i = 0; i < questions.length; i++) {
          const q = questions[i];

          if (yPos > pageHeight - 50) {
            doc.addPage();

            doc.setFillColor(15, 23, 42);
            doc.rect(0, 0, 210, 297, 'F');

            doc.setFillColor(30, 41, 59);
            doc.rect(0, 0, 210, 20, 'F');

            doc.setFontSize(10);
            doc.setTextColor(148, 163, 184);
            doc.text(`Chapter: ${currentTopicName} (Cont.)`, 20, 12);

            yPos = 30;
          }

          doc.setFontSize(12);
          doc.setTextColor(34, 197, 94);
          doc.text(`Q${i + 1}.`, margin, yPos);

          doc.setFontSize(11);
          doc.setTextColor(226, 232, 240);

          const cleanQuestion = q.question.replace(/[\r\n]/g, ' ');
          const questionLines = doc.splitTextToSize(cleanQuestion, textWidth);

          let questionY = yPos;
          questionLines.forEach((line, lineIndex) => {
            if (lineIndex === 0) {
              doc.text(line, margin + 10, questionY);
            } else {
              doc.text(line, margin, questionY);
            }
            questionY += 5;
          });

          yPos = questionY + 5;

          q.options.forEach((opt, optIdx) => {
            if (yPos > pageHeight - 10) {
              doc.addPage();

              doc.setFillColor(15, 23, 42);
              doc.rect(0, 0, 210, 297, 'F');

              doc.setFillColor(30, 41, 59);
              doc.rect(0, 0, 210, 20, 'F');

              doc.setFontSize(10);
              doc.setTextColor(148, 163, 184);
              doc.text(`Chapter: ${currentTopicName} (Cont.)`, 20, 12);

              yPos = 30;
            }

            const optionText = `${String.fromCharCode(65 + optIdx)}. ${opt}`;
            const optionLines = doc.splitTextToSize(optionText, textWidth - 10);

            optionLines.forEach(line => {
              if (optIdx === q.correctIndex) {
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(34, 197, 94);
              } else {
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(148, 163, 184);
              }

              doc.text(line, margin + 5, yPos);
              yPos += 4;
            });
          });

          if (q.explanation && q.explanation.trim() !== '') {
            yPos += 5;

            if (yPos > pageHeight - 30) {
              doc.addPage();

              doc.setFillColor(15, 23, 42);
              doc.rect(0, 0, 210, 297, 'F');

              doc.setFillColor(30, 41, 59);
              doc.rect(0, 0, 210, 20, 'F');

              doc.setFontSize(10);
              doc.setTextColor(148, 163, 184);
              doc.text(`Chapter: ${currentTopicName} (Cont.)`, 20, 12);

              yPos = 30;
            }

            doc.setFont('helvetica', 'bold');
            doc.setTextColor(59, 130, 246);
            doc.text("Explanation:", margin, yPos);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(226, 232, 240);

            const cleanExplanation = q.explanation.replace(/[\r\n]/g, ' ');
            const explanationLines = doc.splitTextToSize(cleanExplanation, textWidth);
            explanationLines.forEach(line => {
              yPos += 5;
              if (yPos > pageHeight - 10) {
                doc.addPage();

                doc.setFillColor(15, 23, 42);
                doc.rect(0, 0, 210, 297, 'F');

                doc.setFillColor(30, 41, 59);
                doc.rect(0, 0, 210, 20, 'F');

                doc.setFontSize(10);
                doc.setTextColor(148, 163, 184);
                doc.text(`Chapter: ${currentTopicName} (Cont.)`, 20, 12);

                yPos = 30;
              }
              doc.text(line, margin, yPos);
            });
          }

          yPos += 10;
          if (yPos > pageHeight - 15) {
            doc.addPage();

            doc.setFillColor(15, 23, 42);
            doc.rect(0, 0, 210, 297, 'F');

            doc.setFillColor(30, 41, 59);
            doc.rect(0, 0, 210, 20, 'F');

            doc.setFontSize(10);
            doc.setTextColor(148, 163, 184);
            doc.text(`Chapter: ${currentTopicName} (Cont.)`, 20, 12);

            yPos = 30;
          }

          doc.setDrawColor(75, 85, 99);
          doc.setLineWidth(0.2);
          doc.line(margin, yPos, 190, yPos);
          yPos += 10;
        }

        const totalPages = doc.internal.getNumberOfPages();
        for (let i = 1; i <= totalPages; i++) {
          doc.setPage(i);
          doc.setFontSize(8);
          doc.setTextColor(148, 163, 184);
          doc.text(`Page ${i} of ${totalPages}`, 105, 290, { align: 'center' });
        }

        updatePDFStatus("PDF Generated successfully!", "You can download it below.");
        setTimeout(() => {
          hidePDFOverlay();
          doc.save(shortFilename);

          const finalScoreDiv = document.querySelector('.final-score');
          const existingQABtn = finalScoreDiv.querySelector('.questions-answers-btn');
          if (!existingQABtn) {
            const qaButton = document.createElement('button');
            qaButton.className = 'questions-answers-btn';
            qaButton.innerHTML = 'ðŸ“š Download Q&A PDF';
            qaButton.onclick = generateQuestionsAnswersPDF;
            const pdfBtn = finalScoreDiv.querySelector('.pdf-report-btn');
            if (pdfBtn) {
              finalScoreDiv.insertBefore(qaButton, pdfBtn.nextSibling);
            }
          }
        }, 1000);

      } catch (error) {
        console.error("Error generating Q&A PDF:", error);
        updatePDFStatus("Error generating Q&A PDF", "Please try again.");
        setTimeout(hidePDFOverlay, 3000);
      }
    }

    // ========== EVENT LISTENERS ==========
    loginFormEl.addEventListener("submit", async function(e) {
      e.preventDefault();

      if (isOnCooldown) {
        loginErrorEl.textContent = "Please wait for cooldown.";
        loginErrorEl.style.display = "block";
        return;
      }

      const username = usernameEl.value.trim();
      const password = passwordEl.value.trim();

      if (!username || !password) {
        loginErrorEl.textContent = "Enter both username and password";
        loginErrorEl.style.display = "block";
        return;
      }

      loginErrorEl.style.display = "none";
      loginBtnEl.disabled = true;
      loginBtnEl.innerHTML = 'Loading...';

      const result = await authenticateWithAppsScript(username, password);

      if (result?.success) {
        resetFailedAttempts();
        const user = result.user;

        if (!result.subscriptionValid) {
          showSubscriptionExpired(user, user.joiningDate, user.lastDate);
        } else {
          const validation = validateUserAccount(user);
          if (!validation.valid) {
            showAccountConfigError(user, validation.error, {
              assignedClasses: validation.assignedClasses
            });
          } else {
            login(user, false);
          }
        }
      } else {
        recordFailedAttempt();
        loginErrorEl.textContent = failedAttempts >= MAX_ATTEMPTS ? 
          `Too many attempts. Wait ${COOLDOWN_TIME}s.` : 
          (result?.error || 'Invalid username or password');
        loginErrorEl.style.display = "block";
      }

      loginBtnEl.disabled = false;
      loginBtnEl.innerHTML = 'Login';
    });

    passwordToggleEl.addEventListener("click", togglePasswordVisibility);
    headerLogoutBtnEl.addEventListener("click", logout);
    backToClassesBtn.addEventListener("click", () => { showClassSelection(); resetInactivityTimer(); });
    backToLoginBtnEl.addEventListener("click", () => { accountConfigErrorEl.style.display = "none"; loginContainerEl.style.display = "flex"; resetInactivityTimer(); });
    backToLoginFromExpiredBtn.addEventListener("click", () => { subscriptionExpiredEl.style.display = "none"; loginContainerEl.style.display = "flex"; resetInactivityTimer(); });

    startBtnEl.addEventListener("click", () => {
      const chapter = topicSelectEl.value;
      if (timerInterval) clearInterval(timerInterval);
      removeTimerNotification();
      resetQuizState();
      loadQuestionsFromGoogleSheet(chapter);
      resetInactivityTimer();
    });

    nextBtn.addEventListener("click", goToNextQuestion);
    previousBtn.addEventListener("click", goToPreviousQuestion);
    navigationToggleBtn.addEventListener("click", toggleQuestionNavigation);
    randomToggleEl.addEventListener("change", () => resetInactivityTimer());

    setupQuestionWhatsAppSupport();

    document.addEventListener('click', (e) => {
      if (questionImageEl.classList.contains('zoomed') && !e.target.closest('#question-image-container')) {
        questionImageEl.classList.remove('zoomed', 'touch-zoom');
      }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') questionImageEl.classList.remove('zoomed', 'touch-zoom');
    });

    // ========== SIDE MENU TOGGLE ==========
    function toggleMenu() {
      sideMenu.classList.toggle('open');
      menuOverlay.classList.toggle('open');
    }
    menuToggle.addEventListener('click', toggleMenu);
    menuOverlay.addEventListener('click', toggleMenu);
    sideLogoutBtn.addEventListener('click', () => {
      toggleMenu();
      logout();
    });

    // ========== THEME TOGGLE ==========
    function setTheme(theme) {
      if (theme === 'light') {
        document.body.classList.add('light-mode');
        themeIcon.textContent = 'â˜€ï¸';
        metaThemeColor.setAttribute('content', '#f3f4f6');
        localStorage.setItem('theme', 'light');
      } else {
        document.body.classList.remove('light-mode');
        themeIcon.textContent = 'ðŸŒ™';
        metaThemeColor.setAttribute('content', '#0f172a');
        localStorage.setItem('theme', 'dark');
      }
    }
    themeToggle.addEventListener('click', () => {
      setTheme(document.body.classList.contains('light-mode') ? 'dark' : 'light');
    });
    setTheme(localStorage.getItem('theme') || 'dark');

    // ========== INITIALIZATION ==========
    async function initializeApp() {
      await loadTelegramConfig();
      await getUserIP();

      if (loadSession()) {
        login(currentUser, true);
      } else {
        usernameEl.focus();
      }

      document.addEventListener('mousemove', handleUserActivity);
      document.addEventListener('keypress', handleUserActivity);
      document.addEventListener('click', handleUserActivity);
      document.addEventListener('scroll', handleUserActivity);
      document.addEventListener('touchstart', handleUserActivity);

      resetFailedAttempts();
    }

    document.addEventListener("DOMContentLoaded", initializeApp);
  </script>
  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("service-worker.js").catch(() => {});
    }
  </script>
</body>
</html>
