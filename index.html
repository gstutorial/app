<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0f172a" id="meta-theme-color">
  <meta charset="UTF-8" />
  <title>G.S. Tutorial â€“ Interactive Learning App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <!-- Include jsPDF library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <!-- Include html2canvas for capturing screenshots -->
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <!-- Include Inter font for better readability -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    /* ===== CSS VARIABLES FOR LIGHT/DARK THEMES - OPTIMIZED ===== */
    :root {
      --bg-primary: #0b1120;
      --bg-secondary: #111827;
      --bg-tertiary: #1e293b;
      --surface: #1a1f2e;
      --surface-light: #2d3748;
      --text-primary: #f3f4f6;
      --text-secondary: #d1d5db;
      --text-muted: #9ca3af;
      --border-light: rgba(255,255,255,0.08);
      --border-medium: rgba(255,255,255,0.12);
      --accent-blue: #3b82f6;
      --accent-blue-dark: #2563eb;
      --accent-green: #22c55e;
      --accent-green-dark: #16a34a;
      --accent-red: #ef4444;
      --accent-red-dark: #dc2626;
      --accent-yellow: #f59e0b;
      --accent-yellow-dark: #d97706;
      --accent-purple: #8b5cf6;
      --accent-purple-dark: #7c3aed;
      --shadow-sm: 0 4px 6px -1px rgba(0,0,0,0.3);
      --shadow-md: 0 10px 15px -3px rgba(0,0,0,0.4);
      --shadow-lg: 0 20px 25px -5px rgba(0,0,0,0.5);
      --gradient-primary: linear-gradient(135deg, #3b82f6 0%, #22c55e 100%);
      --gradient-error: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      --gradient-warning: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      --gradient-purple: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
      --header-height: 70px;
      --sidebar-width: 300px;
      --border-radius-sm: 12px;
      --border-radius-md: 16px;
      --border-radius-lg: 24px;
      --border-radius-xl: 32px;
      --font-size-xs: 0.75rem;
      --font-size-sm: 0.875rem;
      --font-size-md: 1rem;
      --font-size-lg: 1.125rem;
      --font-size-xl: 1.25rem;
      --font-size-2xl: 1.5rem;
      --font-size-3xl: 1.875rem;
      --spacing-xs: 4px;
      --spacing-sm: 8px;
      --spacing-md: 12px;
      --spacing-lg: 16px;
      --spacing-xl: 20px;
      --spacing-2xl: 24px;
      --spacing-3xl: 32px;
    }

    body.light-mode {
      --bg-primary: #f3f4f6;
      --bg-secondary: #ffffff;
      --bg-tertiary: #f9fafb;
      --surface: #ffffff;
      --surface-light: #e5e7eb;
      --text-primary: #111827;
      --text-secondary: #374151;
      --text-muted: #6b7280;
      --border-light: rgba(0,0,0,0.06);
      --border-medium: rgba(0,0,0,0.1);
      --accent-blue: #2563eb;
      --accent-blue-dark: #1d4ed8;
      --accent-green: #16a34a;
      --accent-green-dark: #15803d;
      --accent-red: #dc2626;
      --accent-red-dark: #b91c1c;
      --accent-yellow: #d97706;
      --accent-yellow-dark: #b45309;
      --accent-purple: #7c3aed;
      --accent-purple-dark: #6d28d9;
      --shadow-sm: 0 4px 6px -1px rgba(0,0,0,0.1);
      --shadow-md: 0 10px 15px -3px rgba(0,0,0,0.1);
      --shadow-lg: 0 20px 25px -5px rgba(0,0,0,0.1);
    }

    /* ===== BASE STYLES ===== */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      transition: background-color 0.3s, color 0.2s;
      display: flex;
      flex-direction: column;
      align-items: center;
      -webkit-tap-highlight-color: transparent;
      line-height: 1.5;
    }

    /* ===== LOADING ANIMATIONS ===== */
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideIn {
      from { transform: translateX(-20px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    @keyframes shimmer {
      0% { background-position: -1000px 0; }
      100% { background-position: 1000px 0; }
    }

    .loading-spinner {
      border: 4px solid rgba(59, 130, 246, 0.2);
      border-top: 4px solid var(--accent-blue);
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: var(--spacing-xl) auto;
    }

    .loading-spinner-small {
      border: 3px solid rgba(59, 130, 246, 0.2);
      border-top: 3px solid var(--accent-blue);
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      display: inline-block;
      margin-right: var(--spacing-sm);
    }

    .loading-pulse {
      animation: pulse 1.5s ease-in-out infinite;
    }

    .loading-shimmer {
      background: linear-gradient(90deg, 
        rgba(30, 41, 59, 0.3) 0%, 
        rgba(30, 41, 59, 0.5) 50%, 
        rgba(30, 41, 59, 0.3) 100%);
      background-size: 1000px 100%;
      animation: shimmer 2s infinite;
    }

    .loading-container {
      text-align: center;
      padding: var(--spacing-3xl);
      color: var(--text-muted);
      grid-column: 1/-1;
    }

    .loading-text {
      font-size: var(--font-size-lg);
      margin-top: var(--spacing-lg);
      color: var(--accent-blue);
      font-weight: 500;
    }

    .loading-subtext {
      font-size: var(--font-size-sm);
      margin-top: var(--spacing-sm);
      color: var(--text-muted);
    }

    /* ===== SKELETON LOADING ===== */
    .skeleton-card {
      background: var(--bg-tertiary);
      border-radius: var(--border-radius-md);
      padding: var(--spacing-xl);
      min-height: 120px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--border-light);
      animation: pulse 1.5s infinite;
    }

    .skeleton-icon {
      width: 40px;
      height: 40px;
      border-radius: var(--border-radius-sm);
      background: var(--surface-light);
      margin-bottom: var(--spacing-sm);
    }

    .skeleton-title {
      width: 80px;
      height: 20px;
      background: var(--surface-light);
      border-radius: var(--border-radius-sm);
      margin-bottom: var(--spacing-xs);
    }

    .skeleton-desc {
      width: 120px;
      height: 16px;
      background: var(--surface-light);
      border-radius: var(--border-radius-sm);
    }

    /* ===== FIXED HEADER - REDESIGNED ===== */
    .fixed-header {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background: var(--surface);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border-medium);
      z-index: 1000;
      padding: 0 var(--spacing-xl);
      height: var(--header-height);
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: var(--shadow-md);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
    }

    .logo-header {
      width: 48px;
      height: 48px;
      border-radius: var(--border-radius-md);
      object-fit: contain;
      background: var(--bg-tertiary);
      padding: 4px;
      box-shadow: var(--shadow-sm);
      transition: transform 0.2s;
    }

    .logo-header:hover {
      transform: scale(1.05);
    }

    .brand-container {
      display: flex;
      flex-direction: column;
    }

    .brand-main {
      font-weight: 800;
      font-size: var(--font-size-xl);
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      line-height: 1.2;
      letter-spacing: -0.02em;
    }

    .brand-sub {
      font-size: var(--font-size-xs);
      color: var(--text-muted);
      letter-spacing: 0.3px;
      font-weight: 500;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
    }

    .user-info {
      font-size: var(--font-size-sm);
      color: var(--accent-blue);
      background: rgba(59, 130, 246, 0.1);
      padding: var(--spacing-sm) var(--spacing-lg);
      border-radius: 40px;
      border: 1px solid rgba(59, 130, 246, 0.2);
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
      font-weight: 600;
      backdrop-filter: blur(4px);
    }

    .menu-toggle {
      width: 44px;
      height: 44px;
      border-radius: var(--border-radius-md);
      background: var(--bg-tertiary);
      border: 1px solid var(--border-light);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .menu-toggle:hover {
      background: var(--accent-blue);
      border-color: var(--accent-blue);
    }

    .menu-toggle:hover span {
      background: white;
    }

    .menu-toggle span {
      width: 22px;
      height: 2px;
      background: var(--text-primary);
      border-radius: 4px;
      transition: all 0.3s;
    }

    /* ===== SIDE MENU ===== */
    .side-menu {
      position: fixed;
      top: var(--header-height);
      right: calc(-1 * var(--sidebar-width));
      width: var(--sidebar-width);
      height: calc(100vh - var(--header-height));
      background: var(--surface);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border-left: 1px solid var(--border-medium);
      box-shadow: var(--shadow-lg);
      transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 1001;
      display: flex;
      flex-direction: column;
      padding: var(--spacing-2xl) var(--spacing-lg);
      overflow-y: auto;
    }

    .side-menu.open {
      right: 0;
    }

    .menu-overlay {
      position: fixed;
      top: var(--header-height);
      left: 0;
      width: 100%;
      height: calc(100vh - var(--header-height));
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      z-index: 1000;
      display: none;
      transition: opacity 0.3s;
    }

    .menu-overlay.open {
      display: block;
    }

    .side-profile {
      text-align: center;
      margin-bottom: var(--spacing-2xl);
      animation: slideIn 0.3s ease;
    }

    .side-profile img {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid var(--accent-blue);
      margin-bottom: var(--spacing-md);
      box-shadow: var(--shadow-md);
      transition: transform 0.2s;
    }

    .side-profile img:hover {
      transform: scale(1.05);
    }

    .side-username {
      font-weight: 700;
      font-size: var(--font-size-lg);
      background: rgba(59,130,246,0.1);
      padding: var(--spacing-sm) var(--spacing-lg);
      border-radius: 40px;
      display: inline-block;
      color: var(--text-primary);
      border: 1px solid rgba(59,130,246,0.2);
    }

    .side-dev {
      border-top: 1px solid var(--border-light);
      border-bottom: 1px solid var(--border-light);
      padding: var(--spacing-xl) 0;
      margin: var(--spacing-lg) 0;
    }

    .side-dev p {
      color: var(--text-secondary);
      margin-bottom: var(--spacing-lg);
      font-weight: 700;
      font-size: var(--font-size-md);
      text-align: center;
    }

    .contact-item {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
      padding: var(--spacing-md);
      color: var(--text-secondary);
      transition: all 0.2s;
      cursor: pointer;
      border-radius: var(--border-radius-md);
      margin-bottom: var(--spacing-xs);
    }

    .contact-item:hover {
      background: var(--bg-tertiary);
      color: var(--accent-blue);
      transform: translateX(4px);
    }

    .contact-item img {
      width: 24px;
      height: 24px;
      object-fit: contain;
    }

    .contact-item span {
      color: var(--text-secondary);
      font-size: var(--font-size-sm);
      font-weight: 500;
      transition: color 0.2s;
    }

    .contact-item:hover span {
      color: var(--accent-blue);
    }

    .theme-toggle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--bg-tertiary);
      padding: var(--spacing-md) var(--spacing-lg);
      border-radius: 40px;
      margin: var(--spacing-xl) 0;
      border: 1px solid var(--border-light);
      cursor: pointer;
      color: var(--text-primary);
      font-weight: 600;
      transition: all 0.2s;
    }

    .theme-toggle:hover {
      background: var(--surface-light);
      transform: translateY(-2px);
    }

    .logout-side {
      margin-top: auto;
      padding: var(--spacing-md);
      background: rgba(239,68,68,0.1);
      border: 1px solid rgba(239,68,68,0.2);
      border-radius: 40px;
      color: var(--accent-red);
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--spacing-sm);
      cursor: pointer;
      transition: all 0.2s;
    }

    .logout-side:hover {
      background: rgba(239,68,68,0.2);
      transform: translateY(-2px);
    }

    /* ===== MAIN CONTENT ===== */
    .main-content {
      width: 100%;
      max-width: 500px;
      margin: calc(var(--header-height) + var(--spacing-lg)) auto var(--spacing-xl);
      padding: 0 var(--spacing-md);
      display: flex;
      flex-direction: column;
      gap: var(--spacing-lg);
    }

    /* ===== GREETING MESSAGE ===== */
    .greeting-message {
      background: var(--surface);
      border-radius: var(--border-radius-lg);
      padding: var(--spacing-xl);
      border: 1px solid var(--border-light);
      font-size: var(--font-size-lg);
      color: var(--text-primary);
      box-shadow: var(--shadow-md);
      text-align: center;
      animation: fadeIn 0.3s ease;
      font-weight: 600;
      backdrop-filter: blur(8px);
    }

    .greeting-message span {
      font-weight: 800;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      display: inline-block;
    }

    .class-title {
      font-size: var(--font-size-sm);
      color: var(--text-muted);
      margin-bottom: var(--spacing-md);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      text-align: center;
      font-weight: 700;
    }

    /* ===== LOGIN CONTAINER ===== */
    #login-container {
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: calc(100vh - var(--header-height) - var(--spacing-3xl));
    }

    .login-box {
      background: var(--surface);
      border-radius: var(--border-radius-xl);
      padding: var(--spacing-3xl) var(--spacing-2xl);
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--border-light);
      width: 100%;
      max-width: 400px;
      animation: fadeIn 0.4s ease;
      backdrop-filter: blur(8px);
    }

    .login-header {
      text-align: center;
      margin-bottom: var(--spacing-3xl);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: var(--spacing-lg);
    }

    .logo-login {
      width: 90px;
      height: 90px;
      border-radius: var(--border-radius-lg);
      object-fit: contain;
      background: var(--bg-tertiary);
      padding: var(--spacing-sm);
      box-shadow: var(--shadow-md);
      transition: transform 0.2s;
    }

    .logo-login:hover {
      transform: scale(1.05);
    }

    .login-title {
      font-size: var(--font-size-3xl);
      font-weight: 800;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      letter-spacing: -0.02em;
      line-height: 1.2;
    }

    .login-subtitle {
      font-size: var(--font-size-sm);
      color: var(--text-muted);
      text-align: center;
      font-weight: 500;
    }

    .login-form {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-xl);
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-xs);
      position: relative;
    }

    .form-group label {
      font-size: var(--font-size-sm);
      color: var(--text-secondary);
      font-weight: 600;
      margin-left: var(--spacing-xs);
    }

    .form-input {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border-radius: var(--border-radius-lg);
      border: 1px solid var(--border-light);
      padding: var(--spacing-md) var(--spacing-lg);
      font-size: var(--font-size-md);
      transition: all 0.2s;
      width: 100%;
      padding-right: 45px;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--accent-blue);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }

    .form-input::placeholder {
      color: var(--text-muted);
    }

    .password-input-wrapper {
      position: relative;
      width: 100%;
    }

    .password-toggle {
      position: absolute;
      right: var(--spacing-md);
      top: 50%;
      transform: translateY(-50%);
      background: transparent;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      font-size: var(--font-size-lg);
      transition: color 0.2s;
      padding: var(--spacing-xs);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .password-toggle:hover {
      color: var(--accent-blue);
    }

    .attempt-counter {
      margin-top: var(--spacing-xs);
      font-size: var(--font-size-xs);
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
      padding: var(--spacing-sm) var(--spacing-md);
      background: rgba(239,68,68,0.1);
      border-radius: var(--border-radius-md);
      border: 1px solid rgba(239,68,68,0.2);
      font-weight: 600;
    }

    .attempt-counter.warning {
      color: #fbbf24;
      background: rgba(245,158,11,0.1);
      border-color: rgba(245,158,11,0.2);
    }

    .attempt-counter.critical {
      color: #ef4444;
      background: rgba(239,68,68,0.15);
      border-color: rgba(239,68,68,0.3);
    }

    .cooldown-message {
      margin-top: var(--spacing-xs);
      padding: var(--spacing-md);
      background: rgba(239,68,68,0.15);
      border: 1px solid rgba(239,68,68,0.3);
      border-radius: var(--border-radius-md);
      font-size: var(--font-size-sm);
      color: #fca5a5;
      text-align: center;
      animation: pulse 2s infinite;
      font-weight: 600;
    }

    .login-btn {
      background: var(--gradient-primary);
      color: white;
      border: none;
      border-radius: 40px;
      padding: var(--spacing-md) var(--spacing-xl);
      font-size: var(--font-size-lg);
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      margin-top: var(--spacing-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--spacing-xs);
      box-shadow: var(--shadow-md);
      width: 100%;
    }

    .login-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .login-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .login-error {
      background: rgba(239,68,68,0.15);
      color: #fca5a5;
      padding: var(--spacing-md);
      border-radius: var(--border-radius-md);
      font-size: var(--font-size-sm);
      border: 1px solid rgba(239,68,68,0.3);
      display: none;
      text-align: center;
      font-weight: 600;
    }

    .request-credentials-btn {
      background: linear-gradient(135deg, #25d366, #128c7e);
      color: white;
      border: none;
      border-radius: 40px;
      padding: var(--spacing-md) var(--spacing-xl);
      font-size: var(--font-size-md);
      font-weight: 600;
      cursor: pointer;
      margin-top: var(--spacing-xl);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--spacing-xs);
      box-shadow: var(--shadow-md);
      width: 100%;
      text-decoration: none;
      transition: all 0.2s;
    }

    .request-credentials-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .request-credentials-btn img {
      width: 24px;
      height: 24px;
      object-fit: contain;
    }

    .config-info {
      background: rgba(59,130,246,0.1);
      border: 1px solid rgba(59,130,246,0.2);
      border-radius: var(--border-radius-md);
      padding: var(--spacing-md);
      margin-top: var(--spacing-xl);
      font-size: var(--font-size-xs);
      color: var(--text-muted);
      text-align: center;
      font-weight: 500;
    }

    /* ===== ERROR/EXPIRED SCREENS ===== */
    .account-config-error, .subscription-expired {
      background: var(--surface);
      border-radius: var(--border-radius-xl);
      padding: var(--spacing-3xl) var(--spacing-2xl);
      box-shadow: var(--shadow-lg);
      border: 1px solid rgba(239,68,68,0.3);
      width: 100%;
      max-width: 400px;
      margin: 0 auto;
      animation: fadeIn 0.3s ease;
      backdrop-filter: blur(8px);
    }

    .error-header, .expired-header {
      text-align: center;
      margin-bottom: var(--spacing-2xl);
    }

    .error-title, .expired-title {
      font-size: var(--font-size-2xl);
      font-weight: 800;
      color: var(--accent-red);
      margin-bottom: var(--spacing-sm);
      letter-spacing: -0.02em;
    }

    .error-subtitle, .expired-subtitle {
      font-size: var(--font-size-md);
      color: var(--text-secondary);
      text-align: center;
      font-weight: 500;
    }

    .error-user-info, .expired-user-info {
      text-align: center;
      margin-bottom: var(--spacing-2xl);
      padding: var(--spacing-lg);
      background: rgba(239,68,68,0.1);
      border-radius: var(--border-radius-lg);
      border: 1px solid rgba(239,68,68,0.2);
    }

    .error-user-info strong, .expired-user-info strong {
      color: #fca5a5;
      font-size: var(--font-size-lg);
      font-weight: 700;
    }

    .error-details, .expired-details {
      background: var(--bg-tertiary);
      border-radius: var(--border-radius-lg);
      padding: var(--spacing-xl);
      margin-bottom: var(--spacing-2xl);
      border: 1px solid var(--border-light);
    }

    .error-details ul {
      margin: 0;
      padding-left: var(--spacing-xl);
      color: var(--text-secondary);
      line-height: 1.6;
    }

    .error-details li {
      margin-bottom: var(--spacing-sm);
    }

    .error-details strong {
      color: #fca5a5;
    }

    .whatsapp-btn {
      background: linear-gradient(135deg, #25d366, #128c7e);
      color: white;
      border: none;
      border-radius: 40px;
      padding: var(--spacing-md) var(--spacing-xl);
      font-size: var(--font-size-md);
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--spacing-xs);
      box-shadow: var(--shadow-md);
      width: 100%;
      text-decoration: none;
      transition: all 0.2s;
    }

    .whatsapp-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .whatsapp-btn img {
      width: 24px;
      height: 24px;
      object-fit: contain;
    }

    .back-to-login-btn {
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      border: 1px solid var(--border-light);
      border-radius: 40px;
      padding: var(--spacing-md) var(--spacing-xl);
      font-size: var(--font-size-md);
      cursor: pointer;
      transition: all 0.2s;
      margin-top: var(--spacing-md);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--spacing-xs);
      width: 100%;
      font-weight: 600;
    }

    .back-to-login-btn:hover {
      background: var(--surface-light);
      transform: translateY(-1px);
    }

    /* ===== CLASS SELECTION ===== */
    .class-selection {
      background: var(--surface);
      border-radius: var(--border-radius-xl);
      padding: var(--spacing-2xl) var(--spacing-xl);
      box-shadow: var(--shadow-md);
      border: 1px solid var(--border-light);
      width: 100%;
      animation: fadeIn 0.3s ease;
      backdrop-filter: blur(8px);
    }

    .screen-header {
      text-align: center;
      margin-bottom: var(--spacing-2xl);
    }

    .screen-title {
      font-size: var(--font-size-2xl);
      font-weight: 800;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      letter-spacing: -0.02em;
      margin-bottom: var(--spacing-xs);
    }

    .screen-subtitle {
      font-size: var(--font-size-sm);
      color: var(--text-muted);
      text-align: center;
      font-weight: 500;
    }

    .class-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: var(--spacing-md);
      margin-top: var(--spacing-lg);
    }

    .class-card {
      background: var(--bg-tertiary);
      border-radius: var(--border-radius-lg);
      padding: var(--spacing-xl);
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid var(--border-light);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100px;
      box-shadow: var(--shadow-sm);
    }

    .class-card:hover {
      transform: translateY(-2px);
      border-color: var(--accent-blue);
      box-shadow: var(--shadow-md);
    }

    .class-icon {
      font-size: 2rem;
      margin-bottom: var(--spacing-xs);
    }

    .class-name {
      font-size: var(--font-size-lg);
      font-weight: 700;
      color: var(--text-primary);
    }

    .class-desc {
      font-size: var(--font-size-xs);
      color: var(--text-muted);
      margin-top: var(--spacing-xs);
      font-weight: 500;
    }

    /* ===== SUBJECT SELECTION ===== */
    .subject-selection {
      background: var(--surface);
      border-radius: var(--border-radius-xl);
      padding: var(--spacing-2xl) var(--spacing-xl);
      box-shadow: var(--shadow-md);
      border: 1px solid var(--border-light);
      width: 100%;
      animation: fadeIn 0.3s ease;
      backdrop-filter: blur(8px);
    }

    .subject-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: var(--spacing-md);
      margin-top: var(--spacing-lg);
    }

    .subject-card {
      background: var(--bg-tertiary);
      border-radius: var(--border-radius-lg);
      padding: var(--spacing-xl);
      text-align: center;
      cursor: pointer;
      border: 1px solid var(--border-light);
      transition: all 0.2s;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 120px;
      box-shadow: var(--shadow-sm);
    }

    .subject-card:hover {
      transform: translateY(-2px);
      border-color: var(--accent-blue);
      box-shadow: var(--shadow-md);
    }

    .subject-icon {
      font-size: 2.5rem;
      margin-bottom: var(--spacing-xs);
    }

    .subject-name {
      font-size: var(--font-size-xl);
      font-weight: 700;
      color: var(--text-primary);
    }

    .subject-desc {
      font-size: var(--font-size-xs);
      color: var(--text-muted);
      margin-top: var(--spacing-xs);
      font-weight: 500;
    }

    .back-btn {
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      border: 1px solid var(--border-light);
      border-radius: 40px;
      padding: var(--spacing-md) var(--spacing-xl);
      font-size: var(--font-size-md);
      cursor: pointer;
      transition: all 0.2s;
      margin-top: var(--spacing-xl);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: var(--spacing-xs);
      width: 100%;
      font-weight: 600;
    }

    .back-btn:hover {
      background: var(--surface-light);
      transform: translateY(-1px);
    }

    /* ===== QUIZ CONTAINER ===== */
    .quiz-container {
      background: var(--surface);
      border-radius: var(--border-radius-xl);
      padding: var(--spacing-xl) var(--spacing-lg);
      box-shadow: var(--shadow-md);
      border: 1px solid var(--border-light);
      width: 100%;
      animation: fadeIn 0.3s ease;
      backdrop-filter: blur(8px);
    }

    .topic-section {
      margin-bottom: var(--spacing-lg);
      padding: var(--spacing-lg);
      background: var(--bg-tertiary);
      border-radius: var(--border-radius-lg);
      border: 1px solid var(--border-light);
    }

    .topic-info {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-xs);
      margin-bottom: var(--spacing-md);
    }

    .current-path {
      font-size: var(--font-size-xs);
      color: var(--accent-blue);
      background: rgba(59,130,246,0.1);
      padding: var(--spacing-sm) var(--spacing-md);
      border-radius: var(--border-radius-md);
      border: 1px solid rgba(59,130,246,0.2);
      margin-bottom: var(--spacing-md);
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
      flex-wrap: wrap;
      font-weight: 600;
    }

    .path-separator {
      color: var(--text-muted);
      margin: 0 var(--spacing-xs);
    }

    .path-link {
      color: var(--accent-blue);
      cursor: pointer;
      text-decoration: underline;
      font-weight: 600;
    }

    .topic-name {
      font-size: var(--font-size-md);
      font-weight: 700;
      color: var(--accent-blue);
      background: rgba(59,130,246,0.15);
      padding: var(--spacing-sm) var(--spacing-md);
      border-radius: 30px;
      border: 1px solid rgba(59,130,246,0.3);
      text-align: center;
    }

    .question-count {
      font-size: var(--font-size-sm);
      color: var(--accent-green);
      background: rgba(34,197,94,0.15);
      padding: var(--spacing-sm) var(--spacing-md);
      border-radius: 30px;
      border: 1px solid rgba(34,197,94,0.3);
      text-align: center;
      font-weight: 600;
    }

    .topic-row {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-sm);
      width: 100%;
    }

    .topic-select {
      width: 100%;
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border-radius: 40px;
      border: 1px solid var(--border-light);
      padding: var(--spacing-md) var(--spacing-lg);
      font-size: var(--font-size-sm);
      appearance: none;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%239ca3af' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right var(--spacing-lg) center;
      background-size: 16px;
      font-weight: 500;
      cursor: pointer;
    }

    .start-btn {
      width: 100%;
      border-radius: 40px;
      border: none;
      padding: var(--spacing-md) var(--spacing-xl);
      font-size: var(--font-size-md);
      font-weight: 700;
      cursor: pointer;
      background: var(--gradient-primary);
      color: white;
      box-shadow: var(--shadow-sm);
      transition: all 0.2s;
    }

    .start-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .start-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* ===== QUESTION NAVIGATION ===== */
    .question-navigation {
      margin: var(--spacing-lg) 0;
      padding: var(--spacing-lg);
      background: var(--bg-tertiary);
      border-radius: var(--border-radius-lg);
      border: 1px solid var(--border-light);
      transition: all 0.3s;
    }

    .navigation-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-md);
    }

    .navigation-title {
      font-size: var(--font-size-sm);
      font-weight: 700;
      color: var(--accent-blue);
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
    }

    .question-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: var(--spacing-xs);
      max-height: 150px;
      overflow-y: auto;
      padding: var(--spacing-xs);
    }

    .question-navigation.collapsed .question-grid,
    .question-navigation.collapsed .navigation-stats {
      display: none;
    }

    .question-number-btn {
      width: 100%;
      aspect-ratio: 1;
      border-radius: var(--border-radius-sm);
      border: 1px solid var(--border-light);
      background: var(--surface);
      color: var(--text-primary);
      font-size: var(--font-size-xs);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .question-number-btn:hover {
      background: var(--surface-light);
      border-color: var(--accent-blue);
      transform: translateY(-1px);
    }

    .question-number-btn.current {
      background: rgba(59,130,246,0.2);
      border-color: var(--accent-blue);
      color: var(--accent-blue);
      font-weight: 700;
      box-shadow: 0 0 0 2px rgba(59,130,246,0.3);
    }

    .question-number-btn.answered {
      background: rgba(34,197,94,0.2);
      border-color: var(--accent-green);
      color: var(--accent-green);
    }

    .question-number-btn.incorrect {
      background: rgba(239,68,68,0.2);
      border-color: var(--accent-red);
      color: var(--accent-red);
    }

    .navigation-toggle-btn {
      background: rgba(139,92,246,0.1);
      color: var(--accent-purple);
      border: 1px solid rgba(139,92,246,0.2);
      border-radius: 30px;
      padding: var(--spacing-xs) var(--spacing-md);
      font-size: var(--font-size-xs);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
      font-weight: 600;
      transition: all 0.2s;
    }

    .navigation-toggle-btn:hover {
      background: rgba(139,92,246,0.2);
      transform: translateY(-1px);
    }

    .navigation-stats {
      display: flex;
      gap: var(--spacing-sm);
      margin-top: var(--spacing-md);
      padding-top: var(--spacing-md);
      border-top: 1px solid var(--border-light);
      flex-wrap: wrap;
      font-size: var(--font-size-xs);
    }

    .stat-badge {
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
      padding: var(--spacing-xs) var(--spacing-sm);
      border-radius: 30px;
      background: var(--surface);
      border: 1px solid var(--border-light);
      font-weight: 600;
    }

    .stat-badge.current { color: var(--accent-blue); }
    .stat-badge.answered { color: var(--accent-green); }
    .stat-badge.incorrect { color: var(--accent-red); }

    .toggle-row {
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
      font-size: var(--font-size-sm);
      color: var(--text-secondary);
      margin: var(--spacing-md) 0;
      padding: var(--spacing-sm) var(--spacing-md);
      background: var(--bg-tertiary);
      border-radius: 40px;
      font-weight: 500;
    }

    .toggle-row input {
      transform: scale(1.1);
      cursor: pointer;
      accent-color: var(--accent-blue);
    }

    /* ===== PROGRESS ===== */
    .progress {
      margin-bottom: var(--spacing-lg);
      font-size: var(--font-size-xs);
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
      background: var(--bg-tertiary);
      padding: var(--spacing-sm) var(--spacing-md);
      border-radius: 40px;
      font-weight: 600;
    }

    .progress-bar {
      flex: 1;
      height: 6px;
      background: var(--surface);
      border-radius: 999px;
      overflow: hidden;
    }

    .progress-bar-fill {
      height: 100%;
      width: 0%;
      background: var(--gradient-primary);
      transition: width 0.3s;
    }

    /* ===== TIMER ===== */
    .timer-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-md);
      padding: var(--spacing-sm) var(--spacing-lg);
      background: rgba(59,130,246,0.1);
      border-radius: 40px;
      border: 1px solid rgba(59,130,246,0.2);
      font-weight: 600;
    }

    .timer-label {
      font-size: var(--font-size-sm);
      color: var(--accent-blue);
    }

    .timer-display {
      font-size: var(--font-size-md);
      font-weight: 700;
      color: var(--accent-blue);
      font-family: 'Courier New', monospace;
      background: var(--surface);
      padding: var(--spacing-xs) var(--spacing-md);
      border-radius: 30px;
      letter-spacing: 1px;
    }

    .timer-warning { color: var(--accent-yellow); }
    .timer-critical { color: var(--accent-red); animation: pulse 1s infinite; }

    .timer-notification {
      margin-bottom: var(--spacing-md);
      padding: var(--spacing-sm) var(--spacing-lg);
      background: rgba(245,158,11,0.15);
      border-radius: 40px;
      border: 1px solid rgba(245,158,11,0.3);
      font-size: var(--font-size-sm);
      color: var(--accent-yellow);
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
      font-weight: 600;
    }

    /* ===== QUESTION BOX ===== */
    .question-box {
      background: var(--bg-tertiary);
      border-radius: var(--border-radius-lg);
      padding: var(--spacing-lg);
      border: 1px solid var(--border-light);
      margin: var(--spacing-lg) 0;
      position: relative;
      box-shadow: var(--shadow-sm);
    }

    .question-text {
      font-size: var(--font-size-md);
      font-weight: 600;
      color: var(--text-primary);
      line-height: 1.6;
      padding-right: 35px;
      margin-bottom: var(--spacing-md);
    }

    .question-whatsapp-icon {
      position: absolute;
      top: var(--spacing-md);
      right: var(--spacing-md);
      width: 28px;
      height: 28px;
      cursor: pointer;
      background: transparent;
      border: none;
      opacity: 0.8;
      transition: all 0.2s;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .question-whatsapp-icon:hover {
      opacity: 1;
      transform: scale(1.1);
    }

    .question-whatsapp-icon img {
      width: 28px;
      height: 28px;
      object-fit: contain;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
    }

    .question-image-container {
      margin: var(--spacing-lg) 0;
      display: none;
      text-align: center;
      border-radius: var(--border-radius-md);
      background: var(--surface);
      border: 1px solid var(--border-light);
      padding: var(--spacing-md);
    }

    .question-image-container.visible { display: block; }

    .question-image {
      max-width: 100%;
      max-height: 30vh;
      object-fit: contain;
      cursor: zoom-in;
      border-radius: var(--border-radius-sm);
      transition: transform 0.2s;
    }

    .question-image.zoomed {
      transform: scale(1.5);
      cursor: zoom-out;
      position: relative;
      z-index: 100;
    }

    .image-loading {
      padding: var(--spacing-2xl);
      text-align: center;
      color: var(--text-muted);
      background: var(--surface);
      border-radius: var(--border-radius-md);
      border: 2px dashed rgba(59,130,246,0.3);
      font-weight: 500;
    }

    .image-error {
      padding: var(--spacing-lg);
      text-align: center;
      color: var(--accent-red);
      background: rgba(239,68,68,0.1);
      border-radius: var(--border-radius-md);
      border: 1px solid rgba(239,68,68,0.3);
      font-weight: 600;
    }

    .option-image {
      max-width: 100%;
      max-height: 100px;
      border-radius: var(--border-radius-sm);
      margin-top: var(--spacing-xs);
      border: 1px solid var(--border-light);
    }

    .options {
      list-style: none;
      display: grid;
      gap: var(--spacing-sm);
      margin-top: var(--spacing-lg);
    }

    .option {
      display: flex;
      align-items: stretch;
      min-height: 50px;
      background: var(--surface);
      border-radius: var(--border-radius-md);
      border: 2px solid var(--border-light);
      cursor: pointer;
      transition: all 0.2s;
      font-size: var(--font-size-sm);
      color: var(--text-primary);
      overflow: hidden;
    }

    .option:hover {
      transform: translateY(-1px);
      border-color: var(--accent-blue);
    }

    .option-label {
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 45px;
      background: var(--bg-tertiary);
      border-right: 2px solid var(--border-light);
      font-weight: 800;
      color: var(--accent-blue);
      padding: var(--spacing-sm);
    }

    .option-content {
      flex: 1;
      padding: var(--spacing-sm) var(--spacing-md);
      display: flex;
      align-items: center;
      font-weight: 500;
    }

    .option.correct {
      background: rgba(34,197,94,0.2);
      border-color: var(--accent-green);
    }

    .option.correct .option-label {
      background: rgba(34,197,94,0.3);
      color: var(--accent-green);
      border-right-color: var(--accent-green);
    }

    .option.incorrect {
      background: rgba(239,68,68,0.2);
      border-color: var(--accent-red);
    }

    .option.incorrect .option-label {
      background: rgba(239,68,68,0.3);
      color: var(--accent-red);
      border-right-color: var(--accent-red);
    }

    .option.selected {
      border-color: var(--accent-blue);
    }

    .option.disabled {
      pointer-events: none;
      opacity: 0.9;
    }

    .feedback {
      font-size: var(--font-size-sm);
      margin-top: var(--spacing-lg);
      padding: var(--spacing-md);
      border-radius: var(--border-radius-md);
      font-weight: 600;
    }

    .feedback.correct {
      color: var(--accent-green);
      background: rgba(34,197,94,0.15);
      border: 1px solid rgba(34,197,94,0.3);
    }

    .feedback.incorrect {
      color: var(--accent-red);
      background: rgba(239,68,68,0.15);
      border: 1px solid rgba(239,68,68,0.3);
    }

    .explanation {
      margin-top: var(--spacing-md);
      padding: var(--spacing-md);
      background: rgba(59,130,246,0.1);
      border-radius: var(--border-radius-md);
      border: 1px solid rgba(59,130,246,0.2);
      font-size: var(--font-size-sm);
      color: var(--accent-blue);
      line-height: 1.6;
      font-weight: 500;
    }

    .explanation strong {
      color: var(--accent-blue);
      font-weight: 800;
    }

    /* ===== CONTROLS ===== */
    .controls {
      margin-top: var(--spacing-lg);
      display: flex;
      flex-direction: column;
      gap: var(--spacing-sm);
    }

    .left-controls {
      display: flex;
      gap: var(--spacing-sm);
      width: 100%;
    }

    .right-controls {
      width: 100%;
    }

    #previous-btn, #next-btn {
      flex: 1;
      border-radius: 40px;
      padding: var(--spacing-md) var(--spacing-sm);
      font-size: var(--font-size-sm);
      font-weight: 600;
      cursor: pointer;
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border: 1px solid var(--border-light);
      transition: all 0.2s;
    }

    #previous-btn:hover:enabled, #next-btn:hover:enabled {
      background: var(--surface-light);
      transform: translateY(-1px);
    }

    #previous-btn:disabled, #next-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    #finish-btn {
      width: 100%;
      border-radius: 40px;
      padding: var(--spacing-md) var(--spacing-sm);
      font-size: var(--font-size-md);
      font-weight: 700;
      cursor: pointer;
      background: var(--gradient-warning);
      color: white;
      border: none;
      box-shadow: var(--shadow-sm);
      transition: all 0.2s;
    }

    #finish-btn:hover:enabled {
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    #finish-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* ===== FINAL SCORE ===== */
    .final-score {
      margin-top: var(--spacing-lg);
      padding: var(--spacing-xl);
      border-radius: var(--border-radius-lg);
      background: var(--bg-tertiary);
      border: 1px solid var(--border-light);
    }

    .result-header {
      font-size: var(--font-size-lg);
      font-weight: 800;
      color: var(--accent-blue);
      margin-bottom: var(--spacing-lg);
      text-align: center;
      border-bottom: 1px solid var(--border-light);
      padding-bottom: var(--spacing-md);
    }

    .result-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--spacing-sm);
      margin-bottom: var(--spacing-lg);
    }

    .stat-item {
      padding: var(--spacing-md);
      border-radius: var(--border-radius-md);
      background: var(--surface);
      border: 1px solid var(--border-light);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: var(--spacing-xs);
      text-align: center;
    }

    .stat-label {
      font-size: var(--font-size-xs);
      color: var(--text-muted);
      font-weight: 600;
    }

    .stat-value {
      font-size: var(--font-size-lg);
      font-weight: 800;
      color: var(--text-primary);
    }

    .stat-percentage { color: var(--accent-green); }
    .stat-time { color: var(--accent-yellow); }

    .result-message {
      font-size: var(--font-size-sm);
      padding: var(--spacing-md);
      border-radius: var(--border-radius-md);
      background: rgba(59,130,246,0.1);
      border: 1px solid rgba(59,130,246,0.2);
      text-align: center;
      font-weight: 600;
    }

    .restart-btn, .review-btn, .review-incorrect-btn, .pdf-report-btn, .questions-answers-btn {
      width: 100%;
      border-radius: 40px;
      padding: var(--spacing-md);
      font-size: var(--font-size-sm);
      font-weight: 700;
      cursor: pointer;
      margin-top: var(--spacing-xs);
      border: none;
      color: white;
      transition: all 0.2s;
    }

    .restart-btn { background: var(--gradient-primary); }
    .review-btn { background: var(--gradient-purple); }
    .review-incorrect-btn { background: var(--gradient-error); }
    .pdf-report-btn { background: var(--gradient-error); }
    .questions-answers-btn { background: linear-gradient(135deg, #10b981, #059669); }

    .restart-btn:hover, .review-btn:hover, .review-incorrect-btn:hover, 
    .pdf-report-btn:hover, .questions-answers-btn:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    /* ===== PRELOAD / PDF OVERLAYS ===== */
    .preload-indicator, .pdf-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.95);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      display: none;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      z-index: 9999;
    }

    .preload-progress {
      width: 80%;
      max-width: 300px;
      background: var(--surface);
      height: 8px;
      border-radius: 4px;
      margin: var(--spacing-xl) 0;
      overflow: hidden;
    }

    .preload-progress-fill {
      height: 100%;
      width: 0%;
      background: var(--gradient-primary);
      transition: width 0.3s;
    }

    .preload-status {
      color: var(--text-primary);
      font-size: var(--font-size-md);
      text-align: center;
      font-weight: 600;
    }

    .preload-count {
      color: var(--accent-blue);
      font-weight: 800;
    }

    .pdf-spinner {
      border: 6px solid rgba(59,130,246,0.3);
      border-top: 6px solid var(--accent-blue);
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin-bottom: var(--spacing-xl);
    }

    .pdf-status {
      color: var(--text-primary);
      font-size: var(--font-size-lg);
      margin-bottom: var(--spacing-sm);
      font-weight: 700;
    }

    .pdf-substatus {
      color: var(--accent-blue);
      font-size: var(--font-size-sm);
      text-align: center;
      max-width: 400px;
      font-weight: 500;
    }

    /* ===== RESPONSIVE ===== */
    @media (min-width: 500px) {
      .main-content { max-width: 480px; }
      .class-grid { grid-template-columns: 1fr 1fr; }
      .subject-grid { grid-template-columns: 1fr; }
      .question-grid { grid-template-columns: repeat(6, 1fr); }
    }

    @media (min-width: 768px) {
      .main-content { max-width: 600px; }
      .class-grid { grid-template-columns: repeat(2, 1fr); }
      .subject-grid { grid-template-columns: repeat(2, 1fr); }
      .question-grid { grid-template-columns: repeat(8, 1fr); }
      .topic-row { flex-direction: row; }
      .start-btn { width: auto; }
      .controls { flex-direction: row; }
      .right-controls { width: auto; }
      #finish-btn { width: auto; min-width: 120px; }
    }

    @media (min-width: 1024px) {
      .main-content { max-width: 700px; }
      .question-grid { grid-template-columns: repeat(10, 1fr); }
    }

    /* ===== LIGHT MODE OPTIMIZATIONS ===== */
    body.light-mode .option {
      background: #ffffff;
      border-color: #e5e7eb;
    }

    body.light-mode .option-label {
      background: #f3f4f6;
      color: #2563eb;
      border-right-color: #e5e7eb;
    }

    body.light-mode .option.correct {
      background: #dcfce7;
      border-color: #22c55e;
    }

    body.light-mode .option.correct .option-label {
      background: #bbf7d0;
      color: #166534;
    }

    body.light-mode .option.incorrect {
      background: #fee2e2;
      border-color: #ef4444;
    }

    body.light-mode .option.incorrect .option-label {
      background: #fecaca;
      color: #991b1b;
    }

    body.light-mode .feedback.correct {
      background: #dcfce7;
      color: #166534;
    }

    body.light-mode .feedback.incorrect {
      background: #fee2e2;
      color: #991b1b;
    }

    body.light-mode .question-number-btn {
      background: #ffffff;
      color: #1f2937;
      border-color: #e5e7eb;
    }

    body.light-mode .question-number-btn.current {
      background: #dbeafe;
      color: #1d4ed8;
      border-color: #3b82f6;
    }

    body.light-mode .question-number-btn.answered {
      background: #dcfce7;
      color: #166534;
      border-color: #22c55e;
    }

    body.light-mode .question-number-btn.incorrect {
      background: #fee2e2;
      color: #991b1b;
      border-color: #ef4444;
    }

    body.light-mode .timer-display {
      background: #ffffff;
      color: #2563eb;
    }

    body.light-mode .stat-item {
      background: #ffffff;
    }

    body.light-mode .topic-select {
      background-color: #ffffff;
    }

    body.light-mode .form-input {
      background-color: #ffffff;
    }

    body.light-mode .contact-item span {
      color: #374151;
    }

    body.light-mode .contact-item:hover span {
      color: #2563eb;
    }

    /* ===== CACHE VERSION INDICATOR ===== */
    .cache-version {
      position: fixed;
      bottom: var(--spacing-sm);
      right: var(--spacing-sm);
      font-size: var(--font-size-xs);
      color: var(--text-muted);
      background: var(--surface);
      padding: var(--spacing-xs) var(--spacing-sm);
      border-radius: var(--border-radius-md);
      border: 1px solid var(--border-light);
      z-index: 100;
      opacity: 0.7;
      pointer-events: none;
    }
  </style>
  <!-- Cache busting meta tag -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
</head>
<body>
  <!-- Cache Version Indicator (hidden by default) -->
  <div class="cache-version" id="cacheVersion">v2.0.0</div>

  <!-- Image Preloading Overlay -->
  <div id="preload-overlay" class="preload-indicator">
    <div style="font-size: var(--font-size-xl); color: var(--accent-blue); margin-bottom: var(--spacing-xl); font-weight: 700;">Loading Images...</div>
    <div class="preload-progress">
      <div id="preload-progress-fill" class="preload-progress-fill"></div>
    </div>
    <div id="preload-status" class="preload-status">
      Loading: <span id="preload-count" class="preload-count">0/0</span>
    </div>
  </div>

  <!-- PDF Generating Overlay -->
  <div id="pdf-overlay" class="pdf-overlay">
    <div class="pdf-spinner"></div>
    <div id="pdf-status" class="pdf-status">Generating PDF...</div>
    <div id="pdf-substatus" class="pdf-substatus">Please wait</div>
  </div>

  <!-- Fixed Header -->
  <div class="fixed-header" style="display: none;">
    <div class="header-left">
      <img src="logo.png" alt="Logo" class="logo-header" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2248%22 height=%2248%22 viewBox=%220 0 48 48%22%3E%3Crect width=%2248%22 height=%2248%22 fill=%22%233b82f6%22 rx=%2212%22/%3E%3Ctext x=%2212%22 y=%2234%22 font-size=%2226%22 fill=%22white%22%3EGS%3C/text%3E%3C/svg%3E'">
      <div class="brand-container">
        <span class="brand-main">G.S. Tutorial</span>
        <span class="brand-sub">Interactive Learning App</span>
      </div>
    </div>
    <div class="header-right">
      <div class="user-info" id="header-user-info" style="display: none;">
        <span>ðŸ‘¤</span> <span id="header-username">Guest</span>
      </div>
      <div class="menu-toggle" id="menuToggle">
        <span></span><span></span><span></span>
      </div>
    </div>
  </div>

  <!-- Side Menu -->
  <div class="side-menu" id="sideMenu">
    <div class="side-profile">
      <img src="gobind.png" alt="Gobind Sharma" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22 viewBox=%220 0 100 100%22%3E%3Ccircle cx=%2250%22 cy=%2250%22 r=%2250%22 fill=%22%233b82f6%22/%3E%3Ctext x=%2230%22 y=%2270%22 font-size=%2240%22 fill=%22white%22%3EGS%3C/text%3E%3C/svg%3E'">
      <div class="side-username" id="sideUsername">Guest</div>
    </div>
    
    <div class="side-dev">
      <p>ðŸ‘¨â€ðŸ’» Developer</p>
      <div class="contact-item" onclick="window.open('https://wa.me/919706195457', '_blank')">
        <img src="whatsapp.png" alt="WhatsApp" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2224%22 height=%2224%22 viewBox=%220 0 24 24%22%3E%3Cpath fill=%22%2325d366%22 d=%22M19.077 4.928C17.191 3.041 14.683 2 12.006 2c-5.26 0-9.54 4.28-9.54 9.54 0 1.68.44 3.318 1.278 4.758L2.5 21.5l5.342-1.403c1.377.744 2.926 1.137 4.523 1.137h.004c5.258 0 9.535-4.28 9.535-9.54 0-2.548-.99-4.944-2.787-6.766zM12.006 20.05h-.003c-1.415 0-2.802-.38-4.007-1.1l-.287-.17-3.173.834.85-3.1-.185-.3c-.68-1.1-1.04-2.37-1.04-3.67 0-3.95 3.22-7.17 7.18-7.17 1.91 0 3.71.75 5.06 2.11 1.35 1.36 2.1 3.16 2.1 5.08 0 3.96-3.22 7.18-7.18 7.18z%22/%3E%3C/svg%3E'"><span>WhatsApp</span>
      </div>
      <div class="contact-item" onclick="window.location.href='tel:+919706195457'">
        <img src="phone.png" alt="Call" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2224%22 height=%2224%22 viewBox=%220 0 24 24%22%3E%3Cpath fill=%22%233b82f6%22 d=%22M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z%22/%3E%3C/svg%3E'"><span>+91 97061 95457</span>
      </div>
      <div class="contact-item" onclick="window.location.href='mailto:gobind.bngn@gmail.com'">
        <img src="email.png" alt="Email" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2224%22 height=%2224%22 viewBox=%220 0 24 24%22%3E%3Cpath fill=%22%23ea4335%22 d=%22M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z%22/%3E%3C/svg%3E'"><span>gobind.bngn@gmail.com</span>
      </div>
    </div>

    <div class="theme-toggle" id="themeToggle">
      <span>ðŸŒ™ Dark / Light</span>
      <span id="themeIcon">ðŸŒ™</span>
    </div>

    <div class="logout-side" id="sideLogoutBtn">ðŸ”“ Logout</div>
  </div>
  <div class="menu-overlay" id="menuOverlay"></div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Login -->
    <div id="login-container">
      <div class="login-box">
        <div class="login-header">
          <img src="logo.png" alt="Logo" class="logo-login" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2290%22 height=%2290%22 viewBox=%220 0 90 90%22%3E%3Crect width=%2290%22 height=%2290%22 fill=%22%233b82f6%22 rx=%2220%22/%3E%3Ctext x=%2225%22 y=%2260%22 font-size=%2240%22 fill=%22white%22%3EGS%3C/text%3E%3C/svg%3E'">
          <div class="login-title">G.S. Tutorial</div>
          <div class="login-subtitle">Interactive Learning Â· Created by Gobind Sharma</div>
        </div>
        <form id="login-form" class="login-form">
          <div class="form-group">
            <label>Username</label>
            <input type="text" id="username" class="form-input" placeholder="Enter username" required>
          </div>
          <div class="form-group">
            <label>Password</label>
            <div class="password-input-wrapper">
              <input type="password" id="password" class="form-input" placeholder="Enter password" required>
              <button type="button" class="password-toggle" id="password-toggle">ðŸ‘ï¸</button>
            </div>
          </div>
          <div id="login-error" class="login-error"></div>
          <button type="submit" class="login-btn" id="login-btn">Login</button>
          <a href="https://wa.me/919706195457?text=Hello%20Admin,%20I%20need%20login%20credentials" class="request-credentials-btn" target="_blank">ðŸ“± Request Credentials</a>
        </form>
        <div class="config-info">Â© 2025 G.S. Tutorial</div>
      </div>
    </div>

    <!-- Error Screens -->
    <div class="account-config-error" id="account-config-error" style="display:none;">
      <div class="error-header">
        <div class="error-title">Configuration Required</div>
        <div class="error-subtitle">G.S. Tutorial</div>
      </div>
      <div class="error-user-info">
        Hello <strong id="error-username">User</strong>!<br>
        Your account needs configuration.
      </div>
      <div class="error-details">
        <ul id="error-list">
          <li>Account configuration issue</li>
        </ul>
      </div>
      <a href="https://wa.me/919706195457" class="whatsapp-btn" target="_blank">ðŸ“± Contact Admin</a>
      <button class="back-to-login-btn" id="back-to-login-btn">â† Back to Login</button>
    </div>

    <div class="subscription-expired" id="subscription-expired" style="display:none;">
      <div class="expired-header">
        <div class="expired-title">Subscription Expired</div>
        <div class="expired-subtitle">G.S. Tutorial</div>
      </div>
      <div class="expired-user-info">
        Hello <strong id="expired-username">User</strong>!<br>
        Your access has expired.
      </div>
      <div class="expired-details">
        <p><strong>Expiry:</strong> <span id="expired-last-date">N/A</span></p>
      </div>
      <a href="https://wa.me/919706195457" class="whatsapp-btn" target="_blank">ðŸ“± Contact Admin</a>
      <button class="back-to-login-btn" id="back-to-login-from-expired-btn">â† Back to Login</button>
    </div>

    <!-- Class Selection -->
    <div class="class-selection" id="class-selection" style="display:none;">
      <div class="greeting-message" id="greetingMessage"></div>
      <div class="class-title">SELECT YOUR CLASS</div>
      <div class="class-grid" id="class-grid"></div>
    </div>

    <!-- Subject Selection -->
    <div class="subject-selection" id="subject-selection" style="display:none;">
      <div class="screen-header">
        <div class="screen-title">Select Subject</div>
        <div class="screen-subtitle" id="current-class-display"></div>
      </div>
      <div class="subject-grid" id="subject-grid"></div>
      <button class="back-btn" id="back-to-classes-btn">â† Back to Classes</button>
    </div>

    <!-- Quiz Container -->
    <div class="quiz-container" id="quiz-container" style="display:none;">
      <div id="current-path" class="current-path" style="display:none;"></div>
      
      <div class="topic-section">
        <div class="topic-info">
          <div class="topic-name" id="quiz-topic-name">No chapter selected</div>
          <div class="question-count" id="quiz-question-count">0 questions</div>
        </div>
        <div class="topic-row">
          <select id="topic-select" class="topic-select"><option>Loading...</option></select>
          <button class="start-btn" id="start-btn" disabled>Start</button>
        </div>
      </div>

      <div id="question-navigation" class="question-navigation collapsed">
        <div class="navigation-header">
          <span class="navigation-title">ðŸ“‹ Navigation</span>
          <button id="navigation-toggle-btn" class="navigation-toggle-btn collapsed"><i>â–¶</i> Show</button>
        </div>
        <div id="question-grid" class="question-grid"></div>
        <div id="navigation-stats" class="navigation-stats"></div>
      </div>

      <div id="timer-container" class="timer-container" style="display:none;">
        <span class="timer-label">â±ï¸ Time:</span>
        <span id="timer-display" class="timer-display">--:--:--</span>
      </div>

      <div class="toggle-row">
        <input type="checkbox" id="random-toggle" checked />
        <label for="random-toggle">Randomize</label>
      </div>

      <div class="progress">
        <span id="question-counter">0/0</span>
        <div class="progress-bar"><div id="progress-bar-fill" class="progress-bar-fill"></div></div>
        <span id="score-mini">0</span>
      </div>

      <div class="question-box" id="question-box">
        <button id="question-whatsapp-icon" class="question-whatsapp-icon" style="display:none;"><img src="whatsapp.png" alt="WhatsApp"></button>
        <div id="question-text" class="question-text">Select chapter</div>
        <div id="question-image-container" class="question-image-container"></div>
        <ul id="options-list" class="options"></ul>
        <div id="feedback" class="feedback"></div>
      </div>

      <div class="controls">
        <div class="left-controls">
          <button id="previous-btn" disabled>â† Prev</button>
          <button id="next-btn" disabled>Next â†’</button>
        </div>
        <div class="right-controls">
          <button id="finish-btn" disabled>Submit</button>
        </div>
      </div>

      <div class="score-box"><div id="final-score" class="final-score" style="display:none;"></div></div>
    </div>
  </div>

  <script>
    // ========== APP VERSION FOR CACHE BUSTING ==========
    const APP_VERSION = '2.0.0';
    document.getElementById('cacheVersion').textContent = `v${APP_VERSION}`;

    // ========== FORCE CACHE RELOAD ON NEW VERSION ==========
    (function() {
      const storedVersion = localStorage.getItem('app_version');
      if (storedVersion !== APP_VERSION) {
        console.log('New version detected, clearing cache...');
        if ('caches' in window) {
          caches.keys().then(function(names) {
            for (let name of names) {
              caches.delete(name);
            }
          });
        }
        localStorage.setItem('app_version', APP_VERSION);
        // Reload to get fresh files
        window.location.reload(true);
      }
    })();

    // ========== APPS SCRIPT CONFIGURATION ==========
    const AUTH_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx06h9aa6wDmtDz3jBwNgOuoiz7-NZY1nJaEwts3A7vIHRkWfAU5O3N4UNUooCwvEm7Lw/exec';
    const MASTER_CONFIG_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw2CCk6wZgSWwLVyi4-6izf0DNIvcG-E64_jfsT0TgclHZ_PIevnAEdLq6B2Ccc6ABK/exec';

    // ========== CACHE CONFIGURATION ==========
    let ALL_CONFIG_CACHE = null;
    let ALL_CONFIG_CACHE_TIME = null;
    const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes (reduced for faster updates)

    // ========== GLOBAL VARIABLES ==========
    let questions = [];
    let currentIndex = 0;
    let score = 0;
    let hasAnswered = false;
    let questionsLoaded = false;
    let attempted = 0;
    let userAnswers = [];
    let timeRemaining = 0;
    let timerInterval = null;
    let currentTopicName = "";
    let timerDuration = 0;
    let quizStartTime = null;
    let timerNotification = null;
    let isReviewMode = false;
    let isIncorrectReviewMode = false;
    let incorrectQuestionIndices = [];
    
    // Image preloading system
    let imageCache = new Map();
    let totalImagesToPreload = 0;
    let imagesPreloaded = 0;
    
    // Login system variables
    let currentUser = null;
    let inactivityTimer = null;
    const INACTIVITY_TIMEOUT = 10 * 60 * 1000; // 10 minutes
    
    // Login attempt tracking
    let failedAttempts = 0;
    const MAX_ATTEMPTS = 3;
    const COOLDOWN_TIME = 30;
    let isOnCooldown = false;
    let cooldownTimer = null;
    
    // Navigation variables
    let currentClass = "";
    let currentSubject = "";
    let chaptersList = [];
    let currentSubjectConfig = null;
    
    // Logging
    let userIP = 'Unknown';
    let currentQuizStats = null;
    
    // Notification tracking
    let hasSentLoginNotification = false;
    let hasSentQuizResultNotification = false;
    let currentQuizSessionId = null;

    // Telegram config
    let TELEGRAM_CONFIG = { ENABLED: false, BOT_TOKEN: '', CHAT_ID: '' };
    let ADMIN_CONFIG = { NOTIFY_ON_LOGIN: false, NOTIFY_ON_QUIZ_RESULT: false };

    // ========== DOM ELEMENTS ==========
    const fixedHeaderEl = document.querySelector(".fixed-header");
    const headerUserInfoEl = document.getElementById("header-user-info");
    const headerUsernameEl = document.getElementById("header-username");
    
    const loginContainerEl = document.getElementById("login-container");
    const classSelectionEl = document.getElementById("class-selection");
    const subjectSelectionEl = document.getElementById("subject-selection");
    const quizContainerEl = document.getElementById("quiz-container");
    const accountConfigErrorEl = document.getElementById("account-config-error");
    const subscriptionExpiredEl = document.getElementById("subscription-expired");
    
    const loginFormEl = document.getElementById("login-form");
    const usernameEl = document.getElementById("username");
    const passwordEl = document.getElementById("password");
    const passwordToggleEl = document.getElementById("password-toggle");
    const loginErrorEl = document.getElementById("login-error");
    const loginBtnEl = document.getElementById("login-btn");
    const attemptCounterEl = document.getElementById("attempt-counter");
    const attemptsRemainingEl = document.getElementById("attempts-remaining");
    const cooldownMessageEl = document.getElementById("cooldown-message");
    const cooldownTimerEl = document.getElementById("cooldown-timer");
    
    const accountConfigErrorUsernameEl = document.getElementById("error-username");
    const accountConfigErrorRoleEl = document.getElementById("error-role");
    const accountConfigErrorListEl = document.getElementById("error-list");
    const whatsappBtnEl = document.getElementById("whatsapp-btn");
    const backToLoginBtnEl = document.getElementById("back-to-login-btn");
    
    const expiredUsernameEl = document.getElementById("expired-username");
    const expiredJoiningDateEl = document.getElementById("expired-joining-date");
    const expiredLastDateEl = document.getElementById("expired-last-date");
    const expiredWhatsappBtnEl = document.getElementById("expired-whatsapp-btn");
    const backToLoginFromExpiredBtn = document.getElementById("back-to-login-from-expired-btn");
    
    const classGridEl = document.getElementById("class-grid");
    const subjectGridEl = document.getElementById("subject-grid");
    const currentClassDisplayEl = document.getElementById("current-class-display");
    const backToClassesBtn = document.getElementById("back-to-classes-btn");
    const currentPathEl = document.getElementById("current-path");
    
    const topicSelectEl = document.getElementById("topic-select");
    const startBtnEl = document.getElementById("start-btn");
    const randomToggleEl = document.getElementById("random-toggle");
    const toggleRowEl = document.querySelector(".toggle-row");
    const quizTopicNameEl = document.getElementById("quiz-topic-name");
    const quizQuestionCountEl = document.getElementById("quiz-question-count");
    const timerContainerEl = document.getElementById("timer-container");
    const timerDisplayEl = document.getElementById("timer-display");
    
    const questionNavigationEl = document.getElementById("question-navigation");
    const questionGridEl = document.getElementById("question-grid");
    const navigationToggleBtn = document.getElementById("navigation-toggle-btn");
    const navigationStatsEl = document.getElementById("navigation-stats");
    
    const questionTextEl = document.getElementById("question-text");
    const questionBoxEl = document.getElementById("question-box");
    const questionImageContainerEl = document.getElementById("question-image-container");
    const questionImageEl = document.getElementById("question-image");
    const imageLoadingEl = document.getElementById("image-loading");
    const imageErrorEl = document.getElementById("image-error");
    
    const optionsListEl = document.getElementById("options-list");
    const feedbackEl = document.getElementById("feedback");
    const nextBtn = document.getElementById("next-btn");
    const previousBtn = document.getElementById("previous-btn");
    const finishBtn = document.getElementById("finish-btn");
    const questionCounterEl = document.getElementById("question-counter");
    const progressEl = document.querySelector(".progress");
    const progressBarFillEl = document.getElementById("progress-bar-fill");
    const scoreMiniEl = document.getElementById("score-mini");
    const finalScoreEl = document.getElementById("final-score");
    const controlsEl = document.querySelector(".controls");
    
    const preloadOverlayEl = document.getElementById("preload-overlay");
    const preloadProgressFillEl = document.getElementById("preload-progress-fill");
    const preloadStatusEl = document.getElementById("preload-status");
    const preloadCountEl = document.getElementById("preload-count");
    
    const pdfOverlayEl = document.getElementById("pdf-overlay");
    const pdfStatusEl = document.getElementById("pdf-status");
    const pdfSubstatusEl = document.getElementById("pdf-substatus");

    const questionWhatsappIconEl = document.getElementById("question-whatsapp-icon");

    // Side menu elements
    const menuToggle = document.getElementById('menuToggle');
    const sideMenu = document.getElementById('sideMenu');
    const menuOverlay = document.getElementById('menuOverlay');
    const sideUsername = document.getElementById('sideUsername');
    const sideLogoutBtn = document.getElementById('sideLogoutBtn');
    const themeToggle = document.getElementById('themeToggle');
    const themeIcon = document.getElementById('themeIcon');
    const metaThemeColor = document.getElementById('meta-theme-color');
    const greetingMessageEl = document.getElementById('greetingMessage');

    // ========== PASSWORD TOGGLE ==========
    passwordToggleEl.addEventListener("click", () => {
      passwordEl.type = passwordEl.type === 'password' ? 'text' : 'password';
      passwordToggleEl.textContent = passwordEl.type === 'password' ? 'ðŸ‘ï¸' : 'ðŸ™ˆ';
    });

    // ========== HELPER FUNCTIONS ==========
    function formatDisplayDate(val) {
      if (!val) return "Not available";
      try {
        let d = new Date(val);
        if (isNaN(d.getTime())) return "Not available";
        return d.toLocaleDateString("en-GB", { day: "numeric", month: "short", year: "numeric" });
      } catch { return "Not available"; }
    }

    function getSubjectIcon(subject) {
      const s = subject.toLowerCase();
      if (s.includes('math')) return 'ðŸ“';
      if (s.includes('science')) return 'ðŸ”¬';
      if (s.includes('physics')) return 'âš¡';
      if (s.includes('chem')) return 'ðŸ§ª';
      if (s.includes('bio')) return 'ðŸ§¬';
      if (s.includes('mech')) return 'âš™ï¸';
      if (s.includes('elect')) return 'âš¡';
      if (s.includes('english')) return 'ðŸ“–';
      if (s.includes('social')) return 'ðŸŒ';
      return 'ðŸ“š';
    }

    // ========== JSONP REQUEST ==========
    function jsonpRequest(url, callbackName) {
      return new Promise((resolve, reject) => {
        const uniqueCallback = callbackName + '_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        const script = document.createElement('script');
        
        window[uniqueCallback] = function(data) {
          delete window[uniqueCallback];
          document.body.removeChild(script);
          data && data.success ? resolve(data) : reject(data?.error || 'Unknown error');
        };
        
        script.onerror = () => {
          delete window[uniqueCallback];
          document.body.removeChild(script);
          reject('Network error');
        };
        
        const separator = url.includes('?') ? '&' : '?';
        script.src = `${url}${separator}callback=${uniqueCallback}`;
        document.body.appendChild(script);
        
        setTimeout(() => {
          if (window[uniqueCallback]) {
            delete window[uniqueCallback];
            document.body.removeChild(script);
            reject('Request timeout');
          }
        }, 10000);
      });
    }

    // ========== LOAD CONFIG ==========
    async function loadAllConfigAtOnce() {
      // Check cache but with timestamp to ensure freshness
      if (ALL_CONFIG_CACHE && ALL_CONFIG_CACHE_TIME && Date.now() - ALL_CONFIG_CACHE_TIME < CACHE_DURATION) {
        return ALL_CONFIG_CACHE;
      }
      try {
        // Add timestamp to bypass cache
        const data = await jsonpRequest(`${MASTER_CONFIG_APPS_SCRIPT_URL}?action=getAllConfig&_t=${Date.now()}`, 'allConfigCallback');
        if (data.success) {
          ALL_CONFIG_CACHE = data;
          ALL_CONFIG_CACHE_TIME = Date.now();
          return data;
        }
        throw new Error(data.error || 'Failed to load config');
      } catch (error) {
        console.error("Config error:", error);
        return null;
      }
    }

    // ========== AUTHENTICATION ==========
    async function authenticateWithAppsScript(username, password) {
      try {
        return new Promise((resolve) => {
          const callbackName = 'auth_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
          const script = document.createElement('script');
          
          window[callbackName] = function(data) {
            delete window[callbackName];
            document.body.removeChild(script);
            resolve(data || { success: false, error: 'Invalid response' });
          };
          
          script.onerror = () => {
            delete window[callbackName];
            document.body.removeChild(script);
            resolve({ success: false, error: 'Network error' });
          };
          
          // Add timestamp to bypass cache
          const url = `${AUTH_APPS_SCRIPT_URL}?action=authenticate&username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}&_t=${Date.now()}&callback=${callbackName}`;
          script.src = url;
          document.body.appendChild(script);
          
          setTimeout(() => {
            if (window[callbackName]) {
              delete window[callbackName];
              document.body.removeChild(script);
              resolve({ success: false, error: 'Timeout' });
            }
          }, 10000);
        });
      } catch (error) {
        return { success: false, error: 'Connection failed' };
      }
    }

    // ========== LOAD TELEGRAM CONFIG ==========
    async function loadTelegramConfig() {
      try {
        const data = await jsonpRequest(`${MASTER_CONFIG_APPS_SCRIPT_URL}?action=getTelegramConfig&_t=${Date.now()}`, 'telegramCallback');
        if (data.success) {
          TELEGRAM_CONFIG = { ENABLED: data.enabled, BOT_TOKEN: data.botToken, CHAT_ID: data.chatId };
        }
      } catch (error) {
        console.error("Telegram config error:", error);
      }
    }

    // ========== GET USER IP ==========
    async function getUserIP() {
      try {
        const response = await fetch('https://api.ipify.org?format=json&_t=' + Date.now());
        const data = await response.json();
        userIP = data.ip;
      } catch (error) {}
    }

    // ========== SESSION MANAGEMENT ==========
    function saveSession() {
      if (currentUser) {
        localStorage.setItem('gs_session', JSON.stringify({
          user: currentUser,
          timestamp: Date.now(),
          lastActivity: Date.now()
        }));
      }
    }

    function loadSession() {
      const data = localStorage.getItem('gs_session');
      if (data) {
        try {
          const session = JSON.parse(data);
          if (Date.now() - session.lastActivity < INACTIVITY_TIMEOUT && Date.now() - session.timestamp < 86400000) {
            currentUser = session.user;
            session.lastActivity = Date.now();
            localStorage.setItem('gs_session', JSON.stringify(session));
            return true;
          }
        } catch (e) {}
      }
      clearSession();
      return false;
    }

    function clearSession() { localStorage.removeItem('gs_session'); }
    
    function updateLastActivity() {
      const data = localStorage.getItem('gs_session');
      if (data && currentUser) {
        try {
          const session = JSON.parse(data);
          session.lastActivity = Date.now();
          localStorage.setItem('gs_session', JSON.stringify(session));
        } catch (e) {}
      }
    }

    // ========== LOGIN ATTEMPT TRACKING ==========
    function resetFailedAttempts() {
      failedAttempts = 0;
      isOnCooldown = false;
      if (attemptCounterEl) attemptCounterEl.style.display = 'none';
      if (cooldownMessageEl) cooldownMessageEl.style.display = 'none';
      if (cooldownTimer) { clearInterval(cooldownTimer); cooldownTimer = null; }
    }

    function updateAttemptCounter() {
      const remaining = MAX_ATTEMPTS - failedAttempts;
      if (attemptsRemainingEl) attemptsRemainingEl.textContent = remaining;
      if (failedAttempts > 0 && attemptCounterEl) {
        attemptCounterEl.style.display = 'flex';
        attemptCounterEl.className = remaining <= 1 ? 'attempt-counter critical' : 
                                    remaining <= 2 ? 'attempt-counter warning' : 'attempt-counter';
      } else if (attemptCounterEl) {
        attemptCounterEl.style.display = 'none';
      }
    }

    function startCooldown() {
      isOnCooldown = true;
      loginBtnEl.disabled = true;
      cooldownMessageEl.style.display = 'block';
      attemptCounterEl.style.display = 'none';
      let seconds = COOLDOWN_TIME;
      cooldownTimerEl.textContent = seconds;
      cooldownTimer = setInterval(() => {
        seconds--;
        cooldownTimerEl.textContent = seconds;
        if (seconds <= 0) {
          clearInterval(cooldownTimer);
          isOnCooldown = false;
          loginBtnEl.disabled = false;
          cooldownMessageEl.style.display = 'none';
          resetFailedAttempts();
          usernameEl.focus();
        }
      }, 1000);
    }

    function recordFailedAttempt() {
      failedAttempts++;
      updateAttemptCounter();
      if (failedAttempts >= MAX_ATTEMPTS) startCooldown();
    }

    // ========== USER VALIDATION ==========
    function validateUserAccount(user) {
      const validRoles = ['Admin', 'Teacher', 'User', 'Student'];
      if (!validRoles.includes(user.role)) return { valid: false, error: 'invalid_role' };
      
      const assignedClasses = (user.class || '').split(',').map(c => c.trim()).filter(c => c && !['none','null'].includes(c.toLowerCase()));
      
      if (user.role === 'Admin') return { valid: true, assignedClasses: [] };
      if (['Teacher','User'].includes(user.role)) {
        if (assignedClasses.length === 0) return { valid: false, error: 'no_class_assigned' };
        return { valid: true, assignedClasses };
      }
      if (user.role === 'Student') {
        if (assignedClasses.length === 0) return { valid: false, error: 'no_class_assigned' };
        return { valid: true, assignedClasses: [assignedClasses[0]] };
      }
      return { valid: false, error: 'unknown' };
    }

    // ========== SUBSCRIPTION EXPIRED ==========
    function showSubscriptionExpired(user, joiningDate, lastDate) {
      if (expiredUsernameEl) expiredUsernameEl.textContent = user.name;
      if (expiredJoiningDateEl) expiredJoiningDateEl.textContent = formatDisplayDate(joiningDate);
      if (expiredLastDateEl) expiredLastDateEl.textContent = formatDisplayDate(lastDate);
      const msg = `Hello Admin, my G.S. Tutorial subscription has expired. Username: ${user.username}`;
      if (expiredWhatsappBtnEl) expiredWhatsappBtnEl.href = `https://wa.me/919706195457?text=${encodeURIComponent(msg)}`;
      fixedHeaderEl.style.display = "none";
      loginContainerEl.style.display = "none";
      classSelectionEl.style.display = "none";
      subjectSelectionEl.style.display = "none";
      quizContainerEl.style.display = "none";
      accountConfigErrorEl.style.display = "none";
      subscriptionExpiredEl.style.display = "block";
      resetInactivityTimer();
    }

    // ========== ACCOUNT CONFIG ERROR ==========
    function showAccountConfigError(user, errorType) {
      if (accountConfigErrorUsernameEl) accountConfigErrorUsernameEl.textContent = user.name;
      if (accountConfigErrorRoleEl) accountConfigErrorRoleEl.textContent = user.role;
      const msg = `Hello Admin, I need help with my account configuration. Username: ${user.username}`;
      if (whatsappBtnEl) whatsappBtnEl.href = `https://wa.me/919706195457?text=${encodeURIComponent(msg)}`;
      
      let errorHTML = '';
      if (errorType === 'invalid_role') {
        errorHTML = `<li><strong>Invalid Role:</strong> "${user.role}" is not recognized. Valid: Admin, Teacher, User, Student.</li>`;
      } else if (errorType === 'no_class_assigned') {
        errorHTML = `<li><strong>No Class Assigned:</strong> As a ${user.role}, you need a class assignment.</li>`;
      } else {
        errorHTML = `<li>Account configuration issue. Please contact admin.</li>`;
      }
      if (accountConfigErrorListEl) accountConfigErrorListEl.innerHTML = errorHTML;
      
      fixedHeaderEl.style.display = "none";
      loginContainerEl.style.display = "none";
      classSelectionEl.style.display = "none";
      subjectSelectionEl.style.display = "none";
      quizContainerEl.style.display = "none";
      subscriptionExpiredEl.style.display = "none";
      accountConfigErrorEl.style.display = "block";
      resetInactivityTimer();
    }

    // ========== WHATSAPP SUPPORT ==========
    function setupQuestionWhatsAppSupport() {
      questionWhatsappIconEl?.addEventListener("click", function() {
        if (!currentUser || !questionsLoaded || !questions[currentIndex]) return;
        
        const q = questions[currentIndex];
        let optionsText = q.options.map((opt, i) => 
          `${String.fromCharCode(65+i)}. ${opt}${i === q.correctIndex ? ' âœ…' : ''}`
        ).join('\n');
        
        const message = `Hello Admin,\n\nQuestion concern:\n\nðŸ‘¤ ${currentUser.name} (${currentUser.username})\nðŸ« ${currentClass}\nðŸ“š ${currentSubject}\nðŸ“– ${currentTopicName}\n\nâ“ ${q.question}\n\nðŸ“ Options:\n${optionsText}\n\nðŸ“‹ Concern: `;
        window.open(`https://wa.me/919706195457?text=${encodeURIComponent(message)}`, '_blank');
        resetInactivityTimer();
      });
    }

    // ========== PDF FUNCTIONS ==========
    function showPDFOverlay(msg = "Generating PDF...") { 
      if (pdfStatusEl) pdfStatusEl.textContent = msg; 
      if (pdfOverlayEl) pdfOverlayEl.style.display = 'flex'; 
    }
    
    function hidePDFOverlay() { 
      if (pdfOverlayEl) pdfOverlayEl.style.display = 'none'; 
    }
    
    function getPerformanceRemark(p) { 
      return p >= 80 ? "Excellent!" : p >= 60 ? "Good job!" : p >= 40 ? "Satisfactory" : "Needs improvement"; 
    }

    // ========== TELEGRAM NOTIFICATIONS ==========
    async function sendLoginNotification(user) {
      if (hasSentLoginNotification || !TELEGRAM_CONFIG.ENABLED) return;
      const now = new Date();
      const msg = `ðŸ”´ Login: ${user.name} (${user.username})\nRole: ${user.role}\nTime: ${now.toLocaleString('en-IN')}\nIP: ${userIP}`;
      const sent = await sendTelegramMessage(msg);
      if (sent) hasSentLoginNotification = true;
    }

    async function sendQuizResultNotification(stats) {
      if (hasSentQuizResultNotification || !TELEGRAM_CONFIG.ENABLED) return;
      const msg = `ðŸŸ  Result: ${currentUser?.name}\nClass: ${currentClass}\nSubject: ${currentSubject}\nChapter: ${currentTopicName}\nScore: ${stats.correct}/${stats.total} (${stats.percentage}%)\nTime: ${stats.timeTaken || 'N/A'}`;
      const sent = await sendTelegramMessage(msg);
      if (sent) hasSentQuizResultNotification = true;
    }

    async function sendTelegramMessage(message) {
      if (!TELEGRAM_CONFIG.ENABLED || !TELEGRAM_CONFIG.BOT_TOKEN || !TELEGRAM_CONFIG.CHAT_ID) return false;
      try {
        const res = await fetch(`https://api.telegram.org/bot${TELEGRAM_CONFIG.BOT_TOKEN}/sendMessage`, {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ chat_id: TELEGRAM_CONFIG.CHAT_ID, text: message })
        });
        return res.ok;
      } catch { return false; }
    }

    // ========== IMAGE HANDLING ==========
    function convertImageUrl(url) {
      if (!url || url.startsWith('http')) return url;
      let path = url.trim();
      if (!path.startsWith('images/')) {
        if (/^[a-zA-Z0-9]+\.[a-z]{3,4}$/i.test(path)) path = `images/class${currentClass}/${path}`;
        else if (path.includes('/')) path = `images/${path}`;
      }
      return path;
    }

    function loadImageWithCache(url) {
      return new Promise((resolve, reject) => {
        if (imageCache.has(url)) { resolve(imageCache.get(url)); return; }
        const img = new Image();
        img.onload = () => { imageCache.set(url, img); resolve(img); };
        img.onerror = () => reject();
        img.src = url + '?t=' + Date.now(); // Cache bust
      });
    }

    async function preloadChapterImages(questions) {
      if (!questions?.length) return;
      const urls = new Set();
      questions.forEach(q => {
        if (q.imageUrl?.trim()) urls.add(convertImageUrl(q.imageUrl));
        q.optionImages?.forEach(img => { if (img?.trim()) urls.add(convertImageUrl(img)); });
      });
      
      totalImagesToPreload = urls.size;
      if (totalImagesToPreload === 0) return;
      
      imagesPreloaded = 0;
      preloadOverlayEl.style.display = 'flex';
      
      for (const url of urls) {
        loadImageWithCache(url).finally(() => {
          imagesPreloaded++;
          const percent = (imagesPreloaded / totalImagesToPreload) * 100;
          preloadProgressFillEl.style.width = `${percent}%`;
          preloadCountEl.textContent = `${imagesPreloaded}/${totalImagesToPreload}`;
          if (imagesPreloaded >= totalImagesToPreload) setTimeout(() => preloadOverlayEl.style.display = 'none', 500);
        });
      }
    }

    function toggleImageZoom(img) {
      img.classList.toggle(window.innerWidth > 768 ? 'zoomed' : 'touch-zoom');
    }

    // ========== LOAD CLASSES ==========
    async function loadClasses() {
      classGridEl.innerHTML = '<div class="loading-container"><div class="loading-spinner"></div><div class="loading-text">Loading classes...</div></div>';
      try {
        const data = await loadAllConfigAtOnce();
        if (!data?.classes) throw new Error("No classes");
        
        let classes = data.classes;
        if (currentUser?.role !== 'Admin') {
          const assigned = currentUser?.validatedAssignedClasses || [];
          classes = classes.filter(c => assigned.some(a => a.toString() === c.id.toString()));
        }
        
        renderClassGrid(classes);
      } catch (error) {
        classGridEl.innerHTML = '<div style="text-align:center; padding:40px; color:var(--accent-red);">Error loading classes</div>';
      }
    }

    function renderClassGrid(classes) {
      classGridEl.innerHTML = '';
      if (!classes.length) {
        classGridEl.innerHTML = '<div style="text-align:center; padding:40px; color:var(--text-muted);">No classes available</div>';
        return;
      }
      
      classes.forEach(cls => {
        const card = document.createElement('div');
        card.className = 'class-card';
        card.innerHTML = `<div class="class-icon">${cls.icon || 'ðŸ“š'}</div><div class="class-name">${cls.name}</div>`;
        card.onclick = () => { showSubjectSelection(cls.id); resetInactivityTimer(); };
        classGridEl.appendChild(card);
      });
    }

    // ========== LOAD SUBJECTS ==========
    async function loadSubjects() {
      subjectGridEl.innerHTML = '<div class="loading-container"><div class="loading-spinner"></div><div class="loading-text">Loading subjects...</div></div>';
      try {
        const data = await loadAllConfigAtOnce();
        const subjects = [];
        if (data?.config) {
          const set = new Set();
          for (const key in data.config) {
            if (key.startsWith(currentClass + '_')) set.add(key.split('_')[1]);
          }
          set.forEach(s => subjects.push({
            id: s, name: s.charAt(0).toUpperCase() + s.slice(1),
            icon: getSubjectIcon(s)
          }));
        }
        renderSubjectGrid(subjects);
      } catch (error) {
        subjectGridEl.innerHTML = '<div style="text-align:center; color:var(--accent-red);">Error</div>';
      }
    }

    function renderSubjectGrid(subjects) {
      subjectGridEl.innerHTML = '';
      if (!subjects.length) {
        subjectGridEl.innerHTML = '<div style="text-align:center; color:var(--text-muted);">No subjects</div>';
        return;
      }
      
      subjects.forEach(sub => {
        const card = document.createElement('div');
        card.className = 'subject-card';
        card.innerHTML = `<div class="subject-icon">${sub.icon}</div><div class="subject-name">${sub.name}</div>`;
        card.onclick = () => { currentSubject = sub.name; showQuizContainer(); resetInactivityTimer(); };
        subjectGridEl.appendChild(card);
      });
    }

    // ========== LOAD CHAPTERS ==========
    async function loadChapters() {
      topicSelectEl.innerHTML = '<option>Loading chapters...</option>';
      startBtnEl.disabled = true;
      
      try {
        const data = await loadAllConfigAtOnce();
        const key = `${currentClass}_${currentSubject.toLowerCase()}`;
        
        if (!data?.config?.[key]) throw new Error('No config');
        
        currentSubjectConfig = {
          sheetId: data.config[key].sheetId,
          chapters: data.config[key].chapters
        };
        
        chaptersList = Object.keys(currentSubjectConfig.chapters || {});
        if (!chaptersList.length) throw new Error('No chapters');
        
        topicSelectEl.innerHTML = '<option value="">-- Select Chapter --</option>';
        chaptersList.forEach(ch => {
          topicSelectEl.innerHTML += `<option value="${ch}">${ch}</option>`;
        });
        startBtnEl.disabled = false;
        quizTopicNameEl.textContent = "No chapter selected";
        quizQuestionCountEl.textContent = `${chaptersList.length} chapters`;
        questionTextEl.textContent = "Select a chapter to start.";
      } catch (err) {
        topicSelectEl.innerHTML = '<option>Error loading chapters</option>';
        quizTopicNameEl.textContent = "Error";
        quizTopicNameEl.style.background = 'rgba(239,68,68,0.1)';
        quizTopicNameEl.style.color = '#fca5a5';
      }
      resetInactivityTimer();
    }

    // ========== LOAD QUESTIONS ==========
    async function loadQuestionsFromGoogleSheet(chapter) {
      if (!chapter) { alert("Select a chapter"); return; }
      
      currentTopicName = chapter;
      const gid = currentSubjectConfig?.chapters?.[chapter];
      const sheetId = currentSubjectConfig?.sheetId;
      if (!gid || !sheetId) { alert("Invalid config"); return; }
      
      quizTopicNameEl.textContent = chapter;
      resetQuizState();
      
      try {
        questionTextEl.textContent = `Loading ${chapter}...`;
        // Add timestamp to bypass cache
        const res = await fetch(`https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&gid=${gid}&_t=${Date.now()}`);
        const text = await res.text();
        const json = JSON.parse(text.substring(47).slice(0, -2));
        const rows = json.table.rows;
        
        if (rows.length < 3) throw new Error("No questions");
        
        // Get timer if available
        if (rows[1]?.c?.[7]?.v) timerDuration = parseInt(rows[1].c[7].v) * 60 * 1000;
        
        // Parse questions
        const rawQuestions = [];
        for (let i = 2; i < rows.length; i++) {
          const r = rows[i].c;
          if (!r || !r[0]?.v) continue;
          
          const options = [r[1]?.v || '', r[2]?.v || ''];
          if (r[3]?.v) options.push(r[3].v);
          if (r[4]?.v) options.push(r[4].v);
          
          let correct = 0;
          const ans = (r[5]?.v || 'A').toString().toUpperCase();
          if (ans === 'B' || ans === '2') correct = 1;
          else if (ans === 'C' || ans === '3') correct = 2;
          else if (ans === 'D' || ans === '4') correct = 3;
          
          rawQuestions.push({
            question: r[0].v,
            options,
            correctIndex: correct,
            explanation: r[6]?.v || '',
            imageUrl: r[8]?.v || '',
            optionImages: [r[9]?.v, r[10]?.v, r[11]?.v, r[12]?.v].filter(Boolean)
          });
        }
        
        if (!rawQuestions.length) throw new Error("No valid questions");
        
        // Randomize if enabled
        if (randomToggleEl.checked) {
          shuffleArray(rawQuestions);
          rawQuestions.forEach(q => {
            const idxs = q.options.map((_, i) => i);
            shuffleArray(idxs);
            q.options = idxs.map(i => q.options[i]);
            q.optionImages = idxs.map(i => q.optionImages[i] || '');
            q.correctIndex = idxs.indexOf(q.correctIndex);
          });
        }
        
        questions = rawQuestions;
        userAnswers = new Array(questions.length);
        questionsLoaded = true;
        currentIndex = 0;
        score = 0;
        scoreMiniEl.textContent = '0';
        quizStartTime = Date.now();
        
        quizQuestionCountEl.textContent = `${questions.length} questions`;
        showQuestionNavigation();
        await preloadChapterImages(questions);
        
        if (timerDuration > 0) {
          showTimerNotification();
          startTimer();
        }
        
        renderQuestion();
        resetInactivityTimer();
        
      } catch (err) {
        questionTextEl.textContent = `Error: ${err.message}`;
        quizTopicNameEl.textContent = "Error";
        quizTopicNameEl.style.background = 'rgba(239,68,68,0.1)';
        quizTopicNameEl.style.color = '#fca5a5';
      }
    }

    function shuffleArray(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
    }

    // ========== TIMER FUNCTIONS ==========
    function startTimer() {
      if (timerDuration <= 0) return;
      timeRemaining = timerDuration;
      timerContainerEl.style.display = 'flex';
      updateTimerDisplay();
      
      timerInterval = setInterval(() => {
        timeRemaining -= 1000;
        if (timeRemaining <= 0) {
          clearInterval(timerInterval);
          autoFinishQuiz();
        }
        updateTimerDisplay();
      }, 1000);
    }

    function updateTimerDisplay() {
      const h = Math.floor(timeRemaining / 3600000);
      const m = Math.floor((timeRemaining % 3600000) / 60000);
      const s = Math.floor((timeRemaining % 60000) / 1000);
      timerDisplayEl.textContent = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
      
      timerDisplayEl.classList.remove('timer-warning', 'timer-critical');
      if (timeRemaining <= 1800000) timerDisplayEl.classList.add('timer-warning');
      if (timeRemaining <= 600000) timerDisplayEl.classList.add('timer-critical');
    }

    function stopTimer() {
      if (timerInterval) clearInterval(timerInterval);
      timerContainerEl.style.display = 'none';
    }

    function showTimerNotification() {
      const h = Math.floor(timerDuration / 3600000);
      const m = Math.floor((timerDuration % 3600000) / 60000);
      const timeStr = h ? `${h}h ${m}m` : m ? `${m}m` : '<1m';
      
      timerNotification = document.createElement('div');
      timerNotification.className = 'timer-notification';
      timerNotification.innerHTML = `<span>â±ï¸ Timer: <strong>${timeStr}</strong></span>`;
      document.querySelector('.toggle-row')?.after(timerNotification);
    }

    function removeTimerNotification() { timerNotification?.remove(); }

    function autoFinishQuiz() { showFinalResult(); stopTimer(); removeTimerNotification(); }

    function formatTimeTaken() {
      if (!quizStartTime) return '';
      const taken = Date.now() - quizStartTime;
      const h = Math.floor(taken / 3600000);
      const m = Math.floor((taken % 3600000) / 60000);
      const s = Math.floor((taken % 60000) / 1000);
      return h ? `${h}h ${m}m` : m ? `${m}m ${s}s` : `${s}s`;
    }

    // ========== NAVIGATION FUNCTIONS ==========
    function toggleQuestionNavigation() {
      questionNavigationEl.classList.toggle('collapsed');
      navigationToggleBtn.innerHTML = questionNavigationEl.classList.contains('collapsed') 
        ? '<i>â–¶</i> Show' : '<i>â–¼</i> Hide';
      if (!questionNavigationEl.classList.contains('collapsed')) updateQuestionNavigation();
    }

    function updateQuestionNavigation() {
      if (!questions.length) return;
      
      questionGridEl.innerHTML = '';
      for (let i = 0; i < questions.length; i++) {
        const btn = document.createElement('button');
        btn.className = 'question-number-btn';
        btn.textContent = i + 1;
        if (i === currentIndex) btn.classList.add('current');
        if (userAnswers[i] !== undefined) {
          if (userAnswers[i] === questions[i].correctIndex) btn.classList.add('answered');
          else btn.classList.add('incorrect');
        }
        btn.onclick = () => { currentIndex = i; renderQuestion(); };
        questionGridEl.appendChild(btn);
      }
      
      let correct = 0, incorrect = 0, unanswered = 0;
      for (let i = 0; i < questions.length; i++) {
        if (userAnswers[i] === undefined) unanswered++;
        else if (userAnswers[i] === questions[i].correctIndex) correct++;
        else incorrect++;
      }
      
      navigationStatsEl.innerHTML = `
        <div class="stat-badge current">â— Current: ${currentIndex+1}</div>
        <div class="stat-badge answered">â— Correct: ${correct}</div>
        <div class="stat-badge incorrect">â— Incorrect: ${incorrect}</div>
        <div class="stat-badge">â— Left: ${unanswered}</div>
      `;
    }

    function showQuestionNavigation() { questionNavigationEl.style.display = 'block'; }

    // ========== SCREEN NAVIGATION ==========
    function showClassSelection() {
      classSelectionEl.style.display = 'block';
      subjectSelectionEl.style.display = 'none';
      quizContainerEl.style.display = 'none';
      resetQuizState();
      resetInactivityTimer();
    }

    function showSubjectSelection(className) {
      currentClass = className;
      currentClassDisplayEl.textContent = className === 'JE' ? 'Junior Engineer' : `Class ${className}`;
      classSelectionEl.style.display = 'none';
      subjectSelectionEl.style.display = 'block';
      quizContainerEl.style.display = 'none';
      loadSubjects();
      resetInactivityTimer();
    }

    function showQuizContainer() {
      subjectSelectionEl.style.display = 'none';
      quizContainerEl.style.display = 'block';
      
      currentPathEl.innerHTML = `
        <span class="path-link" onclick="showClassSelection()">Classes</span>
        <span class="path-separator">â€º</span>
        <span class="path-link" onclick="showSubjectSelection('${currentClass}')">
          ${currentClass === 'JE' ? 'Junior Engineer' : 'Class ' + currentClass}
        </span>
        <span class="path-separator">â€º</span>
        <span>${currentSubject}</span>
      `;
      currentPathEl.style.display = 'flex';
      
      loadChapters();
      resetInactivityTimer();
    }

    // ========== QUIZ FUNCTIONS ==========
    function resetQuizState() {
      questions = [];
      currentIndex = 0;
      score = 0;
      hasAnswered = false;
      questionsLoaded = false;
      attempted = 0;
      userAnswers = [];
      timeRemaining = 0;
      timerDuration = 0;
      quizStartTime = null;
      isReviewMode = false;
      isIncorrectReviewMode = false;
      incorrectQuestionIndices = [];
      hasSentQuizResultNotification = false;
      
      questionTextEl.textContent = "Select a chapter to start";
      questionImageContainerEl.classList.remove('visible');
      questionImageEl.src = '';
      optionsListEl.innerHTML = '';
      feedbackEl.innerHTML = '';
      nextBtn.disabled = true;
      previousBtn.disabled = true;
      finishBtn.disabled = true;
      finishBtn.textContent = "Submit";
      finalScoreEl.style.display = 'none';
      progressBarFillEl.style.width = '0%';
      questionCounterEl.textContent = "0/0";
      scoreMiniEl.textContent = "0";
      timerContainerEl.style.display = 'none';
      toggleRowEl.classList.remove('hidden');
      progressEl.classList.remove('hidden');
      controlsEl.classList.remove('hidden');
      questionBoxEl.style.display = 'block';
      
      questionNavigationEl.classList.remove('expanded');
      questionNavigationEl.classList.add('collapsed');
      navigationToggleBtn.innerHTML = '<i>â–¶</i> Show';
      removeTimerNotification();
      questionWhatsappIconEl.style.display = 'none';
      
      finishBtn.onclick = () => {
        if (!questionsLoaded) return;
        if (confirm("Finish quiz?")) showFinalResult();
        resetInactivityTimer();
      };
    }

    function renderQuestion() {
      if (!questions.length) return;
      
      const q = questions[currentIndex];
      hasAnswered = false;
      feedbackEl.innerHTML = '';
      feedbackEl.className = 'feedback';
      
      if (isIncorrectReviewMode) {
        const pos = incorrectQuestionIndices.indexOf(currentIndex) + 1;
        questionCounterEl.textContent = `Q${pos}/${incorrectQuestionIndices.length}`;
        progressBarFillEl.style.width = `${(pos / incorrectQuestionIndices.length) * 100}%`;
      } else {
        questionCounterEl.textContent = `Q${currentIndex+1}/${questions.length}`;
        progressBarFillEl.style.width = `${((currentIndex+1) / questions.length) * 100}%`;
      }
      
      questionTextEl.innerHTML = q.question.replace(/\n/g, '<br>').replace(/\|\|/g, '<br><br>');
      questionWhatsappIconEl.style.display = 'block';
      
      // Handle image
      if (q.imageUrl?.trim()) {
        const url = convertImageUrl(q.imageUrl);
        questionImageContainerEl.classList.add('visible');
        questionImageEl.style.display = 'none';
        imageLoadingEl.style.display = 'block';
        imageErrorEl.style.display = 'none';
        
        loadImageWithCache(url).then(() => {
          questionImageEl.src = url;
          questionImageEl.style.display = 'block';
          imageLoadingEl.style.display = 'none';
        }).catch(() => {
          imageLoadingEl.style.display = 'none';
          imageErrorEl.style.display = 'block';
        });
      } else {
        questionImageContainerEl.classList.remove('visible');
      }
      
      // Render options
      optionsListEl.innerHTML = '';
      q.options.forEach((opt, i) => {
        const li = document.createElement('li');
        li.className = 'option';
        if (userAnswers[currentIndex] === i) li.classList.add('selected');
        
        li.innerHTML = `
          <div class="option-label">${String.fromCharCode(65+i)}.</div>
          <div class="option-content">${opt}</div>
        `;
        
        li.onclick = () => {
          if (hasAnswered || isReviewMode) return;
          document.querySelectorAll('.option').forEach(o => o.classList.remove('selected'));
          li.classList.add('selected');
          userAnswers[currentIndex] = i;
          handleAnswer(i);
        };
        
        optionsListEl.appendChild(li);
      });
      
      previousBtn.disabled = currentIndex === 0;
      nextBtn.disabled = !isReviewMode;
      finishBtn.disabled = false;
      
      if (userAnswers[currentIndex] !== undefined) {
        showAnswerState(userAnswers[currentIndex]);
        if (!isReviewMode) nextBtn.disabled = false;
      } else if (isReviewMode) {
        showAnswerState(-1);
        feedbackEl.innerHTML = `âœ… Correct Answer: ${q.options[q.correctIndex]}`;
        if (q.explanation) {
          feedbackEl.innerHTML += `<div class="explanation">ðŸ“˜ ${q.explanation}</div>`;
        }
      }
      
      updateQuestionNavigation();
      resetInactivityTimer();
    }

    function handleAnswer(selected) {
      const q = questions[currentIndex];
      hasAnswered = true;
      attempted++;
      
      if (selected === q.correctIndex) {
        score++;
        feedbackEl.innerHTML = 'âœ… Correct!';
        feedbackEl.className = 'feedback correct';
      } else {
        feedbackEl.innerHTML = `âŒ Wrong. Correct: ${q.options[q.correctIndex]}`;
        feedbackEl.className = 'feedback incorrect';
      }
      
      if (q.explanation) {
        feedbackEl.innerHTML += `<div class="explanation">ðŸ“˜ ${q.explanation}</div>`;
      }
      
      scoreMiniEl.textContent = `${score}`;
      showAnswerState(selected);
      nextBtn.disabled = false;
      updateQuestionNavigation();
    }

    function showAnswerState(selected) {
      const q = questions[currentIndex];
      document.querySelectorAll('.option').forEach((opt, i) => {
        opt.classList.remove('correct', 'incorrect', 'selected');
        if (i === q.correctIndex) opt.classList.add('correct');
        if (i === selected && selected !== q.correctIndex) opt.classList.add('incorrect');
        if (i === selected) opt.classList.add('selected');
      });
    }

    function goToNext() {
      if (isIncorrectReviewMode) {
        const pos = incorrectQuestionIndices.indexOf(currentIndex);
        if (pos < incorrectQuestionIndices.length - 1) {
          currentIndex = incorrectQuestionIndices[pos + 1];
        } else {
          currentIndex = incorrectQuestionIndices[0];
        }
      } else if (currentIndex < questions.length - 1) {
        currentIndex++;
      } else if (!isReviewMode) {
        showFinalResult();
        return;
      } else {
        currentIndex = 0;
      }
      renderQuestion();
    }

    function goToPrev() {
      if (isIncorrectReviewMode) {
        const pos = incorrectQuestionIndices.indexOf(currentIndex);
        if (pos > 0) {
          currentIndex = incorrectQuestionIndices[pos - 1];
        } else {
          currentIndex = incorrectQuestionIndices[incorrectQuestionIndices.length - 1];
        }
      } else if (currentIndex > 0) {
        currentIndex--;
      }
      renderQuestion();
    }

    function calculateStats() {
      let correct = 0;
      for (let i = 0; i < questions.length; i++) {
        if (userAnswers[i] !== undefined && userAnswers[i] === questions[i].correctIndex) correct++;
      }
      return {
        total: questions.length,
        correct,
        percentage: ((correct / questions.length) * 100).toFixed(2),
        timeTaken: formatTimeTaken()
      };
    }

    function showFinalResult() {
      stopTimer();
      removeTimerNotification();
      const stats = calculateStats();
      
      toggleRowEl.classList.add('hidden');
      progressEl.classList.add('hidden');
      questionNavigationEl.style.display = 'none';
      timerContainerEl.classList.add('hidden');
      controlsEl.classList.add('hidden');
      questionBoxEl.style.display = 'none';
      questionWhatsappIconEl.style.display = 'none';
      
      finalScoreEl.style.display = 'block';
      finalScoreEl.innerHTML = `
        <div class="result-header">Results</div>
        <div class="result-stats">
          <div class="stat-item"><span class="stat-label">Total</span><span class="stat-value">${stats.total}</span></div>
          <div class="stat-item"><span class="stat-label">Correct</span><span class="stat-value">${stats.correct}</span></div>
          <div class="stat-item"><span class="stat-label">Score</span><span class="stat-value stat-percentage">${stats.percentage}%</span></div>
          <div class="stat-item"><span class="stat-label">Time</span><span class="stat-value stat-time">${stats.timeTaken || 'N/A'}</span></div>
        </div>
        <div class="result-message">${getPerformanceRemark(parseFloat(stats.percentage))}</div>
        <button class="restart-btn" onclick="restartQuiz()">Restart</button>
      `;
      
      resetInactivityTimer();
      sendQuizResultNotification(stats);
    }

    function restartQuiz() {
      isReviewMode = false;
      isIncorrectReviewMode = false;
      userAnswers = [];
      score = 0;
      currentIndex = 0;
      scoreMiniEl.textContent = '0';
      
      finishBtn.textContent = "Submit";
      finishBtn.onclick = () => {
        if (!questionsLoaded) return;
        if (confirm("Finish quiz?")) showFinalResult();
        resetInactivityTimer();
      };
      
      finalScoreEl.style.display = 'none';
      toggleRowEl.classList.remove('hidden');
      progressEl.classList.remove('hidden');
      questionNavigationEl.style.display = 'block';
      questionNavigationEl.classList.add('collapsed');
      timerContainerEl.classList.remove('hidden');
      controlsEl.classList.remove('hidden');
      questionBoxEl.style.display = 'block';
      
      if (timerDuration > 0) {
        showTimerNotification();
        startTimer();
      }
      
      renderQuestion();
      resetInactivityTimer();
    }

    // ========== LOGIN FUNCTION ==========
    function login(user, isRestore = false) {
      const validation = validateUserAccount(user);
      if (!validation.valid) {
        if (user.subscriptionReason === 'expired') {
          showSubscriptionExpired(user, user.joiningDate, user.lastDate);
        } else {
          showAccountConfigError(user, validation.error);
        }
        return;
      }
      
      currentUser = user;
      currentUser.validatedAssignedClasses = validation.assignedClasses;
      
      headerUsernameEl.textContent = user.name;
      sideUsername.textContent = user.name;
      greetingMessageEl.innerHTML = `Welcome, <span>${user.name}</span> (${user.role})`;
      
      fixedHeaderEl.style.display = 'flex';
      headerUserInfoEl.style.display = 'block';
      loginContainerEl.style.display = 'none';
      accountConfigErrorEl.style.display = 'none';
      subscriptionExpiredEl.style.display = 'none';
      classSelectionEl.style.display = 'block';
      
      resetFailedAttempts();
      resetInactivityTimer();
      loadClasses();
      saveSession();
      
      if (!isRestore) sendLoginNotification(user);
    }

    // ========== LOGOUT FUNCTION ==========
    function logout() {
      if (timerInterval) clearInterval(timerInterval);
      if (inactivityTimer) clearTimeout(inactivityTimer);
      if (cooldownTimer) clearInterval(cooldownTimer);
      
      imageCache.clear();
      clearSession();
      
      currentUser = null;
      fixedHeaderEl.style.display = 'none';
      classSelectionEl.style.display = 'none';
      subjectSelectionEl.style.display = 'none';
      quizContainerEl.style.display = 'none';
      accountConfigErrorEl.style.display = 'none';
      subscriptionExpiredEl.style.display = 'none';
      loginContainerEl.style.display = 'flex';
      
      loginFormEl.reset();
      passwordEl.type = 'password';
      passwordToggleEl.textContent = 'ðŸ‘ï¸';
      loginErrorEl.style.display = 'none';
      
      sideMenu.classList.remove('open');
      menuOverlay.classList.remove('open');
      usernameEl.focus();
    }

    function autoLogout() {
      if (currentUser) {
        alert("Logged out due to inactivity");
        logout();
      }
    }

    function resetInactivityTimer() {
      if (inactivityTimer) clearTimeout(inactivityTimer);
      if (currentUser) inactivityTimer = setTimeout(autoLogout, INACTIVITY_TIMEOUT);
    }

    function handleUserActivity() {
      updateLastActivity();
      resetInactivityTimer();
    }

    // ========== EVENT LISTENERS ==========
    loginFormEl.addEventListener("submit", async (e) => {
      e.preventDefault();
      
      if (isOnCooldown) {
        loginErrorEl.textContent = "Please wait for cooldown";
        loginErrorEl.style.display = 'block';
        return;
      }
      
      const u = usernameEl.value.trim();
      const p = passwordEl.value.trim();
      
      if (!u || !p) {
        loginErrorEl.textContent = "Enter both fields";
        loginErrorEl.style.display = 'block';
        return;
      }
      
      loginErrorEl.style.display = 'none';
      loginBtnEl.disabled = true;
      loginBtnEl.textContent = 'Loading...';
      
      const result = await authenticateWithAppsScript(u, p);
      
      if (result?.success) {
        resetFailedAttempts();
        if (!result.subscriptionValid) {
          showSubscriptionExpired(result.user, result.user.joiningDate, result.user.lastDate);
        } else {
          login(result.user, false);
        }
      } else {
        recordFailedAttempt();
        loginErrorEl.textContent = failedAttempts >= MAX_ATTEMPTS 
          ? `Too many attempts. Wait ${COOLDOWN_TIME}s` 
          : (result?.error || 'Invalid credentials');
        loginErrorEl.style.display = 'block';
      }
      
      loginBtnEl.disabled = false;
      loginBtnEl.textContent = 'Login';
    });

    startBtnEl.addEventListener("click", () => {
      const ch = topicSelectEl.value;
      if (!ch) { alert("Select a chapter"); return; }
      if (timerInterval) clearInterval(timerInterval);
      removeTimerNotification();
      resetQuizState();
      loadQuestionsFromGoogleSheet(ch);
      resetInactivityTimer();
    });

    nextBtn.addEventListener("click", goToNext);
    previousBtn.addEventListener("click", goToPrev);
    navigationToggleBtn.addEventListener("click", toggleQuestionNavigation);
    randomToggleEl.addEventListener("change", () => resetInactivityTimer());

    backToClassesBtn.addEventListener("click", () => { showClassSelection(); resetInactivityTimer(); });
    backToLoginBtnEl.addEventListener("click", () => { accountConfigErrorEl.style.display = 'none'; loginContainerEl.style.display = 'flex'; resetInactivityTimer(); });
    backToLoginFromExpiredBtn.addEventListener("click", () => { subscriptionExpiredEl.style.display = 'none'; loginContainerEl.style.display = 'flex'; resetInactivityTimer(); });

    setupQuestionWhatsAppSupport();

    document.addEventListener('click', (e) => {
      if (questionImageEl?.classList.contains('zoomed') && !e.target.closest('#question-image-container')) {
        questionImageEl.classList.remove('zoomed', 'touch-zoom');
      }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') questionImageEl?.classList.remove('zoomed', 'touch-zoom');
    });

    // ========== SIDE MENU ==========
    function toggleMenu() {
      sideMenu.classList.toggle('open');
      menuOverlay.classList.toggle('open');
    }
    menuToggle.addEventListener('click', toggleMenu);
    menuOverlay.addEventListener('click', toggleMenu);
    sideLogoutBtn.addEventListener('click', () => {
      toggleMenu();
      logout();
    });

    // ========== THEME TOGGLE ==========
    function setTheme(theme) {
      if (theme === 'light') {
        document.body.classList.add('light-mode');
        themeIcon.textContent = 'â˜€ï¸';
        metaThemeColor.setAttribute('content', '#f3f4f6');
        localStorage.setItem('theme', 'light');
      } else {
        document.body.classList.remove('light-mode');
        themeIcon.textContent = 'ðŸŒ™';
        metaThemeColor.setAttribute('content', '#0b1120');
        localStorage.setItem('theme', 'dark');
      }
    }
    
    themeToggle.addEventListener('click', () => {
      setTheme(document.body.classList.contains('light-mode') ? 'dark' : 'light');
    });
    
    setTheme(localStorage.getItem('theme') || 'dark');

    // ========== INITIALIZATION ==========
    async function init() {
      await loadTelegramConfig();
      await getUserIP();
      
      if (loadSession()) {
        login(currentUser, true);
      } else {
        usernameEl.focus();
      }
      
      document.addEventListener('mousemove', handleUserActivity);
      document.addEventListener('keypress', handleUserActivity);
      document.addEventListener('click', handleUserActivity);
      document.addEventListener('touchstart', handleUserActivity);
      
      resetFailedAttempts();
    }

    document.addEventListener("DOMContentLoaded", init);

    // Expose functions globally
    window.showClassSelection = showClassSelection;
    window.toggleImageZoom = toggleImageZoom;
    window.restartQuiz = restartQuiz;
    window.goToNext = goToNext;
    window.goToPrev = goToPrev;
    window.showFinalResult = showFinalResult;
  </script>
</body>
</html>
